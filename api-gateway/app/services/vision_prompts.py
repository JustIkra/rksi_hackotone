"""
Shared AI Vision prompts for metric extraction.

This module provides the vision prompt used by MetricExtractionService.
Prompts are loaded from config/prompts/vision-extraction.json with
fallback to hardcoded default for backward compatibility.
"""

from __future__ import annotations

import logging
from functools import lru_cache

from app.core.prompt_loader import get_prompt_loader

logger = logging.getLogger(__name__)

# Fallback prompt (used if config file not found)
_FALLBACK_VISION_PROMPT = """Ты анализируешь изображение психологического отчёта. Твоя задача - ТОЧНО прочитать числовые значения метрик с диаграмм, графиков и таблиц.

ВАЖНО: Каждая метрика имеет УНИКАЛЬНОЕ значение! Внимательно читай числа на шкалах, столбцах диаграмм и в таблицах. НЕ ВЫДУМЫВАЙ значения - читай их с изображения!

ФОРМАТ ОТВЕТА: {"metrics": [{"label": "НАЗВАНИЕ", "value": "X.X"}]}

ГДЕ ИСКАТЬ ЗНАЧЕНИЯ:
- На горизонтальных столбчатых диаграммах: длина столбца соответствует значению по шкале 1-10
- В таблицах: значения указаны в колонках рядом с названием метрики
- На круговых/лепестковых диаграммах: значения подписаны или определяются по радиусу
- Числовые значения могут быть с десятичной частью: 6.4, 7.5, 8.2 и т.д.

РАЗРЕШЁННЫЕ МЕТРИКИ (извлекай ТОЛЬКО эти):
- Личностные: АБСТРАКТНОСТЬ, АКТИВНОСТЬ, ЗАМКНУТОСТЬ, ИМПУЛЬСИВНОСТЬ, ДРУЖЕЛЮБИЕ, КОНФЛИКТНОСТЬ, КОНФОРМИЗМ, МОРАЛЬНАЯ ГИБКОСТЬ, МОРАЛЬНОСТЬ, НЕДОВЕРЧИВОСТЬ, НЕЗАВИСИМОСТЬ, НЕЧУВСТВИТЕЛЬНОСТЬ, НОРМАТИВНОСТЬ, ОБЩИТЕЛЬНОСТЬ, ОРГАНИЗОВАННОСТЬ, ПАССИВНОСТЬ, ТРЕВОЖНОСТЬ, УРАВНОВЕШЕННОСТЬ, КОНКРЕТНОСТЬ, СЕНЗИТИВНОСТЬ, ИНТЕЛЛЕКТУАЛЬНАЯ СДЕРЖАННОСТЬ
- Командные роли: АДМИНИСТРАТОР, АНАЛИТИК, ГЕНЕРАТОР ИДЕЙ, ДУША КОМАНДЫ, ИНТЕГРАТОР, ИССЛЕДОВАТЕЛЬ РЕСУРСОВ, КОНТРОЛЕР, КООРДИНАТОР, МОТИВАТОР, ПРЕДПРИНИМАТЕЛЬ, ПРОИЗВОДИТЕЛЬ, РЕАЛИЗАТОР, СПЕЦИАЛИСТ
- Профобласти: АНАЛИЗ И ПЛАНИРОВАНИЕ, КОНТРОЛЬ АУДИТ, ОБЕСПЕЧЕНИЕ ПРОЦЕССА, ПОДДЕРЖКА, ПРИНЯТИЕ РЕШЕНИЙ, ПРОДВИЖЕНИЕ, РАБОТА С ДОКУМЕНТАМИ, РАЗРАБОТКА, ПРОИЗВОДСТВО И ТЕХНОЛОГИИ
- Интеллект: ВЕРБАЛЬНАЯ ЛОГИКА, ВЫЧИСЛЕНИЯ, ЛЕКСИКА, НЕВЕРБАЛЬНАЯ ЛОГИКА, ОБРАБОТКА ИНФОРМАЦИИ, ОБЩИЙ БАЛЛ ИНТЕЛЛЕКТА, ПРОСТРАНСТВЕННОЕ МЫШЛЕНИЕ, ЭРУДИЦИЯ
- Мотивация: ВНЕШНЯЯ МОТИВАЦИЯ, ВНУТРЕННЯЯ МОТИВАЦИЯ, ДЕНЬГИ, ЗДОРОВЬЕ, ИНТЕРЕС, МОТИВАЦИЯ ДОСТИЖЕНИЙ, ПРИЗНАНИЕ, СВЯЗИ, СЛУЖЕНИЕ ОБЩЕСТВУ, СТРЕМЛЕНИЕ К САМОРАЗВИТИЮ, ТРАДИЦИИ, ПОМОЩЬ ЛЮДЯМ
- Компетенции: ВКЛЮЧЕННОСТЬ В КОМАНДУ, ИННОВАЦИОННОСТЬ, КОМАНДНОСТЬ, КОММУНИКАБЕЛЬНОСТЬ, КОМПЛЕКСНОЕ РЕШЕНИЕ ПРОБЛЕМ, ЛИДЕРСТВО, ЛЮБОЗНАТЕЛЬНОСТЬ, ОБЩЕНИЕ, ОРИГИНАЛЬНОСТЬ, ОРИЕНТАЦИЯ НА КЛИЕНТА, ОТВЕТСТВЕННОСТЬ, РУКОВОДСТВО, СТРЕССОУСТОЙЧИВОСТЬ, ТВОРЧЕСТВО, ТРАДИЦИОННОСТЬ
- Управление: СИСТЕМНОЕ МЫШЛЕНИЕ, ВЛИЯНИЕ, ДЕЛЕГИРОВАНИЕ, ПРИНЯТИЕ УПРАВЛЕНЧЕСКИХ РЕШЕНИЙ, КОНТРОЛЬ, ОРГАНИЗАЦИЯ РАБОТЫ, ДЕЛОВАЯ КОММУНИКАЦИЯ, МОТИВАЦИЯ К РУКОВОДСТВУ, ПОТЕНЦИАЛ К РУКОВОДСТВУ

ПРАВИЛА:
1. ЧИТАЙ значения с изображения - у каждой метрики своё уникальное число!
2. label - название метрики В ВЕРХНЕМ РЕГИСТРЕ
3. value - число от 1 до 10 с точкой ("6.4"), НЕ проценты
4. ПАРНЫЕ ШКАЛЫ (ОЧЕНЬ ВАЖНО!):
   - Если на диаграмме слева и справа от столбца указаны ДВА названия (например: "ЗАМКНУТОСТЬ" слева, "ОБЩИТЕЛЬНОСТЬ" справа)
   - Извлекай как ОДНУ метрику через ДЕФИС: {"label": "ЗАМКНУТОСТЬ–ОБЩИТЕЛЬНОСТЬ", "value": "6.1"}
   - Используй символ – (en-dash, длинный дефис) между названиями!

   ПОЛНЫЙ СПИСОК ПАРНЫХ ШКАЛ (извлекай в точности так):
   Блок ЛИЧНОСТЬ:
   - ЗАМКНУТОСТЬ–ОБЩИТЕЛЬНОСТЬ
   - ПАССИВНОСТЬ–АКТИВНОСТЬ
   - НЕДОВЕРЧИВОСТЬ–ДРУЖЕЛЮБИЕ
   - НЕЗАВИСИМОСТЬ–КОНФОРМИЗМ
   - МОРАЛЬНАЯ ГИБКОСТЬ–МОРАЛЬНОСТЬ
   - ИМПУЛЬСИВНОСТЬ–ОРГАНИЗОВАННОСТЬ
   - ТРЕВОЖНОСТЬ–УРАВНОВЕШЕННОСТЬ
   - СЕНЗИТИВНОСТЬ–НЕЧУВСТВИТЕЛЬНОСТЬ
   - ИНТЕЛЛЕКТУАЛЬНАЯ СДЕРЖАННОСТЬ–ЛЮБОЗНАТЕЛЬНОСТЬ
   - ТРАДИЦИОННОСТЬ–ОРИГИНАЛЬНОСТЬ
   - КОНКРЕТНОСТЬ–АБСТРАКТНОСТЬ

   Блок МОТИВАЦИЯ:
   - ВНЕШНЯЯ МОТИВАЦИЯ–ВНУТРЕННЯЯ МОТИВАЦИЯ

5. Нет метрик = {"metrics": []}
6. НЕ ПОВТОРЯЙ одну метрику!
7. Игнорируй подписи шкал (1,2,3...10) - это НЕ значения метрик

НОРМАЛИЗАЦИЯ НАЗВАНИЙ:
- "КОНТРОЛЬ, АУДИТ" → "КОНТРОЛЬ АУДИТ"
- "ПРОИЗВОДИТЕЛЬНОСТЬ" → "ПРОИЗВОДИТЕЛЬ"
- "КОММУНИКАТИВНОСТЬ" → "КОММУНИКАБЕЛЬНОСТЬ"

Ответ - ТОЛЬКО JSON:
"""


@lru_cache(maxsize=1)
def get_vision_prompt() -> str:
    """
    Get vision extraction prompt from config or fallback.

    Returns:
        Vision prompt text for AI extraction
    """
    loader = get_prompt_loader()
    return loader.get_prompt_text(
        "vision-extraction",
        "vision_prompt",
        fallback=_FALLBACK_VISION_PROMPT,
    )


# Backward compatibility: keep IMPROVED_VISION_PROMPT as module-level constant
# This allows existing imports to work unchanged
def _get_prompt_on_import() -> str:
    """Load prompt at import time for backward compatibility."""
    try:
        return get_vision_prompt()
    except Exception as e:
        logger.warning(f"Failed to load vision prompt from config: {e}, using fallback")
        return _FALLBACK_VISION_PROMPT


IMPROVED_VISION_PROMPT = _get_prompt_on_import()
