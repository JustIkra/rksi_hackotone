import{m as i,H as X,v as _,w as l,E as Z,r as d,I as $,o as s,a as m,f as n,J as ee,c as u,F as T,C as Y,e as f,u as te,M as ae,x as p,B as c}from"./index-BibmxTFi.js";import{A as le}from"./AppLayout-DA39d9wk.js";import{a as M}from"./admin-BMxJc4m3.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";const se={class:"audit-log-view"},oe={key:0},de={class:"user-name"},ue={key:0,class:"user-email"},ce={key:1,class:"text-muted"},ie={class:"metric-codes"},re={key:0,class:"affected-counts"},_e={key:0},me={key:1},pe={key:2},fe={key:1,class:"text-muted"},ve={key:2,class:"pagination-wrapper"},ge={__name:"AdminAuditLogView",setup(ye){const y=i(!1),b=i([]),k=i(0),v=i(1),h=i(50),C=i([]),D=i(null),o=i({start_date:null,end_date:null,action:null}),S=[{text:"Сегодня",value:()=>{const t=new Date;t.setHours(0,0,0,0);const a=new Date;return a.setHours(23,59,59,999),[t,a]}},{text:"Последние 7 дней",value:()=>{const t=new Date,a=new Date;return a.setDate(a.getDate()-7),[a,t]}},{text:"Последние 30 дней",value:()=>{const t=new Date,a=new Date;return a.setDate(a.getDate()-30),[a,t]}}],B={bulk_delete:"Массовое удаление",delete:"Удаление",create:"Создание",update:"Обновление"},V=t=>B[t]||t,F=t=>({bulk_delete:"danger",delete:"danger",create:"success",update:"warning"})[t]||"info",H=t=>t?new Date(t).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—",U=t=>{t&&t.length===2?(o.value.start_date=t[0],o.value.end_date=t[1]):(o.value.start_date=null,o.value.end_date=null),r()},N=()=>{v.value=1,r()},P=()=>{r()},E=()=>{D.value=null,o.value={start_date:null,end_date:null,action:null},v.value=1,r()},r=async()=>{y.value=!0;try{const t={limit:h.value,offset:(v.value-1)*h.value};o.value.start_date&&(t.start_date=o.value.start_date),o.value.end_date&&(t.end_date=o.value.end_date),o.value.action&&(t.action=o.value.action);const a=await M.getAuditLog(t);b.value=a.items||[],k.value=a.total||0}catch(t){console.error("Failed to load audit log:",t),Z.error("Не удалось загрузить журнал аудита")}finally{y.value=!1}},I=async()=>{try{const t=await M.getAuditActionTypes();C.value=t.actions||[]}catch(t){console.error("Failed to load action types:",t)}};return X(async()=>{await Promise.all([r(),I()])}),(t,a)=>{const x=d("el-card"),R=d("el-date-picker"),w=d("el-form-item"),J=d("el-option"),j=d("el-select"),q=d("el-icon"),z=d("el-button"),G=d("el-form"),g=d("el-table-column"),A=d("el-tag"),K=d("el-table"),O=d("el-empty"),Q=d("el-pagination"),W=$("loading");return s(),_(le,null,{default:l(()=>[m("div",se,[n(x,{class:"header-card"},{default:l(()=>[...a[4]||(a[4]=[m("div",{class:"header-content"},[m("div",null,[m("h1",null,"Журнал аудита"),m("p",null,"История операций с метриками")])],-1)])]),_:1}),n(x,{class:"filters-card"},{default:l(()=>[n(G,{inline:!0,model:o.value,class:"filters-form"},{default:l(()=>[n(w,{label:"Период"},{default:l(()=>[n(R,{modelValue:D.value,"onUpdate:modelValue":a[0]||(a[0]=e=>D.value=e),type:"daterange","range-separator":"—","start-placeholder":"Начало","end-placeholder":"Конец",format:"DD.MM.YYYY","value-format":"YYYY-MM-DDTHH:mm:ss",shortcuts:S,onChange:U},null,8,["modelValue"])]),_:1}),n(w,{label:"Действие"},{default:l(()=>[n(j,{modelValue:o.value.action,"onUpdate:modelValue":a[1]||(a[1]=e=>o.value.action=e),placeholder:"Все действия",clearable:"",style:{width:"200px"},onChange:r},{default:l(()=>[(s(!0),u(T,null,Y(C.value,e=>(s(),_(J,{key:e,label:V(e),value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),n(w,null,{default:l(()=>[n(z,{type:"primary",onClick:r},{default:l(()=>[n(q,null,{default:l(()=>[n(te(ae))]),_:1}),a[5]||(a[5]=f(" Применить ",-1))]),_:1}),n(z,{onClick:E},{default:l(()=>[...a[6]||(a[6]=[f(" Сбросить ",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),ee((s(),_(x,{class:"table-card"},{default:l(()=>[b.value.length>0?(s(),_(K,{key:0,data:b.value,stripe:"",style:{width:"100%"}},{default:l(()=>[n(g,{label:"Дата и время",width:"180"},{default:l(({row:e})=>[f(c(H(e.timestamp)),1)]),_:1}),n(g,{label:"Пользователь",width:"200"},{default:l(({row:e})=>[e.user?(s(),u("div",oe,[m("div",de,c(e.user.full_name||e.user.email),1),e.user.full_name?(s(),u("div",ue,c(e.user.email),1)):p("",!0)])):(s(),u("span",ce,"Система"))]),_:1}),n(g,{label:"Действие",width:"150"},{default:l(({row:e})=>[n(A,{type:F(e.action)},{default:l(()=>[f(c(V(e.action)),1)]),_:2},1032,["type"])]),_:1}),n(g,{label:"Коды метрик","min-width":"250"},{default:l(({row:e})=>[m("div",ie,[(s(!0),u(T,null,Y(e.metric_codes.slice(0,5),L=>(s(),_(A,{key:L,size:"small",type:"info",class:"metric-code-tag"},{default:l(()=>[f(c(L),1)]),_:2},1024))),128)),e.metric_codes.length>5?(s(),_(A,{key:0,size:"small",type:"info"},{default:l(()=>[f(" +"+c(e.metric_codes.length-5),1)]),_:2},1024)):p("",!0)])]),_:1}),n(g,{label:"Затронуто",width:"200"},{default:l(({row:e})=>[e.affected_counts?(s(),u("div",re,[e.affected_counts.extracted_metrics?(s(),u("div",_e," Извлеч. метрик: "+c(e.affected_counts.extracted_metrics),1)):p("",!0),e.affected_counts.synonyms?(s(),u("div",me," Синонимов: "+c(e.affected_counts.synonyms),1)):p("",!0),e.affected_counts.weight_tables?(s(),u("div",pe," Весовых таблиц: "+c(e.affected_counts.weight_tables),1)):p("",!0)])):(s(),u("span",fe,"—"))]),_:1})]),_:1},8,["data"])):y.value?p("",!0):(s(),_(O,{key:1,description:"Нет записей"})),k.value>0?(s(),u("div",ve,[n(Q,{"current-page":v.value,"onUpdate:currentPage":a[2]||(a[2]=e=>v.value=e),"page-size":h.value,"onUpdate:pageSize":a[3]||(a[3]=e=>h.value=e),total:k.value,"page-sizes":[20,50,100],layout:"total, sizes, prev, pager, next",onSizeChange:N,onCurrentChange:P},null,8,["current-page","page-size","total"])])):p("",!0)]),_:1})),[[W,y.value]])])]),_:1})}}},xe=ne(ge,[["__scopeId","data-v-6ef12a26"]]);export{xe as default};
