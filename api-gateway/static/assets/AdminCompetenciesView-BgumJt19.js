import{O as J,m as d,n as je,P as Z,H as qe,v as z,w as t,E as m,r as s,I as Oe,o as v,a as i,d as l,J as Pe,f as u,u as f,a6 as me,a3 as He,M as Je,c as C,a9 as Ke,K as ee,z as le,ab as Qe,B as _,F as ve,C as pe,ac as Ge,y as We,a1 as fe,aa as Xe,x as B,ad as Ye,a4 as Ze,N as el}from"./index-ZMEcESU3.js";import{A as ll}from"./AppLayout-CZyszRaZ.js";import{m as M,g as tl}from"./metricNames-BmrdaEUl.js";import{_ as al}from"./_plugin-vue_export-helper-DlAUqK2U.js";const K={list:()=>J.get("/admin/metric-categories").then(V=>V.data),create:V=>J.post("/admin/metric-categories",V).then(b=>b.data),update:(V,b)=>J.put(`/admin/metric-categories/${V}`,b).then(x=>x.data),delete:V=>J.delete(`/admin/metric-categories/${V}`).then(b=>b.data)},ol={class:"admin-competencies-view"},nl={class:"header-content"},il={class:"header-buttons"},ul={class:"content-container"},sl={key:1,class:"main-layout"},dl={class:"categories-sidebar"},rl={class:"sidebar-header"},cl={class:"category-list"},ml=["onClick"],vl={class:"category-name"},pl={class:"metrics-content"},fl={class:"metrics-header"},_l={class:"metric-name-cell"},gl={key:0,class:"metric-description"},yl={key:0},wl={style:{margin:"8px 0 0 0","padding-left":"20px"}},bl={key:0},Cl={key:1},Vl={__name:"AdminCompetenciesView",setup(V){const b=d(!1),x=d(!1),Q=d(!1),G=d(!1),E=d(null),T=d(""),R=d([]),j=d([]),p=d(null),W=je(new Set),S=d(!1),F=d(!1),h=d(!1),A=d(!1),$=d(null),k=d(null),L=d(null),g=d(null),I=d(null),X=d(null),te=d(null),r=d({code:"",name:"",name_ru:"",description:"",min_value:1,max_value:10,active:!0,category_id:null}),_e={code:[{required:!0,message:"Введите код метрики",trigger:"blur"},{min:1,max:50,message:"От 1 до 50 символов",trigger:"blur"}],name_ru:[{required:!0,message:"Введите название",trigger:"blur"}]},y=d({name:"",description:""}),ae=new Set,oe=Z(()=>{let a=R.value;if(p.value==="uncategorized"?a=a.filter(e=>!e.category_id):p.value!==null&&(a=a.filter(e=>e.category_id===p.value)),T.value){const e=T.value.toLowerCase();a=a.filter(n=>n.name_ru&&n.name_ru.toLowerCase().includes(e)||n.name&&n.name.toLowerCase().includes(e)||n.code&&n.code.toLowerCase().includes(e))}return a}),ge=Z(()=>{if(p.value===null)return"Все метрики";if(p.value==="uncategorized")return"Без категории";const a=j.value.find(e=>e.id===p.value);return a?a.name:"Метрики"}),ye=Z(()=>R.value.filter(a=>!a.category_id).length),ne=(a,e)=>{const n=a?.code||e,c=n&&ae.has(n)?{warn:()=>{}}:{warn:q=>{n&&ae.add(n),console.warn(q)}};return tl(a,n,c)},we=a=>R.value.filter(e=>e.category_id===a).length,D=async()=>{b.value=!0,E.value=null;try{const[a,e]=await Promise.all([M.listMetricDefs(!1),K.list().catch(()=>[])]);R.value=a.items||[],j.value=e||[]}catch(a){console.error("Failed to load data:",a),E.value="Не удалось загрузить данные",m.error("Ошибка загрузки данных")}finally{b.value=!1}},Y=(a=null)=>{$.value=a,a?r.value={code:a.code,name:a.name||"",name_ru:a.name_ru||"",description:a.description||"",min_value:a.min_value??1,max_value:a.max_value??10,active:a.active??!0,category_id:a.category_id||null}:r.value={code:"",name:"",name_ru:"",description:"",min_value:1,max_value:10,active:!0,category_id:p.value==="uncategorized"?null:p.value},S.value=!0},be=async()=>{try{await te.value?.validate()}catch{return}try{x.value=!0;const a={...r.value};$.value?(await M.updateMetricDef($.value.id,a),m.success("Метрика обновлена")):(await M.createMetricDef(a),m.success("Метрика создана")),S.value=!1,await D()}catch(a){console.error("Failed to save metric:",a),m.error(a.response?.data?.detail||"Ошибка сохранения метрики")}finally{x.value=!1}},Ce=async(a,e)=>{W.add(a.id);try{await M.updateMetricDef(a.id,{active:e}),a.active=e,m.success(e?"Метрика активирована":"Метрика деактивирована")}catch(n){console.error("Failed to toggle metric:",n),m.error("Ошибка изменения статуса")}finally{W.delete(a.id)}},Ve=async(a,e)=>{if(a==="edit")Y(e);else if(a==="delete"){L.value=e,g.value=null,h.value=!0;try{g.value=await M.getUsage(e.id)}catch{g.value={weight_tables_count:0,extracted_metrics_count:0}}}},xe=async()=>{if(L.value)try{Q.value=!0,await M.deleteMetricDef(L.value.id),m.success("Метрика удалена"),h.value=!1,await D()}catch(a){console.error("Failed to delete metric:",a),m.error(a.response?.data?.detail||"Ошибка удаления метрики")}finally{Q.value=!1,L.value=null,g.value=null}},ie=(a=null)=>{k.value=a,a?y.value={name:a.name,description:a.description||""}:y.value={name:"",description:""},F.value=!0},ke=async()=>{if(!y.value.name){m.warning("Введите название категории");return}try{x.value=!0,k.value?(await K.update(k.value.id,y.value),m.success("Категория обновлена")):(await K.create(y.value),m.success("Категория создана")),F.value=!1,await D()}catch(a){console.error("Failed to save category:",a),m.error(a.response?.data?.detail||"Ошибка сохранения категории")}finally{x.value=!1}},Me=async()=>{try{await el.confirm(`Удалить категорию "${k.value.name}"? Метрики в этой категории станут "Без категории".`,"Подтверждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),await K.delete(k.value.id),m.success("Категория удалена"),F.value=!1,p.value=null,await D()}catch(a){a!=="cancel"&&(console.error("Failed to delete category:",a),m.error(a.response?.data?.detail||"Ошибка удаления категории"))}},De=async()=>{try{const a=await M.exportMetrics("xlsx"),e=window.URL.createObjectURL(a),n=document.createElement("a");n.href=e,n.download=`metrics_export_${new Date().toISOString().slice(0,10)}.xlsx`,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(e),m.success("Экспорт завершен")}catch(a){console.error("Failed to export metrics:",a),m.error("Ошибка экспорта")}},Ue=()=>{I.value=null,X.value&&X.value.clearFiles(),A.value=!0},ze=a=>{I.value=a.raw},Fe=async()=>{if(I.value)try{G.value=!0;const a=await M.importMetrics(I.value);m.success(`Импортировано: создано ${a.created_count||0}, обновлено ${a.updated_count||0}`),A.value=!1,await D()}catch(a){console.error("Failed to import metrics:",a),m.error(a.response?.data?.detail||"Ошибка импорта")}finally{G.value=!1}};return qe(async()=>{await D()}),(a,e)=>{const n=s("el-icon"),c=s("el-button"),q=s("el-card"),U=s("el-input"),$e=s("el-result"),O=s("el-tag"),P=s("el-table-column"),ue=s("el-switch"),se=s("el-dropdown-item"),Le=s("el-dropdown-menu"),Be=s("el-dropdown"),Re=s("el-table"),Se=s("el-empty"),w=s("el-form-item"),de=s("el-input-number"),re=s("el-col"),he=s("el-row"),Ae=s("el-option"),Ie=s("el-select"),ce=s("el-form"),H=s("el-dialog"),Ne=s("el-alert"),Ee=s("el-upload"),Te=Oe("loading");return v(),z(ll,null,{default:t(()=>[i("div",ol,[l(q,{class:"header-card"},{default:t(()=>[i("div",nl,[e[26]||(e[26]=i("div",null,[i("h1",null,"Словарь компетенций"),i("p",null,"Управление метриками и категориями для оценки профессиональной пригодности")],-1)),i("div",il,[l(c,{size:"large",onClick:Ue},{default:t(()=>[l(n,null,{default:t(()=>[l(f(me))]),_:1}),e[24]||(e[24]=u(" Импорт ",-1))]),_:1}),l(c,{size:"large",type:"primary",onClick:De},{default:t(()=>[l(n,null,{default:t(()=>[l(f(He))]),_:1}),e[25]||(e[25]=u(" Экспорт ",-1))]),_:1})])])]),_:1}),l(q,{class:"search-card"},{default:t(()=>[l(U,{modelValue:T.value,"onUpdate:modelValue":e[0]||(e[0]=o=>T.value=o),placeholder:"Поиск по названию метрики...","prefix-icon":f(Je),size:"large",clearable:""},null,8,["modelValue","prefix-icon"])]),_:1}),Pe((v(),C("div",ul,[E.value?(v(),z($e,{key:0,icon:"error",title:"Ошибка загрузки","sub-title":E.value},{extra:t(()=>[l(c,{type:"primary",onClick:D},{default:t(()=>[l(n,null,{default:t(()=>[l(f(Ke))]),_:1}),e[27]||(e[27]=u(" Повторить ",-1))]),_:1})]),_:1},8,["sub-title"])):(v(),C("div",sl,[i("div",dl,[i("div",rl,[e[28]||(e[28]=i("h3",null,"Категории",-1)),l(c,{type:"primary",size:"small",circle:"",onClick:e[1]||(e[1]=o=>ie())},{default:t(()=>[l(n,null,{default:t(()=>[l(f(ee))]),_:1})]),_:1})]),i("div",cl,[i("div",{class:le(["category-item",{active:p.value===null}]),onClick:e[2]||(e[2]=o=>p.value=null)},[l(n,null,{default:t(()=>[l(f(Qe))]),_:1}),e[29]||(e[29]=i("span",{class:"category-name"},"Все метрики",-1)),l(O,{size:"small",type:"info"},{default:t(()=>[u(_(R.value.length),1)]),_:1})],2),(v(!0),C(ve,null,pe(j.value,o=>(v(),C("div",{key:o.id,class:le(["category-item",{active:p.value===o.id}]),onClick:N=>p.value=o.id},[l(n,null,{default:t(()=>[l(f(Ge))]),_:1}),i("span",vl,_(o.name),1),l(O,{size:"small",type:"info"},{default:t(()=>[u(_(we(o.id)),1)]),_:2},1024),l(c,{size:"small",circle:"",class:"edit-btn",onClick:We(N=>ie(o),["stop"])},{default:t(()=>[l(n,null,{default:t(()=>[l(f(fe))]),_:1})]),_:1},8,["onClick"])],10,ml))),128)),i("div",{class:le(["category-item",{active:p.value==="uncategorized"}]),onClick:e[3]||(e[3]=o=>p.value="uncategorized")},[l(n,null,{default:t(()=>[l(f(Xe))]),_:1}),e[30]||(e[30]=i("span",{class:"category-name"},"Без категории",-1)),l(O,{size:"small",type:"warning"},{default:t(()=>[u(_(ye.value),1)]),_:1})],2)])]),i("div",pl,[i("div",fl,[i("h3",null,_(ge.value),1),l(c,{type:"primary",onClick:e[4]||(e[4]=o=>Y())},{default:t(()=>[l(n,null,{default:t(()=>[l(f(ee))]),_:1}),e[31]||(e[31]=u(" Добавить метрику ",-1))]),_:1})]),oe.value.length>0?(v(),z(Re,{key:0,data:oe.value,stripe:"",style:{width:"100%"},"max-height":"600"},{default:t(()=>[l(P,{label:"Название","min-width":"250"},{default:t(({row:o})=>[i("div",_l,[i("strong",null,_(ne(o)),1),o.description?(v(),C("div",gl,_(o.description),1)):B("",!0)])]),_:1}),l(P,{prop:"code",label:"Код",width:"180"},{default:t(({row:o})=>[l(O,{type:"info"},{default:t(()=>[u(_(o.code),1)]),_:2},1024)]),_:1}),l(P,{label:"Статус",width:"120",align:"center"},{default:t(({row:o})=>[l(ue,{"model-value":o.active,loading:W.has(o.id),onChange:N=>Ce(o,N)},null,8,["model-value","loading","onChange"])]),_:1}),l(P,{label:"Действия",width:"80",align:"center"},{default:t(({row:o})=>[l(Be,{trigger:"click",onCommand:N=>Ve(N,o)},{dropdown:t(()=>[l(Le,null,{default:t(()=>[l(se,{command:"edit"},{default:t(()=>[l(n,null,{default:t(()=>[l(f(fe))]),_:1}),e[32]||(e[32]=u(" Редактировать ",-1))]),_:1}),l(se,{command:"delete",divided:""},{default:t(()=>[l(n,null,{default:t(()=>[l(f(Ze))]),_:1}),e[33]||(e[33]=u(" Удалить ",-1))]),_:1})]),_:1})]),default:t(()=>[l(c,{circle:"",size:"small"},{default:t(()=>[l(n,null,{default:t(()=>[l(f(Ye))]),_:1})]),_:1})]),_:1},8,["onCommand"])]),_:1})]),_:1},8,["data"])):(v(),z(Se,{key:1,description:"Нет метрик"},{default:t(()=>[l(c,{type:"primary",onClick:e[5]||(e[5]=o=>Y())},{default:t(()=>[l(n,null,{default:t(()=>[l(f(ee))]),_:1}),e[34]||(e[34]=u(" Создать метрику ",-1))]),_:1})]),_:1}))])]))])),[[Te,b.value]])]),l(H,{modelValue:S.value,"onUpdate:modelValue":e[15]||(e[15]=o=>S.value=o),title:$.value?"Редактировать метрику":"Создать метрику",width:"600px","close-on-click-modal":!1},{footer:t(()=>[l(c,{onClick:e[14]||(e[14]=o=>S.value=!1)},{default:t(()=>[...e[35]||(e[35]=[u(" Отмена ",-1)])]),_:1}),l(c,{type:"primary",loading:x.value,onClick:be},{default:t(()=>[u(_($.value?"Сохранить":"Создать"),1)]),_:1},8,["loading"])]),default:t(()=>[l(ce,{ref_key:"metricFormRef",ref:te,model:r.value,rules:_e,"label-width":"140px","label-position":"top"},{default:t(()=>[l(w,{label:"Код (уникальный идентификатор)",prop:"code"},{default:t(()=>[l(U,{modelValue:r.value.code,"onUpdate:modelValue":e[6]||(e[6]=o=>r.value.code=o),disabled:!!$.value,placeholder:"communication_skills"},null,8,["modelValue","disabled"])]),_:1}),l(w,{label:"Название (русское)",prop:"name_ru"},{default:t(()=>[l(U,{modelValue:r.value.name_ru,"onUpdate:modelValue":e[7]||(e[7]=o=>r.value.name_ru=o),placeholder:"Коммуникативные навыки"},null,8,["modelValue"])]),_:1}),l(w,{label:"Название (английское)",prop:"name"},{default:t(()=>[l(U,{modelValue:r.value.name,"onUpdate:modelValue":e[8]||(e[8]=o=>r.value.name=o),placeholder:"Communication Skills"},null,8,["modelValue"])]),_:1}),l(w,{label:"Описание"},{default:t(()=>[l(U,{modelValue:r.value.description,"onUpdate:modelValue":e[9]||(e[9]=o=>r.value.description=o),type:"textarea",rows:3,placeholder:"Описание метрики..."},null,8,["modelValue"])]),_:1}),l(he,{gutter:20},{default:t(()=>[l(re,{span:12},{default:t(()=>[l(w,{label:"Мин. значение"},{default:t(()=>[l(de,{modelValue:r.value.min_value,"onUpdate:modelValue":e[10]||(e[10]=o=>r.value.min_value=o),min:0,max:10,step:1,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),l(re,{span:12},{default:t(()=>[l(w,{label:"Макс. значение"},{default:t(()=>[l(de,{modelValue:r.value.max_value,"onUpdate:modelValue":e[11]||(e[11]=o=>r.value.max_value=o),min:1,max:10,step:1,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(w,{label:"Категория"},{default:t(()=>[l(Ie,{modelValue:r.value.category_id,"onUpdate:modelValue":e[12]||(e[12]=o=>r.value.category_id=o),placeholder:"Выберите категорию",clearable:"",style:{width:"100%"}},{default:t(()=>[(v(!0),C(ve,null,pe(j.value,o=>(v(),z(Ae,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(w,{label:"Статус"},{default:t(()=>[l(ue,{modelValue:r.value.active,"onUpdate:modelValue":e[13]||(e[13]=o=>r.value.active=o),"active-text":"Активна","inactive-text":"Неактивна"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(H,{modelValue:F.value,"onUpdate:modelValue":e[19]||(e[19]=o=>F.value=o),title:k.value?"Редактировать категорию":"Создать категорию",width:"500px"},{footer:t(()=>[l(c,{onClick:e[18]||(e[18]=o=>F.value=!1)},{default:t(()=>[...e[36]||(e[36]=[u(" Отмена ",-1)])]),_:1}),k.value?(v(),z(c,{key:0,type:"danger",onClick:Me},{default:t(()=>[...e[37]||(e[37]=[u(" Удалить ",-1)])]),_:1})):B("",!0),l(c,{type:"primary",loading:x.value,onClick:ke},{default:t(()=>[u(_(k.value?"Сохранить":"Создать"),1)]),_:1},8,["loading"])]),default:t(()=>[l(ce,{model:y.value,"label-width":"100px"},{default:t(()=>[l(w,{label:"Название",required:""},{default:t(()=>[l(U,{modelValue:y.value.name,"onUpdate:modelValue":e[16]||(e[16]=o=>y.value.name=o),placeholder:"Soft Skills"},null,8,["modelValue"])]),_:1}),l(w,{label:"Описание"},{default:t(()=>[l(U,{modelValue:y.value.description,"onUpdate:modelValue":e[17]||(e[17]=o=>y.value.description=o),type:"textarea",rows:3,placeholder:"Описание категории..."},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(H,{modelValue:h.value,"onUpdate:modelValue":e[21]||(e[21]=o=>h.value=o),title:"Подтверждение удаления",width:"500px"},{footer:t(()=>[l(c,{onClick:e[20]||(e[20]=o=>h.value=!1)},{default:t(()=>[...e[41]||(e[41]=[u(" Отмена ",-1)])]),_:1}),l(c,{type:"danger",loading:Q.value,onClick:xe},{default:t(()=>[...e[42]||(e[42]=[u(" Удалить ",-1)])]),_:1},8,["loading"])]),default:t(()=>[L.value?(v(),C("div",yl,[i("p",null,[e[38]||(e[38]=u("Вы уверены, что хотите удалить метрику ",-1)),i("strong",null,_(ne(L.value)),1),e[39]||(e[39]=u("?",-1))]),g.value&&(g.value.weight_tables_count>0||g.value.extracted_metrics_count>0)?(v(),z(Ne,{key:0,type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"16px"}},{title:t(()=>[...e[40]||(e[40]=[u(" Эта метрика используется ",-1)])]),default:t(()=>[i("ul",wl,[g.value.weight_tables_count>0?(v(),C("li",bl," В "+_(g.value.weight_tables_count)+" весовых таблицах ",1)):B("",!0),g.value.extracted_metrics_count>0?(v(),C("li",Cl," В "+_(g.value.extracted_metrics_count)+" извлеченных метриках ",1)):B("",!0)])]),_:1})):B("",!0)])):B("",!0)]),_:1},8,["modelValue"]),l(H,{modelValue:A.value,"onUpdate:modelValue":e[23]||(e[23]=o=>A.value=o),title:"Импорт метрик",width:"600px"},{footer:t(()=>[l(c,{onClick:e[22]||(e[22]=o=>A.value=!1)},{default:t(()=>[...e[45]||(e[45]=[u(" Отмена ",-1)])]),_:1}),l(c,{type:"primary",loading:G.value,disabled:!I.value,onClick:Fe},{default:t(()=>[...e[46]||(e[46]=[u(" Импортировать ",-1)])]),_:1},8,["loading","disabled"])]),default:t(()=>[l(Ee,{ref_key:"uploadRef",ref:X,drag:"","auto-upload":!1,limit:1,accept:".xlsx,.json","on-change":ze},{tip:t(()=>[...e[43]||(e[43]=[i("div",{class:"el-upload__tip"}," Поддерживаются форматы: xlsx, json ",-1)])]),default:t(()=>[l(n,{class:"el-icon--upload"},{default:t(()=>[l(f(me))]),_:1}),e[44]||(e[44]=i("div",{class:"el-upload__text"},[u(" Перетащите файл сюда или "),i("em",null,"нажмите для выбора")],-1))]),_:1},512)]),_:1},8,["modelValue"])]),_:1})}}},Ul=al(Vl,[["__scopeId","data-v-9aabcee7"]]);export{Ul as default};
