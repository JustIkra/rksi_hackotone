import{O as P,m as n,Q as ue,H as ie,v as d,w as a,E as g,r as u,I as ce,o as s,a as o,f as l,x as i,c as k,u as M,az as de,e as c,aA as pe,B as v,J as _e,F as ve,C as fe,aB as me,aC as ge,a4 as ye,N as ke}from"./index-z4An-3zU.js";import{A as he}from"./AppLayout-Da398sgp.js";import{_ as be}from"./_plugin-vue_export-helper-DlAUqK2U.js";async function we(p){const _=new FormData;return _.append("file",p),(await P.post("/admin/metrics/generate",_,{headers:{"Content-Type":"multipart/form-data"}})).data}async function Ce(p){return(await P.get(`/admin/metrics/generate/${p}/status`)).data}async function L(p={}){return(await P.get("/admin/metrics/pending",{params:p})).data}async function xe(p){return(await P.post(`/admin/metrics/${p}/approve`)).data}async function Fe(p,_=null){const f=_?{action:"reject",reason:_}:{action:"reject"};return(await P.post(`/admin/metrics/${p}/reject`,f)).data}const Me={class:"metric-generate-view"},Pe={key:0,class:"upload-actions"},Ie={class:"progress-content"},ze={class:"progress-step"},Be={key:0,class:"progress-stats"},$e={class:"card-header"},De={class:"metric-name"},je={key:0,class:"metric-description"},Ae={key:0,class:"rationale"},Ve={key:0,class:"quotes"},Ge={key:0,class:"load-more"},Ne={__name:"AdminMetricGenerateView",setup(p){const _=n(null),f=n(null),I=n(null),z=n(null),E=n(0),R=n(""),A=n(null),q=n(null),V=n(null),B=n(null),$=n(null),y=n(!1);let C=null;const m=n([]),D=n(0),G=n(0),h=n(!1),b=n(null),H=ue(()=>z.value==="completed"?"success":z.value==="failed"?"exception":"");function J(e){f.value=e.raw}function Q(){f.value=null}async function X(){if(f.value)try{y.value=!0,B.value=null,$.value=null;const e=await we(f.value);I.value=e.task_id,g.success("Обработка запущена"),K()}catch(e){console.error("Failed to start generation:",e),g.error(e.response?.data?.detail||"Ошибка запуска генерации"),y.value=!1}}function K(){C&&clearInterval(C),C=setInterval(async()=>{try{const e=await Ce(I.value);z.value=e.status,E.value=e.progress||0,R.value=e.current_step,A.value=e.total_pages,q.value=e.processed_pages,V.value=e.metrics_found,e.status==="completed"?($.value=e.result,y.value=!1,clearInterval(C),g.success("Генерация завершена!"),N()):e.status==="failed"&&(B.value=e.error||"Неизвестная ошибка",y.value=!1,clearInterval(C),g.error("Генерация не удалась"))}catch(e){console.error("Polling error:",e)}},2e3)}async function N(){try{h.value=!0,G.value=0;const e=await L({limit:20,offset:0});m.value=e.items,D.value=e.total}catch(e){console.error("Failed to load pending metrics:",e),g.error("Ошибка загрузки метрик")}finally{h.value=!1}}async function U(){try{h.value=!0,G.value+=20;const e=await L({limit:20,offset:G.value});m.value.push(...e.items)}catch(e){console.error("Failed to load more:",e)}finally{h.value=!1}}async function W(e){try{b.value=e.id,await xe(e.id),g.success(`Метрика "${e.name}" одобрена`),m.value=m.value.filter(t=>t.id!==e.id),D.value--}catch(t){console.error("Failed to approve:",t),g.error(t.response?.data?.detail||"Ошибка одобрения")}finally{b.value=null}}async function Y(e){try{const{value:t}=await ke.prompt("Укажите причину отклонения (опционально)","Отклонение метрики",{confirmButtonText:"Отклонить",cancelButtonText:"Отмена",inputPlaceholder:"Причина..."});b.value=e.id,await Fe(e.id,t||null),g.warning(`Метрика "${e.name}" отклонена`),m.value=m.value.filter(w=>w.id!==e.id),D.value--}catch(t){if(t==="cancel")return;console.error("Failed to reject:",t),g.error(t.response?.data?.detail||"Ошибка отклонения")}finally{b.value=null}}return ie(()=>{N()}),(e,t)=>{const w=u("el-card"),x=u("el-icon"),Z=u("el-upload"),F=u("el-button"),ee=u("el-progress"),j=u("el-tag"),te=u("el-alert"),ae=u("el-result"),S=u("el-table-column"),O=u("el-text"),le=u("el-button-group"),se=u("el-table"),ne=u("el-empty"),oe=ce("loading");return s(),d(he,null,{default:a(()=>[o("div",Me,[l(w,{class:"header-card"},{default:a(()=>[...t[0]||(t[0]=[o("div",{class:"header-content"},[o("div",null,[o("h1",null,"AI Генерация метрик"),o("p",null,"Автоматическое извлечение метрик из PDF-документов с помощью ИИ")])],-1)])]),_:1}),l(w,{class:"upload-card"},{default:a(()=>[t[3]||(t[3]=o("h3",null,"Загрузка документа",-1)),l(Z,{ref_key:"uploadRef",ref:_,class:"upload-area",drag:"","auto-upload":!1,limit:1,"on-change":J,"on-remove":Q,accept:".pdf,.docx"},{tip:a(()=>[...t[1]||(t[1]=[o("div",{class:"el-upload__tip"}," Поддерживаемые форматы: PDF (рекомендуется), DOCX ",-1)])]),default:a(()=>[l(x,{class:"el-icon--upload"},{default:a(()=>[l(M(de))]),_:1}),t[2]||(t[2]=o("div",{class:"el-upload__text"},[c(" Перетащите файл сюда или "),o("em",null,"нажмите для выбора")],-1))]),_:1},512),f.value?(s(),k("div",Pe,[l(F,{type:"primary",size:"large",loading:y.value,disabled:!f.value||y.value,onClick:X},{default:a(()=>[y.value?i("",!0):(s(),d(x,{key:0},{default:a(()=>[l(M(pe))]),_:1})),c(" "+v(y.value?"Обработка...":"Запустить генерацию"),1)]),_:1},8,["loading","disabled"])])):i("",!0)]),_:1}),I.value?(s(),d(w,{key:0,class:"progress-card"},{default:a(()=>[t[4]||(t[4]=o("h3",null,"Прогресс обработки",-1)),o("div",Ie,[l(ee,{percentage:E.value,status:H.value,"stroke-width":20,striped:"","striped-flow":""},null,8,["percentage","status"]),o("p",ze,v(R.value||"Ожидание..."),1),A.value?(s(),k("div",Be,[l(j,null,{default:a(()=>[c("Страниц: "+v(q.value||0)+"/"+v(A.value),1)]),_:1}),V.value?(s(),d(j,{key:0,type:"success"},{default:a(()=>[c(" Найдено метрик: "+v(V.value),1)]),_:1})):i("",!0)])):i("",!0),B.value?(s(),d(te,{key:1,title:B.value,type:"error","show-icon":"",closable:!1},null,8,["title"])):i("",!0),z.value==="completed"?(s(),d(ae,{key:2,icon:"success",title:"Генерация завершена","sub-title":`Создано: ${$.value?.metrics_created||0}, Сопоставлено: ${$.value?.metrics_matched||0}`},null,8,["sub-title"])):i("",!0)])]),_:1})):i("",!0),l(w,{class:"pending-card"},{header:a(()=>[o("div",$e,[t[6]||(t[6]=o("h3",null,"Метрики на модерации",-1)),l(F,{size:"small",loading:h.value,onClick:N},{default:a(()=>[l(x,null,{default:a(()=>[l(M(ye))]),_:1}),t[5]||(t[5]=c(" Обновить ",-1))]),_:1},8,["loading"])])]),default:a(()=>[_e((s(),d(se,{data:m.value,stripe:"",style:{width:"100%"}},{default:a(()=>[l(S,{label:"Название",prop:"name","min-width":"200"},{default:a(({row:r})=>[o("div",De,[o("strong",null,v(r.name),1),r.category_name?(s(),d(j,{key:0,size:"small",type:"info"},{default:a(()=>[c(v(r.category_name),1)]),_:2},1024)):i("",!0)]),r.description?(s(),k("p",je,v(r.description),1)):i("",!0)]),_:1}),l(S,{label:"Обоснование","min-width":"250"},{default:a(({row:r})=>[r.ai_rationale?(s(),k("div",Ae,[r.ai_rationale.quotes?.length?(s(),k("div",Ve,[l(O,{type:"info",size:"small"},{default:a(()=>[...t[7]||(t[7]=[c(" Цитаты: ",-1)])]),_:1}),o("ul",null,[(s(!0),k(ve,null,fe(r.ai_rationale.quotes.slice(0,2),(T,re)=>(s(),k("li",{key:re},' "'+v(T)+'" ',1))),128))])])):i("",!0),r.ai_rationale.page_numbers?.length?(s(),d(j,{key:1,size:"small",type:"info"},{default:a(()=>[c(" Стр. "+v(r.ai_rationale.page_numbers.join(", ")),1)]),_:2},1024)):i("",!0)])):(s(),d(O,{key:1,type:"info",size:"small"},{default:a(()=>[...t[8]||(t[8]=[c(" Нет данных ",-1)])]),_:1}))]),_:1}),l(S,{label:"Действия",width:"200",fixed:"right"},{default:a(({row:r})=>[l(le,null,{default:a(()=>[l(F,{type:"success",size:"small",loading:b.value===r.id,onClick:T=>W(r)},{default:a(()=>[l(x,null,{default:a(()=>[l(M(me))]),_:1}),t[9]||(t[9]=c(" Одобрить ",-1))]),_:1},8,["loading","onClick"]),l(F,{type:"danger",size:"small",loading:b.value===r.id,onClick:T=>Y(r)},{default:a(()=>[l(x,null,{default:a(()=>[l(M(ge))]),_:1}),t[10]||(t[10]=c(" Отклонить ",-1))]),_:1},8,["loading","onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[oe,h.value]]),D.value>m.value.length?(s(),k("div",Ge,[l(F,{onClick:U},{default:a(()=>[...t[11]||(t[11]=[c(" Загрузить ещё ",-1)])]),_:1})])):i("",!0),!h.value&&m.value.length===0?(s(),d(ne,{key:1,description:"Нет метрик на модерации"})):i("",!0)]),_:1})])]),_:1})}}},Re=be(Ne,[["__scopeId","data-v-990d01b6"]]);export{Re as default};
