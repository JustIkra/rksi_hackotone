import{A as L}from"./AppLayout-CdFMFOll.js";import{P as R,m as b,D as g,l as P,Q as H,H as J,E as f,v,w as n,r as h,I as Q,o as m,a as w,d,J as $,B as y,u,f as p,c as N,x as T,N as j}from"./index-pq0ppcP1.js";import{a as k}from"./admin-Dmv1pyJZ.js";import{g as M,a as V,b as q,c as F}from"./labels-BVQZd3gV.js";import{_ as G}from"./_plugin-vue_export-helper-DlAUqK2U.js";const K=R("admin",()=>{const _=b([]),l=b([]),c=b(!1),o=b(null);async function z(){c.value=!0,o.value=null;try{const t=await k.getPendingUsers();return _.value=t,t}catch(t){const a=g(t,"Ошибка загрузки пользователей");throw o.value=a.message,t.normalizedError=a,t}finally{c.value=!1}}async function E(){c.value=!0,o.value=null;try{const t=await k.getAllUsers();return l.value=t,t}catch(t){const a=g(t,"Ошибка загрузки списка пользователей");throw o.value=a.message,t.normalizedError=a,t}finally{c.value=!1}}async function C(t){c.value=!0,o.value=null;try{const a=await k.approveUser(t);return _.value=_.value.filter(e=>e.id!==t),l.value=l.value.map(e=>e.id===t?a:e),a}catch(a){const e=g(a,"Ошибка одобрения пользователя");throw o.value=e.message,a.normalizedError=e,a}finally{c.value=!1}}async function D(t){c.value=!0,o.value=null;try{const a=await k.makeAdmin(t);return l.value=l.value.map(e=>e.id===t?a:e),a}catch(a){const e=g(a,"Ошибка назначения прав администратора");throw o.value=e.message,a.normalizedError=e,a}finally{c.value=!1}}async function i(t){c.value=!0,o.value=null;try{const a=await k.deleteUser(t);return l.value=l.value.filter(e=>e.id!==t),_.value=_.value.filter(e=>e.id!==t),a}catch(a){const e=g(a,"Ошибка удаления пользователя");throw o.value=e.message,a.normalizedError=e,a}finally{c.value=!1}}async function s(t){c.value=!0,o.value=null;try{const a=await k.revokeAdmin(t);return l.value=l.value.map(e=>e.id===t?a:e),a}catch(a){const e=g(a,"Ошибка снятия прав администратора");throw o.value=e.message,a.normalizedError=e,a}finally{c.value=!1}}return{pendingUsers:_,users:l,loading:c,error:o,fetchPendingUsers:z,fetchAllUsers:E,approveUser:C,makeAdmin:D,revokeAdmin:s,deleteUser:i}}),O={class:"admin-users-view"},W={class:"actions-column"},X={key:0,class:"actions-column"},Y={key:1,class:"actions-column"},Z={__name:"AdminUsersView",setup(_){const l=K(),c=P(),o=H(()=>l.users),z=async i=>{try{await l.approveUser(i.id),f.success(`Пользователь ${i.email} одобрен`)}catch{f.error(l.error||"Ошибка одобрения пользователя")}},E=async i=>{try{await l.makeAdmin(i.id),f.success(`Пользователь ${i.email} назначен администратором`)}catch{f.error(l.error||"Ошибка назначения прав администратора")}},C=async i=>{try{await l.revokeAdmin(i.id),f.success(`Права администратора сняты с ${i.email}`)}catch{f.error(l.error||"Ошибка снятия прав администратора")}},D=async i=>{if(i.id===c.user?.id){f.error("Нельзя удалить собственную учётную запись администратора");return}try{await j.confirm(`Вы уверены, что хотите удалить пользователя ${i.email}?`,"Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning",confirmButtonClass:"el-button--danger"}),await l.deleteUser(i.id),f.success(`Пользователь ${i.email} удалён`)}catch(s){if(s==="cancel")return;f.error(l.error||"Ошибка удаления пользователя")}};return J(async()=>{try{await l.fetchPendingUsers(),await l.fetchAllUsers()}catch{f.error(l.error||"Ошибка загрузки пользователей")}}),(i,s)=>{const t=h("el-card"),a=h("el-empty"),e=h("el-table-column"),A=h("el-tag"),U=h("el-button"),x=h("el-table"),B=Q("loading");return m(),v(L,null,{default:n(()=>[w("div",O,[d(t,{class:"header-card"},{default:n(()=>[...s[0]||(s[0]=[w("h1",null,"Управление пользователями",-1),w("p",null,"Одобрение новых пользователей, назначение админов и удаление учётных записей",-1)])]),_:1}),$((m(),v(t,{class:"users-card"},{default:n(()=>[w("h3",null,"Ожидают одобрения ("+y(u(l).pendingUsers.length)+")",1),u(l).pendingUsers.length===0?(m(),v(a,{key:0,description:"Нет пользователей, ожидающих одобрения"})):(m(),v(x,{key:1,data:u(l).pendingUsers,stripe:""},{default:n(()=>[d(e,{prop:"email",label:"Email","min-width":"250"}),d(e,{label:"Статус",width:"140"},{default:n(({row:r})=>[d(A,{type:u(M)(r.status)},{default:n(()=>[p(y(u(V)(r.status)),1)]),_:2},1032,["type"])]),_:1}),d(e,{prop:"created_at",label:"Дата регистрации",width:"180"},{default:n(({row:r})=>[p(y(new Date(r.created_at).toLocaleDateString("ru-RU")),1)]),_:1}),d(e,{label:"Действия",width:"160",align:"center"},{default:n(({row:r})=>[w("div",W,[d(U,{type:"success",onClick:S=>z(r)},{default:n(()=>[...s[1]||(s[1]=[p(" Одобрить ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"]))]),_:1})),[[B,u(l).loading]]),$((m(),v(t,{class:"users-card"},{default:n(()=>[w("h3",null,"Все пользователи ("+y(o.value.length)+")",1),o.value.length===0?(m(),v(a,{key:0,description:"Пользователи не найдены"})):(m(),v(x,{key:1,data:o.value,stripe:""},{default:n(()=>[d(e,{prop:"email",label:"Email","min-width":"250"}),d(e,{label:"Роль",width:"150"},{default:n(({row:r})=>[d(A,{type:u(q)(r.role)},{default:n(()=>[p(y(u(F)(r.role)),1)]),_:2},1032,["type"])]),_:1}),d(e,{label:"Статус",width:"140"},{default:n(({row:r})=>[d(A,{type:u(M)(r.status)},{default:n(()=>[p(y(u(V)(r.status)),1)]),_:2},1032,["type"])]),_:1}),d(e,{prop:"created_at",label:"Дата регистрации",width:"180"},{default:n(({row:r})=>[p(y(new Date(r.created_at).toLocaleDateString("ru-RU")),1)]),_:1}),d(e,{label:"Действия",width:"160",align:"center"},{default:n(({row:r})=>[r.id===u(c).user?.id?(m(),N("div",X,[d(A,{type:"info"},{default:n(()=>[...s[2]||(s[2]=[p(" Это вы ",-1)])]),_:1})])):(m(),N("div",Y,[r.role!=="ADMIN"?(m(),v(U,{key:0,type:"warning",onClick:S=>E(r)},{default:n(()=>[...s[3]||(s[3]=[p(" В админы ",-1)])]),_:1},8,["onClick"])):T("",!0),r.role==="ADMIN"?(m(),v(U,{key:1,type:"info",onClick:S=>C(r)},{default:n(()=>[...s[4]||(s[4]=[p(" Снять админа ",-1)])]),_:1},8,["onClick"])):T("",!0),d(U,{type:"danger",onClick:S=>D(r)},{default:n(()=>[...s[5]||(s[5]=[p(" Удалить ",-1)])]),_:1},8,["onClick"])]))]),_:1})]),_:1},8,["data"]))]),_:1})),[[B,u(l).loading]])])]),_:1})}}},re=G(Z,[["__scopeId","data-v-14f9f3f9"]]);export{re as default};
