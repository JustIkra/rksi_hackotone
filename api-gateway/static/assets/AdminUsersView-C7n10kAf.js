import{A as R}from"./AppLayout-BzfT33nq.js";import{P as T,m as U,D as _,l as P,Q as G,H,E as d,v as f,w as r,r as b,I,o as i,a as c,J as x,c as z,B as g,u as p,f as u,e as h,z as $,x as V,N as J}from"./index-CvR0dbKI.js";import{a as y}from"./admin-DGRgzat1.js";import{g as L,a as K}from"./labels-z_zmtJvN.js";import{_ as O}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Q=T("admin",()=>{const v=U([]),o=U([]),n=U(!1),t=U(null);async function k(){n.value=!0,t.value=null;try{const a=await y.getPendingUsers();return v.value=a,a}catch(a){const e=_(a,"Ошибка загрузки пользователей");throw t.value=e.message,a.normalizedError=e,a}finally{n.value=!1}}async function w(){n.value=!0,t.value=null;try{const a=await y.getAllUsers();return o.value=a,a}catch(a){const e=_(a,"Ошибка загрузки списка пользователей");throw t.value=e.message,a.normalizedError=e,a}finally{n.value=!1}}async function C(a){n.value=!0,t.value=null;try{const e=await y.approveUser(a);return v.value=v.value.filter(s=>s.id!==a),o.value=o.value.map(s=>s.id===a?e:s),e}catch(e){const s=_(e,"Ошибка одобрения пользователя");throw t.value=s.message,e.normalizedError=s,e}finally{n.value=!1}}async function E(a){n.value=!0,t.value=null;try{const e=await y.makeAdmin(a);return o.value=o.value.map(s=>s.id===a?e:s),e}catch(e){const s=_(e,"Ошибка назначения прав администратора");throw t.value=s.message,e.normalizedError=s,e}finally{n.value=!1}}async function D(a){n.value=!0,t.value=null;try{const e=await y.deleteUser(a);return o.value=o.value.filter(s=>s.id!==a),v.value=v.value.filter(s=>s.id!==a),e}catch(e){const s=_(e,"Ошибка удаления пользователя");throw t.value=s.message,e.normalizedError=s,e}finally{n.value=!1}}async function M(a){n.value=!0,t.value=null;try{const e=await y.revokeAdmin(a);return o.value=o.value.map(s=>s.id===a?e:s),e}catch(e){const s=_(e,"Ошибка снятия прав администратора");throw t.value=s.message,e.normalizedError=s,e}finally{n.value=!1}}return{pendingUsers:v,users:o,loading:n,error:t,fetchPendingUsers:k,fetchAllUsers:w,approveUser:C,makeAdmin:E,revokeAdmin:M,deleteUser:D}}),j={class:"admin-users-view"},q={class:"card section-card"},F={class:"section-title"},W={class:"status-tag status-tag--pending"},X={class:"actions-column"},Y={class:"card section-card"},Z={class:"section-title"},ee={key:0,class:"actions-column"},ae={key:1,class:"actions-column"},te={__name:"AdminUsersView",setup(v){const o=a=>({ADMIN:"status-tag--primary",USER:"status-tag--info"})[a]||"status-tag--info",n=a=>({ACTIVE:"status-tag--success",PENDING:"status-tag--pending",BLOCKED:"status-tag--danger"})[a]||"status-tag--info",t=Q(),k=P(),w=G(()=>t.users),C=async a=>{try{await t.approveUser(a.id),d.success(`Пользователь ${a.email} одобрен`)}catch{d.error(t.error||"Ошибка одобрения пользователя")}},E=async a=>{try{await t.makeAdmin(a.id),d.success(`Пользователь ${a.email} назначен администратором`)}catch{d.error(t.error||"Ошибка назначения прав администратора")}},D=async a=>{try{await t.revokeAdmin(a.id),d.success(`Права администратора сняты с ${a.email}`)}catch{d.error(t.error||"Ошибка снятия прав администратора")}},M=async a=>{if(a.id===k.user?.id){d.error("Нельзя удалить собственную учётную запись администратора");return}try{await J.confirm(`Вы уверены, что хотите удалить пользователя ${a.email}?`,"Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning",confirmButtonClass:"el-button--danger"}),await t.deleteUser(a.id),d.success(`Пользователь ${a.email} удалён`)}catch(e){if(e==="cancel")return;d.error(t.error||"Ошибка удаления пользователя")}};return H(async()=>{try{await t.fetchPendingUsers(),await t.fetchAllUsers()}catch{d.error(t.error||"Ошибка загрузки пользователей")}}),(a,e)=>{const s=b("el-empty"),m=b("el-table-column"),A=b("el-button"),B=b("el-table"),N=I("loading");return i(),f(R,null,{default:r(()=>[c("div",j,[e[5]||(e[5]=c("header",{class:"page-header"},[c("h1",{class:"page-title"}," Управление пользователями "),c("p",{class:"page-subtitle"}," Одобрение новых пользователей, назначение админов и удаление учётных записей ")],-1)),x((i(),z("section",q,[c("h3",F," Ожидают одобрения ("+g(p(t).pendingUsers.length)+") ",1),p(t).pendingUsers.length===0?(i(),f(s,{key:0,description:"Нет пользователей, ожидающих одобрения"})):(i(),f(B,{key:1,data:p(t).pendingUsers,class:"users-table"},{default:r(()=>[u(m,{prop:"email",label:"Email","min-width":"250"}),u(m,{label:"Статус",width:"140"},{default:r(({row:l})=>[c("span",W,g(p(L)(l.status)),1)]),_:1}),u(m,{prop:"created_at",label:"Дата регистрации",width:"180"},{default:r(({row:l})=>[h(g(new Date(l.created_at).toLocaleDateString("ru-RU")),1)]),_:1}),u(m,{label:"Действия",width:"160",align:"center"},{default:r(({row:l})=>[c("div",X,[u(A,{type:"success",size:"small",onClick:S=>C(l)},{default:r(()=>[...e[0]||(e[0]=[h(" Одобрить ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"]))])),[[N,p(t).loading]]),x((i(),z("section",Y,[c("h3",Z," Все пользователи ("+g(w.value.length)+") ",1),w.value.length===0?(i(),f(s,{key:0,description:"Пользователи не найдены"})):(i(),f(B,{key:1,data:w.value,class:"users-table"},{default:r(()=>[u(m,{prop:"email",label:"Email","min-width":"250"}),u(m,{label:"Роль",width:"150"},{default:r(({row:l})=>[c("span",{class:$(["status-tag",o(l.role)])},g(p(K)(l.role)),3)]),_:1}),u(m,{label:"Статус",width:"140"},{default:r(({row:l})=>[c("span",{class:$(["status-tag",n(l.status)])},g(p(L)(l.status)),3)]),_:1}),u(m,{prop:"created_at",label:"Дата регистрации",width:"180"},{default:r(({row:l})=>[h(g(new Date(l.created_at).toLocaleDateString("ru-RU")),1)]),_:1}),u(m,{label:"Действия",width:"200",align:"center"},{default:r(({row:l})=>[l.id===p(k).user?.id?(i(),z("div",ee,[...e[1]||(e[1]=[c("span",{class:"status-tag status-tag--info"}," Это вы ",-1)])])):(i(),z("div",ae,[l.role!=="ADMIN"?(i(),f(A,{key:0,type:"warning",size:"small",onClick:S=>E(l)},{default:r(()=>[...e[2]||(e[2]=[h(" В админы ",-1)])]),_:1},8,["onClick"])):V("",!0),l.role==="ADMIN"?(i(),f(A,{key:1,size:"small",onClick:S=>D(l)},{default:r(()=>[...e[3]||(e[3]=[h(" Снять админа ",-1)])]),_:1},8,["onClick"])):V("",!0),u(A,{type:"danger",size:"small",onClick:S=>M(l)},{default:r(()=>[...e[4]||(e[4]=[h(" Удалить ",-1)])]),_:1},8,["onClick"])]))]),_:1})]),_:1},8,["data"]))])),[[N,p(t).loading]])])]),_:1})}}},ie=O(te,[["__scopeId","data-v-3c4e7d31"]]);export{ie as default};
