import{A as V}from"./AppLayout-BUkm5VzU.js";import{N as g,a2 as L,m as z,D as h,l as R,O as P,H,E as p,v as y,w as r,r as w,I as J,o as m,a as k,d as u,J as M,B as _,u as v,f,c as N,x as T,M as O}from"./index-B06ugpJL.js";import{g as j,a as q,b as F,c as G}from"./labels-BU7QeQ3P.js";import{_ as K}from"./_plugin-vue_export-helper-DlAUqK2U.js";const A={async getPendingUsers(){return(await g.get("/admin/pending-users")).data},async getAllUsers(){return(await g.get("/admin/users")).data},async approveUser(o){return(await g.post(`/admin/approve/${o}`)).data},async makeAdmin(o){return(await g.post(`/admin/make-admin/${o}`)).data},async deleteUser(o){return(await g.delete(`/admin/users/${o}`)).data},async revokeAdmin(o){return(await g.post(`/admin/revoke-admin/${o}`)).data}},Q=L("admin",()=>{const o=z([]),t=z([]),d=z(!1),i=z(null);async function C(){d.value=!0,i.value=null;try{const n=await A.getPendingUsers();return o.value=n,n}catch(n){const a=h(n,"Ошибка загрузки пользователей");throw i.value=a.message,n.normalizedError=a,n}finally{d.value=!1}}async function E(){d.value=!0,i.value=null;try{const n=await A.getAllUsers();return t.value=n,n}catch(n){const a=h(n,"Ошибка загрузки списка пользователей");throw i.value=a.message,n.normalizedError=a,n}finally{d.value=!1}}async function $(n){d.value=!0,i.value=null;try{const a=await A.approveUser(n);return o.value=o.value.filter(e=>e.id!==n),t.value=t.value.map(e=>e.id===n?a:e),a}catch(a){const e=h(a,"Ошибка одобрения пользователя");throw i.value=e.message,a.normalizedError=e,a}finally{d.value=!1}}async function D(n){d.value=!0,i.value=null;try{const a=await A.makeAdmin(n);return t.value=t.value.map(e=>e.id===n?a:e),a}catch(a){const e=h(a,"Ошибка назначения прав администратора");throw i.value=e.message,a.normalizedError=e,a}finally{d.value=!1}}async function c(n){d.value=!0,i.value=null;try{const a=await A.deleteUser(n);return t.value=t.value.filter(e=>e.id!==n),o.value=o.value.filter(e=>e.id!==n),a}catch(a){const e=h(a,"Ошибка удаления пользователя");throw i.value=e.message,a.normalizedError=e,a}finally{d.value=!1}}async function l(n){d.value=!0,i.value=null;try{const a=await A.revokeAdmin(n);return t.value=t.value.map(e=>e.id===n?a:e),a}catch(a){const e=h(a,"Ошибка снятия прав администратора");throw i.value=e.message,a.normalizedError=e,a}finally{d.value=!1}}return{pendingUsers:o,users:t,loading:d,error:i,fetchPendingUsers:C,fetchAllUsers:E,approveUser:$,makeAdmin:D,revokeAdmin:l,deleteUser:c}}),W={class:"admin-users-view"},X={class:"actions-group"},Y={key:0,class:"actions-column"},Z={key:1,class:"actions-column"},I={__name:"AdminUsersView",setup(o){const t=Q(),d=R(),i=P(()=>t.users),C=async c=>{try{await t.approveUser(c.id),p.success(`Пользователь ${c.email} одобрен`)}catch{p.error(t.error||"Ошибка одобрения пользователя")}},E=async c=>{try{await t.makeAdmin(c.id),p.success(`Пользователь ${c.email} назначен администратором`)}catch{p.error(t.error||"Ошибка назначения прав администратора")}},$=async c=>{try{await t.revokeAdmin(c.id),p.success(`Права администратора сняты с ${c.email}`)}catch{p.error(t.error||"Ошибка снятия прав администратора")}},D=async c=>{if(c.id===d.user?.id){p.error("Нельзя удалить собственную учётную запись администратора");return}try{await O.confirm(`Вы уверены, что хотите удалить пользователя ${c.email}?`,"Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning",confirmButtonClass:"el-button--danger"}),await t.deleteUser(c.id),p.success(`Пользователь ${c.email} удалён`)}catch(l){if(l==="cancel")return;p.error(t.error||"Ошибка удаления пользователя")}};return H(async()=>{try{await t.fetchPendingUsers(),await t.fetchAllUsers()}catch{p.error(t.error||"Ошибка загрузки пользователей")}}),(c,l)=>{const n=w("el-card"),a=w("el-empty"),e=w("el-table-column"),U=w("el-tag"),b=w("el-button"),S=w("el-table"),B=J("loading");return m(),y(V,null,{default:r(()=>[k("div",W,[u(n,{class:"header-card"},{default:r(()=>[...l[0]||(l[0]=[k("h1",null,"Управление пользователями",-1),k("p",null,"Одобрение новых пользователей, назначение админов и удаление учётных записей",-1)])]),_:1}),M((m(),y(n,{class:"users-card"},{default:r(()=>[k("h3",null,"Ожидают одобрения ("+_(v(t).pendingUsers.length)+")",1),v(t).pendingUsers.length===0?(m(),y(a,{key:0,description:"Нет пользователей, ожидающих одобрения"})):(m(),y(S,{key:1,data:v(t).pendingUsers,stripe:""},{default:r(()=>[u(e,{prop:"email",label:"Email","min-width":"250"}),u(e,{label:"Статус",width:"120"},{default:r(({row:s})=>[u(U,{type:"warning"},{default:r(()=>[f(_(s.status),1)]),_:2},1024)]),_:1}),u(e,{prop:"created_at",label:"Дата регистрации",width:"180"},{default:r(({row:s})=>[f(_(new Date(s.created_at).toLocaleDateString("ru-RU")),1)]),_:1}),u(e,{label:"Действия",width:"150",fixed:"right"},{default:r(({row:s})=>[k("div",X,[u(b,{type:"success",size:"small",onClick:x=>C(s)},{default:r(()=>[...l[1]||(l[1]=[f(" Одобрить ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"]))]),_:1})),[[B,v(t).loading]]),M((m(),y(n,{class:"users-card"},{default:r(()=>[k("h3",null,"Все пользователи ("+_(i.value.length)+")",1),i.value.length===0?(m(),y(a,{key:0,description:"Пользователи не найдены"})):(m(),y(S,{key:1,data:i.value,stripe:""},{default:r(()=>[u(e,{prop:"email",label:"Email","min-width":"250"}),u(e,{label:"Роль",width:"150"},{default:r(({row:s})=>[u(U,{type:v(j)(s.role)},{default:r(()=>[f(_(v(q)(s.role)),1)]),_:2},1032,["type"])]),_:1}),u(e,{label:"Статус",width:"140"},{default:r(({row:s})=>[u(U,{type:v(F)(s.status)},{default:r(()=>[f(_(v(G)(s.status)),1)]),_:2},1032,["type"])]),_:1}),u(e,{prop:"created_at",label:"Дата регистрации",width:"180"},{default:r(({row:s})=>[f(_(new Date(s.created_at).toLocaleDateString("ru-RU")),1)]),_:1}),u(e,{label:"Действия",width:"160",align:"center"},{default:r(({row:s})=>[s.id===v(d).user?.id?(m(),N("div",Y,[u(U,{type:"info"},{default:r(()=>[...l[2]||(l[2]=[f(" Это вы ",-1)])]),_:1})])):(m(),N("div",Z,[s.role!=="ADMIN"?(m(),y(b,{key:0,type:"warning",onClick:x=>E(s)},{default:r(()=>[...l[3]||(l[3]=[f(" В админы ",-1)])]),_:1},8,["onClick"])):T("",!0),s.role==="ADMIN"?(m(),y(b,{key:1,type:"info",onClick:x=>$(s)},{default:r(()=>[...l[4]||(l[4]=[f(" Снять админа ",-1)])]),_:1},8,["onClick"])):T("",!0),u(b,{type:"danger",onClick:x=>D(s)},{default:r(()=>[...l[5]||(l[5]=[f(" Удалить ",-1)])]),_:1},8,["onClick"])]))]),_:1})]),_:1},8,["data"]))]),_:1})),[[B,v(t).loading]])])]),_:1})}}},re=K(I,[["__scopeId","data-v-c5c4e454"]]);export{re as default};
