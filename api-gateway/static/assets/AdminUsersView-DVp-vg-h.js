import{A as P}from"./AppLayout-CNbYGbQ6.js";import{O as g,a7 as R,m as z,D as h,l as H,P as J,H as O,E as v,v as y,w as s,r as w,I as j,o as p,a as k,d as u,J as N,B as _,u as m,f,c as T,x as M,N as q}from"./index-bPtqW5CV.js";import{g as V,a as L,b as F,c as G}from"./labels-BVQZd3gV.js";import{_ as K}from"./_plugin-vue_export-helper-DlAUqK2U.js";const A={async getPendingUsers(){return(await g.get("/admin/pending-users")).data},async getAllUsers(){return(await g.get("/admin/users")).data},async approveUser(o){return(await g.post(`/admin/approve/${o}`)).data},async makeAdmin(o){return(await g.post(`/admin/make-admin/${o}`)).data},async deleteUser(o){return(await g.delete(`/admin/users/${o}`)).data},async revokeAdmin(o){return(await g.post(`/admin/revoke-admin/${o}`)).data}},Q=R("admin",()=>{const o=z([]),t=z([]),d=z(!1),i=z(null);async function C(){d.value=!0,i.value=null;try{const n=await A.getPendingUsers();return o.value=n,n}catch(n){const a=h(n,"Ошибка загрузки пользователей");throw i.value=a.message,n.normalizedError=a,n}finally{d.value=!1}}async function E(){d.value=!0,i.value=null;try{const n=await A.getAllUsers();return t.value=n,n}catch(n){const a=h(n,"Ошибка загрузки списка пользователей");throw i.value=a.message,n.normalizedError=a,n}finally{d.value=!1}}async function $(n){d.value=!0,i.value=null;try{const a=await A.approveUser(n);return o.value=o.value.filter(e=>e.id!==n),t.value=t.value.map(e=>e.id===n?a:e),a}catch(a){const e=h(a,"Ошибка одобрения пользователя");throw i.value=e.message,a.normalizedError=e,a}finally{d.value=!1}}async function D(n){d.value=!0,i.value=null;try{const a=await A.makeAdmin(n);return t.value=t.value.map(e=>e.id===n?a:e),a}catch(a){const e=h(a,"Ошибка назначения прав администратора");throw i.value=e.message,a.normalizedError=e,a}finally{d.value=!1}}async function c(n){d.value=!0,i.value=null;try{const a=await A.deleteUser(n);return t.value=t.value.filter(e=>e.id!==n),o.value=o.value.filter(e=>e.id!==n),a}catch(a){const e=h(a,"Ошибка удаления пользователя");throw i.value=e.message,a.normalizedError=e,a}finally{d.value=!1}}async function l(n){d.value=!0,i.value=null;try{const a=await A.revokeAdmin(n);return t.value=t.value.map(e=>e.id===n?a:e),a}catch(a){const e=h(a,"Ошибка снятия прав администратора");throw i.value=e.message,a.normalizedError=e,a}finally{d.value=!1}}return{pendingUsers:o,users:t,loading:d,error:i,fetchPendingUsers:C,fetchAllUsers:E,approveUser:$,makeAdmin:D,revokeAdmin:l,deleteUser:c}}),W={class:"admin-users-view"},X={class:"actions-column"},Y={key:0,class:"actions-column"},Z={key:1,class:"actions-column"},I={__name:"AdminUsersView",setup(o){const t=Q(),d=H(),i=J(()=>t.users),C=async c=>{try{await t.approveUser(c.id),v.success(`Пользователь ${c.email} одобрен`)}catch{v.error(t.error||"Ошибка одобрения пользователя")}},E=async c=>{try{await t.makeAdmin(c.id),v.success(`Пользователь ${c.email} назначен администратором`)}catch{v.error(t.error||"Ошибка назначения прав администратора")}},$=async c=>{try{await t.revokeAdmin(c.id),v.success(`Права администратора сняты с ${c.email}`)}catch{v.error(t.error||"Ошибка снятия прав администратора")}},D=async c=>{if(c.id===d.user?.id){v.error("Нельзя удалить собственную учётную запись администратора");return}try{await q.confirm(`Вы уверены, что хотите удалить пользователя ${c.email}?`,"Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning",confirmButtonClass:"el-button--danger"}),await t.deleteUser(c.id),v.success(`Пользователь ${c.email} удалён`)}catch(l){if(l==="cancel")return;v.error(t.error||"Ошибка удаления пользователя")}};return O(async()=>{try{await t.fetchPendingUsers(),await t.fetchAllUsers()}catch{v.error(t.error||"Ошибка загрузки пользователей")}}),(c,l)=>{const n=w("el-card"),a=w("el-empty"),e=w("el-table-column"),U=w("el-tag"),b=w("el-button"),x=w("el-table"),B=j("loading");return p(),y(P,null,{default:s(()=>[k("div",W,[u(n,{class:"header-card"},{default:s(()=>[...l[0]||(l[0]=[k("h1",null,"Управление пользователями",-1),k("p",null,"Одобрение новых пользователей, назначение админов и удаление учётных записей",-1)])]),_:1}),N((p(),y(n,{class:"users-card"},{default:s(()=>[k("h3",null,"Ожидают одобрения ("+_(m(t).pendingUsers.length)+")",1),m(t).pendingUsers.length===0?(p(),y(a,{key:0,description:"Нет пользователей, ожидающих одобрения"})):(p(),y(x,{key:1,data:m(t).pendingUsers,stripe:""},{default:s(()=>[u(e,{prop:"email",label:"Email","min-width":"250"}),u(e,{label:"Статус",width:"140"},{default:s(({row:r})=>[u(U,{type:m(V)(r.status)},{default:s(()=>[f(_(m(L)(r.status)),1)]),_:2},1032,["type"])]),_:1}),u(e,{prop:"created_at",label:"Дата регистрации",width:"180"},{default:s(({row:r})=>[f(_(new Date(r.created_at).toLocaleDateString("ru-RU")),1)]),_:1}),u(e,{label:"Действия",width:"160",align:"center"},{default:s(({row:r})=>[k("div",X,[u(b,{type:"success",onClick:S=>C(r)},{default:s(()=>[...l[1]||(l[1]=[f(" Одобрить ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"]))]),_:1})),[[B,m(t).loading]]),N((p(),y(n,{class:"users-card"},{default:s(()=>[k("h3",null,"Все пользователи ("+_(i.value.length)+")",1),i.value.length===0?(p(),y(a,{key:0,description:"Пользователи не найдены"})):(p(),y(x,{key:1,data:i.value,stripe:""},{default:s(()=>[u(e,{prop:"email",label:"Email","min-width":"250"}),u(e,{label:"Роль",width:"150"},{default:s(({row:r})=>[u(U,{type:m(F)(r.role)},{default:s(()=>[f(_(m(G)(r.role)),1)]),_:2},1032,["type"])]),_:1}),u(e,{label:"Статус",width:"140"},{default:s(({row:r})=>[u(U,{type:m(V)(r.status)},{default:s(()=>[f(_(m(L)(r.status)),1)]),_:2},1032,["type"])]),_:1}),u(e,{prop:"created_at",label:"Дата регистрации",width:"180"},{default:s(({row:r})=>[f(_(new Date(r.created_at).toLocaleDateString("ru-RU")),1)]),_:1}),u(e,{label:"Действия",width:"160",align:"center"},{default:s(({row:r})=>[r.id===m(d).user?.id?(p(),T("div",Y,[u(U,{type:"info"},{default:s(()=>[...l[2]||(l[2]=[f(" Это вы ",-1)])]),_:1})])):(p(),T("div",Z,[r.role!=="ADMIN"?(p(),y(b,{key:0,type:"warning",onClick:S=>E(r)},{default:s(()=>[...l[3]||(l[3]=[f(" В админы ",-1)])]),_:1},8,["onClick"])):M("",!0),r.role==="ADMIN"?(p(),y(b,{key:1,type:"info",onClick:S=>$(r)},{default:s(()=>[...l[4]||(l[4]=[f(" Снять админа ",-1)])]),_:1},8,["onClick"])):M("",!0),u(b,{type:"danger",onClick:S=>D(r)},{default:s(()=>[...l[5]||(l[5]=[f(" Удалить ",-1)])]),_:1},8,["onClick"])]))]),_:1})]),_:1},8,["data"]))]),_:1})),[[B,m(t).loading]])])]),_:1})}}},re=K(I,[["__scopeId","data-v-14f9f3f9"]]);export{re as default};
