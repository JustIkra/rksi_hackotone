import{O as z,m,Q as W,H as qe,v as $,w as a,E as _,r as c,I as Le,o as d,a as r,f as t,J as Ee,e as n,u as v,a3 as me,M as Ie,c as f,a4 as Qe,F as Q,C as X,K as _e,B as p,_ as fe,Z as Y,x as N,a5 as ee,a0 as Re,N as He}from"./index-CCSg9zNk.js";import{A as Je}from"./AppLayout-CUBrNqbP.js";import{m as Ke,g as Oe}from"./metricNames-okK6Tlev.js";import{b as Ze}from"./dateFormat-Bky3s5gS.js";import{_ as je}from"./_plugin-vue_export-helper-DlAUqK2U.js";const R={async list(){return(await z.get("/prof-activities")).data.activities||[]},async create(g){return(await z.post("/prof-activities",g)).data},async update(g,h){return(await z.put(`/prof-activities/${g}`,h)).data},async delete(g){await z.delete(`/prof-activities/${g}`)}},te={async upload(g){return(await z.post("/admin/weights/upload",g)).data},async update(g,h){return(await z.put(`/admin/weights/${g}`,h)).data},async list(g=null){const h=g?{prof_activity_code:g}:{};return(await z.get("/admin/weights",{params:h})).data}},Ge={class:"admin-weights-view"},Xe={class:"header-content"},Ye={class:"header-buttons"},et={class:"areas-container"},tt={key:2,class:"areas-grid"},at={class:"area-header"},lt={class:"area-title"},ot={key:0,class:"area-description"},st={key:0,class:"no-table"},it={key:1,class:"table-info"},nt={class:"table-stats"},rt={class:"stat-item"},dt={class:"stat-item"},ut={class:"stat-item"},ct={class:"table-actions"},pt={class:"selected-area"},vt={class:"area-name"},mt={class:"selected-area"},_t={class:"area-name"},ft={class:"weights-editor"},gt={key:0},yt={key:1},wt={key:0},ht={class:"metric-cell"},bt={key:0,style:{"margin-top":"20px"}},kt={__name:"AdminWeightsView",setup(g){const h=m(!1),V=m(!1),P=m(""),C=m(null),ae=m([]),H=m([]),J=m([]),le=new Set,oe=(l,e)=>{const s=l?.code||e,i=s&&le.has(s)?{warn:()=>{}}:{warn:b=>{s&&le.add(s),console.warn(b)}};return Oe(l,s,i)},D=m(!1),q=m(!1),T=m(!1),w=m(null),A=m(null),k=m(null),ge=m(null),u=m({prof_activity_code:"",weights:[],metadata:{description:""}}),y=m({code:"",name:"",description:""}),se=W(()=>{const l=H.value.map(s=>{const i=ae.value.find(b=>b.prof_activity_code===s.code);return{...s,weightTable:i||null}});if(!P.value)return l;const e=P.value.toLowerCase();return l.filter(s=>s.name.toLowerCase().includes(e)||s.description&&s.description.toLowerCase().includes(e))}),L=W(()=>{const l=H.value.find(e=>e.code===u.value.prof_activity_code);return l?l.name:""}),ye=W(()=>A.value?`Редактировать весовую таблицу: ${L.value}`:`Создать весовую таблицу: ${L.value}`),F=W(()=>u.value.weights.reduce((l,e)=>l+(parseFloat(e.weight)||0),0)),we=W(()=>Math.abs(F.value-1)<1e-4&&u.value.weights.length>0),he=W(()=>Math.abs(F.value-1)<1e-4?"success":F.value<1?"warning":"error"),K=async()=>{try{const l=await te.list();ae.value=l}catch(l){throw console.error("Failed to load weight tables:",l),C.value="Ошибка загрузки весовых таблиц",_.error("Ошибка загрузки весовых таблиц"),l}},be=l=>{A.value=null,u.value={prof_activity_code:l.code,weights:[],metadata:{description:""}},D.value=!0},O=async()=>{try{const l=await R.list();H.value=l}catch(l){throw console.error("Failed to load prof activities:",l),C.value="Ошибка загрузки профессиональных областей",_.error("Ошибка загрузки профессиональных областей"),l}},ke=async()=>{try{const l=await Ke.listMetricDefs(!0);J.value=l.items||[]}catch(l){throw console.error("Failed to load metrics:",l),C.value="Ошибка загрузки метрик",_.error("Ошибка загрузки метрик"),l}},ie=l=>{A.value=l,u.value={prof_activity_code:l.prof_activity_code,weights:l.weights.map(e=>({metric_code:e.metric_code,weight:parseFloat(e.weight)})),metadata:l.metadata||{description:""}},D.value=!0},Ve=()=>{u.value.weights.push({metric_code:"",weight:0})},xe=l=>{u.value.weights.splice(l,1)},Ce=async()=>{try{if(V.value=!0,!u.value.prof_activity_code){_.warning("Выберите профессиональную область");return}if(u.value.weights.length===0){_.warning("Добавьте хотя бы одну компетенцию");return}const l=u.value.weights.map(i=>i.metric_code);if(new Set(l.filter(i=>i)).size!==u.value.weights.length){_.warning("Компетенции должны быть уникальными");return}if(u.value.weights.some(i=>!i.metric_code)){_.warning("Все компетенции должны быть заполнены");return}const s={prof_activity_code:u.value.prof_activity_code,weights:u.value.weights.map(i=>({metric_code:i.metric_code,weight:parseFloat(i.weight)})),metadata:u.value.metadata.description?u.value.metadata:null};A.value?(await te.update(A.value.id,s),_.success("Изменения применены")):(await te.upload(s),_.success("Таблица создана")),D.value=!1,await K()}catch(l){console.error("Failed to save weight table:",l),_.error(l.response?.data?.detail||"Ошибка сохранения таблицы")}finally{V.value=!1}},Fe=l=>{w.value=l,q.value=!0},ne=()=>{k.value=null,y.value={code:"",name:"",description:""},T.value=!0},Te=l=>{k.value=l,y.value={code:l.code,name:l.name,description:l.description||""},T.value=!0},Ae=async()=>{try{if(V.value=!0,!y.value.code||!y.value.name){_.warning("Заполните обязательные поля");return}k.value?(await R.update(k.value.id,{name:y.value.name,description:y.value.description}),_.success("Область обновлена")):(await R.create(y.value),_.success("Область создана")),T.value=!1,await O()}catch(l){console.error("Failed to save prof activity:",l),_.error(l.response?.data?.detail||"Ошибка сохранения области")}finally{V.value=!1}},$e=async()=>{try{await He.confirm(`Удалить профессиональную область "${k.value.name}"? Это действие нельзя отменить.`,"Предупреждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"error"}),await R.delete(k.value.id),_.success("Область удалена"),T.value=!1,await O(),await K()}catch(l){l!=="cancel"&&(console.error("Failed to delete prof activity:",l),_.error(l.response?.data?.detail||"Ошибка удаления области"))}},Z=l=>l.weights.reduce((e,s)=>e+parseFloat(s.weight),0),re=l=>{const e=Z(l);return Math.abs(e-1)<1e-4?"success":"danger"},ze=l=>l.map(e=>{const s=J.value.find(i=>i.code===e.metric_code);return{...e,metric_name:oe(s,e.metric_code),metric_code:e.metric_code}}),de=Ze,ue=async()=>{h.value=!0,C.value=null;try{await Promise.all([K(),O(),ke()])}catch(l){console.error("Failed to load data:",l),C.value||(C.value="Не удалось загрузить данные")}finally{h.value=!1}};return qe(async()=>{await ue()}),(l,e)=>{const s=c("el-icon"),i=c("el-button"),b=c("el-card"),S=c("el-input"),De=c("el-result"),ce=c("el-empty"),B=c("el-tag"),pe=c("el-text"),M=c("el-form-item"),E=c("el-divider"),Me=c("el-alert"),Ue=c("el-option"),We=c("el-select"),Se=c("el-input-number"),ve=c("el-form"),j=c("el-dialog"),G=c("el-descriptions-item"),Be=c("el-descriptions"),I=c("el-table-column"),Ne=c("el-table"),Pe=Le("loading");return d(),$(Je,null,{default:a(()=>[r("div",Ge,[t(b,{class:"header-card"},{default:a(()=>[r("div",Xe,[e[13]||(e[13]=r("div",null,[r("h1",null,"Управление весовыми таблицами"),r("p",null,"Каждая профессиональная область имеет свою уникальную весовую таблицу")],-1)),r("div",Ye,[t(i,{size:"large",type:"primary",onClick:ne},{default:a(()=>[t(s,null,{default:a(()=>[t(v(me))]),_:1}),e[12]||(e[12]=n(" Новая область ",-1))]),_:1})])])]),_:1}),t(b,{class:"search-card"},{default:a(()=>[t(S,{modelValue:P.value,"onUpdate:modelValue":e[0]||(e[0]=o=>P.value=o),placeholder:"Поиск по названию профессиональной области...","prefix-icon":v(Ie),size:"large",clearable:""},null,8,["modelValue","prefix-icon"])]),_:1}),Ee((d(),f("div",et,[C.value?(d(),$(De,{key:0,icon:"error",title:"Ошибка загрузки","sub-title":C.value},{extra:a(()=>[t(i,{type:"primary",onClick:ue},{default:a(()=>[t(s,null,{default:a(()=>[t(v(Qe))]),_:1}),e[14]||(e[14]=n(" Повторить ",-1))]),_:1})]),_:1},8,["sub-title"])):se.value.length===0&&!h.value?(d(),$(ce,{key:1,description:"Нет профессиональных областей"},{default:a(()=>[t(i,{type:"primary",onClick:ne},{default:a(()=>[t(s,null,{default:a(()=>[t(v(me))]),_:1}),e[15]||(e[15]=n(" Создать первую область ",-1))]),_:1})]),_:1})):(d(),f("div",tt,[(d(!0),f(Q,null,X(se.value,o=>(d(),f("div",{key:o.id,class:"area-card-wrapper"},[t(b,{class:"area-card",shadow:"hover"},{header:a(()=>[r("div",at,[r("div",lt,[t(s,{size:24,class:"icon-primary"},{default:a(()=>[t(v(ee))]),_:1}),r("h3",null,p(o.name),1)]),t(i,{size:"small",circle:"",onClick:U=>Te(o)},{default:a(()=>[t(s,null,{default:a(()=>[t(v(Y))]),_:1})]),_:1},8,["onClick"])]),o.description?(d(),f("div",ot,p(o.description),1)):N("",!0)]),default:a(()=>[o.weightTable?(d(),f("div",it,[r("div",nt,[r("div",rt,[e[17]||(e[17]=r("span",{class:"stat-label"},"Компетенций:",-1)),t(B,{size:"large"},{default:a(()=>[n(p(o.weightTable.weights.length),1)]),_:2},1024)]),r("div",dt,[e[18]||(e[18]=r("span",{class:"stat-label"},"Сумма весов:",-1)),t(B,{type:re(o.weightTable),size:"large"},{default:a(()=>[n(p(Z(o.weightTable).toFixed(4)),1)]),_:2},1032,["type"])]),r("div",ut,[e[19]||(e[19]=r("span",{class:"stat-label"},"Обновлена:",-1)),t(pe,{type:"info"},{default:a(()=>[n(p(v(de)(o.weightTable.created_at)),1)]),_:2},1024)])]),r("div",ct,[t(i,{type:"info",onClick:U=>Fe(o.weightTable)},{default:a(()=>[t(s,null,{default:a(()=>[t(v(fe))]),_:1}),e[20]||(e[20]=n(" Просмотр ",-1))]),_:1},8,["onClick"]),t(i,{type:"primary",onClick:U=>ie(o.weightTable)},{default:a(()=>[t(s,null,{default:a(()=>[t(v(Y))]),_:1}),e[21]||(e[21]=n(" Редактировать ",-1))]),_:1},8,["onClick"])])])):(d(),f("div",st,[t(ce,{description:"Весовая таблица не создана","image-size":80},{default:a(()=>[t(i,{type:"primary",onClick:U=>be(o)},{default:a(()=>[t(s,null,{default:a(()=>[t(v(_e))]),_:1}),e[16]||(e[16]=n(" Создать таблицу ",-1))]),_:1},8,["onClick"])]),_:2},1024)]))]),_:2},1024)]))),128))]))])),[[Pe,h.value]])]),t(j,{modelValue:D.value,"onUpdate:modelValue":e[3]||(e[3]=o=>D.value=o),title:ye.value,width:"900px","close-on-click-modal":!1,"align-center":""},{footer:a(()=>[t(i,{onClick:e[2]||(e[2]=o=>D.value=!1)},{default:a(()=>[...e[24]||(e[24]=[n(" Отмена ",-1)])]),_:1}),t(i,{type:"primary",loading:V.value,disabled:!we.value,onClick:Ce},{default:a(()=>[n(p(A.value?"Сохранить":"Создать"),1)]),_:1},8,["loading","disabled"])]),default:a(()=>[t(ve,{ref_key:"formRef",ref:ge,model:u.value,"label-width":"200px","label-position":"top"},{default:a(()=>[A.value?(d(),$(M,{key:1,label:"Профессиональная область"},{default:a(()=>[t(b,{shadow:"never",class:"area-display-card"},{default:a(()=>[r("div",mt,[t(s,{size:20,class:"icon-primary"},{default:a(()=>[t(v(ee))]),_:1}),r("span",_t,p(L.value),1)])]),_:1})]),_:1})):(d(),$(M,{key:0,label:"Профессиональная область",required:""},{default:a(()=>[t(b,{shadow:"never",class:"area-display-card"},{default:a(()=>[r("div",pt,[t(s,{size:20,class:"icon-primary"},{default:a(()=>[t(v(ee))]),_:1}),r("span",vt,p(L.value),1)])]),_:1})]),_:1})),t(E,{"content-position":"left"},{default:a(()=>[...e[22]||(e[22]=[n(" Компетенции и веса ",-1)])]),_:1}),r("div",ft,[t(Me,{type:he.value,title:`Сумма весов: ${F.value.toFixed(4)} (требуется: 1.0000)`,closable:!1,"show-icon":"",style:{"margin-bottom":"16px"}},{default:a(()=>[F.value!==1?(d(),f(Q,{key:0},[F.value<1?(d(),f("span",gt," Осталось распределить: "+p((1-F.value).toFixed(4)),1)):(d(),f("span",yt," Превышение: "+p((F.value-1).toFixed(4)),1))],64)):N("",!0)]),_:1},8,["type","title"]),(d(!0),f(Q,null,X(u.value.weights,(o,U)=>(d(),f("div",{key:U,class:"weight-row"},[t(We,{modelValue:o.metric_code,"onUpdate:modelValue":x=>o.metric_code=x,placeholder:"Выберите метрику",filterable:"",style:{width:"420px"}},{default:a(()=>[(d(!0),f(Q,null,X(J.value,x=>(d(),$(Ue,{key:x.code,label:`${oe(x)} (${x.code})`,value:x.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]),t(Se,{modelValue:o.weight,"onUpdate:modelValue":x=>o.weight=x,min:0,max:1,step:.01,precision:4,placeholder:"Вес",style:{width:"180px"}},null,8,["modelValue","onUpdate:modelValue"]),t(i,{type:"danger",size:"small",icon:v(Re),circle:"",onClick:x=>xe(U)},null,8,["icon","onClick"])]))),128)),t(i,{type:"primary",plain:"",icon:v(_e),style:{"margin-top":"16px"},onClick:Ve},{default:a(()=>[...e[23]||(e[23]=[n(" Добавить компетенцию ",-1)])]),_:1},8,["icon"])]),t(E),t(M,{label:"Метаданные (опционально)"},{default:a(()=>[t(S,{modelValue:u.value.metadata.description,"onUpdate:modelValue":e[1]||(e[1]=o=>u.value.metadata.description=o),type:"textarea",rows:3,placeholder:"Описание версии таблицы, примечания и т.д."},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(j,{modelValue:q.value,"onUpdate:modelValue":e[6]||(e[6]=o=>q.value=o),title:`Весовая таблица: ${w.value?.prof_activity_name}`,width:"900px","align-center":""},{footer:a(()=>[t(i,{size:"large",onClick:e[4]||(e[4]=o=>q.value=!1)},{default:a(()=>[...e[27]||(e[27]=[n(" Закрыть ",-1)])]),_:1}),t(i,{type:"primary",size:"large",onClick:e[5]||(e[5]=o=>ie(w.value))},{default:a(()=>[t(s,null,{default:a(()=>[t(v(Y))]),_:1}),e[28]||(e[28]=n(" Редактировать ",-1))]),_:1})]),default:a(()=>[w.value?(d(),f("div",wt,[t(b,{shadow:"never",class:"table-summary-card"},{default:a(()=>[t(Be,{column:2,border:""},{default:a(()=>[t(G,{label:"Профессиональная область",span:2},{default:a(()=>[n(p(w.value.prof_activity_name),1)]),_:1}),t(G,{label:"Создана"},{default:a(()=>[n(p(v(de)(w.value.created_at)),1)]),_:1}),t(G,{label:"Сумма весов"},{default:a(()=>[t(B,{type:re(w.value),size:"large"},{default:a(()=>[n(p(Z(w.value).toFixed(4)),1)]),_:1},8,["type"])]),_:1})]),_:1})]),_:1}),t(E,{"content-position":"left"},{default:a(()=>[t(s,null,{default:a(()=>[t(v(fe))]),_:1}),n(" Компетенции ("+p(w.value.weights.length)+") ",1)]),_:1}),t(Ne,{data:ze(w.value.weights),stripe:"","max-height":"500",size:"large","table-layout":"fixed"},{default:a(()=>[t(I,{type:"index",label:"#",width:"60",align:"center"}),t(I,{label:"Метрика"},{default:a(({row:o})=>[r("div",ht,[r("strong",null,p(o.metric_name),1),e[25]||(e[25]=r("br",null,null,-1)),t(pe,{size:"small",type:"info"},{default:a(()=>[n(p(o.metric_code),1)]),_:2},1024)])]),_:1}),t(I,{prop:"weight",label:"Вес",width:"140",align:"center"},{default:a(({row:o})=>[t(B,{size:"large"},{default:a(()=>[n(p(parseFloat(o.weight).toFixed(4)),1)]),_:2},1024)]),_:1}),t(I,{label:"Процент",width:"140",align:"center"},{default:a(({row:o})=>[t(B,{type:"info",size:"large"},{default:a(()=>[n(p((parseFloat(o.weight)*100).toFixed(2))+"% ",1)]),_:2},1024)]),_:1})]),_:1},8,["data"]),w.value.metadata&&w.value.metadata.description?(d(),f("div",bt,[t(E,{"content-position":"left"},{default:a(()=>[...e[26]||(e[26]=[n(" Описание ",-1)])]),_:1}),t(b,{shadow:"never",class:"metadata-card"},{default:a(()=>[n(p(w.value.metadata.description),1)]),_:1})])):N("",!0)])):N("",!0)]),_:1},8,["modelValue","title"]),t(j,{modelValue:T.value,"onUpdate:modelValue":e[11]||(e[11]=o=>T.value=o),title:k.value?"Редактировать область":"Создать область",width:"600px"},{footer:a(()=>[t(i,{onClick:e[10]||(e[10]=o=>T.value=!1)},{default:a(()=>[...e[29]||(e[29]=[n(" Отмена ",-1)])]),_:1}),k.value?(d(),$(i,{key:0,type:"danger",onClick:$e},{default:a(()=>[...e[30]||(e[30]=[n(" Удалить ",-1)])]),_:1})):N("",!0),t(i,{type:"primary",loading:V.value,onClick:Ae},{default:a(()=>[n(p(k.value?"Сохранить":"Создать"),1)]),_:1},8,["loading"])]),default:a(()=>[t(ve,{model:y.value,"label-width":"120px"},{default:a(()=>[t(M,{label:"Код",required:""},{default:a(()=>[t(S,{modelValue:y.value.code,"onUpdate:modelValue":e[7]||(e[7]=o=>y.value.code=o),disabled:!!k.value,placeholder:"meeting_facilitation"},null,8,["modelValue","disabled"])]),_:1}),t(M,{label:"Название",required:""},{default:a(()=>[t(S,{modelValue:y.value.name,"onUpdate:modelValue":e[8]||(e[8]=o=>y.value.name=o),placeholder:"Проведение совещаний"},null,8,["modelValue"])]),_:1}),t(M,{label:"Описание"},{default:a(()=>[t(S,{modelValue:y.value.description,"onUpdate:modelValue":e[9]||(e[9]=o=>y.value.description=o),type:"textarea",rows:3,placeholder:"Описание профессиональной области"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})}}},At=je(kt,[["__scopeId","data-v-d5172d6a"]]);export{At as default};
