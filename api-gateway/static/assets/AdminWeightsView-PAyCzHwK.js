import{O as X,m,P as U,H as qe,v as z,w as l,E as _,r as c,I as Le,o as d,a as r,d as t,J as Ee,f as n,u as v,a8 as me,M as Ie,c as f,a9 as Re,F as I,C as Y,K as _e,B as p,a2 as fe,a1 as Z,x as B,aa as ee,a4 as He,N as Je}from"./index-Cg1oGpNZ.js";import{A as Ke}from"./AppLayout-B_t3ulwr.js";import{p as R,b as Oe}from"./dateFormat-Cx_Fj9p8.js";import{m as Qe,g as je}from"./metricNames-Cjbljbqv.js";import{_ as Ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";const te={async upload(F){return(await X.post("/admin/weights/upload",F)).data},async update(F,b){return(await X.put(`/admin/weights/${F}`,b)).data},async list(F=null){const b=F?{prof_activity_code:F}:{};return(await X.get("/admin/weights",{params:b})).data}},Xe={class:"admin-weights-view"},Ye={class:"header-content"},Ze={class:"header-buttons"},et={class:"areas-container"},tt={key:2,class:"areas-grid"},lt={class:"area-header"},at={class:"area-title"},ot={key:0,class:"area-description"},it={key:0,class:"no-table"},st={key:1,class:"table-info"},nt={class:"table-stats"},rt={class:"stat-item"},dt={class:"stat-item"},ut={class:"stat-item"},ct={class:"table-actions"},pt={class:"selected-area"},vt={class:"area-name"},mt={class:"selected-area"},_t={class:"area-name"},ft={class:"weights-editor"},gt={key:0},yt={key:1},wt={key:0},ht={class:"metric-cell"},bt={key:0,style:{"margin-top":"20px"}},kt={__name:"AdminWeightsView",setup(F){const b=m(!1),V=m(!1),N=m(""),x=m(null),le=m([]),H=m([]),J=m([]),ae=new Set,oe=(a,e)=>{const i=a?.code||e,s=i&&ae.has(i)?{warn:()=>{}}:{warn:w=>{i&&ae.add(i),console.warn(w)}};return je(a,i,s)},$=m(!1),P=m(!1),T=m(!1),y=m(null),A=m(null),h=m(null),ge=m(null),u=m({prof_activity_code:"",weights:[],metadata:{description:""}}),g=m({code:"",name:"",description:""}),ie=U(()=>{const a=H.value.map(i=>{const s=le.value.find(w=>w.prof_activity_code===i.code);return{...i,weightTable:s||null}});if(!N.value)return a;const e=N.value.toLowerCase();return a.filter(i=>i.name.toLowerCase().includes(e)||i.description&&i.description.toLowerCase().includes(e))}),q=U(()=>{const a=H.value.find(e=>e.code===u.value.prof_activity_code);return a?a.name:""}),ye=U(()=>A.value?`Редактировать весовую таблицу: ${q.value}`:`Создать весовую таблицу: ${q.value}`),C=U(()=>u.value.weights.reduce((a,e)=>a+(parseFloat(e.weight)||0),0)),we=U(()=>Math.abs(C.value-1)<1e-4&&u.value.weights.length>0),he=U(()=>Math.abs(C.value-1)<1e-4?"success":C.value<1?"warning":"error"),K=async()=>{try{const a=await te.list();le.value=a}catch(a){throw console.error("Failed to load weight tables:",a),x.value="Ошибка загрузки весовых таблиц",_.error("Ошибка загрузки весовых таблиц"),a}},be=a=>{A.value=null,u.value={prof_activity_code:a.code,weights:[],metadata:{description:""}},$.value=!0},O=async()=>{try{const a=await R.list();H.value=a}catch(a){throw console.error("Failed to load prof activities:",a),x.value="Ошибка загрузки профессиональных областей",_.error("Ошибка загрузки профессиональных областей"),a}},ke=async()=>{try{const a=await Qe.listMetricDefs(!0);J.value=a.items||[]}catch(a){throw console.error("Failed to load metrics:",a),x.value="Ошибка загрузки метрик",_.error("Ошибка загрузки метрик"),a}},se=a=>{A.value=a,u.value={prof_activity_code:a.prof_activity_code,weights:a.weights.map(e=>({metric_code:e.metric_code,weight:parseFloat(e.weight)})),metadata:a.metadata||{description:""}},$.value=!0},Ve=()=>{u.value.weights.push({metric_code:"",weight:0})},xe=a=>{u.value.weights.splice(a,1)},Ce=async()=>{try{if(V.value=!0,!u.value.prof_activity_code){_.warning("Выберите профессиональную область");return}if(u.value.weights.length===0){_.warning("Добавьте хотя бы одну компетенцию");return}const a=u.value.weights.map(s=>s.metric_code);if(new Set(a.filter(s=>s)).size!==u.value.weights.length){_.warning("Компетенции должны быть уникальными");return}if(u.value.weights.some(s=>!s.metric_code)){_.warning("Все компетенции должны быть заполнены");return}const i={prof_activity_code:u.value.prof_activity_code,weights:u.value.weights.map(s=>({metric_code:s.metric_code,weight:parseFloat(s.weight)})),metadata:u.value.metadata.description?u.value.metadata:null};A.value?(await te.update(A.value.id,i),_.success("Изменения применены")):(await te.upload(i),_.success("Таблица создана")),$.value=!1,await K()}catch(a){console.error("Failed to save weight table:",a),_.error(a.response?.data?.detail||"Ошибка сохранения таблицы")}finally{V.value=!1}},Fe=a=>{y.value=a,P.value=!0},ne=()=>{h.value=null,g.value={code:"",name:"",description:""},T.value=!0},Te=a=>{h.value=a,g.value={code:a.code,name:a.name,description:a.description||""},T.value=!0},Ae=async()=>{try{if(V.value=!0,!g.value.code||!g.value.name){_.warning("Заполните обязательные поля");return}h.value?(await R.update(h.value.id,{name:g.value.name,description:g.value.description}),_.success("Область обновлена")):(await R.create(g.value),_.success("Область создана")),T.value=!1,await O()}catch(a){console.error("Failed to save prof activity:",a),_.error(a.response?.data?.detail||"Ошибка сохранения области")}finally{V.value=!1}},ze=async()=>{try{await Je.confirm(`Удалить профессиональную область "${h.value.name}"? Это действие нельзя отменить.`,"Предупреждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"error"}),await R.delete(h.value.id),_.success("Область удалена"),T.value=!1,await O(),await K()}catch(a){a!=="cancel"&&(console.error("Failed to delete prof activity:",a),_.error(a.response?.data?.detail||"Ошибка удаления области"))}},Q=a=>a.weights.reduce((e,i)=>e+parseFloat(i.weight),0),re=a=>{const e=Q(a);return Math.abs(e-1)<1e-4?"success":"danger"},$e=a=>a.map(e=>{const i=J.value.find(s=>s.code===e.metric_code);return{...e,metric_name:oe(i,e.metric_code),metric_code:e.metric_code}}),de=Oe,ue=async()=>{b.value=!0,x.value=null;try{await Promise.all([K(),O(),ke()])}catch(a){console.error("Failed to load data:",a),x.value||(x.value="Не удалось загрузить данные")}finally{b.value=!1}};return qe(async()=>{await ue()}),(a,e)=>{const i=c("el-icon"),s=c("el-button"),w=c("el-card"),W=c("el-input"),De=c("el-result"),ce=c("el-empty"),S=c("el-tag"),pe=c("el-text"),D=c("el-form-item"),L=c("el-divider"),Me=c("el-alert"),Ue=c("el-option"),We=c("el-select"),Se=c("el-input-number"),ve=c("el-form"),j=c("el-dialog"),G=c("el-descriptions-item"),Be=c("el-descriptions"),E=c("el-table-column"),Ne=c("el-table"),Pe=Le("loading");return d(),z(Ke,null,{default:l(()=>[r("div",Xe,[t(w,{class:"header-card"},{default:l(()=>[r("div",Ye,[e[13]||(e[13]=r("div",null,[r("h1",null,"Управление весовыми таблицами"),r("p",null,"Каждая профессиональная область имеет свою уникальную весовую таблицу")],-1)),r("div",Ze,[t(s,{size:"large",type:"primary",onClick:ne},{default:l(()=>[t(i,null,{default:l(()=>[t(v(me))]),_:1}),e[12]||(e[12]=n(" Новая область ",-1))]),_:1})])])]),_:1}),t(w,{class:"search-card"},{default:l(()=>[t(W,{modelValue:N.value,"onUpdate:modelValue":e[0]||(e[0]=o=>N.value=o),placeholder:"Поиск по названию профессиональной области...","prefix-icon":v(Ie),size:"large",clearable:""},null,8,["modelValue","prefix-icon"])]),_:1}),Ee((d(),f("div",et,[x.value?(d(),z(De,{key:0,icon:"error",title:"Ошибка загрузки","sub-title":x.value},{extra:l(()=>[t(s,{type:"primary",onClick:ue},{default:l(()=>[t(i,null,{default:l(()=>[t(v(Re))]),_:1}),e[14]||(e[14]=n(" Повторить ",-1))]),_:1})]),_:1},8,["sub-title"])):ie.value.length===0&&!b.value?(d(),z(ce,{key:1,description:"Нет профессиональных областей"},{default:l(()=>[t(s,{type:"primary",onClick:ne},{default:l(()=>[t(i,null,{default:l(()=>[t(v(me))]),_:1}),e[15]||(e[15]=n(" Создать первую область ",-1))]),_:1})]),_:1})):(d(),f("div",tt,[(d(!0),f(I,null,Y(ie.value,o=>(d(),f("div",{key:o.id,class:"area-card-wrapper"},[t(w,{class:"area-card",shadow:"hover"},{header:l(()=>[r("div",lt,[r("div",at,[t(i,{size:24,class:"icon-primary"},{default:l(()=>[t(v(ee))]),_:1}),r("h3",null,p(o.name),1)]),t(s,{size:"small",circle:"",onClick:M=>Te(o)},{default:l(()=>[t(i,null,{default:l(()=>[t(v(Z))]),_:1})]),_:1},8,["onClick"])]),o.description?(d(),f("div",ot,p(o.description),1)):B("",!0)]),default:l(()=>[o.weightTable?(d(),f("div",st,[r("div",nt,[r("div",rt,[e[17]||(e[17]=r("span",{class:"stat-label"},"Компетенций:",-1)),t(S,{size:"large"},{default:l(()=>[n(p(o.weightTable.weights.length),1)]),_:2},1024)]),r("div",dt,[e[18]||(e[18]=r("span",{class:"stat-label"},"Сумма весов:",-1)),t(S,{type:re(o.weightTable),size:"large"},{default:l(()=>[n(p(Q(o.weightTable).toFixed(4)),1)]),_:2},1032,["type"])]),r("div",ut,[e[19]||(e[19]=r("span",{class:"stat-label"},"Обновлена:",-1)),t(pe,{type:"info"},{default:l(()=>[n(p(v(de)(o.weightTable.created_at)),1)]),_:2},1024)])]),r("div",ct,[t(s,{type:"info",onClick:M=>Fe(o.weightTable)},{default:l(()=>[t(i,null,{default:l(()=>[t(v(fe))]),_:1}),e[20]||(e[20]=n(" Просмотр ",-1))]),_:1},8,["onClick"]),t(s,{type:"primary",onClick:M=>se(o.weightTable)},{default:l(()=>[t(i,null,{default:l(()=>[t(v(Z))]),_:1}),e[21]||(e[21]=n(" Редактировать ",-1))]),_:1},8,["onClick"])])])):(d(),f("div",it,[t(ce,{description:"Весовая таблица не создана","image-size":80},{default:l(()=>[t(s,{type:"primary",onClick:M=>be(o)},{default:l(()=>[t(i,null,{default:l(()=>[t(v(_e))]),_:1}),e[16]||(e[16]=n(" Создать таблицу ",-1))]),_:1},8,["onClick"])]),_:2},1024)]))]),_:2},1024)]))),128))]))])),[[Pe,b.value]])]),t(j,{modelValue:$.value,"onUpdate:modelValue":e[3]||(e[3]=o=>$.value=o),title:ye.value,width:"900px","close-on-click-modal":!1,"align-center":""},{footer:l(()=>[t(s,{onClick:e[2]||(e[2]=o=>$.value=!1)},{default:l(()=>[...e[24]||(e[24]=[n(" Отмена ",-1)])]),_:1}),t(s,{type:"primary",loading:V.value,disabled:!we.value,onClick:Ce},{default:l(()=>[n(p(A.value?"Сохранить":"Создать"),1)]),_:1},8,["loading","disabled"])]),default:l(()=>[t(ve,{ref_key:"formRef",ref:ge,model:u.value,"label-width":"200px","label-position":"top"},{default:l(()=>[A.value?(d(),z(D,{key:1,label:"Профессиональная область"},{default:l(()=>[t(w,{shadow:"never",class:"area-display-card"},{default:l(()=>[r("div",mt,[t(i,{size:20,class:"icon-primary"},{default:l(()=>[t(v(ee))]),_:1}),r("span",_t,p(q.value),1)])]),_:1})]),_:1})):(d(),z(D,{key:0,label:"Профессиональная область",required:""},{default:l(()=>[t(w,{shadow:"never",class:"area-display-card"},{default:l(()=>[r("div",pt,[t(i,{size:20,class:"icon-primary"},{default:l(()=>[t(v(ee))]),_:1}),r("span",vt,p(q.value),1)])]),_:1})]),_:1})),t(L,{"content-position":"left"},{default:l(()=>[...e[22]||(e[22]=[n(" Компетенции и веса ",-1)])]),_:1}),r("div",ft,[t(Me,{type:he.value,title:`Сумма весов: ${C.value.toFixed(4)} (требуется: 1.0000)`,closable:!1,"show-icon":"",style:{"margin-bottom":"16px"}},{default:l(()=>[C.value!==1?(d(),f(I,{key:0},[C.value<1?(d(),f("span",gt," Осталось распределить: "+p((1-C.value).toFixed(4)),1)):(d(),f("span",yt," Превышение: "+p((C.value-1).toFixed(4)),1))],64)):B("",!0)]),_:1},8,["type","title"]),(d(!0),f(I,null,Y(u.value.weights,(o,M)=>(d(),f("div",{key:M,class:"weight-row"},[t(We,{modelValue:o.metric_code,"onUpdate:modelValue":k=>o.metric_code=k,placeholder:"Выберите метрику",filterable:"",style:{width:"420px"}},{default:l(()=>[(d(!0),f(I,null,Y(J.value,k=>(d(),z(Ue,{key:k.code,label:`${oe(k)} (${k.code})`,value:k.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]),t(Se,{modelValue:o.weight,"onUpdate:modelValue":k=>o.weight=k,min:0,max:1,step:.01,precision:4,placeholder:"Вес",style:{width:"180px"}},null,8,["modelValue","onUpdate:modelValue"]),t(s,{type:"danger",size:"small",icon:v(He),circle:"",onClick:k=>xe(M)},null,8,["icon","onClick"])]))),128)),t(s,{type:"primary",plain:"",icon:v(_e),style:{"margin-top":"16px"},onClick:Ve},{default:l(()=>[...e[23]||(e[23]=[n(" Добавить компетенцию ",-1)])]),_:1},8,["icon"])]),t(L),t(D,{label:"Метаданные (опционально)"},{default:l(()=>[t(W,{modelValue:u.value.metadata.description,"onUpdate:modelValue":e[1]||(e[1]=o=>u.value.metadata.description=o),type:"textarea",rows:3,placeholder:"Описание версии таблицы, примечания и т.д."},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(j,{modelValue:P.value,"onUpdate:modelValue":e[6]||(e[6]=o=>P.value=o),title:`Весовая таблица: ${y.value?.prof_activity_name}`,width:"900px","align-center":""},{footer:l(()=>[t(s,{size:"large",onClick:e[4]||(e[4]=o=>P.value=!1)},{default:l(()=>[...e[27]||(e[27]=[n(" Закрыть ",-1)])]),_:1}),t(s,{type:"primary",size:"large",onClick:e[5]||(e[5]=o=>se(y.value))},{default:l(()=>[t(i,null,{default:l(()=>[t(v(Z))]),_:1}),e[28]||(e[28]=n(" Редактировать ",-1))]),_:1})]),default:l(()=>[y.value?(d(),f("div",wt,[t(w,{shadow:"never",class:"table-summary-card"},{default:l(()=>[t(Be,{column:2,border:""},{default:l(()=>[t(G,{label:"Профессиональная область",span:2},{default:l(()=>[n(p(y.value.prof_activity_name),1)]),_:1}),t(G,{label:"Создана"},{default:l(()=>[n(p(v(de)(y.value.created_at)),1)]),_:1}),t(G,{label:"Сумма весов"},{default:l(()=>[t(S,{type:re(y.value),size:"large"},{default:l(()=>[n(p(Q(y.value).toFixed(4)),1)]),_:1},8,["type"])]),_:1})]),_:1})]),_:1}),t(L,{"content-position":"left"},{default:l(()=>[t(i,null,{default:l(()=>[t(v(fe))]),_:1}),n(" Компетенции ("+p(y.value.weights.length)+") ",1)]),_:1}),t(Ne,{data:$e(y.value.weights),stripe:"","max-height":"500",size:"large"},{default:l(()=>[t(E,{type:"index",label:"#",width:"60",align:"center"}),t(E,{label:"Метрика","min-width":"250"},{default:l(({row:o})=>[r("div",ht,[r("strong",null,p(o.metric_name),1),e[25]||(e[25]=r("br",null,null,-1)),t(pe,{size:"small",type:"info"},{default:l(()=>[n(p(o.metric_code),1)]),_:2},1024)])]),_:1}),t(E,{prop:"weight",label:"Вес",width:"140",align:"center"},{default:l(({row:o})=>[t(S,{size:"large"},{default:l(()=>[n(p(parseFloat(o.weight).toFixed(4)),1)]),_:2},1024)]),_:1}),t(E,{label:"Процент",width:"140",align:"center"},{default:l(({row:o})=>[t(S,{type:"info",size:"large"},{default:l(()=>[n(p((parseFloat(o.weight)*100).toFixed(2))+"% ",1)]),_:2},1024)]),_:1})]),_:1},8,["data"]),y.value.metadata&&y.value.metadata.description?(d(),f("div",bt,[t(L,{"content-position":"left"},{default:l(()=>[...e[26]||(e[26]=[n(" Описание ",-1)])]),_:1}),t(w,{shadow:"never",class:"metadata-card"},{default:l(()=>[n(p(y.value.metadata.description),1)]),_:1})])):B("",!0)])):B("",!0)]),_:1},8,["modelValue","title"]),t(j,{modelValue:T.value,"onUpdate:modelValue":e[11]||(e[11]=o=>T.value=o),title:h.value?"Редактировать область":"Создать область",width:"600px"},{footer:l(()=>[t(s,{onClick:e[10]||(e[10]=o=>T.value=!1)},{default:l(()=>[...e[29]||(e[29]=[n(" Отмена ",-1)])]),_:1}),h.value?(d(),z(s,{key:0,type:"danger",onClick:ze},{default:l(()=>[...e[30]||(e[30]=[n(" Удалить ",-1)])]),_:1})):B("",!0),t(s,{type:"primary",loading:V.value,onClick:Ae},{default:l(()=>[n(p(h.value?"Сохранить":"Создать"),1)]),_:1},8,["loading"])]),default:l(()=>[t(ve,{model:g.value,"label-width":"120px"},{default:l(()=>[t(D,{label:"Код",required:""},{default:l(()=>[t(W,{modelValue:g.value.code,"onUpdate:modelValue":e[7]||(e[7]=o=>g.value.code=o),disabled:!!h.value,placeholder:"meeting_facilitation"},null,8,["modelValue","disabled"])]),_:1}),t(D,{label:"Название",required:""},{default:l(()=>[t(W,{modelValue:g.value.name,"onUpdate:modelValue":e[8]||(e[8]=o=>g.value.name=o),placeholder:"Проведение совещаний"},null,8,["modelValue"])]),_:1}),t(D,{label:"Описание"},{default:l(()=>[t(W,{modelValue:g.value.description,"onUpdate:modelValue":e[9]||(e[9]=o=>g.value.description=o),type:"textarea",rows:3,placeholder:"Описание профессиональной области"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})}}},At=Ge(kt,[["__scopeId","data-v-6f72dd38"]]);export{At as default};
