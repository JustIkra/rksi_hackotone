import{m as r,n as j,H as Xe,v as c,w as l,q as Ze,E as u,d as ea,r as d,I as aa,o,J as me,c as f,x as P,f as t,u as y,e as s,B as v,a as h,K as be,F as ce,C as fe,z as la,a4 as ta,M as ia,N as we}from"./index-CLa57XdF.js";import{A as na}from"./AppLayout-CgNgEes3.js";import{p as ke}from"./participants-8uyslejd.js";import{w as oa}from"./weights-D60kgzmu.js";import{o as w}from"./organizations-BJ4F9Gfo.js";import{a as sa}from"./dateFormat-Bky3s5gS.js";import{u as ra}from"./useResponsive-PLxFU8ar.js";import{_ as ua}from"./_plugin-vue_export-helper-DlAUqK2U.js";const da={class:"org-detail"},pa={class:"card-header"},ma={class:"header-actions"},ca={key:1,class:"departments-section"},fa={class:"section-header"},va={key:1,class:"departments-list"},_a={class:"dept-header"},ya=["onClick"],ga={class:"dept-name"},ba={class:"dept-actions"},wa={key:0,class:"dept-description"},ka={key:1,class:"dept-participants"},Va={key:0,class:"scores-toolbar"},ha={key:0},xa={key:1,class:"text-muted"},Ca={style:{"margin-bottom":"16px",color:"var(--color-text-secondary)"}},Da={class:"participant-search-list"},za={key:0,class:"participant-ext-id"},$a={__name:"OrganizationDetailView",setup(Pa){const H=ea(),g=Ze(),{isMobile:R}=ra(),G=r(!1),p=r(!1),_=r(null),x=r({}),X=r({}),Z=r({}),ee=r({}),W=r(!1),ae=r(null),T=j({name:"",description:""}),Ve={name:[{required:!0,message:"Введите название",trigger:"blur"}]},S=r(!1),le=r(null),U=j({name:"",description:""}),ve={name:[{required:!0,message:"Введите название отдела",trigger:"blur"}]},Y=r(!1),te=r(null),k=j({id:null,name:"",description:""}),B=r(!1),V=r(null),E=r(null),ie=r([]),ne=r(!1),O=r(!1),oe=r("existing"),C=r(null),F=r([]),N=r([]),I=r(!1),se=r("");let _e=null;const re=r(null),b=j({full_name:"",birth_date:"",external_id:""}),he={full_name:[{required:!0,message:"Введите ФИО",trigger:"blur"},{min:1,max:255,message:"От 1 до 255 символов",trigger:"blur"}]},xe=i=>i>=80?"#67C23A":i>=60?"#E6A23C":i>=40?"#F56C6C":"#909399",D=async()=>{G.value=!0;try{const i=await w.getById(g.params.id);_.value=i}catch{u.error("Организация не найдена"),H.push("/organizations")}finally{G.value=!1}},Ce=async()=>{ae.value&&await ae.value.validate(async i=>{if(i){p.value=!0;try{await w.update(g.params.id,T),u.success("Организация обновлена"),W.value=!1,await D()}catch(e){u.error(e.response?.data?.detail||"Ошибка обновления")}finally{p.value=!1}}})},De=async()=>{le.value&&await le.value.validate(async i=>{if(i){p.value=!0;try{await w.createDepartment(g.params.id,U),u.success("Отдел создан"),S.value=!1,U.name="",U.description="",await D()}catch(e){u.error(e.response?.data?.detail||"Ошибка создания отдела")}finally{p.value=!1}}})},ze=i=>{k.id=i.id,k.name=i.name,k.description=i.description||"",Y.value=!0},$e=async()=>{te.value&&await te.value.validate(async i=>{if(i){p.value=!0;try{await w.updateDepartment(g.params.id,k.id,{name:k.name,description:k.description}),u.success("Отдел обновлён"),Y.value=!1,await D()}catch(e){u.error(e.response?.data?.detail||"Ошибка обновления отдела")}finally{p.value=!1}}})},Pe=i=>{we.confirm(`Удалить отдел "${i.name}"? Участники будут отвязаны, но не удалены.`,"Подтверждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await w.deleteDepartment(g.params.id,i.id),u.success("Отдел удалён"),await D()}catch{u.error("Ошибка удаления отдела")}}).catch(()=>{})},Te=async i=>{V.value=i,E.value=i.weight_table_id||null,B.value=!0,ne.value=!0;try{const e=await oa.list();ie.value=(e.items||e).map(n=>({id:n.id,prof_activity_name:n.prof_activity_name||n.prof_activity?.name||"Без названия"}))}catch{ie.value=[],u.error("Ошибка загрузки весовых таблиц")}finally{ne.value=!1}},Ue=async()=>{if(!(!E.value||!V.value)){p.value=!0;try{await w.attachWeightTable(g.params.id,V.value.id,E.value),u.success("Весовая таблица привязана"),B.value=!1,await D(),x.value[V.value.id]&&await A(V.value.id)}catch(i){u.error(i.response?.data?.detail||"Ошибка привязки весовой таблицы")}finally{p.value=!1}}},Fe=async()=>{if(V.value){p.value=!0;try{await w.attachWeightTable(g.params.id,V.value.id,null),u.success("Весовая таблица отвязана"),B.value=!1,await D(),x.value[V.value.id]&&await A(V.value.id)}catch(i){u.error(i.response?.data?.detail||"Ошибка отвязки весовой таблицы")}finally{p.value=!1}}},Ae=async i=>{ee.value[i.id]=!0;try{const e=await w.calculateDepartmentScores(g.params.id,i.id);u.success(`Рассчитано: ${e.calculated}`+(e.errors?.length?`, ошибок: ${e.errors.length}`:"")),await A(i.id)}catch(e){u.error(e.response?.data?.detail||"Ошибка расчёта")}finally{ee.value[i.id]=!1}},Re=async i=>{if(x.value[i]){x.value[i]=!1;return}x.value[i]=!0,await A(i)},A=async i=>{Z.value[i]=!0;try{const e=_.value?.departments?.find(M=>M.id===i);let n;e?.weight_table_id?n=await w.listDepartmentParticipantsWithScores(g.params.id,i):n=await w.listDepartmentParticipants(g.params.id,i),X.value[i]=n}catch{u.error("Ошибка загрузки участников отдела")}finally{Z.value[i]=!1}},Be=async i=>{C.value=i,F.value=[],N.value=[],se.value="",oe.value="existing",b.full_name="",b.birth_date="",b.external_id="",O.value=!0,await ye("")},ye=async i=>{I.value=!0;try{const e={size:50};i&&i.length>=2&&(e.query=i);const n=await ke.search(e);N.value=n.items||[]}catch{N.value=[]}finally{I.value=!1}},Ee=i=>{clearTimeout(_e),_e=setTimeout(()=>{ye(i)},300)},Me=async()=>{if(!(!F.value.length||!C.value)){p.value=!0;try{await w.attachParticipants(g.params.id,C.value.id,F.value),u.success("Участники привязаны"),O.value=!1,await D(),x.value[C.value.id]&&await A(C.value.id)}catch(i){u.error(i.response?.data?.detail||"Ошибка привязки участников")}finally{p.value=!1}}},We=async()=>{!re.value||!C.value||await re.value.validate(async i=>{if(i){p.value=!0;try{const e=await ke.create({full_name:b.full_name,birth_date:b.birth_date||null,external_id:b.external_id||null});await w.attachParticipants(g.params.id,C.value.id,[e.id]),u.success(`Участник "${e.full_name}" создан и привязан`),O.value=!1,await D(),x.value[C.value.id]&&await A(C.value.id)}catch(e){u.error(e.response?.data?.detail||"Ошибка создания участника")}finally{p.value=!1}}})},Se=(i,e)=>{we.confirm(`Отвязать "${e.full_name}" от отдела "${i.name}"?`,"Подтверждение",{confirmButtonText:"Отвязать",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await w.detachParticipant(g.params.id,i.id,e.id),u.success("Участник отвязан"),await D(),await A(i.id)}catch{u.error("Ошибка отвязки участника")}}).catch(()=>{})};return Xe(async()=>{await D(),_.value&&(T.name=_.value.name,T.description=_.value.description||"")}),(i,e)=>{const n=d("el-button"),M=d("el-descriptions-item"),Ye=d("el-descriptions"),Oe=d("el-card"),ue=d("el-icon"),de=d("el-empty"),q=d("el-tag"),Ne=d("el-link"),L=d("el-table-column"),qe=d("el-progress"),Le=d("el-table"),z=d("el-input"),$=d("el-form-item"),J=d("el-form"),K=d("el-dialog"),He=d("el-option"),Ie=d("el-select"),Je=d("el-checkbox"),Ke=d("el-checkbox-group"),ge=d("el-tab-pane"),Qe=d("el-date-picker"),je=d("el-tabs"),Ge=d("el-drawer"),pe=aa("loading");return o(),c(na,null,{default:l(()=>[me((o(),f("div",da,[_.value?(o(),c(Oe,{key:0,class:"detail-card"},{header:l(()=>[h("div",pa,[h("h2",null,v(_.value.name),1),h("div",ma,[t(n,{onClick:e[0]||(e[0]=a=>y(H).push("/organizations"))},{default:l(()=>[...e[25]||(e[25]=[s(" Назад ",-1)])]),_:1}),t(n,{type:"primary",onClick:e[1]||(e[1]=a=>W.value=!0)},{default:l(()=>[...e[26]||(e[26]=[s(" Редактировать ",-1)])]),_:1})])])]),default:l(()=>[t(Ye,{column:y(R)?1:2,border:""},{default:l(()=>[t(M,{label:"Название"},{default:l(()=>[s(v(_.value.name),1)]),_:1}),t(M,{label:"Описание"},{default:l(()=>[s(v(_.value.description||"Не указано"),1)]),_:1}),t(M,{label:"Дата создания"},{default:l(()=>[s(v(y(sa)(_.value.created_at)),1)]),_:1}),t(M,{label:"Кол-во отделов"},{default:l(()=>[s(v(_.value.departments?.length||0),1)]),_:1})]),_:1},8,["column"])]),_:1})):P("",!0),_.value?(o(),f("div",ca,[h("div",fa,[e[28]||(e[28]=h("h3",null,"Отделы",-1)),t(n,{type:"primary",onClick:e[2]||(e[2]=a=>S.value=!0)},{default:l(()=>[t(ue,null,{default:l(()=>[t(y(be))]),_:1}),e[27]||(e[27]=s(" Добавить отдел ",-1))]),_:1})]),_.value.departments?.length?(o(),f("div",va,[(o(!0),f(ce,null,fe(_.value.departments,a=>(o(),f("div",{key:a.id,class:"dept-item"},[h("div",_a,[h("div",{class:"dept-title",onClick:m=>Re(a.id)},[t(ue,{class:la(["dept-expand-icon",{"is-expanded":x.value[a.id]}])},{default:l(()=>[t(y(ta))]),_:1},8,["class"]),h("span",ga,v(a.name),1),t(q,{size:"small",type:"info"},{default:l(()=>[s(v(a.participants_count)+" уч. ",1)]),_:2},1024),a.weight_table_name?(o(),c(q,{key:0,size:"small",type:"success"},{default:l(()=>[s(v(a.weight_table_name),1)]),_:2},1024)):(o(),c(q,{key:1,size:"small",type:"info",effect:"plain"},{default:l(()=>[...e[29]||(e[29]=[s(" Нет весовой таблицы ",-1)])]),_:1}))],8,ya),h("div",ba,[t(n,{size:"small",plain:"",onClick:m=>Te(a)},{default:l(()=>[...e[30]||(e[30]=[s(" Весы ",-1)])]),_:1},8,["onClick"]),t(n,{size:"small",type:"primary",plain:"",onClick:m=>Be(a)},{default:l(()=>[t(ue,null,{default:l(()=>[t(y(be))]),_:1}),e[31]||(e[31]=s(" Добавить ",-1))]),_:1},8,["onClick"]),t(n,{size:"small",onClick:m=>ze(a)},{default:l(()=>[...e[32]||(e[32]=[s(" Изменить ",-1)])]),_:1},8,["onClick"]),t(n,{size:"small",type:"danger",plain:"",onClick:m=>Pe(a)},{default:l(()=>[...e[33]||(e[33]=[s(" Удалить ",-1)])]),_:1},8,["onClick"])])]),a.description&&x.value[a.id]?(o(),f("div",wa,v(a.description),1)):P("",!0),x.value[a.id]?me((o(),f("div",ka,[a.weight_table_id?(o(),f("div",Va,[t(n,{type:"primary",size:"small",loading:ee.value[a.id],onClick:m=>Ae(a)},{default:l(()=>[...e[34]||(e[34]=[s(" Рассчитать соответствие ",-1)])]),_:1},8,["loading","onClick"])])):P("",!0),X.value[a.id]?.length?(o(),c(Le,{key:2,data:X.value[a.id],size:"small",stripe:"","default-sort":a.weight_table_id?{prop:"suitability_pct",order:"descending"}:{}},{default:l(()=>[t(L,{label:"ФИО"},{default:l(({row:m})=>[t(Ne,{type:"primary",underline:!1,onClick:Q=>y(H).push(`/participants/${m.id}`)},{default:l(()=>[s(v(m.full_name),1)]),_:2},1032,["onClick"])]),_:1}),t(L,{prop:"external_id",label:"Внешний ID",width:"150"}),a.weight_table_id?(o(),c(L,{key:0,label:"Соответствие",prop:"suitability_pct",width:"180",sortable:""},{default:l(({row:m})=>[m.has_metrics?m.suitability_pct==null?(o(),c(q,{key:1,size:"small",type:"warning"},{default:l(()=>[...e[36]||(e[36]=[s("Не рассчитано",-1)])]),_:1})):(o(),c(qe,{key:2,percentage:m.suitability_pct,color:xe(m.suitability_pct),"stroke-width":14,"text-inside":!0,format:Q=>Q.toFixed(1)+"%"},null,8,["percentage","color","format"])):(o(),c(q,{key:0,size:"small",type:"info"},{default:l(()=>[...e[35]||(e[35]=[s("Нет данных",-1)])]),_:1}))]),_:1})):P("",!0),a.weight_table_id?(o(),c(L,{key:1,label:"Покрытие",prop:"metrics_coverage",width:"120",sortable:""},{default:l(({row:m})=>[m.metrics_coverage!=null?(o(),f("span",ha,v(m.metrics_coverage)+"%",1)):(o(),f("span",xa,"-"))]),_:1})):P("",!0),t(L,{label:"",width:"240",align:"center"},{default:l(({row:m})=>[t(n,{type:"primary",size:"small",plain:"",onClick:Q=>y(H).push(`/participants/${m.id}`)},{default:l(()=>[...e[37]||(e[37]=[s(" Профиль ",-1)])]),_:1},8,["onClick"]),t(n,{type:"warning",size:"small",plain:"",onClick:Q=>Se(a,m)},{default:l(()=>[...e[38]||(e[38]=[s(" Отвязать ",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1032,["data","default-sort"])):(o(),c(de,{key:1,description:"Нет участников","image-size":60}))])),[[pe,Z.value[a.id]]]):P("",!0)]))),128))])):(o(),c(de,{key:0,description:"Нет отделов","image-size":80}))])):P("",!0),t(K,{modelValue:W.value,"onUpdate:modelValue":e[6]||(e[6]=a=>W.value=a),title:"Редактировать организацию",width:y(R)?"95%":"500px"},{footer:l(()=>[t(n,{onClick:e[5]||(e[5]=a=>W.value=!1)},{default:l(()=>[...e[39]||(e[39]=[s(" Отмена ",-1)])]),_:1}),t(n,{type:"primary",loading:p.value,onClick:Ce},{default:l(()=>[...e[40]||(e[40]=[s(" Сохранить ",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(J,{ref_key:"editFormRef",ref:ae,model:T,rules:Ve,"label-position":"top"},{default:l(()=>[t($,{label:"Название",prop:"name"},{default:l(()=>[t(z,{modelValue:T.name,"onUpdate:modelValue":e[3]||(e[3]=a=>T.name=a)},null,8,["modelValue"])]),_:1}),t($,{label:"Описание",prop:"description"},{default:l(()=>[t(z,{modelValue:T.description,"onUpdate:modelValue":e[4]||(e[4]=a=>T.description=a),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),t(K,{modelValue:S.value,"onUpdate:modelValue":e[10]||(e[10]=a=>S.value=a),title:"Добавить отдел",width:y(R)?"95%":"500px"},{footer:l(()=>[t(n,{onClick:e[9]||(e[9]=a=>S.value=!1)},{default:l(()=>[...e[41]||(e[41]=[s(" Отмена ",-1)])]),_:1}),t(n,{type:"primary",loading:p.value,onClick:De},{default:l(()=>[...e[42]||(e[42]=[s(" Создать ",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(J,{ref_key:"deptFormRef",ref:le,model:U,rules:ve,"label-position":"top"},{default:l(()=>[t($,{label:"Название",prop:"name"},{default:l(()=>[t(z,{modelValue:U.name,"onUpdate:modelValue":e[7]||(e[7]=a=>U.name=a),placeholder:"Введите название отдела"},null,8,["modelValue"])]),_:1}),t($,{label:"Описание",prop:"description"},{default:l(()=>[t(z,{modelValue:U.description,"onUpdate:modelValue":e[8]||(e[8]=a=>U.description=a),type:"textarea",rows:3,placeholder:"Описание (необязательно)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),t(K,{modelValue:Y.value,"onUpdate:modelValue":e[14]||(e[14]=a=>Y.value=a),title:"Редактировать отдел",width:y(R)?"95%":"500px"},{footer:l(()=>[t(n,{onClick:e[13]||(e[13]=a=>Y.value=!1)},{default:l(()=>[...e[43]||(e[43]=[s(" Отмена ",-1)])]),_:1}),t(n,{type:"primary",loading:p.value,onClick:$e},{default:l(()=>[...e[44]||(e[44]=[s(" Сохранить ",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(J,{ref_key:"editDeptFormRef",ref:te,model:k,rules:ve,"label-position":"top"},{default:l(()=>[t($,{label:"Название",prop:"name"},{default:l(()=>[t(z,{modelValue:k.name,"onUpdate:modelValue":e[11]||(e[11]=a=>k.name=a)},null,8,["modelValue"])]),_:1}),t($,{label:"Описание",prop:"description"},{default:l(()=>[t(z,{modelValue:k.description,"onUpdate:modelValue":e[12]||(e[12]=a=>k.description=a),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),t(K,{modelValue:B.value,"onUpdate:modelValue":e[17]||(e[17]=a=>B.value=a),title:"Весовая таблица",width:y(R)?"95%":"500px"},{footer:l(()=>[V.value?.weight_table_id?(o(),c(n,{key:0,type:"danger",plain:"",loading:p.value,onClick:Fe},{default:l(()=>[...e[45]||(e[45]=[s(" Отвязать ",-1)])]),_:1},8,["loading"])):P("",!0),t(n,{onClick:e[16]||(e[16]=a=>B.value=!1)},{default:l(()=>[...e[46]||(e[46]=[s(" Отмена ",-1)])]),_:1}),t(n,{type:"primary",loading:p.value,disabled:!E.value,onClick:Ue},{default:l(()=>[...e[47]||(e[47]=[s(" Сохранить ",-1)])]),_:1},8,["loading","disabled"])]),default:l(()=>[h("p",Ca,' Выберите весовую таблицу для отдела "'+v(V.value?.name)+'" ',1),t(Ie,{modelValue:E.value,"onUpdate:modelValue":e[15]||(e[15]=a=>E.value=a),placeholder:"Выберите весовую таблицу",filterable:"",clearable:"",style:{width:"100%"},loading:ne.value},{default:l(()=>[(o(!0),f(ce,null,fe(ie.value,a=>(o(),c(He,{key:a.id,label:a.prof_activity_name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1},8,["modelValue","width"]),t(Ge,{modelValue:O.value,"onUpdate:modelValue":e[24]||(e[24]=a=>O.value=a),title:"Добавить участника — "+(C.value?.name||""),size:y(R)?"100%":"480px",direction:"rtl","destroy-on-close":""},{default:l(()=>[t(je,{modelValue:oe.value,"onUpdate:modelValue":e[23]||(e[23]=a=>oe.value=a)},{default:l(()=>[t(ge,{label:"Найти существующего",name:"existing"},{default:l(()=>[t(z,{modelValue:se.value,"onUpdate:modelValue":e[18]||(e[18]=a=>se.value=a),placeholder:"Поиск по имени...",clearable:"","prefix-icon":y(ia),style:{"margin-bottom":"var(--spacing-md)"},onInput:Ee},null,8,["modelValue","prefix-icon"]),me((o(),f("div",Da,[!I.value&&!N.value.length?(o(),c(de,{key:0,description:"Участники не найдены","image-size":60})):(o(),c(Ke,{key:1,modelValue:F.value,"onUpdate:modelValue":e[19]||(e[19]=a=>F.value=a)},{default:l(()=>[(o(!0),f(ce,null,fe(N.value,a=>(o(),f("div",{key:a.id,class:"participant-search-item"},[t(Je,{value:a.id},{default:l(()=>[h("span",null,v(a.full_name),1),a.external_id?(o(),f("span",za,v(a.external_id),1)):P("",!0)]),_:2},1032,["value"])]))),128))]),_:1},8,["modelValue"]))])),[[pe,I.value]]),t(n,{type:"primary",loading:p.value,disabled:!F.value.length,style:{width:"100%","margin-top":"var(--spacing-md)"},onClick:Me},{default:l(()=>[s(" Привязать ("+v(F.value.length)+") ",1)]),_:1},8,["loading","disabled"])]),_:1}),t(ge,{label:"Создать нового",name:"create"},{default:l(()=>[t(J,{ref_key:"newParticipantFormRef",ref:re,model:b,rules:he,"label-position":"top"},{default:l(()=>[t($,{label:"ФИО",prop:"full_name"},{default:l(()=>[t(z,{modelValue:b.full_name,"onUpdate:modelValue":e[20]||(e[20]=a=>b.full_name=a),placeholder:"Введите полное имя"},null,8,["modelValue"])]),_:1}),t($,{label:"Дата рождения",prop:"birth_date"},{default:l(()=>[t(Qe,{modelValue:b.birth_date,"onUpdate:modelValue":e[21]||(e[21]=a=>b.birth_date=a),type:"date",placeholder:"Выберите дату",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t($,{label:"Внешний ID",prop:"external_id"},{default:l(()=>[t(z,{modelValue:b.external_id,"onUpdate:modelValue":e[22]||(e[22]=a=>b.external_id=a),placeholder:"Внешний идентификатор (необязательно)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),t(n,{type:"primary",loading:p.value,style:{width:"100%","margin-top":"var(--spacing-md)"},onClick:We},{default:l(()=>[...e[48]||(e[48]=[s(" Создать и привязать ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title","size"])])),[[pe,G.value]])]),_:1})}}},Wa=ua($a,[["__scopeId","data-v-cc98be2c"]]);export{Wa as default};
