import{P as J,m as k,D as O,n as q,H as K,v as F,w as o,E as $,d as j,r as m,I as G,o as y,a as u,J as I,f as n,e as v,u as p,K as Q,L as W,M as X,c as b,B as S,x as Y,F as Z,C as ee,N as ae}from"./index-CLa57XdF.js";import{A as te}from"./AppLayout-CgNgEes3.js";import{o as E}from"./organizations-BJ4F9Gfo.js";import{u as ne}from"./useResponsive-PLxFU8ar.js";import{_ as le}from"./_plugin-vue_export-helper-DlAUqK2U.js";const oe=J("organizations",()=>{const z=k([]),_=k(null),l=k(!1),r=k(null),s=k({total:0,page:1,size:20,totalPages:0});async function w(d={}){l.value=!0,r.value=null;try{const a=await E.search(d);return z.value=a.items,s.value={total:a.total,page:a.page,size:a.size,totalPages:Math.ceil(a.total/a.size)},a}catch(a){const i=O(a,"Ошибка загрузки организаций");throw r.value=i.message,a.normalizedError=i,a}finally{l.value=!1}}async function h(d){l.value=!0,r.value=null;try{const a=await E.getById(d);return _.value=a,a}catch(a){const i=O(a,"Ошибка загрузки организации");throw r.value=i.message,a.normalizedError=i,a}finally{l.value=!1}}async function g(d){l.value=!0,r.value=null;try{const a=await E.create(d);return z.value.unshift(a),a}catch(a){const i=O(a,"Ошибка создания организации");throw r.value=i.message,a.normalizedError=i,a}finally{l.value=!1}}async function B(d,a){l.value=!0,r.value=null;try{const i=await E.update(d,a),c=z.value.findIndex(e=>e.id===d);return c!==-1&&(z.value[c]=i),_.value?.id===d&&(_.value={..._.value,...i}),i}catch(i){const c=O(i,"Ошибка обновления организации");throw r.value=c.message,i.normalizedError=c,i}finally{l.value=!1}}async function f(d){l.value=!0,r.value=null;try{await E.delete(d),z.value=z.value.filter(a=>a.id!==d),_.value?.id===d&&(_.value=null)}catch(a){const i=O(a,"Ошибка удаления организации");throw r.value=i.message,a.normalizedError=i,a}finally{l.value=!1}}return{organizations:z,currentOrganization:_,loading:l,error:r,pagination:s,searchOrganizations:w,getOrganization:h,createOrganization:g,updateOrganization:B,deleteOrganization:f}}),ie={class:"organizations-view"},re={class:"page-header"},se={class:"header-content"},de={class:"filter-card card"},ue={class:"table-card card"},pe={class:"actions-group"},ce={key:1,class:"org-cards"},me={class:"org-card__name"},ge={class:"org-card__info"},fe={class:"org-card__field"},ve={class:"field-value"},_e={class:"org-card__field"},ye={class:"field-value"},ze={class:"org-card__actions"},we={key:2,class:"pagination"},Ce={key:3,class:"pagination pagination--mobile"},ke={__name:"OrganizationsView",setup(z){const _=j(),l=oe(),{isMobile:r}=ne(),s=q({query:"",page:1,size:20}),w=k(!1),h=k(null),g=q({name:"",description:""}),B={name:[{required:!0,message:"Введите название",trigger:"blur"},{min:1,max:255,message:"От 1 до 255 символов",trigger:"blur"}]},f=async()=>{try{await l.searchOrganizations(s)}catch{$.error("Ошибка загрузки организаций")}},d=async()=>{h.value&&await h.value.validate(async c=>{if(c)try{await l.createOrganization(g),$.success("Организация создана"),w.value=!1,g.name="",g.description="",await f()}catch{$.error(l.error||"Ошибка создания организации")}})},a=c=>{_.push(`/organizations/${c}`)},i=c=>{ae.confirm(`Вы уверены, что хотите удалить организацию "${c.name}"? Все отделы также будут удалены.`,"Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await l.deleteOrganization(c.id),$.success("Организация удалена"),await f()}catch{$.error(l.error||"Ошибка удаления организации")}}).catch(()=>{})};return K(()=>{f()}),(c,e)=>{const M=m("el-icon"),C=m("el-button"),U=m("el-input"),D=m("el-form-item"),N=m("el-form"),P=m("el-link"),x=m("el-table-column"),A=m("el-table"),L=m("el-empty"),R=m("el-pagination"),T=m("el-dialog"),H=G("loading");return y(),F(te,null,{default:o(()=>[u("div",ie,[u("div",re,[u("div",se,[e[12]||(e[12]=u("h1",{class:"page-title"}," Организации ",-1)),n(C,{type:"primary",onClick:e[0]||(e[0]=t=>w.value=!0)},{default:o(()=>[n(M,null,{default:o(()=>[n(p(Q))]),_:1}),e[11]||(e[11]=v(" Добавить организацию ",-1))]),_:1})])]),u("div",de,[n(N,{inline:!p(r),model:s},{default:o(()=>[n(D,{label:"Поиск"},{default:o(()=>[n(U,{modelValue:s.query,"onUpdate:modelValue":e[1]||(e[1]=t=>s.query=t),placeholder:"Название организации",clearable:"",style:W(p(r)?"width: 100%":"width: 300px"),onChange:f},{prefix:o(()=>[n(M,null,{default:o(()=>[n(p(X))]),_:1})]),_:1},8,["modelValue","style"])]),_:1})]),_:1},8,["inline","model"])]),I((y(),b("div",ue,[p(r)?(y(),b("div",ce,[(y(!0),b(Z,null,ee(p(l).organizations,t=>(y(),b("div",{key:t.id,class:"org-card"},[u("div",me,[n(P,{type:"primary",underline:!1,onClick:V=>a(t.id)},{default:o(()=>[v(S(t.name),1)]),_:2},1032,["onClick"])]),u("div",ge,[u("div",fe,[e[15]||(e[15]=u("span",{class:"field-label"},"Описание:",-1)),u("span",ve,S(t.description||"—"),1)]),u("div",_e,[e[16]||(e[16]=u("span",{class:"field-label"},"Отделов:",-1)),u("span",ye,S(t.departments_count),1)])]),u("div",ze,[n(C,{type:"primary",onClick:V=>a(t.id)},{default:o(()=>[...e[17]||(e[17]=[v(" Открыть ",-1)])]),_:1},8,["onClick"]),n(C,{type:"danger",plain:"",onClick:V=>i(t)},{default:o(()=>[...e[18]||(e[18]=[v(" Удалить ",-1)])]),_:1},8,["onClick"])])]))),128)),!p(l).organizations.length&&!p(l).loading?(y(),F(L,{key:0,description:"Нет организаций","image-size":120},{default:o(()=>[n(C,{type:"primary",onClick:e[2]||(e[2]=t=>w.value=!0)},{default:o(()=>[...e[19]||(e[19]=[v(" Добавить организацию ",-1)])]),_:1})]),_:1})):Y("",!0)])):(y(),F(A,{key:0,data:p(l).organizations,stripe:"","table-layout":"fixed"},{default:o(()=>[n(x,{label:"Название"},{default:o(({row:t})=>[n(P,{type:"primary",underline:!1,onClick:V=>a(t.id)},{default:o(()=>[v(S(t.name),1)]),_:2},1032,["onClick"])]),_:1}),n(x,{prop:"description",label:"Описание","show-overflow-tooltip":""}),n(x,{prop:"departments_count",label:"Отделов",width:"100",align:"center"}),n(x,{prop:"participants_count",label:"Участников",width:"120",align:"center"}),n(x,{label:"Действия",width:"200",align:"center"},{default:o(({row:t})=>[u("div",pe,[n(C,{type:"primary",size:"small",onClick:V=>a(t.id)},{default:o(()=>[...e[13]||(e[13]=[v(" Открыть ",-1)])]),_:1},8,["onClick"]),n(C,{type:"danger",size:"small",plain:"",onClick:V=>i(t)},{default:o(()=>[...e[14]||(e[14]=[v(" Удалить ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"])),p(r)?(y(),b("div",Ce,[n(R,{"current-page":s.page,"onUpdate:currentPage":e[5]||(e[5]=t=>s.page=t),"page-size":s.size,"onUpdate:pageSize":e[6]||(e[6]=t=>s.size=t),total:p(l).pagination.total,"page-sizes":[10,20,50],layout:"prev, pager, next",small:"",onCurrentChange:f,onSizeChange:f},null,8,["current-page","page-size","total"])])):(y(),b("div",we,[n(R,{"current-page":s.page,"onUpdate:currentPage":e[3]||(e[3]=t=>s.page=t),"page-size":s.size,"onUpdate:pageSize":e[4]||(e[4]=t=>s.size=t),total:p(l).pagination.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",onCurrentChange:f,onSizeChange:f},null,8,["current-page","page-size","total"])]))])),[[H,p(l).loading]]),n(T,{modelValue:w.value,"onUpdate:modelValue":e[10]||(e[10]=t=>w.value=t),title:"Добавить организацию",width:p(r)?"95%":"500px"},{footer:o(()=>[n(C,{onClick:e[9]||(e[9]=t=>w.value=!1)},{default:o(()=>[...e[20]||(e[20]=[v(" Отмена ",-1)])]),_:1}),n(C,{type:"primary",loading:p(l).loading,onClick:d},{default:o(()=>[...e[21]||(e[21]=[v(" Создать ",-1)])]),_:1},8,["loading"])]),default:o(()=>[n(N,{ref_key:"createFormRef",ref:h,model:g,rules:B,"label-position":"top"},{default:o(()=>[n(D,{label:"Название",prop:"name"},{default:o(()=>[n(U,{modelValue:g.name,"onUpdate:modelValue":e[7]||(e[7]=t=>g.name=t),placeholder:"Введите название организации"},null,8,["modelValue"])]),_:1}),n(D,{label:"Описание",prop:"description"},{default:o(()=>[n(U,{modelValue:g.description,"onUpdate:modelValue":e[8]||(e[8]=t=>g.description=t),type:"textarea",rows:3,placeholder:"Описание (необязательно)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"])])]),_:1})}}},$e=le(ke,[["__scopeId","data-v-745e40e8"]]);export{$e as default};
