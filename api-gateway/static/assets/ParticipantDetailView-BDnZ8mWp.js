import{O as ee,P as Ge,m as h,Q as J,D as qe,p as ae,r as m,c as U,o as r,f as t,x as z,R as je,w as e,u as f,S as Je,K as We,z as Te,B as S,F as te,H as xe,T as Ne,v as y,e as v,a as g,C as de,U as ye,V as Fe,E as q,q as ze,d as Le,I as Se,J as ge,W as He,k as be,X as ke,g as Ce,Y as Ke,Z as Me,_ as $e,h as Ie,$ as Ve,a0 as Ee,N as Ze,L as Qe,a1 as Ye,a2 as Re,G as et}from"./index-CvR0dbKI.js";import{A as tt}from"./AppLayout-BzfT33nq.js";import{_ as pe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{m as _e,f as at,g as lt}from"./metricNames-B6hm_LbF.js";import{f as st,a as he}from"./dateFormat-Bky3s5gS.js";import{a as Oe,p as Pe,u as nt}from"./useResponsive-2o9KfkWn.js";const me={async upload(l,D){const n=new FormData;return n.append("file",D),(await ee.post(`/participants/${l}/reports`,n,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(l){return await ee.get(`/reports/${l}/download`,{responseType:"blob"})},async getById(l){return(await ee.get(`/reports/${l}`)).data},async delete(l){return(await ee.delete(`/reports/${l}`)).data},async extract(l){return(await ee.post(`/reports/${l}/extract`)).data},async getMetrics(l){return(await ee.get(`/reports/${l}/metrics`)).data},async getList(l){return(await ee.get(`/participants/${l}/reports`)).data}},Ue=Ge("metrics",()=>{const l=h([]),D=h(!1),n=h(null),x=h(null),X=300*1e3,$=J(()=>x.value?Date.now()-x.value>X:!0),A=J(()=>l.value.length>0);async function k({force:p=!1,activeOnly:I=!1}={}){if(!p&&A.value&&!$.value)return l.value;if(D.value)return new Promise(E=>{const w=setInterval(()=>{D.value||(clearInterval(w),E(l.value))},50)});D.value=!0,n.value=null;try{const E=await _e.listMetricDefs(I);return l.value=E.items||[],x.value=Date.now(),l.value}catch(E){const w=qe(E,"Ошибка загрузки метрик");throw n.value=w.message,E.normalizedError=w,E}finally{D.value=!1}}function M(p){return l.value.find(I=>I.id===p)}function T(p){const I=M(p);return I?.name_ru||I?.name||p}function j(){x.value=null}function N(p){const I=l.value.findIndex(E=>E.id===p.id);I!==-1&&(l.value[I]=p)}function C(p){l.value=l.value.filter(I=>I.id!==p)}function L(p){l.value.push(p)}return{metricDefs:l,loading:D,error:n,isStale:$,hasData:A,fetchMetricDefs:k,getMetricDefById:M,getMetricName:T,invalidateCache:j,updateInCache:N,removeFromCache:C,addToCache:L}});function ve(l,D=1){if(l==null||l==="")return"";const n=typeof l=="string"?parseFloat(l):l;return isNaN(n)?"":n.toLocaleString("ru-RU",{minimumFractionDigits:D,maximumFractionDigits:D})}function oe(l){if(l==null||l==="")return null;const n=String(l).trim().replace(",","."),x=parseFloat(n);return isNaN(x)?null:x}function ot(l){return oe(l)}function rt(l,D=1){return ve(l,D)}const it={key:0,class:"error-message"},ut={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(l,{emit:D}){const n=l,x=D,X=h(null),$=h(""),A=h(!1),k=h(!1),M=h(""),T=J(()=>oe($.value)),j=J(()=>{const i=T.value;return i===null||i<=n.min}),N=J(()=>{const i=T.value;return i===null||i>=n.max}),C=i=>{if(i==null||i===""){$.value="";return}A.value?$.value=String(i).replace(".",","):$.value=ve(i,n.precision)},L=i=>{if(i==null||i==="")return k.value=!1,M.value="",!0;const b=oe(i);return b===null?(k.value=!0,M.value="Некорректное число",!1):b<n.min?(k.value=!0,M.value=`Значение должно быть не меньше ${ve(n.min,n.precision)}`,!1):b>n.max?(k.value=!0,M.value=`Значение должно быть не больше ${ve(n.max,n.precision)}`,!1):(k.value=!1,M.value="",!0)},p=i=>{const b=i.replace(/[^\d,.-]/g,"");let u=!1;const P=b.split("").filter(V=>V===","||V==="."?u?!1:(u=!0,!0):!0).join("").replace(".",",");$.value=P;const W=oe(P);W!==null?x("update:modelValue",W):(P===""||P==="-")&&x("update:modelValue",null)},I=()=>{A.value=!1;const i=oe($.value);if(L($.value)){if(i!==null){const b=Math.round(i*Math.pow(10,n.precision))/Math.pow(10,n.precision),u=Math.max(n.min,Math.min(n.max,b));x("update:modelValue",u),C(u),x("change",u)}}else if(i!==null&&(i<n.min||i>n.max)){const b=Math.max(n.min,Math.min(n.max,i));x("update:modelValue",b),C(b),x("change",b),k.value=!1,M.value=""}x("blur")},E=()=>{A.value=!0,T.value!==null&&($.value=String(T.value).replace(".",","))},w=()=>{const i=T.value||0,b=Math.min(n.max,i+n.step),u=Math.round(b*Math.pow(10,n.precision))/Math.pow(10,n.precision);x("update:modelValue",u),x("change",u),C(u)},o=()=>{const i=T.value||0,b=Math.max(n.min,i-n.step),u=Math.round(b*Math.pow(10,n.precision))/Math.pow(10,n.precision);x("update:modelValue",u),x("change",u),C(u)};return ae(()=>n.modelValue,i=>{C(i)},{immediate:!0}),C(n.modelValue),(i,b)=>{const u=m("el-button"),P=m("el-button-group"),W=m("el-input");return r(),U(te,null,[t(W,{ref_key:"inputRef",ref:X,modelValue:$.value,"onUpdate:modelValue":b[0]||(b[0]=V=>$.value=V),placeholder:l.placeholder,disabled:l.disabled,class:Te({"is-invalid":k.value}),onInput:p,onBlur:I,onFocus:E},je({_:2},[l.showControls?{name:"append",fn:e(()=>[t(P,null,{default:e(()=>[t(u,{icon:f(Je),disabled:l.disabled||j.value,onClick:o},null,8,["icon","disabled"]),t(u,{icon:f(We),disabled:l.disabled||N.value,onClick:w},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),k.value?(r(),U("div",it,S(M.value),1)):z("",!0)],64)}}},ct=pe(ut,[["__scopeId","data-v-ff39cd14"]]),dt={class:"card-header"},pt={class:"card-header-left"},ft={class:"card-header-actions"},mt={class:"metrics-filter"},_t={class:"metrics-stats"},vt={class:"metrics-count"},yt={key:0,class:"metric-description"},gt={key:0,class:"metrics-info"},ht={class:"info-row"},wt={key:0,class:"info-row"},bt={__name:"MetricsEditor",props:{reportId:{type:String,required:!0},reportStatus:{type:String,default:null},reportExtractWarning:{type:String,default:null}},emits:["metrics-updated"],setup(l,{emit:D}){const n=l,x=D,X=h(!1),$=h(!1),A=h(!1),k=h(null),M=h(!1),T=h(0),j=h(0),N=h([]),C=h([]),L=h({metrics:{}}),p=h({}),I=h("metrics"),E=h(null),w=J(()=>{if(!N.value||N.value.length===0)return[];if(M.value)return N.value;const _=new Set(C.value.filter(s=>{const a=parseFloat(String(s.value).replace(",","."));return!isNaN(a)&&a>0}).map(s=>s.metric_def_id));return N.value.filter(s=>{const a=_.has(s.id),O=L.value.metrics[s.id],K=O!=null&&O!==""&&parseFloat(String(O).replace(",","."))>0;return a||K})}),o=J(()=>!C.value||C.value.length===0?[]:[...new Set(C.value.map(_=>_.source))]),i=J(()=>{if(!C.value||C.value.length===0)return null;const _=C.value.map(s=>s.updated_at||s.created_at).filter(Boolean).map(s=>new Date(s));return _.length===0?null:new Date(Math.max(..._))}),b=async()=>{X.value=!0,k.value=null;try{const _=await _e.getMetricTemplate(n.reportId);T.value=_.filled_count||0,j.value=_.missing_count||0;const s=_.items||[];C.value=s.filter(a=>a.value!==null).map(a=>({metric_def_id:a.metric_def.id,value:a.value,source:a.source,confidence:a.confidence,notes:a.notes,updated_at:a.updated_at})),N.value=s.map(a=>({id:a.metric_def.id,code:a.metric_def.code,name:a.metric_def.name,name_ru:a.metric_def.name_ru,unit:a.metric_def.unit,min_value:a.metric_def.min_value,max_value:a.metric_def.max_value,description:a.metric_def.description})),L.value.metrics={},s.forEach(a=>{const O=a.metric_def.id;a.value!==null?L.value.metrics[O]=oe(a.value):L.value.metrics[O]=null}),p.value=JSON.parse(JSON.stringify(L.value.metrics))}catch(_){console.error("Failed to load metrics:",_),k.value="Не удалось загрузить метрики"}finally{X.value=!1}},u=async()=>{await b(),q.success("Метрики обновлены")},P=()=>{E.value||(E.value=setInterval(async()=>{await b()},5e3))},W=()=>{E.value&&(clearInterval(E.value),E.value=null)},V=()=>{A.value=!0,M.value=!0,p.value=JSON.parse(JSON.stringify(L.value.metrics))},Z=()=>{L.value.metrics=JSON.parse(JSON.stringify(p.value)),A.value=!1,k.value=null},le=async()=>{$.value=!0,k.value=null;try{const _=[],s=[];for(const[H,Q]of Object.entries(L.value.metrics)){const Y=p.value[H],ce=Y!=null&&Y!=="";if(Q!=null&&Q!==""){const se=ot(Q);se!==null&&_.push({metric_def_id:H,value:se,source:"MANUAL",notes:null})}else ce&&s.push(H)}const O=(await Promise.allSettled(s.map(H=>_e.clearExtractedMetric(n.reportId,H)))).filter(H=>H.status==="fulfilled"||H.status==="rejected"&&H.reason?.response?.status===404).length;_.length>0&&await _e.bulkCreateExtractedMetrics(n.reportId,_);const K=[];_.length>0&&K.push(`сохранено: ${_.length}`),O>0&&K.push(`сброшено: ${O}`),K.length===0?q.info("Нет изменений для сохранения"):q.success(`Метрики обновлены (${K.join(", ")})`),A.value=!1,await b(),x("metrics-updated")}catch(_){console.error("Failed to save metrics:",_);let s="Не удалось сохранить метрики";_.response?.data?.detail&&(typeof _.response.data.detail=="string"?s=_.response.data.detail:Array.isArray(_.response.data.detail)&&(s=_.response.data.detail.map(a=>a.msg||a.message).join(", "))),k.value=s,q.error(s)}finally{$.value=!1}},re=_=>{switch(_){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},ie=_=>{switch(_){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return _}},ue=st;return xe(async()=>{}),Ne(()=>{W()}),ae(()=>n.reportId,async _=>{_&&await b()}),ae(()=>n.reportStatus,async(_,s)=>{s||await b(),_==="PROCESSING"?(P(),s&&s!=="PROCESSING"&&await b()):(W(),_==="EXTRACTED"&&s&&s!=="EXTRACTED"&&await b())},{immediate:!0}),(_,s)=>{const a=m("el-icon"),O=m("el-tag"),K=m("el-button"),H=m("el-alert"),Q=m("el-switch"),Y=m("el-form-item"),ce=m("el-col"),se=m("el-row"),d=m("el-form"),c=m("el-divider"),G=m("el-tab-pane"),F=m("el-tabs"),ne=m("el-card");return r(),y(ne,{class:"metrics-editor"},{header:e(()=>[g("div",dt,[g("div",pt,[s[5]||(s[5]=g("span",null,"Метрики отчёта",-1)),l.reportStatus==="PROCESSING"?(r(),y(O,{key:0,type:"warning",size:"small",class:"status-tag"},{default:e(()=>[t(a,{class:"is-loading"},{default:e(()=>[t(f(ye))]),_:1}),s[3]||(s[3]=v(" Извлечение... ",-1))]),_:1})):l.reportStatus==="EXTRACTED"?(r(),y(O,{key:1,type:"success",size:"small",class:"status-tag"},{default:e(()=>[...s[4]||(s[4]=[v(" Извлечено ",-1)])]),_:1})):z("",!0)]),g("div",ft,[A.value?z("",!0):(r(),y(K,{key:0,size:"small",loading:X.value,onClick:u},{default:e(()=>[t(a,null,{default:e(()=>[t(f(Fe))]),_:1}),s[6]||(s[6]=v(" Обновить ",-1))]),_:1},8,["loading"])),A.value?(r(),U(te,{key:2},[t(K,{size:"small",onClick:Z},{default:e(()=>[...s[8]||(s[8]=[v(" Отмена ",-1)])]),_:1}),t(K,{type:"primary",size:"small",loading:$.value,onClick:le},{default:e(()=>[...s[9]||(s[9]=[v(" Сохранить ",-1)])]),_:1},8,["loading"])],64)):(r(),y(K,{key:1,type:"primary",size:"small",onClick:V},{default:e(()=>[...s[7]||(s[7]=[v(" Редактировать ",-1)])]),_:1}))])])]),default:e(()=>[k.value?(r(),y(H,{key:0,type:"error",title:k.value,closable:"",style:{"margin-bottom":"16px"},onClose:s[0]||(s[0]=B=>k.value=null)},null,8,["title"])):z("",!0),n.reportExtractWarning&&n.reportStatus==="EXTRACTED"?(r(),y(H,{key:1,type:"warning",title:n.reportExtractWarning,closable:!1,style:{"margin-bottom":"16px"}},null,8,["title"])):z("",!0),!C.value||C.value.length===0?(r(),y(H,{key:2,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...s[10]||(s[10]=[v(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):z("",!0),t(F,{modelValue:I.value,"onUpdate:modelValue":s[2]||(s[2]=B=>I.value=B),type:"card"},{default:e(()=>[t(G,{label:"Метрики",name:"metrics"},{default:e(()=>[g("div",mt,[t(Q,{modelValue:M.value,"onUpdate:modelValue":s[1]||(s[1]=B=>M.value=B),"active-text":"Показать все метрики","inactive-text":"Только заполненные"},null,8,["modelValue"]),g("div",_t,[t(O,{type:"success",size:"small"},{default:e(()=>[v(" Заполнено: "+S(T.value),1)]),_:1}),t(O,{type:"info",size:"small"},{default:e(()=>[v(" Не заполнено: "+S(j.value),1)]),_:1}),g("span",vt," Показано: "+S(w.value.length)+" из "+S(N.value.length),1)])]),t(d,{ref:"formRef",model:L.value,"label-position":"top",disabled:!A.value},{default:e(()=>[t(se,{gutter:20},{default:e(()=>[(r(!0),U(te,null,de(w.value,B=>(r(),y(ce,{key:B.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(Y,{label:f(at)(B),prop:`metrics.${B.id}`},{default:e(()=>[t(ct,{modelValue:L.value.metrics[B.id],"onUpdate:modelValue":fe=>L.value.metrics[B.id]=fe,min:B.min_value||1,max:B.max_value||10,precision:1,step:.1,disabled:!A.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),B.description?(r(),U("div",yt,S(B.description),1)):z("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),C.value&&C.value.length>0?(r(),U("div",gt,[t(c),g("div",ht,[s[11]||(s[11]=g("span",{class:"info-label"},"Источник данных:",-1)),(r(!0),U(te,null,de(o.value,B=>(r(),y(O,{key:B,type:re(B),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[v(S(ie(B)),1)]),_:2},1032,["type"]))),128))]),i.value?(r(),U("div",wt,[s[12]||(s[12]=g("span",{class:"info-label"},"Последнее обновление:",-1)),g("span",null,S(f(ue)(i.value)),1)])):z("",!0)])):z("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},kt=pe(bt,[["__scopeId","data-v-b43d5796"]]),Ct={class:"report-list"},Et={class:"report-list__controls"},xt={class:"controls-left"},St={class:"controls-right"},Dt={class:"filename"},Mt={class:"status-cell"},$t={key:1,class:"report-list__cards"},It={class:"report-card__header"},Vt={class:"report-card__status"},Rt={class:"report-card__body"},At={class:"report-card__field"},Tt={class:"field-value field-value--filename"},Nt={class:"report-card__field"},Ft={class:"field-value"},zt={class:"report-card__actions"},Lt={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(l,{emit:D}){const n=l,x=D,X=ze(),$=Le(),{isMobile:A}=Oe();xe(()=>{X.query.status&&(k.value=X.query.status),X.query.sort&&(M.value=X.query.sort)});const k=h(""),M=h("desc"),T=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];ae([k,M],([w,o])=>{const i={...X.query};w?i.status=w:delete i.status,o?i.sort=o:delete i.sort,$.replace({query:i})});const j=()=>{},N=()=>{M.value=M.value==="desc"?"asc":"desc"},C=J(()=>{let w=[...n.reports];return k.value&&(w=w.filter(o=>o.status===k.value)),w.sort((o,i)=>{const b=new Date(o.uploaded_at),u=new Date(i.uploaded_at);return M.value==="desc"?u-b:b-u}),w}),L=J(()=>k.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),p=w=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[w]||w,I=w=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[w]||"info",E=async({action:w,report:o})=>{switch(w){case"view":x("view",o.id);break;case"edit":x("edit",o.id);break;case"extract":x("extract",o.id);break;case"download":x("download",o.id);break;case"delete":try{await Ze.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),x("delete",o.id)}catch{}break}};return(w,o)=>{const i=m("el-option"),b=m("el-select"),u=m("el-icon"),P=m("el-button"),W=m("el-table-column"),V=m("el-tag"),Z=m("el-dropdown-item"),le=m("el-dropdown-menu"),re=m("el-dropdown"),ie=m("el-table"),ue=m("el-card"),_=m("el-empty"),s=Se("loading");return r(),U("div",Ct,[g("div",Et,[g("div",xt,[t(b,{modelValue:k.value,"onUpdate:modelValue":o[0]||(o[0]=a=>k.value=a),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:j},{default:e(()=>[t(i,{label:"Все статусы",value:""}),(r(),U(te,null,de(T,a=>t(i,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),g("div",St,[t(P,{type:M.value==="desc"?"primary":"default",size:"small",onClick:N},{default:e(()=>[t(u,null,{default:e(()=>[t(f(He))]),_:1}),v(" "+S(M.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),f(A)?ge((r(),U("div",$t,[(r(!0),U(te,null,de(C.value,a=>(r(),y(ue,{key:a.id,class:"report-card",shadow:"hover"},{header:e(()=>[g("div",It,[g("div",Vt,[a.status==="PROCESSING"?(r(),y(u,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(f(ye))]),_:1})):a.status==="EXTRACTED"?(r(),y(u,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(f(be))]),_:1})):a.status==="FAILED"?(r(),y(u,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(f(ke))]),_:1})):(r(),y(u,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(f(Ce))]),_:1})),t(V,{type:I(a.status),size:"small"},{default:e(()=>[v(S(p(a.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[g("div",zt,[a.status==="EXTRACTED"?(r(),y(P,{key:0,type:"success",size:"small",onClick:O=>E({action:"edit",report:a})},{default:e(()=>[t(u,null,{default:e(()=>[t(f(Me))]),_:1}),o[10]||(o[10]=v(" Редактировать ",-1))]),_:1},8,["onClick"])):z("",!0),a.status==="PROCESSING"||a.status==="EXTRACTED"?(r(),y(P,{key:1,type:"info",size:"small",onClick:O=>E({action:"view",report:a})},{default:e(()=>[t(u,null,{default:e(()=>[t(f($e))]),_:1}),o[11]||(o[11]=v(" Просмотр ",-1))]),_:1},8,["onClick"])):z("",!0),t(P,{type:"primary",size:"small",onClick:O=>E({action:"extract",report:a})},{default:e(()=>[t(u,null,{default:e(()=>[t(f(Ie))]),_:1}),v(" "+S(a.status==="FAILED"?"Повторить":a.status==="PROCESSING"?"Перезапустить":a.status==="EXTRACTED"?"Переизвлечь":"Извлечь"),1)]),_:2},1032,["onClick"]),t(P,{size:"small",onClick:O=>E({action:"download",report:a})},{default:e(()=>[t(u,null,{default:e(()=>[t(f(Ve))]),_:1}),o[12]||(o[12]=v(" Скачать ",-1))]),_:1},8,["onClick"]),t(P,{type:"danger",size:"small",onClick:O=>E({action:"delete",report:a})},{default:e(()=>[t(u,null,{default:e(()=>[t(f(Ee))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[g("div",Rt,[g("div",At,[o[8]||(o[8]=g("span",{class:"field-label"},"Файл:",-1)),g("span",Tt,S(a.file_ref?.filename||"Без названия"),1)]),g("div",Nt,[o[9]||(o[9]=g("span",{class:"field-label"},"Дата загрузки:",-1)),g("span",Ft,S(f(he)(a.uploaded_at)),1)])])]),_:2},1024))),128)),!C.value.length&&!l.loading?(r(),y(_,{key:0,description:L.value,"image-size":120},{default:e(()=>[k.value?z("",!0):(r(),y(P,{key:0,type:"primary",onClick:o[1]||(o[1]=a=>w.$emit("upload"))},{default:e(()=>[...o[13]||(o[13]=[v(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):z("",!0)])),[[s,l.loading]]):ge((r(),y(ie,{key:0,data:C.value,class:"report-list__table",stripe:"","empty-text":L.value},{default:e(()=>[t(W,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:a})=>[g("span",Dt,S(a.file_ref?.filename||"Без названия"),1)]),_:1}),t(W,{prop:"status",label:"Статус",width:"200"},{default:e(({row:a})=>[g("div",Mt,[a.status==="PROCESSING"?(r(),y(u,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(f(ye))]),_:1})):a.status==="EXTRACTED"?(r(),y(u,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(f(be))]),_:1})):a.status==="FAILED"?(r(),y(u,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(f(ke))]),_:1})):(r(),y(u,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(f(Ce))]),_:1})),t(V,{type:I(a.status),size:"default"},{default:e(()=>[v(S(p(a.status)),1)]),_:2},1032,["type"])])]),_:1}),t(W,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:a})=>[v(S(f(he)(a.uploaded_at)),1)]),_:1}),t(W,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:a})=>[t(re,{trigger:"click",onCommand:E},{dropdown:e(()=>[t(le,null,{default:e(()=>[a.status==="EXTRACTED"?(r(),y(Z,{key:0,command:{action:"edit",report:a}},{default:e(()=>[t(u,null,{default:e(()=>[t(f(Me))]),_:1}),o[4]||(o[4]=v(" Редактировать метрики ",-1))]),_:1},8,["command"])):z("",!0),a.status==="PROCESSING"||a.status==="EXTRACTED"?(r(),y(Z,{key:1,command:{action:"view",report:a}},{default:e(()=>[t(u,null,{default:e(()=>[t(f($e))]),_:1}),o[5]||(o[5]=v(" Просмотр метрик ",-1))]),_:1},8,["command"])):z("",!0),t(Z,{command:{action:"extract",report:a}},{default:e(()=>[t(u,null,{default:e(()=>[t(f(Ie))]),_:1}),v(" "+S(a.status==="FAILED"?"Повторить извлечение":a.status==="PROCESSING"?"Перезапустить извлечение":a.status==="EXTRACTED"?"Переизвлечь метрики":"Извлечь метрики"),1)]),_:2},1032,["command"]),t(Z,{divided:"",command:{action:"download",report:a}},{default:e(()=>[t(u,null,{default:e(()=>[t(f(Ve))]),_:1}),o[6]||(o[6]=v(" Скачать ",-1))]),_:1},8,["command"]),t(Z,{command:{action:"delete",report:a},class:"dropdown-item--danger"},{default:e(()=>[t(u,null,{default:e(()=>[t(f(Ee))]),_:1}),o[7]||(o[7]=v(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(P,{type:"primary",size:"small"},{default:e(()=>[o[3]||(o[3]=v(" Действия ",-1)),t(u,{class:"el-icon--right"},{default:e(()=>[t(f(Ke))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[s,l.loading]]),!C.value.length&&!l.loading&&!f(A)?(r(),y(_,{key:2,description:L.value,"image-size":120},{default:e(()=>[k.value?z("",!0):(r(),y(P,{key:0,type:"primary",onClick:o[2]||(o[2]=a=>w.$emit("upload"))},{default:e(()=>[...o[14]||(o[14]=[v(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):z("",!0)])}}},Ot=pe(Lt,[["__scopeId","data-v-5eecde76"]]),Pt={class:"metrics-drawer"},Ut={class:"drawer-actions"},Bt={key:1},Xt={key:1},Gt={__name:"ParticipantMetricsDrawer",props:{modelValue:{type:Boolean,required:!0},participantId:{type:String,required:!0},participantName:{type:String,required:!0}},emits:["update:modelValue"],setup(l,{emit:D}){const n=l,x=D,X=Ue(),$=h(!1),A=h([]),k=J(()=>X.metricDefs),M=J(()=>"Метрики ещё не извлечены. Загрузите и обработайте отчёты."),T=p=>{x("update:modelValue",p)},j=async()=>{try{await X.fetchMetricDefs({activeOnly:!0})}catch(p){console.error("Error loading metric definitions:",p)}},N=async()=>{$.value=!0;try{const p=await Pe.getMetrics(n.participantId);A.value=p.metrics||[]}catch(p){console.error("Error loading participant metrics:",p),q.error("Ошибка загрузки метрик участника")}finally{$.value=!1}},C=p=>{if(!p)return"—";const I=k.value?.find(w=>w.code===p);return lt(I,p,{warn:()=>{}})},L=p=>p>=.8?"var(--el-color-success)":p>=.6?"var(--el-color-warning)":"var(--el-color-danger)";return ae(()=>n.participantId,async p=>{p&&n.modelValue&&(await j(),await N())}),ae(()=>n.modelValue,async p=>{p&&n.participantId&&(await j(),await N())}),(p,I)=>{const E=m("el-icon"),w=m("el-button"),o=m("el-table-column"),i=m("el-tag"),b=m("el-table"),u=m("el-empty"),P=m("el-drawer"),W=Se("loading");return r(),y(P,{"model-value":l.modelValue,title:`Метрики участника: ${l.participantName}`,size:"70%",direction:"rtl","onUpdate:modelValue":T},{default:e(()=>[ge((r(),U("div",Pt,[g("div",Ut,[t(w,{type:"primary",size:"small",onClick:N},{default:e(()=>[t(E,null,{default:e(()=>[t(f(Fe))]),_:1}),I[0]||(I[0]=v(" Обновить ",-1))]),_:1})]),t(b,{data:A.value,stripe:"","empty-text":M.value},{default:e(()=>[t(o,{prop:"metric_code",label:"Код метрики",width:"200"}),t(o,{label:"Название метрики","min-width":"250"},{default:e(({row:V})=>[v(S(C(V.metric_code)),1)]),_:1}),t(o,{prop:"value",label:"Значение",width:"120"},{default:e(({row:V})=>[t(i,{type:"success"},{default:e(()=>[v(S(f(rt)(V.value)),1)]),_:2},1024)]),_:1}),t(o,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:V})=>[V.confidence!==null?(r(),U("span",{key:0,style:Qe({color:L(V.confidence)})},S((V.confidence*100).toFixed(0))+"% ",5)):(r(),U("span",Bt,"—"))]),_:1}),t(o,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:V})=>[v(S(f(he)(V.updated_at)),1)]),_:1}),t(o,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:V})=>[V.last_source_report_id?(r(),y(i,{key:0,size:"small"},{default:e(()=>[...I[1]||(I[1]=[v(" Из отчёта ",-1)])]),_:1})):(r(),U("span",Xt,"—"))]),_:1})]),_:1},8,["data","empty-text"]),!A.value.length&&!$.value?(r(),y(u,{key:0,description:M.value},null,8,["description"])):z("",!0)])),[[W,$.value]])]),_:1},8,["model-value","title"])}}},qt=pe(Gt,[["__scopeId","data-v-81d85b13"]]),jt={class:"participant-detail"},Jt={class:"card-header"},Wt={class:"header-actions"},Ht={class:"section-header"},Kt={key:0,class:"batch-files-list"},Zt={class:"batch-files-header"},Qt={class:"batch-file-info"},Yt={class:"batch-file-name"},ea={class:"batch-file-size"},ta={key:0,class:"batch-file-error"},Ae=20*1024*1024,we=10,aa={__name:"ParticipantDetailView",setup(l){const D=Le(),n=ze(),x=nt(),X=Ue(),$=h(!1),A=h(!1),{isMobile:k}=Oe(),M=h(!1),T=J(()=>x.currentParticipant),j=h([]),N=h(null);J(()=>X.metricDefs);const C=h(null),L=J(()=>j.value.some(d=>d.status==="PROCESSING")),p=J(()=>N.value&&j.value.find(c=>c.id===N.value)?.status||null),I=J(()=>N.value&&j.value.find(c=>c.id===N.value)?.extract_warning||null),E=h(!1),w=h(!1),o=h(!1),i=h(null),b=h([]),u=h([]);let P=0;const W=async()=>{$.value=!0;try{await x.getParticipant(n.params.id)}catch{q.error("Участник не найден"),D.push("/participants")}finally{$.value=!1}},V=async({silent:d=!1}={})=>{d||(A.value=!0);try{const c=await Pe.getReports(n.params.id);j.value=c.items||[]}catch(c){console.error("Error loading reports:",c),q.error("Ошибка загрузки списка отчётов")}finally{d||(A.value=!1)}},Z=async()=>{try{await X.fetchMetricDefs({activeOnly:!0})}catch(d){console.error("Error loading metric definitions:",d)}},le=d=>d<1024?d+" B":d<1024*1024?(d/1024).toFixed(1)+" KB":(d/(1024*1024)).toFixed(1)+" MB",re=d=>d.name.toLowerCase().endsWith(".docx")?d.size>Ae?`Размер файла превышает ${le(Ae)}`:null:"Только файлы формата .docx",ie=(d,c)=>{const G=d.raw;if(u.value.length>=we){q.warning(`Максимальное количество файлов: ${we}`),i.value&&i.value.clearFiles();return}const F=re(G);if(F){q.error(F),i.value&&i.value.clearFiles();return}u.value.push({id:++P,file:G,name:G.name,size:G.size,status:"pending",progress:0,error:null,reportId:null}),i.value&&i.value.clearFiles()},ue=d=>{u.value=u.value.filter(c=>c.id!==d)},_=async d=>{d.status="uploading",d.progress=0;try{const c=await me.upload(n.params.id,d.file);d.status="success",d.reportId=c.id}catch(c){d.status="error",d.error=c.response?.data?.detail||"Ошибка загрузки"}},s=async()=>{const d=u.value.filter(c=>c.status==="pending");if(d.length===0){q.warning("Нет файлов для загрузки");return}M.value=!0;try{await Promise.allSettled(d.map(F=>_(F)));const c=u.value.filter(F=>F.status==="success").length,G=u.value.filter(F=>F.status==="error").length;G===0?(q.success(`Загружено ${c} отчётов`),E.value=!1,a()):q.warning(`Загружено: ${c}, ошибок: ${G}`),await V()}finally{M.value=!1}},a=()=>{u.value=[],b.value=[],i.value&&i.value.clearFiles()},O=async d=>{try{const c=await me.download(d),G=window.URL.createObjectURL(new Blob([c.data])),F=document.createElement("a");F.href=G,F.setAttribute("download",`report_${d}.docx`),document.body.appendChild(F),F.click(),F.remove(),window.URL.revokeObjectURL(G),q.success("Отчёт скачан")}catch{q.error("Ошибка скачивания отчёта")}},K=async d=>{try{await me.extract(d),q.success("Извлечение метрик запущено"),await V()}catch{q.error("Ошибка запуска извлечения метрик")}},H=()=>{C.value||(C.value=setInterval(async()=>{try{await V({silent:!0})}catch(d){console.error("Auto-refresh error:",d)}},3e3))},Q=()=>{C.value&&(clearInterval(C.value),C.value=null)};ae(L,d=>{d?H():Q()});const Y=async d=>{N.value=d,await et(),w.value=!0},ce=async()=>{q.success("Метрики обновлены"),await V({silent:!0})},se=async d=>{try{await me.delete(d),q.success("Отчёт удалён"),await V()}catch{q.error("Ошибка удаления отчёта")}};return xe(async()=>{await Promise.all([W(),V(),Z()])}),Ne(()=>{Q()}),(d,c)=>{const G=m("el-button"),F=m("el-icon"),ne=m("el-descriptions-item"),B=m("el-descriptions"),fe=m("el-card"),Be=m("el-upload"),De=m("el-dialog"),Xe=Se("loading");return r(),y(tt,null,{default:e(()=>[ge((r(),U("div",jt,[T.value?(r(),y(fe,{key:0,class:"detail-card"},{header:e(()=>[g("div",Jt,[g("h2",null,S(T.value.full_name),1),g("div",Wt,[t(G,{onClick:c[0]||(c[0]=R=>f(D).back())},{default:e(()=>[...c[8]||(c[8]=[v(" Назад ",-1)])]),_:1}),t(G,{type:"info",onClick:c[1]||(c[1]=R=>o.value=!0)},{default:e(()=>[t(F,null,{default:e(()=>[t(f(Ye))]),_:1}),c[9]||(c[9]=v(" Метрики ",-1))]),_:1})])])]),default:e(()=>[t(B,{column:f(k)?1:2,border:""},{default:e(()=>[t(ne,{label:"ФИО"},{default:e(()=>[v(S(T.value.full_name),1)]),_:1}),t(ne,{label:"Дата рождения"},{default:e(()=>[v(S(T.value.birth_date||"Не указана"),1)]),_:1}),t(ne,{label:"Внешний ID"},{default:e(()=>[v(S(T.value.external_id||"Не указан"),1)]),_:1}),t(ne,{label:"Дата создания"},{default:e(()=>[v(S(f(he)(T.value.created_at)),1)]),_:1})]),_:1},8,["column"])]),_:1})):z("",!0),t(fe,{class:"section-card"},{header:e(()=>[g("div",Ht,[c[11]||(c[11]=g("h3",null,"Отчёты",-1)),t(G,{type:"primary",onClick:c[2]||(c[2]=R=>E.value=!0)},{default:e(()=>[t(F,null,{default:e(()=>[t(f(Re))]),_:1}),c[10]||(c[10]=v(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(Ot,{reports:j.value,loading:A.value,onView:Y,onEdit:Y,onExtract:K,onDownload:O,onDelete:se,onUpload:c[3]||(c[3]=R=>E.value=!0)},null,8,["reports","loading"])]),_:1}),t(De,{modelValue:E.value,"onUpdate:modelValue":c[5]||(c[5]=R=>E.value=R),title:"Загрузить отчёты",width:f(k)?"95%":"600px","destroy-on-close":"",onClose:a},{footer:e(()=>[t(G,{onClick:c[4]||(c[4]=R=>E.value=!1)},{default:e(()=>[...c[14]||(c[14]=[v(" Отмена ",-1)])]),_:1}),t(G,{type:"primary",loading:M.value,disabled:!u.value.some(R=>R.status==="pending"),onClick:s},{default:e(()=>[v(" Загрузить все ("+S(u.value.filter(R=>R.status==="pending").length)+") ",1)]),_:1},8,["loading","disabled"])]),default:e(()=>[t(Be,{ref_key:"uploadRef",ref:i,"auto-upload":!1,multiple:"",accept:".docx","on-change":ie,"show-file-list":!1,drag:""},{tip:e(()=>[...c[12]||(c[12]=[g("div",{class:"el-upload__tip"}," Только .docx файлы, макс. 20 МБ, до 10 файлов ",-1)])]),default:e(()=>[t(F,{class:"el-icon--upload"},{default:e(()=>[t(f(Re))]),_:1}),c[13]||(c[13]=g("div",{class:"el-upload__text"},[v(" Перетащите файлы сюда или "),g("em",null,"нажмите для выбора")],-1))]),_:1},512),u.value.length?(r(),U("div",Kt,[g("div",Zt," Выбрано файлов: "+S(u.value.length)+"/"+S(we),1),(r(!0),U(te,null,de(u.value,R=>(r(),U("div",{key:R.id,class:Te(["batch-file-item","batch-file-item--"+R.status])},[R.status==="pending"?(r(),y(F,{key:0,class:"batch-file-icon"},{default:e(()=>[t(f(Ce))]),_:1})):R.status==="uploading"?(r(),y(F,{key:1,class:"batch-file-icon is-loading"},{default:e(()=>[t(f(ye))]),_:1})):R.status==="success"?(r(),y(F,{key:2,class:"batch-file-icon batch-file-icon--success"},{default:e(()=>[t(f(be))]),_:1})):R.status==="error"?(r(),y(F,{key:3,class:"batch-file-icon batch-file-icon--error"},{default:e(()=>[t(f(ke))]),_:1})):z("",!0),g("div",Qt,[g("span",Yt,S(R.name),1),g("span",ea,S(le(R.size)),1),R.error?(r(),U("span",ta,S(R.error),1)):z("",!0)]),R.status==="pending"||R.status==="error"?(r(),y(G,{key:4,type:"danger",icon:f(Ee),circle:"",size:"small",onClick:la=>ue(R.id)},null,8,["icon","onClick"])):z("",!0)],2))),128))])):z("",!0)]),_:1},8,["modelValue","width"]),t(De,{modelValue:w.value,"onUpdate:modelValue":c[6]||(c[6]=R=>w.value=R),title:"Метрики отчёта",width:"90%",top:"5vh","destroy-on-close":""},{default:e(()=>[N.value?(r(),y(kt,{key:0,"report-id":N.value,"report-status":p.value,"report-extract-warning":I.value,onMetricsUpdated:ce},null,8,["report-id","report-status","report-extract-warning"])):z("",!0)]),_:1},8,["modelValue"]),t(qt,{modelValue:o.value,"onUpdate:modelValue":c[7]||(c[7]=R=>o.value=R),"participant-id":T.value?.id,"participant-name":T.value?.full_name},null,8,["modelValue","participant-id","participant-name"])])),[[Xe,$.value]])]),_:1})}}},ca=pe(aa,[["__scopeId","data-v-a6d5aaa7"]]);export{ca as default};
