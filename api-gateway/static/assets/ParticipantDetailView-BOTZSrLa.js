import{O as Z,P as st,m as b,Q as j,D as nt,p as re,r as v,c as T,o as n,f as t,x as z,R as ot,w as e,u as m,S as rt,K as it,z as Re,B as w,F as ae,H as Te,T as He,v as g,e as _,a as d,C as oe,U as Ce,V as Ne,E as U,q as Ke,d as Ze,I as ze,J as _e,W as ut,k as Ie,X as Ve,g as Fe,Y as ct,Z as Be,_ as Xe,h as Ge,$ as qe,a0 as Ae,N as dt,L as pt,a1 as ft,a2 as je,a3 as mt,G as _t}from"./index-CLa57XdF.js";import{A as vt}from"./AppLayout-CgNgEes3.js";import{_ as ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{m as be,f as gt,g as yt}from"./metricNames-BxY4wRfG.js";import{f as ht,a as ve}from"./dateFormat-Bky3s5gS.js";import{u as Qe}from"./useResponsive-PLxFU8ar.js";import{p as Ye}from"./participants-8uyslejd.js";import{u as wt}from"./participants-B8TgiyCd.js";const we={async upload(s,k){const o=new FormData;return o.append("file",k),(await Z.post(`/participants/${s}/reports`,o,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(s){return await Z.get(`/reports/${s}/download`,{responseType:"blob"})},async getById(s){return(await Z.get(`/reports/${s}`)).data},async delete(s){return(await Z.delete(`/reports/${s}`)).data},async extract(s){return(await Z.post(`/reports/${s}/extract`)).data},async getMetrics(s){return(await Z.get(`/reports/${s}/metrics`)).data},async getList(s){return(await Z.get(`/participants/${s}/reports`)).data}},et=st("metrics",()=>{const s=b([]),k=b(!1),o=b(null),$=b(null),q=300*1e3,F=j(()=>$.value?Date.now()-$.value>q:!0),N=j(()=>s.value.length>0);async function E({force:p=!1,activeOnly:M=!1}={}){if(!p&&N.value&&!F.value)return s.value;if(k.value)return new Promise(V=>{const D=setInterval(()=>{k.value||(clearInterval(D),V(s.value))},50)});k.value=!0,o.value=null;try{const V=await be.listMetricDefs(M);return s.value=V.items||[],$.value=Date.now(),s.value}catch(V){const D=nt(V,"Ошибка загрузки метрик");throw o.value=D.message,V.normalizedError=D,V}finally{k.value=!1}}function R(p){return s.value.find(M=>M.id===p)}function P(p){const M=R(p);return M?.name_ru||M?.name||p}function H(){$.value=null}function B(p){const M=s.value.findIndex(V=>V.id===p.id);M!==-1&&(s.value[M]=p)}function C(p){s.value=s.value.filter(M=>M.id!==p)}function A(p){s.value.push(p)}return{metricDefs:s,loading:k,error:o,isStale:F,hasData:N,fetchMetricDefs:E,getMetricDefById:R,getMetricName:P,invalidateCache:H,updateInCache:B,removeFromCache:C,addToCache:A}});function ke(s,k=1){if(s==null||s==="")return"";const o=typeof s=="string"?parseFloat(s):s;return isNaN(o)?"":o.toLocaleString("ru-RU",{minimumFractionDigits:k,maximumFractionDigits:k})}function ce(s){if(s==null||s==="")return null;const o=String(s).trim().replace(",","."),$=parseFloat(o);return isNaN($)?null:$}function bt(s){return ce(s)}function kt(s,k=1){return ke(s,k)}const Ct={key:0,class:"error-message"},xt={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(s,{emit:k}){const o=s,$=k,q=b(null),F=b(""),N=b(!1),E=b(!1),R=b(""),P=j(()=>ce(F.value)),H=j(()=>{const c=P.value;return c===null||c<=o.min}),B=j(()=>{const c=P.value;return c===null||c>=o.max}),C=c=>{if(c==null||c===""){F.value="";return}N.value?F.value=String(c).replace(".",","):F.value=ke(c,o.precision)},A=c=>{if(c==null||c==="")return E.value=!1,R.value="",!0;const x=ce(c);return x===null?(E.value=!0,R.value="Некорректное число",!1):x<o.min?(E.value=!0,R.value=`Значение должно быть не меньше ${ke(o.min,o.precision)}`,!1):x>o.max?(E.value=!0,R.value=`Значение должно быть не больше ${ke(o.max,o.precision)}`,!1):(E.value=!1,R.value="",!0)},p=c=>{const x=c.replace(/[^\d,.-]/g,"");let f=!1;const I=x.split("").filter(S=>S===","||S==="."?f?!1:(f=!0,!0):!0).join("").replace(".",",");F.value=I;const J=ce(I);J!==null?$("update:modelValue",J):(I===""||I==="-")&&$("update:modelValue",null)},M=()=>{N.value=!1;const c=ce(F.value);if(A(F.value)){if(c!==null){const x=Math.round(c*Math.pow(10,o.precision))/Math.pow(10,o.precision),f=Math.max(o.min,Math.min(o.max,x));$("update:modelValue",f),C(f),$("change",f)}}else if(c!==null&&(c<o.min||c>o.max)){const x=Math.max(o.min,Math.min(o.max,c));$("update:modelValue",x),C(x),$("change",x),E.value=!1,R.value=""}$("blur")},V=()=>{N.value=!0,P.value!==null&&(F.value=String(P.value).replace(".",","))},D=()=>{const c=P.value||0,x=Math.min(o.max,c+o.step),f=Math.round(x*Math.pow(10,o.precision))/Math.pow(10,o.precision);$("update:modelValue",f),$("change",f),C(f)},u=()=>{const c=P.value||0,x=Math.max(o.min,c-o.step),f=Math.round(x*Math.pow(10,o.precision))/Math.pow(10,o.precision);$("update:modelValue",f),$("change",f),C(f)};return re(()=>o.modelValue,c=>{C(c)},{immediate:!0}),C(o.modelValue),(c,x)=>{const f=v("el-button"),I=v("el-button-group"),J=v("el-input");return n(),T(ae,null,[t(J,{ref_key:"inputRef",ref:q,modelValue:F.value,"onUpdate:modelValue":x[0]||(x[0]=S=>F.value=S),placeholder:s.placeholder,disabled:s.disabled,class:Re({"is-invalid":E.value}),onInput:p,onBlur:M,onFocus:V},ot({_:2},[s.showControls?{name:"append",fn:e(()=>[t(I,null,{default:e(()=>[t(f,{icon:m(rt),disabled:s.disabled||H.value,onClick:u},null,8,["icon","disabled"]),t(f,{icon:m(it),disabled:s.disabled||B.value,onClick:D},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),E.value?(n(),T("div",Ct,w(R.value),1)):z("",!0)],64)}}},Et=ge(xt,[["__scopeId","data-v-ff39cd14"]]),St={class:"card-header"},$t={class:"card-header-left"},Dt={class:"card-header-actions"},Mt={class:"metrics-filter"},Rt={class:"metrics-stats"},It={class:"metrics-count"},Vt={key:0,class:"metric-description"},Ft={key:0,class:"metrics-info"},At={class:"info-row"},Tt={key:0,class:"info-row"},Nt={__name:"MetricsEditor",props:{reportId:{type:String,required:!0},reportStatus:{type:String,default:null},reportExtractWarning:{type:String,default:null}},emits:["metrics-updated"],setup(s,{emit:k}){const o=s,$=k,q=b(!1),F=b(!1),N=b(!1),E=b(null),R=b(!1),P=b(0),H=b(0),B=b([]),C=b([]),A=b({metrics:{}}),p=b({}),M=b("metrics"),V=b(null),D=j(()=>{if(!B.value||B.value.length===0)return[];if(R.value)return B.value;const h=new Set(C.value.filter(r=>{const a=parseFloat(String(r.value).replace(",","."));return!isNaN(a)&&a>0}).map(r=>r.metric_def_id));return B.value.filter(r=>{const a=h.has(r.id),L=A.value.metrics[r.id],K=L!=null&&L!==""&&parseFloat(String(L).replace(",","."))>0;return a||K})}),u=j(()=>!C.value||C.value.length===0?[]:[...new Set(C.value.map(h=>h.source))]),c=j(()=>{if(!C.value||C.value.length===0)return null;const h=C.value.map(r=>r.updated_at||r.created_at).filter(Boolean).map(r=>new Date(r));return h.length===0?null:new Date(Math.max(...h))}),x=async()=>{q.value=!0,E.value=null;try{const h=await be.getMetricTemplate(o.reportId);P.value=h.filled_count||0,H.value=h.missing_count||0;const r=h.items||[];C.value=r.filter(a=>a.value!==null).map(a=>({metric_def_id:a.metric_def.id,value:a.value,source:a.source,confidence:a.confidence,notes:a.notes,updated_at:a.updated_at})),B.value=r.map(a=>({id:a.metric_def.id,code:a.metric_def.code,name:a.metric_def.name,name_ru:a.metric_def.name_ru,unit:a.metric_def.unit,min_value:a.metric_def.min_value,max_value:a.metric_def.max_value,description:a.metric_def.description})),A.value.metrics={},r.forEach(a=>{const L=a.metric_def.id;a.value!==null?A.value.metrics[L]=ce(a.value):A.value.metrics[L]=null}),p.value=JSON.parse(JSON.stringify(A.value.metrics))}catch(h){console.error("Failed to load metrics:",h),E.value="Не удалось загрузить метрики"}finally{q.value=!1}},f=async()=>{await x(),U.success("Метрики обновлены")},I=()=>{V.value||(V.value=setInterval(async()=>{await x()},5e3))},J=()=>{V.value&&(clearInterval(V.value),V.value=null)},S=()=>{N.value=!0,R.value=!0,p.value=JSON.parse(JSON.stringify(A.value.metrics))},Y=()=>{A.value.metrics=JSON.parse(JSON.stringify(p.value)),N.value=!1,E.value=null},de=async()=>{F.value=!0,E.value=null;try{const h=[],r=[];for(const[W,ee]of Object.entries(A.value.metrics)){const le=p.value[W],fe=le!=null&&le!=="";if(ee!=null&&ee!==""){const ue=bt(ee);ue!==null&&h.push({metric_def_id:W,value:ue,source:"MANUAL",notes:null})}else fe&&r.push(W)}const L=(await Promise.allSettled(r.map(W=>be.clearExtractedMetric(o.reportId,W)))).filter(W=>W.status==="fulfilled"||W.status==="rejected"&&W.reason?.response?.status===404).length;h.length>0&&await be.bulkCreateExtractedMetrics(o.reportId,h);const K=[];h.length>0&&K.push(`сохранено: ${h.length}`),L>0&&K.push(`сброшено: ${L}`),K.length===0?U.info("Нет изменений для сохранения"):U.success(`Метрики обновлены (${K.join(", ")})`),N.value=!1,await x(),$("metrics-updated")}catch(h){console.error("Failed to save metrics:",h);let r="Не удалось сохранить метрики";h.response?.data?.detail&&(typeof h.response.data.detail=="string"?r=h.response.data.detail:Array.isArray(h.response.data.detail)&&(r=h.response.data.detail.map(a=>a.msg||a.message).join(", "))),E.value=r,U.error(r)}finally{F.value=!1}},Q=h=>{switch(h){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},pe=h=>{switch(h){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return h}},ie=ht;return Te(async()=>{}),He(()=>{J()}),re(()=>o.reportId,async h=>{h&&await x()}),re(()=>o.reportStatus,async(h,r)=>{r||await x(),h==="PROCESSING"?(I(),r&&r!=="PROCESSING"&&await x()):(J(),h==="EXTRACTED"&&r&&r!=="EXTRACTED"&&await x())},{immediate:!0}),(h,r)=>{const a=v("el-icon"),L=v("el-tag"),K=v("el-button"),W=v("el-alert"),ee=v("el-switch"),le=v("el-form-item"),fe=v("el-col"),ue=v("el-row"),ye=v("el-form"),he=v("el-divider"),xe=v("el-tab-pane"),Ee=v("el-tabs"),Se=v("el-card");return n(),g(Se,{class:"metrics-editor"},{header:e(()=>[d("div",St,[d("div",$t,[r[5]||(r[5]=d("span",null,"Метрики отчёта",-1)),s.reportStatus==="PROCESSING"?(n(),g(L,{key:0,type:"warning",size:"small",class:"status-tag"},{default:e(()=>[t(a,{class:"is-loading"},{default:e(()=>[t(m(Ce))]),_:1}),r[3]||(r[3]=_(" Извлечение... ",-1))]),_:1})):s.reportStatus==="EXTRACTED"?(n(),g(L,{key:1,type:"success",size:"small",class:"status-tag"},{default:e(()=>[...r[4]||(r[4]=[_(" Извлечено ",-1)])]),_:1})):z("",!0)]),d("div",Dt,[N.value?z("",!0):(n(),g(K,{key:0,size:"small",loading:q.value,onClick:f},{default:e(()=>[t(a,null,{default:e(()=>[t(m(Ne))]),_:1}),r[6]||(r[6]=_(" Обновить ",-1))]),_:1},8,["loading"])),N.value?(n(),T(ae,{key:2},[t(K,{size:"small",onClick:Y},{default:e(()=>[...r[8]||(r[8]=[_(" Отмена ",-1)])]),_:1}),t(K,{type:"primary",size:"small",loading:F.value,onClick:de},{default:e(()=>[...r[9]||(r[9]=[_(" Сохранить ",-1)])]),_:1},8,["loading"])],64)):(n(),g(K,{key:1,type:"primary",size:"small",onClick:S},{default:e(()=>[...r[7]||(r[7]=[_(" Редактировать ",-1)])]),_:1}))])])]),default:e(()=>[E.value?(n(),g(W,{key:0,type:"error",title:E.value,closable:"",style:{"margin-bottom":"16px"},onClose:r[0]||(r[0]=X=>E.value=null)},null,8,["title"])):z("",!0),o.reportExtractWarning&&o.reportStatus==="EXTRACTED"?(n(),g(W,{key:1,type:"warning",title:o.reportExtractWarning,closable:!1,style:{"margin-bottom":"16px"}},null,8,["title"])):z("",!0),!C.value||C.value.length===0?(n(),g(W,{key:2,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...r[10]||(r[10]=[_(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):z("",!0),t(Ee,{modelValue:M.value,"onUpdate:modelValue":r[2]||(r[2]=X=>M.value=X),type:"card"},{default:e(()=>[t(xe,{label:"Метрики",name:"metrics"},{default:e(()=>[d("div",Mt,[t(ee,{modelValue:R.value,"onUpdate:modelValue":r[1]||(r[1]=X=>R.value=X),"active-text":"Показать все метрики","inactive-text":"Только заполненные"},null,8,["modelValue"]),d("div",Rt,[t(L,{type:"success",size:"small"},{default:e(()=>[_(" Заполнено: "+w(P.value),1)]),_:1}),t(L,{type:"info",size:"small"},{default:e(()=>[_(" Не заполнено: "+w(H.value),1)]),_:1}),d("span",It," Показано: "+w(D.value.length)+" из "+w(B.value.length),1)])]),t(ye,{ref:"formRef",model:A.value,"label-position":"top",disabled:!N.value},{default:e(()=>[t(ue,{gutter:20},{default:e(()=>[(n(!0),T(ae,null,oe(D.value,X=>(n(),g(fe,{key:X.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(le,{label:m(gt)(X),prop:`metrics.${X.id}`},{default:e(()=>[t(Et,{modelValue:A.value.metrics[X.id],"onUpdate:modelValue":$e=>A.value.metrics[X.id]=$e,min:X.min_value||1,max:X.max_value||10,precision:1,step:.1,disabled:!N.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),X.description?(n(),T("div",Vt,w(X.description),1)):z("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),C.value&&C.value.length>0?(n(),T("div",Ft,[t(he),d("div",At,[r[11]||(r[11]=d("span",{class:"info-label"},"Источник данных:",-1)),(n(!0),T(ae,null,oe(u.value,X=>(n(),g(L,{key:X,type:Q(X),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[_(w(pe(X)),1)]),_:2},1032,["type"]))),128))]),c.value?(n(),T("div",Tt,[r[12]||(r[12]=d("span",{class:"info-label"},"Последнее обновление:",-1)),d("span",null,w(m(ie)(c.value)),1)])):z("",!0)])):z("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},zt=ge(Nt,[["__scopeId","data-v-b43d5796"]]),Lt={class:"report-list"},Ot={class:"report-list__controls"},Pt={class:"controls-left"},Ut={class:"controls-right"},Bt={class:"filename"},Xt={class:"status-cell"},Gt={key:1,class:"report-list__cards"},qt={class:"report-card__header"},jt={class:"report-card__status"},Jt={class:"report-card__body"},Wt={class:"report-card__field"},Ht={class:"field-value field-value--filename"},Kt={class:"report-card__field"},Zt={class:"field-value"},Qt={class:"report-card__actions"},Yt={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(s,{emit:k}){const o=s,$=k,q=Ke(),F=Ze(),{isMobile:N}=Qe();Te(()=>{q.query.status&&(E.value=q.query.status),q.query.sort&&(R.value=q.query.sort)});const E=b(""),R=b("desc"),P=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];re([E,R],([D,u])=>{const c={...q.query};D?c.status=D:delete c.status,u?c.sort=u:delete c.sort,F.replace({query:c})});const H=()=>{},B=()=>{R.value=R.value==="desc"?"asc":"desc"},C=j(()=>{let D=[...o.reports];return E.value&&(D=D.filter(u=>u.status===E.value)),D.sort((u,c)=>{const x=new Date(u.uploaded_at),f=new Date(c.uploaded_at);return R.value==="desc"?f-x:x-f}),D}),A=j(()=>E.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),p=D=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[D]||D,M=D=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[D]||"info",V=async({action:D,report:u})=>{switch(D){case"view":$("view",u.id);break;case"edit":$("edit",u.id);break;case"extract":$("extract",u.id);break;case"download":$("download",u.id);break;case"delete":try{await dt.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),$("delete",u.id)}catch{}break}};return(D,u)=>{const c=v("el-option"),x=v("el-select"),f=v("el-icon"),I=v("el-button"),J=v("el-table-column"),S=v("el-tag"),Y=v("el-dropdown-item"),de=v("el-dropdown-menu"),Q=v("el-dropdown"),pe=v("el-table"),ie=v("el-card"),h=v("el-empty"),r=ze("loading");return n(),T("div",Lt,[d("div",Ot,[d("div",Pt,[t(x,{modelValue:E.value,"onUpdate:modelValue":u[0]||(u[0]=a=>E.value=a),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:H},{default:e(()=>[t(c,{label:"Все статусы",value:""}),(n(),T(ae,null,oe(P,a=>t(c,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),d("div",Ut,[t(I,{type:R.value==="desc"?"primary":"default",size:"small",onClick:B},{default:e(()=>[t(f,null,{default:e(()=>[t(m(ut))]),_:1}),_(" "+w(R.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),m(N)?_e((n(),T("div",Gt,[(n(!0),T(ae,null,oe(C.value,a=>(n(),g(ie,{key:a.id,class:"report-card",shadow:"hover"},{header:e(()=>[d("div",qt,[d("div",jt,[a.status==="PROCESSING"?(n(),g(f,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(m(Ce))]),_:1})):a.status==="EXTRACTED"?(n(),g(f,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(m(Ie))]),_:1})):a.status==="FAILED"?(n(),g(f,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(m(Ve))]),_:1})):(n(),g(f,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(m(Fe))]),_:1})),t(S,{type:M(a.status),size:"small"},{default:e(()=>[_(w(p(a.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[d("div",Qt,[a.status==="EXTRACTED"?(n(),g(I,{key:0,type:"success",size:"small",onClick:L=>V({action:"edit",report:a})},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Be))]),_:1}),u[10]||(u[10]=_(" Редактировать ",-1))]),_:1},8,["onClick"])):z("",!0),a.status==="PROCESSING"||a.status==="EXTRACTED"?(n(),g(I,{key:1,type:"info",size:"small",onClick:L=>V({action:"view",report:a})},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Xe))]),_:1}),u[11]||(u[11]=_(" Просмотр ",-1))]),_:1},8,["onClick"])):z("",!0),t(I,{type:"primary",size:"small",onClick:L=>V({action:"extract",report:a})},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Ge))]),_:1}),_(" "+w(a.status==="FAILED"?"Повторить":a.status==="PROCESSING"?"Перезапустить":a.status==="EXTRACTED"?"Переизвлечь":"Извлечь"),1)]),_:2},1032,["onClick"]),t(I,{size:"small",onClick:L=>V({action:"download",report:a})},{default:e(()=>[t(f,null,{default:e(()=>[t(m(qe))]),_:1}),u[12]||(u[12]=_(" Скачать ",-1))]),_:1},8,["onClick"]),t(I,{type:"danger",size:"small",onClick:L=>V({action:"delete",report:a})},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Ae))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[d("div",Jt,[d("div",Wt,[u[8]||(u[8]=d("span",{class:"field-label"},"Файл:",-1)),d("span",Ht,w(a.file_ref?.filename||"Без названия"),1)]),d("div",Kt,[u[9]||(u[9]=d("span",{class:"field-label"},"Дата загрузки:",-1)),d("span",Zt,w(m(ve)(a.uploaded_at)),1)])])]),_:2},1024))),128)),!C.value.length&&!s.loading?(n(),g(h,{key:0,description:A.value,"image-size":120},{default:e(()=>[E.value?z("",!0):(n(),g(I,{key:0,type:"primary",onClick:u[1]||(u[1]=a=>D.$emit("upload"))},{default:e(()=>[...u[13]||(u[13]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):z("",!0)])),[[r,s.loading]]):_e((n(),g(pe,{key:0,data:C.value,class:"report-list__table",stripe:"","empty-text":A.value},{default:e(()=>[t(J,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:a})=>[d("span",Bt,w(a.file_ref?.filename||"Без названия"),1)]),_:1}),t(J,{prop:"status",label:"Статус",width:"200"},{default:e(({row:a})=>[d("div",Xt,[a.status==="PROCESSING"?(n(),g(f,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(m(Ce))]),_:1})):a.status==="EXTRACTED"?(n(),g(f,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(m(Ie))]),_:1})):a.status==="FAILED"?(n(),g(f,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(m(Ve))]),_:1})):(n(),g(f,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(m(Fe))]),_:1})),t(S,{type:M(a.status),size:"default"},{default:e(()=>[_(w(p(a.status)),1)]),_:2},1032,["type"])])]),_:1}),t(J,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:a})=>[_(w(m(ve)(a.uploaded_at)),1)]),_:1}),t(J,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:a})=>[t(Q,{trigger:"click",onCommand:V},{dropdown:e(()=>[t(de,null,{default:e(()=>[a.status==="EXTRACTED"?(n(),g(Y,{key:0,command:{action:"edit",report:a}},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Be))]),_:1}),u[4]||(u[4]=_(" Редактировать метрики ",-1))]),_:1},8,["command"])):z("",!0),a.status==="PROCESSING"||a.status==="EXTRACTED"?(n(),g(Y,{key:1,command:{action:"view",report:a}},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Xe))]),_:1}),u[5]||(u[5]=_(" Просмотр метрик ",-1))]),_:1},8,["command"])):z("",!0),t(Y,{command:{action:"extract",report:a}},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Ge))]),_:1}),_(" "+w(a.status==="FAILED"?"Повторить извлечение":a.status==="PROCESSING"?"Перезапустить извлечение":a.status==="EXTRACTED"?"Переизвлечь метрики":"Извлечь метрики"),1)]),_:2},1032,["command"]),t(Y,{divided:"",command:{action:"download",report:a}},{default:e(()=>[t(f,null,{default:e(()=>[t(m(qe))]),_:1}),u[6]||(u[6]=_(" Скачать ",-1))]),_:1},8,["command"]),t(Y,{command:{action:"delete",report:a},class:"dropdown-item--danger"},{default:e(()=>[t(f,null,{default:e(()=>[t(m(Ae))]),_:1}),u[7]||(u[7]=_(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(I,{type:"primary",size:"small"},{default:e(()=>[u[3]||(u[3]=_(" Действия ",-1)),t(f,{class:"el-icon--right"},{default:e(()=>[t(m(ct))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[r,s.loading]]),!C.value.length&&!s.loading&&!m(N)?(n(),g(h,{key:2,description:A.value,"image-size":120},{default:e(()=>[E.value?z("",!0):(n(),g(I,{key:0,type:"primary",onClick:u[2]||(u[2]=a=>D.$emit("upload"))},{default:e(()=>[...u[14]||(u[14]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):z("",!0)])}}},ea=ge(Yt,[["__scopeId","data-v-5eecde76"]]),ta={class:"metrics-drawer"},aa={class:"drawer-actions"},la={key:1},sa={key:1},na={__name:"ParticipantMetricsDrawer",props:{modelValue:{type:Boolean,required:!0},participantId:{type:String,required:!0},participantName:{type:String,required:!0}},emits:["update:modelValue"],setup(s,{emit:k}){const o=s,$=k,q=et(),F=b(!1),N=b([]),E=j(()=>q.metricDefs),R=j(()=>"Метрики ещё не извлечены. Загрузите и обработайте отчёты."),P=p=>{$("update:modelValue",p)},H=async()=>{try{await q.fetchMetricDefs({activeOnly:!0})}catch(p){console.error("Error loading metric definitions:",p)}},B=async()=>{F.value=!0;try{const p=await Ye.getMetrics(o.participantId);N.value=p.metrics||[]}catch(p){console.error("Error loading participant metrics:",p),U.error("Ошибка загрузки метрик участника")}finally{F.value=!1}},C=p=>{if(!p)return"—";const M=E.value?.find(D=>D.code===p);return yt(M,p,{warn:()=>{}})},A=p=>p>=.8?"var(--el-color-success)":p>=.6?"var(--el-color-warning)":"var(--el-color-danger)";return re(()=>o.participantId,async p=>{p&&o.modelValue&&(await H(),await B())}),re(()=>o.modelValue,async p=>{p&&o.participantId&&(await H(),await B())}),(p,M)=>{const V=v("el-icon"),D=v("el-button"),u=v("el-table-column"),c=v("el-tag"),x=v("el-table"),f=v("el-empty"),I=v("el-drawer"),J=ze("loading");return n(),g(I,{"model-value":s.modelValue,title:`Метрики участника: ${s.participantName}`,size:"70%",direction:"rtl","onUpdate:modelValue":P},{default:e(()=>[_e((n(),T("div",ta,[d("div",aa,[t(D,{type:"primary",size:"small",onClick:B},{default:e(()=>[t(V,null,{default:e(()=>[t(m(Ne))]),_:1}),M[0]||(M[0]=_(" Обновить ",-1))]),_:1})]),t(x,{data:N.value,stripe:"","empty-text":R.value},{default:e(()=>[t(u,{prop:"metric_code",label:"Код метрики",width:"200"}),t(u,{label:"Название метрики","min-width":"250"},{default:e(({row:S})=>[_(w(C(S.metric_code)),1)]),_:1}),t(u,{prop:"value",label:"Значение",width:"120"},{default:e(({row:S})=>[t(c,{type:"success"},{default:e(()=>[_(w(m(kt)(S.value)),1)]),_:2},1024)]),_:1}),t(u,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:S})=>[S.confidence!==null?(n(),T("span",{key:0,style:pt({color:A(S.confidence)})},w((S.confidence*100).toFixed(0))+"% ",5)):(n(),T("span",la,"—"))]),_:1}),t(u,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:S})=>[_(w(m(ve)(S.updated_at)),1)]),_:1}),t(u,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:S})=>[S.last_source_report_id?(n(),g(c,{key:0,size:"small"},{default:e(()=>[...M[1]||(M[1]=[_(" Из отчёта ",-1)])]),_:1})):(n(),T("span",sa,"—"))]),_:1})]),_:1},8,["data","empty-text"]),!N.value.length&&!F.value?(n(),g(f,{key:0,description:R.value},null,8,["description"])):z("",!0)])),[[J,F.value]])]),_:1},8,["model-value","title"])}}},oa=ge(na,[["__scopeId","data-v-81d85b13"]]),Je={async getParticipantScores(s){return(await Z.get(`/scoring/participants/${s}`)).data},async recalculateParticipant(s,k=null){return(await Z.post(`/scoring/participants/${s}/recalculate`,k?{weight_table_ids:k}:{})).data},async calculateSingle(s,k){return(await Z.post(`/scoring/participants/${s}/calculate/${k}`)).data},async batchRecalculate({participantIds:s=null,weightTableIds:k=null}={}){return(await Z.post("/scoring/batch/recalculate",{participant_ids:s,weight_table_ids:k})).data}},ra={class:"participant-detail"},ia={class:"card-header"},ua={class:"header-actions"},ca={class:"section-header"},da={class:"section-header"},pa={class:"scoring-content"},fa={key:1,class:"scoring-cards"},ma={class:"scoring-card-header"},_a={class:"scoring-model-name"},va={class:"scoring-details"},ga={class:"scoring-row"},ya={class:"scoring-value"},ha={class:"scoring-row"},wa={key:1,class:"scoring-penalties"},ba={class:"penalties-header"},ka={class:"penalty-metric"},Ca={class:"penalty-info"},xa={class:"scoring-footer"},Ea={key:0,class:"batch-files-list"},Sa={class:"batch-files-header"},$a={class:"batch-file-info"},Da={class:"batch-file-name"},Ma={class:"batch-file-size"},Ra={key:0,class:"batch-file-error"},We=20*1024*1024,Me=10,Ia={__name:"ParticipantDetailView",setup(s){const k=Ze(),o=Ke(),$=wt(),q=et(),F=b(!1),N=b(!1),E=b(!1),R=b(!1),P=b([]),{isMobile:H}=Qe(),B=b(!1),C=j(()=>$.currentParticipant),A=b([]),p=b(null);j(()=>q.metricDefs);const M=b(null),V=j(()=>A.value.some(i=>i.status==="PROCESSING")),D=j(()=>p.value&&A.value.find(l=>l.id===p.value)?.status||null),u=j(()=>p.value&&A.value.find(l=>l.id===p.value)?.extract_warning||null),c=b(!1),x=b(!1),f=b(!1),I=b(null),J=b([]),S=b([]);let Y=0;const de=async()=>{F.value=!0;try{await $.getParticipant(o.params.id)}catch{U.error("Участник не найден"),k.push("/participants")}finally{F.value=!1}},Q=async({silent:i=!1}={})=>{i||(N.value=!0);try{const l=await Ye.getReports(o.params.id);A.value=l.items||[]}catch(l){console.error("Error loading reports:",l),U.error("Ошибка загрузки списка отчётов")}finally{i||(N.value=!1)}},pe=async()=>{try{await q.fetchMetricDefs({activeOnly:!0})}catch(i){console.error("Error loading metric definitions:",i)}},ie=i=>i<1024?i+" B":i<1024*1024?(i/1024).toFixed(1)+" KB":(i/(1024*1024)).toFixed(1)+" MB",h=[".docx",".pdf"],r=i=>{const l=i.name.toLowerCase();return h.some(G=>l.endsWith(G))?i.size>We?`Размер файла превышает ${ie(We)}`:null:"Только файлы формата .docx и .pdf"},a=(i,l)=>{const G=i.raw;if(S.value.length>=Me){U.warning(`Максимальное количество файлов: ${Me}`),I.value&&I.value.clearFiles();return}const O=r(G);if(O){U.error(O),I.value&&I.value.clearFiles();return}S.value.push({id:++Y,file:G,name:G.name,size:G.size,status:"pending",progress:0,error:null,reportId:null}),I.value&&I.value.clearFiles()},L=i=>{S.value=S.value.filter(l=>l.id!==i)},K=async i=>{i.status="uploading",i.progress=0;try{const l=await we.upload(o.params.id,i.file);i.status="success",i.reportId=l.id}catch(l){i.status="error",i.error=l.response?.data?.detail||"Ошибка загрузки"}},W=async()=>{const i=S.value.filter(l=>l.status==="pending");if(i.length===0){U.warning("Нет файлов для загрузки");return}B.value=!0;try{await Promise.allSettled(i.map(O=>K(O)));const l=S.value.filter(O=>O.status==="success").length,G=S.value.filter(O=>O.status==="error").length;G===0?(U.success(`Загружено ${l} отчётов`),c.value=!1,ee()):U.warning(`Загружено: ${l}, ошибок: ${G}`),await Q()}finally{B.value=!1}},ee=()=>{S.value=[],J.value=[],I.value&&I.value.clearFiles()},le=async i=>{try{const l=await we.download(i),G=l.headers?.["content-disposition"];let O=`report_${i}`;if(G){const te=G.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);te&&te[1]&&(O=te[1].replace(/['"]/g,""))}if(!O.includes(".")){const De=(l.headers?.["content-type"]||"").includes("pdf")?".pdf":".docx";O+=De}const se=window.URL.createObjectURL(new Blob([l.data])),ne=document.createElement("a");ne.href=se,ne.setAttribute("download",O),document.body.appendChild(ne),ne.click(),ne.remove(),window.URL.revokeObjectURL(se),U.success("Отчёт скачан")}catch{U.error("Ошибка скачивания отчёта")}},fe=async i=>{try{await we.extract(i),U.success("Извлечение метрик запущено"),await Q()}catch{U.error("Ошибка запуска извлечения метрик")}},ue=()=>{M.value||(M.value=setInterval(async()=>{try{await Q({silent:!0})}catch(i){console.error("Auto-refresh error:",i)}},3e3))},ye=()=>{M.value&&(clearInterval(M.value),M.value=null)};re(V,i=>{i?ue():ye()});const he=async i=>{p.value=i,await _t(),x.value=!0},xe=async()=>{U.success("Метрики обновлены"),await Q({silent:!0})},Ee=async i=>{try{await we.delete(i),U.success("Отчёт удалён"),await Q()}catch{U.error("Ошибка удаления отчёта")}},Se=async()=>{E.value=!0;try{const i=await Je.getParticipantScores(o.params.id);P.value=i.results||[]}catch(i){console.error("Error loading scoring:",i),P.value=[]}finally{E.value=!1}},X=async()=>{R.value=!0;try{const i=await Je.recalculateParticipant(o.params.id);P.value=i,U.success(`Скоринг рассчитан для ${i.length} моделей`)}catch(i){console.error("Error recalculating scoring:",i),U.error(i.response?.data?.detail||"Ошибка расчёта скоринга")}finally{R.value=!1}},$e=i=>{const l=parseFloat(i);return l>=7?"success":l>=5?"warning":"danger"};return Te(async()=>{await Promise.all([de(),Q(),pe(),Se()])}),He(()=>{ye()}),(i,l)=>{const G=v("el-button"),O=v("el-icon"),se=v("el-descriptions-item"),ne=v("el-descriptions"),te=v("el-card"),De=v("el-empty"),Le=v("el-tag"),tt=v("el-divider"),Oe=v("el-text"),at=v("el-upload"),Pe=v("el-dialog"),Ue=ze("loading");return n(),g(vt,null,{default:e(()=>[_e((n(),T("div",ra,[C.value?(n(),g(te,{key:0,class:"detail-card"},{header:e(()=>[d("div",ia,[d("h2",null,w(C.value.full_name),1),d("div",ua,[t(G,{onClick:l[0]||(l[0]=y=>m(k).back())},{default:e(()=>[...l[8]||(l[8]=[_(" Назад ",-1)])]),_:1}),t(G,{type:"info",onClick:l[1]||(l[1]=y=>f.value=!0)},{default:e(()=>[t(O,null,{default:e(()=>[t(m(ft))]),_:1}),l[9]||(l[9]=_(" Метрики ",-1))]),_:1})])])]),default:e(()=>[t(ne,{column:m(H)?1:2,border:""},{default:e(()=>[t(se,{label:"ФИО"},{default:e(()=>[_(w(C.value.full_name),1)]),_:1}),t(se,{label:"Дата рождения"},{default:e(()=>[_(w(C.value.birth_date||"Не указана"),1)]),_:1}),t(se,{label:"Внешний ID"},{default:e(()=>[_(w(C.value.external_id||"Не указан"),1)]),_:1}),t(se,{label:"Дата создания"},{default:e(()=>[_(w(m(ve)(C.value.created_at)),1)]),_:1})]),_:1},8,["column"])]),_:1})):z("",!0),t(te,{class:"section-card"},{header:e(()=>[d("div",ca,[l[11]||(l[11]=d("h3",null,"Отчёты",-1)),t(G,{type:"primary",onClick:l[2]||(l[2]=y=>c.value=!0)},{default:e(()=>[t(O,null,{default:e(()=>[t(m(je))]),_:1}),l[10]||(l[10]=_(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(ea,{reports:A.value,loading:N.value,onView:he,onEdit:he,onExtract:fe,onDownload:le,onDelete:Ee,onUpload:l[3]||(l[3]=y=>c.value=!0)},null,8,["reports","loading"])]),_:1}),t(te,{class:"section-card"},{header:e(()=>[d("div",da,[l[13]||(l[13]=d("h3",null,"Скоринг по моделям компетенций",-1)),t(G,{type:"primary",loading:R.value,onClick:X},{default:e(()=>[t(O,null,{default:e(()=>[t(m(Ne))]),_:1}),l[12]||(l[12]=_(" Пересчитать ",-1))]),_:1},8,["loading"])])]),default:e(()=>[_e((n(),T("div",pa,[!E.value&&P.value.length===0?(n(),g(De,{key:0,description:"Скоринг ещё не рассчитан. Нажмите «Пересчитать» для расчёта."})):(n(),T("div",fa,[(n(!0),T(ae,null,oe(P.value,y=>(n(),g(te,{key:y.id,class:"scoring-result-card",shadow:"hover"},{header:e(()=>[d("div",ma,[d("span",_a,w(y.prof_activity_name),1),t(Le,{type:$e(y.final_score),size:"large",class:"scoring-final-tag"},{default:e(()=>[_(w(parseFloat(y.final_score).toFixed(1)),1)]),_:2},1032,["type"])])]),default:e(()=>[d("div",va,[d("div",ga,[l[14]||(l[14]=d("span",{class:"scoring-label"},"Базовый балл:",-1)),d("span",ya,w(parseFloat(y.base_score).toFixed(2)),1)]),d("div",ha,[l[15]||(l[15]=d("span",{class:"scoring-label"},"Множитель штрафов:",-1)),d("span",{class:Re(["scoring-value",{"scoring-value--penalty":parseFloat(y.penalty_multiplier)<1}])}," × "+w(parseFloat(y.penalty_multiplier).toFixed(2)),3)]),y.penalties_applied&&y.penalties_applied.length>0?(n(),g(tt,{key:0})):z("",!0),y.penalties_applied&&y.penalties_applied.length>0?(n(),T("div",wa,[d("div",ba,[t(O,{color:"var(--el-color-warning)"},{default:e(()=>[t(m(mt))]),_:1}),l[16]||(l[16]=d("span",null,"Применённые штрафы:",-1))]),(n(!0),T(ae,null,oe(y.penalties_applied,(me,lt)=>(n(),T("div",{key:lt,class:"penalty-item"},[d("span",ka,w(me.metric_code),1),d("span",Ca,w(parseFloat(me.value).toFixed(1))+" < "+w(parseFloat(me.threshold).toFixed(1)),1),t(Le,{type:"danger",size:"small"},{default:e(()=>[_(" -"+w((parseFloat(me.penalty)*100).toFixed(0))+"% ",1)]),_:2},1024)]))),128))])):(n(),g(Oe,{key:2,type:"success",size:"small"},{default:e(()=>[...l[17]||(l[17]=[_(" Штрафы не применены ",-1)])]),_:1}))]),d("div",xa,[t(Oe,{type:"info",size:"small"},{default:e(()=>[_(" Рассчитано: "+w(m(ve)(y.computed_at)),1)]),_:2},1024)])]),_:2},1024))),128))]))])),[[Ue,E.value]])]),_:1}),t(Pe,{modelValue:c.value,"onUpdate:modelValue":l[5]||(l[5]=y=>c.value=y),title:"Загрузить отчёты",width:m(H)?"95%":"600px","destroy-on-close":"",onClose:ee},{footer:e(()=>[t(G,{onClick:l[4]||(l[4]=y=>c.value=!1)},{default:e(()=>[...l[20]||(l[20]=[_(" Отмена ",-1)])]),_:1}),t(G,{type:"primary",loading:B.value,disabled:!S.value.some(y=>y.status==="pending"),onClick:W},{default:e(()=>[_(" Загрузить все ("+w(S.value.filter(y=>y.status==="pending").length)+") ",1)]),_:1},8,["loading","disabled"])]),default:e(()=>[t(at,{ref_key:"uploadRef",ref:I,"auto-upload":!1,multiple:"",accept:".docx,.pdf","on-change":a,"show-file-list":!1,drag:""},{tip:e(()=>[...l[18]||(l[18]=[d("div",{class:"el-upload__tip"}," .docx и .pdf файлы, макс. 20 МБ, до 10 файлов ",-1)])]),default:e(()=>[t(O,{class:"el-icon--upload"},{default:e(()=>[t(m(je))]),_:1}),l[19]||(l[19]=d("div",{class:"el-upload__text"},[_(" Перетащите файлы сюда или "),d("em",null,"нажмите для выбора")],-1))]),_:1},512),S.value.length?(n(),T("div",Ea,[d("div",Sa," Выбрано файлов: "+w(S.value.length)+"/"+w(Me),1),(n(!0),T(ae,null,oe(S.value,y=>(n(),T("div",{key:y.id,class:Re(["batch-file-item","batch-file-item--"+y.status])},[y.status==="pending"?(n(),g(O,{key:0,class:"batch-file-icon"},{default:e(()=>[t(m(Fe))]),_:1})):y.status==="uploading"?(n(),g(O,{key:1,class:"batch-file-icon is-loading"},{default:e(()=>[t(m(Ce))]),_:1})):y.status==="success"?(n(),g(O,{key:2,class:"batch-file-icon batch-file-icon--success"},{default:e(()=>[t(m(Ie))]),_:1})):y.status==="error"?(n(),g(O,{key:3,class:"batch-file-icon batch-file-icon--error"},{default:e(()=>[t(m(Ve))]),_:1})):z("",!0),d("div",$a,[d("span",Da,w(y.name),1),d("span",Ma,w(ie(y.size)),1),y.error?(n(),T("span",Ra,w(y.error),1)):z("",!0)]),y.status==="pending"||y.status==="error"?(n(),g(G,{key:4,type:"danger",icon:m(Ae),circle:"",size:"small",onClick:me=>L(y.id)},null,8,["icon","onClick"])):z("",!0)],2))),128))])):z("",!0)]),_:1},8,["modelValue","width"]),t(Pe,{modelValue:x.value,"onUpdate:modelValue":l[6]||(l[6]=y=>x.value=y),title:"Метрики отчёта",width:"90%",top:"5vh","destroy-on-close":""},{default:e(()=>[p.value?(n(),g(zt,{key:0,"report-id":p.value,"report-status":D.value,"report-extract-warning":u.value,onMetricsUpdated:xe},null,8,["report-id","report-status","report-extract-warning"])):z("",!0)]),_:1},8,["modelValue"]),t(oa,{modelValue:f.value,"onUpdate:modelValue":l[7]||(l[7]=y=>f.value=y),"participant-id":C.value?.id,"participant-name":C.value?.full_name},null,8,["modelValue","participant-id","participant-name"])])),[[Ue,F.value]])]),_:1})}}},Pa=ge(Ia,[["__scopeId","data-v-9985aefc"]]);export{Pa as default};
