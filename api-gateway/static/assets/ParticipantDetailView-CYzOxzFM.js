import{N as j,m as g,O as H,p as Z,r as m,c as S,o,d as t,x as L,P as mt,w as e,u as k,Q as ft,K as _t,z as vt,B as R,F as W,H as he,v,f,C as Q,a as _,E as N,q as Pe,e as Oe,R as ze,I as ke,J as ce,S as yt,T as xe,k as Ve,U as Ae,g as Ne,V as gt,W as Ie,X as Te,h as Le,Y as be,Z as Fe,M as wt,_ as Be,$ as bt,n as Ue,a0 as ht,t as kt,a1 as Ct,G as Rt}from"./index-B06ugpJL.js";import{A as Dt}from"./AppLayout-BUkm5VzU.js";import{_ as pe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{f as $t,m as ue,g as Et,p as St}from"./metricNames-BECh_bcj.js";import{p as qe,u as Mt}from"./participants-BwFFp7Ua.js";const fe={async upload(i,C){const r=new FormData;return r.append("file",C),(await j.post(`/participants/${i}/reports`,r,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(i){return await j.get(`/reports/${i}/download`,{responseType:"blob"})},async getById(i){return(await j.get(`/reports/${i}`)).data},async delete(i){return(await j.delete(`/reports/${i}`)).data},async extract(i){return(await j.post(`/reports/${i}/extract`)).data},async getMetrics(i){return(await j.get(`/reports/${i}/metrics`)).data},async getList(i){return(await j.get(`/participants/${i}/reports`)).data}},we={async calculate(i,C){return(await j.post(`/scoring/participants/${i}/calculate`,null,{params:{activity_code:C}})).data},async getHistory(i,C=10){return(await j.get(`/scoring/participants/${i}/scores`,{params:{limit:C}})).data},async getById(i){return(await j.get(`/scoring-results/${i}`)).data},async generateRecommendations(i){return(await j.post(`/reports/${i}/recommendations`)).data},async getFinalReport(i,C,r="json"){const D={params:{activity_code:C,format:r}};r==="html"&&(D.responseType="text");const I=await j.get(`/participants/${i}/final-report`,D);return I.data},async downloadFinalReportPdf(i,C){return await j.get(`/participants/${i}/final-report`,{params:{activity_code:C,format:"pdf"},responseType:"blob"})}};function _e(i,C=1){if(i==null||i==="")return"";const r=typeof i=="string"?parseFloat(i):i;return isNaN(r)?"":r.toLocaleString("ru-RU",{minimumFractionDigits:C,maximumFractionDigits:C})}function oe(i){if(i==null||i==="")return null;const r=String(i).trim().replace(",","."),D=parseFloat(r);return isNaN(D)?null:D}function xt(i){return oe(i)}function de(i,C=1){return _e(i,C)}const Vt={key:0,class:"error-message"},At={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(i,{emit:C}){const r=i,D=C,I=g(null),M=g(""),F=g(!1),$=g(!1),E=g(""),w=H(()=>oe(M.value)),V=H(()=>{const l=w.value;return l===null||l<=r.min}),B=H(()=>{const l=w.value;return l===null||l>=r.max}),q=l=>{if(l==null||l===""){M.value="";return}F.value?M.value=String(l).replace(".",","):M.value=_e(l,r.precision)},G=l=>{if(l==null||l==="")return $.value=!1,E.value="",!0;const s=oe(l);return s===null?($.value=!0,E.value="Некорректное число",!1):s<r.min?($.value=!0,E.value=`Значение должно быть не меньше ${_e(r.min,r.precision)}`,!1):s>r.max?($.value=!0,E.value=`Значение должно быть не больше ${_e(r.max,r.precision)}`,!1):($.value=!1,E.value="",!0)},b=l=>{const s=l.replace(/[^\d,.-]/g,"");let h=!1;const p=s.split("").filter(y=>y===","||y==="."?h?!1:(h=!0,!0):!0).join("").replace(".",",");M.value=p;const d=oe(p);d!==null?D("update:modelValue",d):(p===""||p==="-")&&D("update:modelValue",null)},x=()=>{F.value=!1;const l=oe(M.value);if(G(M.value)){if(l!==null){const s=Math.round(l*Math.pow(10,r.precision))/Math.pow(10,r.precision),h=Math.max(r.min,Math.min(r.max,s));D("update:modelValue",h),q(h),D("change",h)}}else if(l!==null&&(l<r.min||l>r.max)){const s=Math.max(r.min,Math.min(r.max,l));D("update:modelValue",s),q(s),D("change",s),$.value=!1,E.value=""}D("blur")},X=()=>{F.value=!0,w.value!==null&&(M.value=String(w.value).replace(".",","))},J=()=>{const l=w.value||0,s=Math.min(r.max,l+r.step),h=Math.round(s*Math.pow(10,r.precision))/Math.pow(10,r.precision);D("update:modelValue",h),D("change",h),q(h)},P=()=>{const l=w.value||0,s=Math.max(r.min,l-r.step),h=Math.round(s*Math.pow(10,r.precision))/Math.pow(10,r.precision);D("update:modelValue",h),D("change",h),q(h)};return Z(()=>r.modelValue,l=>{q(l)},{immediate:!0}),q(r.modelValue),(l,s)=>{const h=m("el-button"),p=m("el-button-group"),d=m("el-input");return o(),S(W,null,[t(d,{ref_key:"inputRef",ref:I,modelValue:M.value,"onUpdate:modelValue":s[0]||(s[0]=y=>M.value=y),placeholder:i.placeholder,disabled:i.disabled,class:vt({"is-invalid":$.value}),onInput:b,onBlur:x,onFocus:X},mt({_:2},[i.showControls?{name:"append",fn:e(()=>[t(p,null,{default:e(()=>[t(h,{icon:k(ft),disabled:i.disabled||V.value,onClick:P},null,8,["icon","disabled"]),t(h,{icon:k(_t),disabled:i.disabled||B.value,onClick:J},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),$.value?(o(),S("div",Vt,R(E.value),1)):L("",!0)],64)}}},Nt=pe(At,[["__scopeId","data-v-74ef628d"]]),It={class:"card-header"},Tt={key:1},Lt={key:0,class:"metric-description"},Ft={key:2,class:"metrics-info"},Ut={class:"info-row"},Pt={key:0,class:"info-row"},Ot={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(i,{emit:C}){const r=i,D=C,I=g(!1),M=g(!1),F=g(!1),$=g(null),E=g([]),w=g([]),V=g({metrics:{}}),B=g({}),q=H(()=>!w.value||w.value.length===0?[]:[...new Set(w.value.map(p=>p.source))]),G=H(()=>!w.value||w.value.length===0?null:new Date),b=async()=>{try{const p=await ue.listMetricDefs(!0);E.value=p.items||[]}catch(p){console.error("Failed to load metric definitions:",p),$.value="Не удалось загрузить определения метрик"}},x=async()=>{I.value=!0,$.value=null;try{const p=await ue.listExtractedMetrics(r.reportId);w.value=p.items||[],V.value.metrics={},w.value.forEach(d=>{V.value.metrics[d.metric_def_id]=oe(d.value)}),B.value=JSON.parse(JSON.stringify(V.value.metrics))}catch(p){console.error("Failed to load metrics:",p),$.value="Не удалось загрузить метрики"}finally{I.value=!1}},X=()=>{F.value=!0,B.value=JSON.parse(JSON.stringify(V.value.metrics))},J=()=>{V.value.metrics=JSON.parse(JSON.stringify(B.value)),F.value=!1,$.value=null},P=async()=>{M.value=!0,$.value=null;try{const p=[];for(const[d,y]of Object.entries(V.value.metrics))if(y!=null&&y!==""){const O=xt(y);O!==null&&p.push({metric_def_id:d,value:O,source:"MANUAL",notes:null})}if(p.length===0){N.warning("Не введено ни одного значения метрики"),M.value=!1;return}await ue.bulkCreateExtractedMetrics(r.reportId,p),N.success(`Успешно сохранено ${p.length} метрик`),F.value=!1,await x(),D("metrics-updated")}catch(p){console.error("Failed to save metrics:",p);let d="Не удалось сохранить метрики";p.response?.data?.detail&&(typeof p.response.data.detail=="string"?d=p.response.data.detail:Array.isArray(p.response.data.detail)&&(d=p.response.data.detail.map(y=>y.msg||y.message).join(", "))),$.value=d,N.error(d)}finally{M.value=!1}},l=p=>{switch(p){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},s=p=>{switch(p){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return p}},h=p=>new Date(p).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return he(async()=>{await b(),await x()}),Z(()=>r.reportId,async p=>{p&&await x()}),(p,d)=>{const y=m("el-button"),O=m("el-alert"),ee=m("el-form-item"),z=m("el-col"),te=m("el-row"),le=m("el-form"),re=m("el-divider"),ie=m("el-tag"),ae=m("el-card");return o(),v(ae,{class:"metrics-editor"},{header:e(()=>[_("div",It,[d[4]||(d[4]=_("span",null,"Ручной ввод метрик",-1)),F.value?(o(),S("div",Tt,[t(y,{size:"small",onClick:J},{default:e(()=>[...d[2]||(d[2]=[f(" Отмена ",-1)])]),_:1}),t(y,{type:"primary",size:"small",loading:M.value,onClick:P},{default:e(()=>[...d[3]||(d[3]=[f(" Сохранить ",-1)])]),_:1},8,["loading"])])):(o(),v(y,{key:0,type:"primary",size:"small",onClick:X},{default:e(()=>[...d[1]||(d[1]=[f(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[$.value?(o(),v(O,{key:0,type:"error",title:$.value,closable:"",style:{"margin-bottom":"16px"},onClose:d[0]||(d[0]=A=>$.value=null)},null,8,["title"])):L("",!0),!w.value||w.value.length===0?(o(),v(O,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...d[5]||(d[5]=[f(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):L("",!0),t(le,{ref:"formRef",model:V.value,"label-position":"top",disabled:!F.value},{default:e(()=>[t(te,{gutter:20},{default:e(()=>[(o(!0),S(W,null,Q(E.value,A=>(o(),v(z,{key:A.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(ee,{label:k($t)(A),prop:`metrics.${A.id}`},{default:e(()=>[t(Nt,{modelValue:V.value.metrics[A.id],"onUpdate:modelValue":u=>V.value.metrics[A.id]=u,min:A.min_value||1,max:A.max_value||10,precision:1,step:.1,disabled:!F.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),A.description?(o(),S("div",Lt,R(A.description),1)):L("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),w.value&&w.value.length>0?(o(),S("div",Ft,[t(re),_("div",Ut,[d[6]||(d[6]=_("span",{class:"info-label"},"Источник данных:",-1)),(o(!0),S(W,null,Q(q.value,A=>(o(),v(ie,{key:A,type:l(A),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[f(R(s(A)),1)]),_:2},1032,["type"]))),128))]),G.value?(o(),S("div",Pt,[d[7]||(d[7]=_("span",{class:"info-label"},"Последнее обновление:",-1)),_("span",null,R(h(G.value)),1)])):L("",!0)])):L("",!0)]),_:1})}}},zt=pe(Ot,[["__scopeId","data-v-1e3d866a"]]),Bt={class:"report-list"},qt={class:"report-list__controls"},Xt={class:"controls-left"},Gt={class:"controls-right"},jt={class:"filename"},Jt={class:"status-cell"},Ht={key:1,class:"report-list__cards"},Wt={class:"report-card__header"},Kt={class:"report-card__status"},Qt={class:"report-card__body"},Yt={class:"report-card__field"},Zt={class:"field-value"},ea={class:"report-card__field"},ta={class:"field-value"},aa={class:"report-card__actions"},na={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(i,{emit:C}){const r=i,D=C,I=Pe(),M=Oe(),F=g(window.innerWidth<=768),$=()=>{F.value=window.innerWidth<=768};he(()=>{window.addEventListener("resize",$),I.query.status&&(E.value=I.query.status),I.query.sort&&(w.value=I.query.sort)}),ze(()=>{window.removeEventListener("resize",$)});const E=g(""),w=g("desc"),V=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];Z([E,w],([l,s])=>{const h={...I.query};l?h.status=l:delete h.status,s?h.sort=s:delete h.sort,M.replace({query:h})});const B=()=>{},q=()=>{w.value=w.value==="desc"?"asc":"desc"},G=H(()=>{let l=[...r.reports];return E.value&&(l=l.filter(s=>s.status===E.value)),l.sort((s,h)=>{const p=new Date(s.uploaded_at),d=new Date(h.uploaded_at);return w.value==="desc"?d-p:p-d}),l}),b=H(()=>E.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),x=l=>{if(!l)return"—";const s=new Date(l);return Number.isNaN(s.getTime())?"—":s.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},X=l=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[l]||l,J=l=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[l]||"info",P=async({action:l,report:s})=>{switch(l){case"view":D("view",s.id);break;case"edit":D("edit",s.id);break;case"extract":D("extract",s.id);break;case"download":D("download",s.id);break;case"delete":try{await wt.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),D("delete",s.id)}catch{}break}};return(l,s)=>{const h=m("el-option"),p=m("el-select"),d=m("el-icon"),y=m("el-button"),O=m("el-table-column"),ee=m("el-tag"),z=m("el-dropdown-item"),te=m("el-dropdown-menu"),le=m("el-dropdown"),re=m("el-table"),ie=m("el-card"),ae=m("el-empty"),A=ke("loading");return o(),S("div",Bt,[_("div",qt,[_("div",Xt,[t(p,{modelValue:E.value,"onUpdate:modelValue":s[0]||(s[0]=u=>E.value=u),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:B},{default:e(()=>[t(h,{label:"Все статусы",value:""}),(o(),S(W,null,Q(V,u=>t(h,{key:u.value,label:u.label,value:u.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_("div",Gt,[t(y,{type:w.value==="desc"?"primary":"default",size:"small",onClick:q},{default:e(()=>[t(d,null,{default:e(()=>[t(k(yt))]),_:1}),f(" "+R(w.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),F.value?ce((o(),S("div",Ht,[(o(!0),S(W,null,Q(G.value,u=>(o(),v(ie,{key:u.id,class:"report-card",shadow:"hover"},{header:e(()=>[_("div",Wt,[_("div",Kt,[u.status==="PROCESSING"?(o(),v(d,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(k(xe))]),_:1})):u.status==="EXTRACTED"?(o(),v(d,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(k(Ve))]),_:1})):u.status==="FAILED"?(o(),v(d,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(k(Ae))]),_:1})):(o(),v(d,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(k(Ne))]),_:1})),t(ee,{type:J(u.status),size:"small"},{default:e(()=>[f(R(X(u.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[_("div",aa,[u.status==="EXTRACTED"?(o(),v(y,{key:0,type:"success",size:"small",onClick:Y=>P({action:"edit",report:u})},{default:e(()=>[t(d,null,{default:e(()=>[t(k(Ie))]),_:1}),s[10]||(s[10]=f(" Редактировать ",-1))]),_:1},8,["onClick"])):L("",!0),u.status==="PROCESSING"||u.status==="EXTRACTED"?(o(),v(y,{key:1,type:"info",size:"small",onClick:Y=>P({action:"view",report:u})},{default:e(()=>[t(d,null,{default:e(()=>[t(k(Te))]),_:1}),s[11]||(s[11]=f(" Просмотр ",-1))]),_:1},8,["onClick"])):L("",!0),t(y,{type:"primary",size:"small",onClick:Y=>P({action:"extract",report:u})},{default:e(()=>[t(d,null,{default:e(()=>[t(k(Le))]),_:1}),f(" "+R(u.status==="FAILED"?"Повторить":u.status==="PROCESSING"?"Перезапустить":u.status==="EXTRACTED"?"Переизвлечь":"Извлечь"),1)]),_:2},1032,["onClick"]),t(y,{size:"small",onClick:Y=>P({action:"download",report:u})},{default:e(()=>[t(d,null,{default:e(()=>[t(k(be))]),_:1}),s[12]||(s[12]=f(" Скачать ",-1))]),_:1},8,["onClick"]),t(y,{type:"danger",size:"small",onClick:Y=>P({action:"delete",report:u})},{default:e(()=>[t(d,null,{default:e(()=>[t(k(Fe))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[_("div",Qt,[_("div",Yt,[s[8]||(s[8]=_("span",{class:"field-label"},"Файл:",-1)),_("span",Zt,R(u.file_ref?.filename||"Без названия"),1)]),_("div",ea,[s[9]||(s[9]=_("span",{class:"field-label"},"Дата загрузки:",-1)),_("span",ta,R(x(u.uploaded_at)),1)])])]),_:2},1024))),128)),!G.value.length&&!i.loading?(o(),v(ae,{key:0,description:b.value,"image-size":120},{default:e(()=>[E.value?L("",!0):(o(),v(y,{key:0,type:"primary",onClick:s[1]||(s[1]=u=>l.$emit("upload"))},{default:e(()=>[...s[13]||(s[13]=[f(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):L("",!0)])),[[A,i.loading]]):ce((o(),v(re,{key:0,data:G.value,class:"report-list__table",stripe:"","empty-text":b.value},{default:e(()=>[t(O,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:u})=>[_("span",jt,R(u.file_ref?.filename||"Без названия"),1)]),_:1}),t(O,{prop:"status",label:"Статус",width:"200"},{default:e(({row:u})=>[_("div",Jt,[u.status==="PROCESSING"?(o(),v(d,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(k(xe))]),_:1})):u.status==="EXTRACTED"?(o(),v(d,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(k(Ve))]),_:1})):u.status==="FAILED"?(o(),v(d,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(k(Ae))]),_:1})):(o(),v(d,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(k(Ne))]),_:1})),t(ee,{type:J(u.status),size:"default"},{default:e(()=>[f(R(X(u.status)),1)]),_:2},1032,["type"])])]),_:1}),t(O,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:u})=>[f(R(x(u.uploaded_at)),1)]),_:1}),t(O,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:u})=>[t(le,{trigger:"click",onCommand:P},{dropdown:e(()=>[t(te,null,{default:e(()=>[u.status==="EXTRACTED"?(o(),v(z,{key:0,command:{action:"edit",report:u}},{default:e(()=>[t(d,null,{default:e(()=>[t(k(Ie))]),_:1}),s[4]||(s[4]=f(" Редактировать метрики ",-1))]),_:1},8,["command"])):L("",!0),u.status==="PROCESSING"||u.status==="EXTRACTED"?(o(),v(z,{key:1,command:{action:"view",report:u}},{default:e(()=>[t(d,null,{default:e(()=>[t(k(Te))]),_:1}),s[5]||(s[5]=f(" Просмотр метрик ",-1))]),_:1},8,["command"])):L("",!0),t(z,{command:{action:"extract",report:u}},{default:e(()=>[t(d,null,{default:e(()=>[t(k(Le))]),_:1}),f(" "+R(u.status==="FAILED"?"Повторить извлечение":u.status==="PROCESSING"?"Перезапустить извлечение":u.status==="EXTRACTED"?"Переизвлечь метрики":"Извлечь метрики"),1)]),_:2},1032,["command"]),t(z,{divided:"",command:{action:"download",report:u}},{default:e(()=>[t(d,null,{default:e(()=>[t(k(be))]),_:1}),s[6]||(s[6]=f(" Скачать ",-1))]),_:1},8,["command"]),t(z,{command:{action:"delete",report:u},class:"dropdown-item--danger"},{default:e(()=>[t(d,null,{default:e(()=>[t(k(Fe))]),_:1}),s[7]||(s[7]=f(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(y,{type:"primary",size:"small"},{default:e(()=>[s[3]||(s[3]=f(" Действия ",-1)),t(d,{class:"el-icon--right"},{default:e(()=>[t(k(gt))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[A,i.loading]]),!G.value.length&&!i.loading&&!F.value?(o(),v(ae,{key:2,description:b.value,"image-size":120},{default:e(()=>[E.value?L("",!0):(o(),v(y,{key:0,type:"primary",onClick:s[2]||(s[2]=u=>l.$emit("upload"))},{default:e(()=>[...s[14]||(s[14]=[f(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):L("",!0)])}}},sa=pe(na,[["__scopeId","data-v-c9651b50"]]),oa={class:"metrics-drawer"},la={class:"drawer-actions"},ra={key:1},ia={key:1},da={__name:"ParticipantMetricsDrawer",props:{modelValue:{type:Boolean,required:!0},participantId:{type:String,required:!0},participantName:{type:String,required:!0}},emits:["update:modelValue"],setup(i,{emit:C}){const r=i,D=C,I=g(!1),M=g([]),F=g([]),$=H(()=>"Метрики ещё не извлечены. Загрузите и обработайте отчёты."),E=b=>{D("update:modelValue",b)},w=async()=>{try{const b=await ue.listMetricDefs(!0);F.value=b.items||[]}catch(b){console.error("Error loading metric definitions:",b)}},V=async()=>{I.value=!0;try{const b=await qe.getMetrics(r.participantId);M.value=b.metrics||[]}catch(b){console.error("Error loading participant metrics:",b),N.error("Ошибка загрузки метрик участника")}finally{I.value=!1}},B=b=>{if(!b)return"—";const x=F.value.find(J=>J.code===b);return Et(x,b,{warn:()=>{}})},q=b=>b>=.8?"var(--el-color-success)":b>=.6?"var(--el-color-warning)":"var(--el-color-danger)",G=b=>{if(!b)return"—";const x=new Date(b);return Number.isNaN(x.getTime())?"—":x.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})};return Z(()=>r.participantId,async b=>{b&&r.modelValue&&(await w(),await V())}),Z(()=>r.modelValue,async b=>{b&&r.participantId&&(await w(),await V())}),(b,x)=>{const X=m("el-icon"),J=m("el-button"),P=m("el-table-column"),l=m("el-tag"),s=m("el-table"),h=m("el-empty"),p=m("el-drawer"),d=ke("loading");return o(),v(p,{"model-value":i.modelValue,title:`Метрики участника: ${i.participantName}`,size:"70%",direction:"rtl","onUpdate:modelValue":E},{default:e(()=>[ce((o(),S("div",oa,[_("div",la,[t(J,{type:"primary",size:"small",onClick:V},{default:e(()=>[t(X,null,{default:e(()=>[t(k(Be))]),_:1}),x[0]||(x[0]=f(" Обновить ",-1))]),_:1})]),t(s,{data:M.value,stripe:"","empty-text":$.value},{default:e(()=>[t(P,{prop:"metric_code",label:"Код метрики",width:"200"}),t(P,{label:"Название метрики","min-width":"250"},{default:e(({row:y})=>[f(R(B(y.metric_code)),1)]),_:1}),t(P,{prop:"value",label:"Значение",width:"120"},{default:e(({row:y})=>[t(l,{type:"success"},{default:e(()=>[f(R(k(de)(y.value)),1)]),_:2},1024)]),_:1}),t(P,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:y})=>[y.confidence!==null?(o(),S("span",{key:0,style:bt({color:q(y.confidence)})},R((y.confidence*100).toFixed(0))+"% ",5)):(o(),S("span",ra,"—"))]),_:1}),t(P,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:y})=>[f(R(G(y.updated_at)),1)]),_:1}),t(P,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:y})=>[y.last_source_report_id?(o(),v(l,{key:0,size:"small"},{default:e(()=>[...x[1]||(x[1]=[f(" Из отчёта ",-1)])]),_:1})):(o(),S("span",ia,"—"))]),_:1})]),_:1},8,["data","empty-text"]),!M.value.length&&!I.value?(o(),v(h,{key:0,description:$.value},null,8,["description"])):L("",!0)])),[[d,I.value]])]),_:1},8,["model-value","title"])}}},ua=pe(da,[["__scopeId","data-v-93720633"]]),ca={class:"participant-detail"},pa={class:"card-header"},ma={class:"header-actions"},fa={class:"section-header"},_a={class:"scoring-result"},va={class:"score-value"},ya={class:"score-number"},ga={class:"score-details"},wa={class:"score-section"},ba={key:0},ha={class:"score-section"},ka={key:0},Ca={class:"score-section recommendations-status-section"},Ra={class:"recommendations-pending-alert"},Da={key:0,class:"final-report-actions"},$a={class:"activity-code-hint"},Ea={__name:"ParticipantDetailView",setup(i){const C=Oe(),r=Pe(),D=Mt(),I=g(!1),M=g(!1),F=g(!1);g(!1);const $=g(!1),E=g(!1),w=H(()=>D.currentParticipant),V=g([]),B=g([]),q=g([]),G=g([]);g([]);const b=g(null),x=g(null),X=g(null),J=H(()=>V.value.some(a=>a.status==="PROCESSING")),P=H(()=>B.value.some(a=>a.recommendations_status==="pending")),l=g(!1),s=g(!1),h=g(!1),p=g(!1),d=g(null),y=g([]),O=Ue({file:null}),ee={file:[{required:!0,message:"Выберите файл",trigger:"change"}]},z=Ue({activityCode:""}),te=a=>{if(!a)return"—";const n=new Date(a);return Number.isNaN(n.getTime())?"—":n.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},le=a=>a>=80?"success":a>=60?"":"warning",re=a=>({pending:"Формируются",ready:"Готовы",error:"Ошибка",disabled:"Отключены"})[a]||a,ie=a=>({pending:"info",ready:"success",error:"danger",disabled:"warning"})[a]||"info",ae=async()=>{I.value=!0;try{await D.getParticipant(r.params.id)}catch{N.error("Участник не найден"),C.push("/participants")}finally{I.value=!1}},A=async({silent:a=!1}={})=>{a||(M.value=!0);try{const n=await qe.getReports(r.params.id);V.value=n.items||[]}catch(n){console.error("Error loading reports:",n),N.error("Ошибка загрузки списка отчётов")}finally{a||(M.value=!1)}},u=a=>{if(!a)return a;const n=Array.isArray(a.recommendations)?a.recommendations:[];let T=a.recommendations_status||a.recommendationsStatus||null;T||(T=n.length>0?"ready":"pending");const U=Number(a.score_pct),ne=Number.isNaN(U)?a.score_pct:U;return{...a,score_pct:ne,recommendations:n,recommendations_status:T,recommendations_error:a.recommendations_error||a.recommendationsError||null}},Y=async()=>{try{const a=await we.getHistory(r.params.id),n=Array.isArray(a.items)?a.items:[];B.value=n.map(u)}catch(a){console.error("Error loading scoring results:",a)}},Xe=async()=>{F.value=!0;try{const a=await St.list();q.value=a||[]}catch{N.error("Ошибка загрузки профессиональных областей")}finally{F.value=!1}},Ge=async()=>{try{const a=await ue.listMetricDefs(!0);G.value=a.items||[]}catch(a){console.error("Error loading metric definitions:",a)}},je=a=>{O.file=a.raw,y.value=[a]},Je=async()=>{d.value&&await d.value.validate(async a=>{if(a){if(!O.file){N.error("Выберите файл");return}$.value=!0;try{await fe.upload(r.params.id,O.file),N.success("Отчёт загружен успешно"),l.value=!1,O.file=null,y.value=[],await A()}catch{N.error("Ошибка загрузки отчёта")}finally{$.value=!1}}})},He=async a=>{try{const n=await fe.download(a),T=window.URL.createObjectURL(new Blob([n.data])),U=document.createElement("a");U.href=T,U.setAttribute("download",`report_${a}.docx`),document.body.appendChild(U),U.click(),U.remove(),window.URL.revokeObjectURL(T),N.success("Отчёт скачан")}catch{N.error("Ошибка скачивания отчёта")}},We=async a=>{try{await fe.extract(a),N.success("Извлечение метрик запущено"),await A()}catch{N.error("Ошибка запуска извлечения метрик")}},Ke=()=>{x.value||(x.value=setInterval(async()=>{try{await A({silent:!0})}catch(a){console.error("Auto-refresh error:",a)}},3e3))},Ce=()=>{x.value&&(clearInterval(x.value),x.value=null)},Qe=()=>{X.value||(X.value=setInterval(async()=>{try{await Y()}catch(a){console.error("Recommendations auto-refresh error:",a)}},15e3))},Re=()=>{X.value&&(clearInterval(X.value),X.value=null)};Z(J,a=>{a?Ke():Ce()}),Z(P,a=>{a?Qe():Re()});const De=async a=>{b.value=a,await Rt(),h.value=!0},Ye=async()=>{N.success("Метрики обновлены")},Ze=async a=>{try{await fe.delete(a),N.success("Отчёт удалён"),await A()}catch{N.error("Ошибка удаления отчёта")}},et=async()=>{if(!z.activityCode){N.warning("Выберите профессиональную область");return}E.value=!0;try{const a=await we.calculate(r.params.id,z.activityCode),n=u({id:a.scoring_result_id,participant_id:r.params.id,prof_activity_code:a.prof_activity_code||z.activityCode,prof_activity_name:a.prof_activity_name,score_pct:parseFloat(a.score_pct),strengths:a.strengths||[],dev_areas:a.dev_areas||[],recommendations:a.recommendations||[],recommendations_status:a.recommendations_status||((a.recommendations||[]).length>0?"ready":"pending"),recommendations_error:a.recommendations_error||null,created_at:new Date().toISOString()});B.value.unshift(n),N.success("Расчёт пригодности выполнен"),s.value=!1,z.activityCode=""}catch(a){console.error("Scoring calculation error:",a);const n=a.response?.data?.detail||"Ошибка расчёта пригодности";N.error(n)}finally{E.value=!1}},tt=async a=>{if(!a.prof_activity_code){N.warning("Код профессиональной деятельности не найден");return}try{const n=await we.downloadFinalReportPdf(r.params.id,a.prof_activity_code),T=window.URL.createObjectURL(new Blob([n.data])),U=document.createElement("a");U.href=T,U.setAttribute("download",`final_report_${a.prof_activity_code}_${new Date().toISOString().split("T")[0]}.pdf`),document.body.appendChild(U),U.click(),U.remove(),window.URL.revokeObjectURL(T),N.success("Отчёт PDF скачан")}catch(n){const T=n.response?.data?.detail||"Ошибка загрузки PDF отчёта";N.error(T)}},$e=a=>a?.recommendations_status==="ready"||a?.recommendations_status==="disabled",at=a=>a?.recommendations_status==="pending"?"Дождитесь завершения генерации рекомендаций":a?.recommendations_status==="error"?"Ошибка генерации рекомендаций. Попробуйте пересчитать пригодность":"",nt=a=>a?.recommendations_error?`Ошибка генерации: ${a.recommendations_error}`:"Не удалось получить рекомендации";return he(async()=>{await ae(),await A(),await Y(),await Xe(),await Ge()}),ze(()=>{Ce(),Re()}),(a,n)=>{const T=m("el-button"),U=m("el-icon"),ne=m("el-descriptions-item"),st=m("el-descriptions"),me=m("el-card"),ot=m("el-progress"),ve=m("el-empty"),lt=m("el-tag"),se=m("el-alert"),rt=m("el-tooltip"),it=m("el-timeline-item"),dt=m("el-timeline"),ut=m("el-upload"),Ee=m("el-form-item"),Se=m("el-form"),ye=m("el-dialog"),ct=m("el-option"),pt=m("el-select"),Me=ke("loading");return o(),v(Dt,null,{default:e(()=>[ce((o(),S("div",ca,[w.value?(o(),v(me,{key:0,class:"detail-card"},{header:e(()=>[_("div",pa,[_("h2",null,R(w.value.full_name),1),_("div",ma,[t(T,{onClick:n[0]||(n[0]=c=>k(C).back())},{default:e(()=>[...n[12]||(n[12]=[f(" Назад ",-1)])]),_:1}),t(T,{type:"info",onClick:n[1]||(n[1]=c=>p.value=!0)},{default:e(()=>[t(U,null,{default:e(()=>[t(k(ht))]),_:1}),n[13]||(n[13]=f(" Метрики ",-1))]),_:1}),t(T,{type:"primary",onClick:n[2]||(n[2]=c=>s.value=!0)},{default:e(()=>[t(U,null,{default:e(()=>[t(k(kt))]),_:1}),n[14]||(n[14]=f(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(st,{column:2,border:""},{default:e(()=>[t(ne,{label:"ФИО"},{default:e(()=>[f(R(w.value.full_name),1)]),_:1}),t(ne,{label:"Дата рождения"},{default:e(()=>[f(R(w.value.birth_date||"Не указана"),1)]),_:1}),t(ne,{label:"Внешний ID"},{default:e(()=>[f(R(w.value.external_id||"Не указан"),1)]),_:1}),t(ne,{label:"Дата создания"},{default:e(()=>[f(R(te(w.value.created_at)),1)]),_:1})]),_:1})]),_:1})):L("",!0),t(me,{class:"section-card"},{header:e(()=>[_("div",fa,[n[16]||(n[16]=_("h3",null,"Отчёты",-1)),t(T,{type:"primary",onClick:n[3]||(n[3]=c=>l.value=!0)},{default:e(()=>[t(U,null,{default:e(()=>[t(k(Ct))]),_:1}),n[15]||(n[15]=f(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(sa,{reports:V.value,loading:M.value,onView:De,onEdit:De,onExtract:We,onDownload:He,onDelete:Ze,onUpload:n[4]||(n[4]=c=>l.value=!0)},null,8,["reports","loading"])]),_:1}),B.value.length>0?(o(),v(me,{key:1,class:"section-card"},{header:e(()=>[...n[17]||(n[17]=[_("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(dt,null,{default:e(()=>[(o(!0),S(W,null,Q(B.value,c=>(o(),v(it,{key:c.id,timestamp:te(c.created_at),placement:"top"},{default:e(()=>[t(me,null,{default:e(()=>[_("h4",null,R(c.prof_activity_name),1),_("div",_a,[_("div",va,[_("span",ya,R(c.score_pct)+"%",1),t(ot,{percentage:c.score_pct,status:le(c.score_pct)},null,8,["percentage","status"])]),_("div",ga,[_("div",wa,[n[18]||(n[18]=_("h5",null,"Сильные стороны:",-1)),c.strengths&&c.strengths.length?(o(),S("ul",ba,[(o(!0),S(W,null,Q(c.strengths,(K,ge)=>(o(),S("li",{key:ge},[_("strong",null,R(K.metric_name),1),f(" — "+R(k(de)(K.value))+" (вес "+R(k(de)(K.weight,2))+") ",1)]))),128))])):(o(),v(ve,{key:1,description:"Нет данных","image-size":60}))]),_("div",ha,[n[19]||(n[19]=_("h5",null,"Зоны развития:",-1)),c.dev_areas&&c.dev_areas.length?(o(),S("ul",ka,[(o(!0),S(W,null,Q(c.dev_areas,(K,ge)=>(o(),S("li",{key:ge},[_("strong",null,R(K.metric_name),1),f(" — "+R(k(de)(K.value))+" (вес "+R(k(de)(K.weight,2))+") ",1)]))),128))])):(o(),v(ve,{key:1,description:"Нет данных","image-size":60}))]),_("div",Ca,[_("h5",null,[n[20]||(n[20]=f(" Рекомендации: ",-1)),c.recommendations_status?(o(),v(lt,{key:0,type:ie(c.recommendations_status),size:"small",class:"recommendation-status-tag"},{default:e(()=>[f(R(re(c.recommendations_status)),1)]),_:2},1032,["type"])):L("",!0)]),c.recommendations_status==="pending"?(o(),v(se,{key:0,type:"info",closable:!1,"show-icon":""},{title:e(()=>[_("div",Ra,[t(U,{class:"is-loading"},{default:e(()=>[t(k(Be))]),_:1}),n[21]||(n[21]=_("span",null,"Рекомендации формируются...",-1))])]),default:e(()=>[...n[22]||(n[22]=[f(" Кнопка «Скачать PDF» станет доступна после завершения генерации. ",-1)])]),_:1})):c.recommendations_status==="ready"?(o(),v(se,{key:1,title:"Рекомендации готовы",type:"success",closable:!1,"show-icon":""},{default:e(()=>[...n[23]||(n[23]=[f(" Персональные рекомендации доступны в итоговом PDF-отчёте. ",-1)])]),_:1})):c.recommendations_status==="error"?(o(),v(se,{key:2,title:nt(c),type:"error",closable:!1,"show-icon":""},{default:e(()=>[...n[24]||(n[24]=[f(" Не удалось сформировать рекомендации. Попробуйте пересчитать пригодность. ",-1)])]),_:1},8,["title"])):c.recommendations_status==="disabled"?(o(),v(se,{key:3,title:"Генерация рекомендаций отключена",type:"warning",closable:!1,"show-icon":""},{default:e(()=>[...n[25]||(n[25]=[f(" Генерация рекомендаций отключена для данного окружения. ",-1)])]),_:1})):(o(),v(ve,{key:4,description:"Статус рекомендаций неизвестен","image-size":60}))])]),c.prof_activity_code?(o(),S("div",Da,[t(rt,{disabled:$e(c),content:at(c),placement:"top"},{default:e(()=>[_("span",null,[t(T,{type:"primary",size:"small",disabled:!$e(c),loading:c.recommendations_status==="pending",onClick:K=>tt(c)},{default:e(()=>[c.recommendations_status!=="pending"?(o(),v(U,{key:0},{default:e(()=>[t(k(be))]),_:1})):L("",!0),f(" "+R(c.recommendations_status==="pending"?"Формируется...":"Скачать PDF"),1)]),_:2},1032,["disabled","loading","onClick"])])]),_:2},1032,["disabled","content"])])):L("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):L("",!0),t(ye,{modelValue:l.value,"onUpdate:modelValue":n[6]||(n[6]=c=>l.value=c),title:"Загрузить отчёт",width:"500px"},{footer:e(()=>[t(T,{onClick:n[5]||(n[5]=c=>l.value=!1)},{default:e(()=>[...n[28]||(n[28]=[f(" Отмена ",-1)])]),_:1}),t(T,{type:"primary",loading:$.value,onClick:Je},{default:e(()=>[...n[29]||(n[29]=[f(" Загрузить ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(Se,{ref_key:"uploadFormRef",ref:d,model:O,rules:ee,"label-position":"top"},{default:e(()=>[t(Ee,{label:"Файл (DOCX)",prop:"file"},{default:e(()=>[t(ut,{ref:"uploadRef","auto-upload":!1,limit:1,accept:".docx","on-change":je,"file-list":y.value},{tip:e(()=>[...n[27]||(n[27]=[_("div",{class:"el-upload__tip"}," Только файлы DOCX, максимум 20 МБ ",-1)])]),default:e(()=>[t(T,{type:"primary"},{default:e(()=>[...n[26]||(n[26]=[f(" Выбрать файл ",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(ye,{modelValue:s.value,"onUpdate:modelValue":n[9]||(n[9]=c=>s.value=c),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:e(()=>[t(T,{onClick:n[8]||(n[8]=c=>s.value=!1)},{default:e(()=>[...n[30]||(n[30]=[f(" Отмена ",-1)])]),_:1}),t(T,{type:"primary",loading:E.value,disabled:!z.activityCode||V.value.length===0,onClick:et},{default:e(()=>[...n[31]||(n[31]=[f(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t(Se,{model:z,"label-position":"top"},{default:e(()=>[t(Ee,{label:"Профессиональная область",required:""},{default:e(()=>[ce((o(),v(pt,{modelValue:z.activityCode,"onUpdate:modelValue":n[7]||(n[7]=c=>z.activityCode=c),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(o(!0),S(W,null,Q(q.value,c=>(o(),v(ct,{key:c.code,label:c.name,value:c.code},{default:e(()=>[_("span",null,R(c.name),1),_("span",$a,R(c.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[Me,F.value]])]),_:1}),t(se,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),V.value.length===0?(o(),v(se,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):L("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(ye,{modelValue:h.value,"onUpdate:modelValue":n[10]||(n[10]=c=>h.value=c),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[b.value?(o(),v(zt,{key:0,"report-id":b.value,onMetricsUpdated:Ye},null,8,["report-id"])):L("",!0)]),_:1},8,["modelValue"]),t(ua,{modelValue:p.value,"onUpdate:modelValue":n[11]||(n[11]=c=>p.value=c),"participant-id":w.value?.id,"participant-name":w.value?.full_name},null,8,["modelValue","participant-id","participant-name"])])),[[Me,I.value]])]),_:1})}}},Na=pe(Ea,[["__scopeId","data-v-4cb7c67d"]]);export{Na as default};
