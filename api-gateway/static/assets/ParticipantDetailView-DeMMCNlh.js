import{O as Y,P as ct,m as _,Q as Z,D as dt,p as ie,r as d,c as M,o as n,d as e,x as P,R as pt,w as t,u as p,S as ft,K as mt,z as Be,B as w,F as te,H as Xe,T as Qe,v as y,f as v,a as u,C as se,U as we,V as _t,W as vt,X as yt,Y as gt,L as Ye,Z as wt,_ as et,E as B,q as tt,e as at,I as qe,J as he,$ as ht,k as ze,a0 as Le,g as Oe,a1 as bt,a2 as Je,a3 as He,h as Ke,a4 as Pe,a5 as Ue,N as kt,n as Ct,a6 as $t,t as St,a7 as We,G as xt}from"./index-pq0ppcP1.js";import{A as Et}from"./AppLayout-CdFMFOll.js";import{_ as fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{m as Ce,f as Dt,g as Rt}from"./metricNames-I04aV1GI.js";import{f as Mt,a as be,p as It}from"./dateFormat-DKHiE1_x.js";import{a as lt,p as st,u as Vt}from"./useResponsive-BaYWJYPi.js";const ge={async upload(a,k){const o=new FormData;return o.append("file",k),(await Y.post(`/participants/${a}/reports`,o,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(a){return await Y.get(`/reports/${a}/download`,{responseType:"blob"})},async getById(a){return(await Y.get(`/reports/${a}`)).data},async delete(a){return(await Y.delete(`/reports/${a}`)).data},async extract(a){return(await Y.post(`/reports/${a}/extract`)).data},async getMetrics(a){return(await Y.get(`/reports/${a}/metrics`)).data},async getList(a){return(await Y.get(`/participants/${a}/reports`)).data},async getReportImages(a){return(await Y.get(`/reports/${a}/images`)).data}},Ne={async calculate(a,k){return(await Y.post(`/scoring/participants/${a}/calculate`,null,{params:{activity_code:k}})).data},async getHistory(a,k=10){return(await Y.get(`/scoring/participants/${a}/scores`,{params:{limit:k}})).data},async getById(a){return(await Y.get(`/scoring-results/${a}`)).data},async generateRecommendations(a){return(await Y.post(`/reports/${a}/recommendations`)).data},async getFinalReport(a,k,o="json"){const h={params:{activity_code:k,format:o}};o==="html"&&(h.responseType="text");const z=await Y.get(`/participants/${a}/final-report`,h);return z.data},async downloadFinalReportPdf(a,k,o=null){const h={activity_code:k,format:"pdf"};return o&&(h.scoring_result_id=o),await Y.get(`/participants/${a}/final-report`,{params:h,responseType:"blob"})}},nt=ct("metrics",()=>{const a=_([]),k=_(!1),o=_(null),h=_(null),z=300*1e3,x=Z(()=>h.value?Date.now()-h.value>z:!0),U=Z(()=>a.value.length>0);async function S({force:g=!1,activeOnly:A=!1}={}){if(!g&&U.value&&!x.value)return a.value;if(k.value)return new Promise(V=>{const D=setInterval(()=>{k.value||(clearInterval(D),V(a.value))},50)});k.value=!0,o.value=null;try{const V=await Ce.listMetricDefs(A);return a.value=V,h.value=Date.now(),V}catch(V){const D=dt(V,"Ошибка загрузки метрик");throw o.value=D.message,V.normalizedError=D,V}finally{k.value=!1}}function N(g){return a.value.find(A=>A.id===g)}function J(g){const A=N(g);return A?.name_ru||A?.name||g}function W(){h.value=null}function I(g){const A=a.value.findIndex(V=>V.id===g.id);A!==-1&&(a.value[A]=g)}function E(g){a.value=a.value.filter(A=>A.id!==g)}function X(g){a.value.push(g)}return{metricDefs:a,loading:k,error:o,isStale:x,hasData:U,fetchMetricDefs:S,getMetricDefById:N,getMetricName:J,invalidateCache:W,updateInCache:I,removeFromCache:E,addToCache:X}});function $e(a,k=1){if(a==null||a==="")return"";const o=typeof a=="string"?parseFloat(a):a;return isNaN(o)?"":o.toLocaleString("ru-RU",{minimumFractionDigits:k,maximumFractionDigits:k})}function pe(a){if(a==null||a==="")return null;const o=String(a).trim().replace(",","."),h=parseFloat(o);return isNaN(h)?null:h}function At(a){return pe(a)}function ot(a,k=1){return $e(a,k)}const Ft={key:0,class:"error-message"},Nt={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(a,{emit:k}){const o=a,h=k,z=_(null),x=_(""),U=_(!1),S=_(!1),N=_(""),J=Z(()=>pe(x.value)),W=Z(()=>{const c=J.value;return c===null||c<=o.min}),I=Z(()=>{const c=J.value;return c===null||c>=o.max}),E=c=>{if(c==null||c===""){x.value="";return}U.value?x.value=String(c).replace(".",","):x.value=$e(c,o.precision)},X=c=>{if(c==null||c==="")return S.value=!1,N.value="",!0;const F=pe(c);return F===null?(S.value=!0,N.value="Некорректное число",!1):F<o.min?(S.value=!0,N.value=`Значение должно быть не меньше ${$e(o.min,o.precision)}`,!1):F>o.max?(S.value=!0,N.value=`Значение должно быть не больше ${$e(o.max,o.precision)}`,!1):(S.value=!1,N.value="",!0)},g=c=>{const F=c.replace(/[^\d,.-]/g,"");let m=!1;const O=F.split("").filter(G=>G===","||G==="."?m?!1:(m=!0,!0):!0).join("").replace(".",",");x.value=O;const q=pe(O);q!==null?h("update:modelValue",q):(O===""||O==="-")&&h("update:modelValue",null)},A=()=>{U.value=!1;const c=pe(x.value);if(X(x.value)){if(c!==null){const F=Math.round(c*Math.pow(10,o.precision))/Math.pow(10,o.precision),m=Math.max(o.min,Math.min(o.max,F));h("update:modelValue",m),E(m),h("change",m)}}else if(c!==null&&(c<o.min||c>o.max)){const F=Math.max(o.min,Math.min(o.max,c));h("update:modelValue",F),E(F),h("change",F),S.value=!1,N.value=""}h("blur")},V=()=>{U.value=!0,J.value!==null&&(x.value=String(J.value).replace(".",","))},D=()=>{const c=J.value||0,F=Math.min(o.max,c+o.step),m=Math.round(F*Math.pow(10,o.precision))/Math.pow(10,o.precision);h("update:modelValue",m),h("change",m),E(m)},r=()=>{const c=J.value||0,F=Math.max(o.min,c-o.step),m=Math.round(F*Math.pow(10,o.precision))/Math.pow(10,o.precision);h("update:modelValue",m),h("change",m),E(m)};return ie(()=>o.modelValue,c=>{E(c)},{immediate:!0}),E(o.modelValue),(c,F)=>{const m=d("el-button"),O=d("el-button-group"),q=d("el-input");return n(),M(te,null,[e(q,{ref_key:"inputRef",ref:z,modelValue:x.value,"onUpdate:modelValue":F[0]||(F[0]=G=>x.value=G),placeholder:a.placeholder,disabled:a.disabled,class:Be({"is-invalid":S.value}),onInput:g,onBlur:A,onFocus:V},pt({_:2},[a.showControls?{name:"append",fn:t(()=>[e(O,null,{default:t(()=>[e(m,{icon:p(ft),disabled:a.disabled||W.value,onClick:r},null,8,["icon","disabled"]),e(m,{icon:p(mt),disabled:a.disabled||I.value,onClick:D},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),S.value?(n(),M("div",Ft,w(N.value),1)):P("",!0)],64)}}},Tt=fe(Nt,[["__scopeId","data-v-f31d5553"]]),zt={class:"card-header"},Lt={class:"card-header-left"},Ot={class:"card-header-actions"},Pt={class:"metrics-filter"},Ut={class:"metrics-stats"},Bt={class:"metrics-count"},Xt={key:0,class:"metric-description"},qt={key:0,class:"metrics-info"},Gt={class:"info-row"},jt={key:0,class:"info-row"},Jt={key:0,class:"loading-container"},Ht={key:1,class:"no-images"},Kt={key:2,class:"images-container"},Wt={class:"image-controls"},Zt={class:"image-slide"},Qt=["src","alt"],Yt={class:"image-info"},ea={class:"image-filename"},ta={key:0,class:"image-page"},aa={__name:"MetricsEditor",props:{reportId:{type:String,required:!0},reportStatus:{type:String,default:null}},emits:["metrics-updated"],setup(a,{emit:k}){const o=a,h=k,z=_(!1),x=_(!1),U=_(!1),S=_(null),N=_(!1),J=_(0),W=_(0),I=_([]),E=_([]),X=_({metrics:{}}),g=_({}),A=_("metrics"),V=_([]),D=_(!1),r=_(1),c=_(!1),F=_(null),m=_(500),O=_(null),q=Z(()=>{if(!I.value||I.value.length===0)return[];if(N.value)return I.value;const C=new Set(E.value.filter(i=>{const $=parseFloat(String(i.value).replace(",","."));return!isNaN($)&&$>0}).map(i=>i.metric_def_id));return I.value.filter(i=>{const $=C.has(i.id),H=X.value.metrics[i.id],K=H!=null&&H!==""&&parseFloat(String(H).replace(",","."))>0;return $||K})}),G=Z(()=>!E.value||E.value.length===0?[]:[...new Set(E.value.map(C=>C.source))]),j=Z(()=>{if(!E.value||E.value.length===0)return null;const C=E.value.map(i=>i.updated_at||i.created_at).filter(Boolean).map(i=>new Date(i));return C.length===0?null:new Date(Math.max(...C))}),ae=async()=>{z.value=!0,S.value=null;try{const C=await Ce.getMetricTemplate(o.reportId);J.value=C.filled_count||0,W.value=C.missing_count||0;const i=C.items||[];E.value=i.filter($=>$.value!==null).map($=>({metric_def_id:$.metric_def.id,value:$.value,source:$.source,confidence:$.confidence,notes:$.notes,updated_at:$.updated_at})),I.value=i.map($=>({id:$.metric_def.id,code:$.metric_def.code,name:$.metric_def.name,name_ru:$.metric_def.name_ru,unit:$.metric_def.unit,min_value:$.metric_def.min_value,max_value:$.metric_def.max_value,description:$.metric_def.description})),X.value.metrics={},i.forEach($=>{const H=$.metric_def.id;$.value!==null?X.value.metrics[H]=pe($.value):X.value.metrics[H]=null}),g.value=JSON.parse(JSON.stringify(X.value.metrics))}catch(C){console.error("Failed to load metrics:",C),S.value="Не удалось загрузить метрики"}finally{z.value=!1}},ee=async()=>{await ae(),B.success("Метрики обновлены")},me=()=>{O.value||(O.value=setInterval(async()=>{await ae()},5e3))},le=()=>{O.value&&(clearInterval(O.value),O.value=null)},ue=()=>{U.value=!0,N.value=!0,g.value=JSON.parse(JSON.stringify(X.value.metrics))},de=()=>{X.value.metrics=JSON.parse(JSON.stringify(g.value)),U.value=!1,S.value=null},f=async()=>{x.value=!0,S.value=null;try{const C=[],i=[];for(const[Q,oe]of Object.entries(X.value.metrics)){const ce=g.value[Q],ve=ce!=null&&ce!=="";if(oe!=null&&oe!==""){const l=At(oe);l!==null&&C.push({metric_def_id:Q,value:l,source:"MANUAL",notes:null})}else ve&&i.push(Q)}const H=(await Promise.allSettled(i.map(Q=>Ce.clearExtractedMetric(o.reportId,Q)))).filter(Q=>Q.status==="fulfilled"||Q.status==="rejected"&&Q.reason?.response?.status===404).length;C.length>0&&await Ce.bulkCreateExtractedMetrics(o.reportId,C);const K=[];C.length>0&&K.push(`сохранено: ${C.length}`),H>0&&K.push(`сброшено: ${H}`),K.length===0?B.info("Нет изменений для сохранения"):B.success(`Метрики обновлены (${K.join(", ")})`),U.value=!1,await ae(),h("metrics-updated")}catch(C){console.error("Failed to save metrics:",C);let i="Не удалось сохранить метрики";C.response?.data?.detail&&(typeof C.response.data.detail=="string"?i=C.response.data.detail:Array.isArray(C.response.data.detail)&&(i=C.response.data.detail.map($=>$.msg||$.message).join(", "))),S.value=i,B.error(i)}finally{x.value=!1}},ne=C=>{switch(C){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},ke=C=>{switch(C){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return C}},Se=Mt,xe=async()=>{D.value=!0,S.value=null;try{V.value=await ge.getReportImages(o.reportId)}catch(C){console.error("Failed to load report images:",C),S.value="Не удалось загрузить изображения отчёта",B.error("Не удалось загрузить изображения отчёта")}finally{D.value=!1}},Ee=()=>{r.value<2&&(r.value=Math.min(2,r.value+.25))},De=()=>{r.value>.5&&(r.value=Math.max(.5,r.value-.25))},Re=()=>{r.value=1},_e=()=>{c.value=!c.value,c.value?m.value=window.innerHeight-100:m.value=500};return Xe(async()=>{}),Qe(()=>{le()}),ie(()=>o.reportId,async C=>{C&&(await ae(),V.value=[])}),ie(()=>o.reportStatus,async(C,i)=>{i||await ae(),C==="PROCESSING"?(me(),i&&i!=="PROCESSING"&&await ae()):(le(),C==="EXTRACTED"&&i&&i!=="EXTRACTED"&&await ae())},{immediate:!0}),ie(A,async C=>{C==="images"&&V.value.length===0&&!D.value&&await xe()}),(C,i)=>{const $=d("el-icon"),H=d("el-tag"),K=d("el-button"),Q=d("el-alert"),oe=d("el-switch"),ce=d("el-form-item"),ve=d("el-col"),l=d("el-row"),s=d("el-form"),T=d("el-divider"),R=d("el-tab-pane"),re=d("el-empty"),Me=d("el-button-group"),ye=d("el-carousel-item"),Ie=d("el-carousel"),Ve=d("el-tabs"),Ae=d("el-card");return n(),y(Ae,{class:"metrics-editor"},{header:t(()=>[u("div",zt,[u("div",Lt,[i[5]||(i[5]=u("span",null,"Метрики отчёта",-1)),a.reportStatus==="PROCESSING"?(n(),y(H,{key:0,type:"warning",size:"small",class:"status-tag"},{default:t(()=>[e($,{class:"is-loading"},{default:t(()=>[e(p(we))]),_:1}),i[3]||(i[3]=v(" Извлечение... ",-1))]),_:1})):a.reportStatus==="EXTRACTED"?(n(),y(H,{key:1,type:"success",size:"small",class:"status-tag"},{default:t(()=>[...i[4]||(i[4]=[v(" Извлечено ",-1)])]),_:1})):P("",!0)]),u("div",Ot,[U.value?P("",!0):(n(),y(K,{key:0,size:"small",loading:z.value,onClick:ee},{default:t(()=>[e($,null,{default:t(()=>[e(p(et))]),_:1}),i[6]||(i[6]=v(" Обновить ",-1))]),_:1},8,["loading"])),U.value?(n(),M(te,{key:2},[e(K,{size:"small",onClick:de},{default:t(()=>[...i[8]||(i[8]=[v(" Отмена ",-1)])]),_:1}),e(K,{type:"primary",size:"small",loading:x.value,onClick:f},{default:t(()=>[...i[9]||(i[9]=[v(" Сохранить ",-1)])]),_:1},8,["loading"])],64)):(n(),y(K,{key:1,type:"primary",size:"small",onClick:ue},{default:t(()=>[...i[7]||(i[7]=[v(" Редактировать ",-1)])]),_:1}))])])]),default:t(()=>[S.value?(n(),y(Q,{key:0,type:"error",title:S.value,closable:"",style:{"margin-bottom":"16px"},onClose:i[0]||(i[0]=L=>S.value=null)},null,8,["title"])):P("",!0),!E.value||E.value.length===0?(n(),y(Q,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:t(()=>[...i[10]||(i[10]=[v(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):P("",!0),e(Ve,{modelValue:A.value,"onUpdate:modelValue":i[2]||(i[2]=L=>A.value=L),type:"card"},{default:t(()=>[e(R,{label:"Метрики",name:"metrics"},{default:t(()=>[u("div",Pt,[e(oe,{modelValue:N.value,"onUpdate:modelValue":i[1]||(i[1]=L=>N.value=L),"active-text":"Показать все метрики","inactive-text":"Только заполненные"},null,8,["modelValue"]),u("div",Ut,[e(H,{type:"success",size:"small"},{default:t(()=>[v(" Заполнено: "+w(J.value),1)]),_:1}),e(H,{type:"info",size:"small"},{default:t(()=>[v(" Не заполнено: "+w(W.value),1)]),_:1}),u("span",Bt," Показано: "+w(q.value.length)+" из "+w(I.value.length),1)])]),e(s,{ref:"formRef",model:X.value,"label-position":"top",disabled:!U.value},{default:t(()=>[e(l,{gutter:20},{default:t(()=>[(n(!0),M(te,null,se(q.value,L=>(n(),y(ve,{key:L.id,xs:24,sm:12,md:8,lg:6},{default:t(()=>[e(ce,{label:p(Dt)(L),prop:`metrics.${L.id}`},{default:t(()=>[e(Tt,{modelValue:X.value.metrics[L.id],"onUpdate:modelValue":Fe=>X.value.metrics[L.id]=Fe,min:L.min_value||1,max:L.max_value||10,precision:1,step:.1,disabled:!U.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),L.description?(n(),M("div",Xt,w(L.description),1)):P("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),E.value&&E.value.length>0?(n(),M("div",qt,[e(T),u("div",Gt,[i[11]||(i[11]=u("span",{class:"info-label"},"Источник данных:",-1)),(n(!0),M(te,null,se(G.value,L=>(n(),y(H,{key:L,type:ne(L),size:"small",style:{"margin-left":"8px"}},{default:t(()=>[v(w(ke(L)),1)]),_:2},1032,["type"]))),128))]),j.value?(n(),M("div",jt,[i[12]||(i[12]=u("span",{class:"info-label"},"Последнее обновление:",-1)),u("span",null,w(p(Se)(j.value)),1)])):P("",!0)])):P("",!0)]),_:1}),e(R,{label:"Изображения отчёта",name:"images"},{default:t(()=>[D.value?(n(),M("div",Jt,[e($,{class:"is-loading"},{default:t(()=>[e(p(we))]),_:1}),i[13]||(i[13]=u("span",{style:{"margin-left":"8px"}},"Загрузка изображений...",-1))])):V.value.length===0?(n(),M("div",Ht,[e(re,{description:"Изображения отсутствуют"},{image:t(()=>[e($,{size:60,color:"var(--el-color-info)"},{default:t(()=>[e(p(_t))]),_:1})]),_:1})])):(n(),M("div",Kt,[u("div",Wt,[e(Me,null,{default:t(()=>[e(K,{disabled:r.value<=.5,onClick:De},{default:t(()=>[e($,null,{default:t(()=>[e(p(vt))]),_:1})]),_:1},8,["disabled"]),e(K,{onClick:Re},{default:t(()=>[v(w(Math.round(r.value*100))+"% ",1)]),_:1}),e(K,{disabled:r.value>=2,onClick:Ee},{default:t(()=>[e($,null,{default:t(()=>[e(p(yt))]),_:1})]),_:1},8,["disabled"])]),_:1}),e(K,{style:{"margin-left":"12px"},onClick:_e},{default:t(()=>[e($,null,{default:t(()=>[e(p(gt))]),_:1}),i[14]||(i[14]=v(" Полноэкранный режим ",-1))]),_:1})]),u("div",{ref_key:"carouselContainer",ref:F,class:Be(["carousel-wrapper",{fullscreen:c.value}])},[e(Ie,{height:m.value+"px",arrow:"always","indicator-position":"outside"},{default:t(()=>[(n(!0),M(te,null,se(V.value,L=>(n(),y(ye,{key:L.id},{default:t(()=>[u("div",Zt,[u("div",{class:"image-wrapper",style:Ye({transform:`scale(${r.value})`})},[u("img",{src:L.data_url,alt:L.filename,class:"report-image"},null,8,Qt)],4),u("div",Yt,[u("span",ea,w(L.filename),1),L.page_number?(n(),M("span",ta," Страница "+w(L.page_number),1)):P("",!0)])])]),_:2},1024))),128))]),_:1},8,["height"]),c.value?(n(),y(K,{key:0,class:"exit-fullscreen",circle:"",onClick:_e},{default:t(()=>[e($,null,{default:t(()=>[e(p(wt))]),_:1})]),_:1})):P("",!0)],2)]))]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},la=fe(aa,[["__scopeId","data-v-4c7faa80"]]),sa={class:"report-list"},na={class:"report-list__controls"},oa={class:"controls-left"},ra={class:"controls-right"},ia={class:"filename"},ua={class:"status-cell"},ca={key:1,class:"report-list__cards"},da={class:"report-card__header"},pa={class:"report-card__status"},fa={class:"report-card__body"},ma={class:"report-card__field"},_a={class:"field-value field-value--filename"},va={class:"report-card__field"},ya={class:"field-value"},ga={class:"report-card__actions"},wa={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(a,{emit:k}){const o=a,h=k,z=tt(),x=at(),{isMobile:U}=lt();Xe(()=>{z.query.status&&(S.value=z.query.status),z.query.sort&&(N.value=z.query.sort)});const S=_(""),N=_("desc"),J=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];ie([S,N],([D,r])=>{const c={...z.query};D?c.status=D:delete c.status,r?c.sort=r:delete c.sort,x.replace({query:c})});const W=()=>{},I=()=>{N.value=N.value==="desc"?"asc":"desc"},E=Z(()=>{let D=[...o.reports];return S.value&&(D=D.filter(r=>r.status===S.value)),D.sort((r,c)=>{const F=new Date(r.uploaded_at),m=new Date(c.uploaded_at);return N.value==="desc"?m-F:F-m}),D}),X=Z(()=>S.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),g=D=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[D]||D,A=D=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[D]||"info",V=async({action:D,report:r})=>{switch(D){case"view":h("view",r.id);break;case"edit":h("edit",r.id);break;case"extract":h("extract",r.id);break;case"download":h("download",r.id);break;case"delete":try{await kt.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),h("delete",r.id)}catch{}break}};return(D,r)=>{const c=d("el-option"),F=d("el-select"),m=d("el-icon"),O=d("el-button"),q=d("el-table-column"),G=d("el-tag"),j=d("el-dropdown-item"),ae=d("el-dropdown-menu"),ee=d("el-dropdown"),me=d("el-table"),le=d("el-card"),ue=d("el-empty"),de=qe("loading");return n(),M("div",sa,[u("div",na,[u("div",oa,[e(F,{modelValue:S.value,"onUpdate:modelValue":r[0]||(r[0]=f=>S.value=f),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:W},{default:t(()=>[e(c,{label:"Все статусы",value:""}),(n(),M(te,null,se(J,f=>e(c,{key:f.value,label:f.label,value:f.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),u("div",ra,[e(O,{type:N.value==="desc"?"primary":"default",size:"small",onClick:I},{default:t(()=>[e(m,null,{default:t(()=>[e(p(ht))]),_:1}),v(" "+w(N.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),p(U)?he((n(),M("div",ca,[(n(!0),M(te,null,se(E.value,f=>(n(),y(le,{key:f.id,class:"report-card",shadow:"hover"},{header:t(()=>[u("div",da,[u("div",pa,[f.status==="PROCESSING"?(n(),y(m,{key:0,class:"status-icon status-icon--spinning"},{default:t(()=>[e(p(we))]),_:1})):f.status==="EXTRACTED"?(n(),y(m,{key:1,class:"status-icon status-icon--success"},{default:t(()=>[e(p(ze))]),_:1})):f.status==="FAILED"?(n(),y(m,{key:2,class:"status-icon status-icon--error"},{default:t(()=>[e(p(Le))]),_:1})):(n(),y(m,{key:3,class:"status-icon status-icon--info"},{default:t(()=>[e(p(Oe))]),_:1})),e(G,{type:A(f.status),size:"small"},{default:t(()=>[v(w(g(f.status)),1)]),_:2},1032,["type"])])])]),footer:t(()=>[u("div",ga,[f.status==="EXTRACTED"?(n(),y(O,{key:0,type:"success",size:"small",onClick:ne=>V({action:"edit",report:f})},{default:t(()=>[e(m,null,{default:t(()=>[e(p(Je))]),_:1}),r[10]||(r[10]=v(" Редактировать ",-1))]),_:1},8,["onClick"])):P("",!0),f.status==="PROCESSING"||f.status==="EXTRACTED"?(n(),y(O,{key:1,type:"info",size:"small",onClick:ne=>V({action:"view",report:f})},{default:t(()=>[e(m,null,{default:t(()=>[e(p(He))]),_:1}),r[11]||(r[11]=v(" Просмотр ",-1))]),_:1},8,["onClick"])):P("",!0),e(O,{type:"primary",size:"small",onClick:ne=>V({action:"extract",report:f})},{default:t(()=>[e(m,null,{default:t(()=>[e(p(Ke))]),_:1}),v(" "+w(f.status==="FAILED"?"Повторить":f.status==="PROCESSING"?"Перезапустить":f.status==="EXTRACTED"?"Переизвлечь":"Извлечь"),1)]),_:2},1032,["onClick"]),e(O,{size:"small",onClick:ne=>V({action:"download",report:f})},{default:t(()=>[e(m,null,{default:t(()=>[e(p(Pe))]),_:1}),r[12]||(r[12]=v(" Скачать ",-1))]),_:1},8,["onClick"]),e(O,{type:"danger",size:"small",onClick:ne=>V({action:"delete",report:f})},{default:t(()=>[e(m,null,{default:t(()=>[e(p(Ue))]),_:1})]),_:1},8,["onClick"])])]),default:t(()=>[u("div",fa,[u("div",ma,[r[8]||(r[8]=u("span",{class:"field-label"},"Файл:",-1)),u("span",_a,w(f.file_ref?.filename||"Без названия"),1)]),u("div",va,[r[9]||(r[9]=u("span",{class:"field-label"},"Дата загрузки:",-1)),u("span",ya,w(p(be)(f.uploaded_at)),1)])])]),_:2},1024))),128)),!E.value.length&&!a.loading?(n(),y(ue,{key:0,description:X.value,"image-size":120},{default:t(()=>[S.value?P("",!0):(n(),y(O,{key:0,type:"primary",onClick:r[1]||(r[1]=f=>D.$emit("upload"))},{default:t(()=>[...r[13]||(r[13]=[v(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):P("",!0)])),[[de,a.loading]]):he((n(),y(me,{key:0,data:E.value,class:"report-list__table",stripe:"","empty-text":X.value},{default:t(()=>[e(q,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:t(({row:f})=>[u("span",ia,w(f.file_ref?.filename||"Без названия"),1)]),_:1}),e(q,{prop:"status",label:"Статус",width:"200"},{default:t(({row:f})=>[u("div",ua,[f.status==="PROCESSING"?(n(),y(m,{key:0,class:"status-icon status-icon--spinning"},{default:t(()=>[e(p(we))]),_:1})):f.status==="EXTRACTED"?(n(),y(m,{key:1,class:"status-icon status-icon--success"},{default:t(()=>[e(p(ze))]),_:1})):f.status==="FAILED"?(n(),y(m,{key:2,class:"status-icon status-icon--error"},{default:t(()=>[e(p(Le))]),_:1})):(n(),y(m,{key:3,class:"status-icon status-icon--info"},{default:t(()=>[e(p(Oe))]),_:1})),e(G,{type:A(f.status),size:"default"},{default:t(()=>[v(w(g(f.status)),1)]),_:2},1032,["type"])])]),_:1}),e(q,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:t(({row:f})=>[v(w(p(be)(f.uploaded_at)),1)]),_:1}),e(q,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:t(({row:f})=>[e(ee,{trigger:"click",onCommand:V},{dropdown:t(()=>[e(ae,null,{default:t(()=>[f.status==="EXTRACTED"?(n(),y(j,{key:0,command:{action:"edit",report:f}},{default:t(()=>[e(m,null,{default:t(()=>[e(p(Je))]),_:1}),r[4]||(r[4]=v(" Редактировать метрики ",-1))]),_:1},8,["command"])):P("",!0),f.status==="PROCESSING"||f.status==="EXTRACTED"?(n(),y(j,{key:1,command:{action:"view",report:f}},{default:t(()=>[e(m,null,{default:t(()=>[e(p(He))]),_:1}),r[5]||(r[5]=v(" Просмотр метрик ",-1))]),_:1},8,["command"])):P("",!0),e(j,{command:{action:"extract",report:f}},{default:t(()=>[e(m,null,{default:t(()=>[e(p(Ke))]),_:1}),v(" "+w(f.status==="FAILED"?"Повторить извлечение":f.status==="PROCESSING"?"Перезапустить извлечение":f.status==="EXTRACTED"?"Переизвлечь метрики":"Извлечь метрики"),1)]),_:2},1032,["command"]),e(j,{divided:"",command:{action:"download",report:f}},{default:t(()=>[e(m,null,{default:t(()=>[e(p(Pe))]),_:1}),r[6]||(r[6]=v(" Скачать ",-1))]),_:1},8,["command"]),e(j,{command:{action:"delete",report:f},class:"dropdown-item--danger"},{default:t(()=>[e(m,null,{default:t(()=>[e(p(Ue))]),_:1}),r[7]||(r[7]=v(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:t(()=>[e(O,{type:"primary",size:"small"},{default:t(()=>[r[3]||(r[3]=v(" Действия ",-1)),e(m,{class:"el-icon--right"},{default:t(()=>[e(p(bt))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[de,a.loading]]),!E.value.length&&!a.loading&&!p(U)?(n(),y(ue,{key:2,description:X.value,"image-size":120},{default:t(()=>[S.value?P("",!0):(n(),y(O,{key:0,type:"primary",onClick:r[2]||(r[2]=f=>D.$emit("upload"))},{default:t(()=>[...r[14]||(r[14]=[v(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):P("",!0)])}}},ha=fe(wa,[["__scopeId","data-v-49005412"]]),ba={class:"metrics-drawer"},ka={class:"drawer-actions"},Ca={key:1},$a={key:1},Sa={__name:"ParticipantMetricsDrawer",props:{modelValue:{type:Boolean,required:!0},participantId:{type:String,required:!0},participantName:{type:String,required:!0}},emits:["update:modelValue"],setup(a,{emit:k}){const o=a,h=k,z=nt(),x=_(!1),U=_([]),S=Z(()=>z.metricDefs),N=Z(()=>"Метрики ещё не извлечены. Загрузите и обработайте отчёты."),J=g=>{h("update:modelValue",g)},W=async()=>{try{await z.fetchMetricDefs({activeOnly:!0})}catch(g){console.error("Error loading metric definitions:",g)}},I=async()=>{x.value=!0;try{const g=await st.getMetrics(o.participantId);U.value=g.metrics||[]}catch(g){console.error("Error loading participant metrics:",g),B.error("Ошибка загрузки метрик участника")}finally{x.value=!1}},E=g=>{if(!g)return"—";const A=S.value?.find(D=>D.code===g);return Rt(A,g,{warn:()=>{}})},X=g=>g>=.8?"var(--el-color-success)":g>=.6?"var(--el-color-warning)":"var(--el-color-danger)";return ie(()=>o.participantId,async g=>{g&&o.modelValue&&(await W(),await I())}),ie(()=>o.modelValue,async g=>{g&&o.participantId&&(await W(),await I())}),(g,A)=>{const V=d("el-icon"),D=d("el-button"),r=d("el-table-column"),c=d("el-tag"),F=d("el-table"),m=d("el-empty"),O=d("el-drawer"),q=qe("loading");return n(),y(O,{"model-value":a.modelValue,title:`Метрики участника: ${a.participantName}`,size:"70%",direction:"rtl","onUpdate:modelValue":J},{default:t(()=>[he((n(),M("div",ba,[u("div",ka,[e(D,{type:"primary",size:"small",onClick:I},{default:t(()=>[e(V,null,{default:t(()=>[e(p(et))]),_:1}),A[0]||(A[0]=v(" Обновить ",-1))]),_:1})]),e(F,{data:U.value,stripe:"","empty-text":N.value},{default:t(()=>[e(r,{prop:"metric_code",label:"Код метрики",width:"200"}),e(r,{label:"Название метрики","min-width":"250"},{default:t(({row:G})=>[v(w(E(G.metric_code)),1)]),_:1}),e(r,{prop:"value",label:"Значение",width:"120"},{default:t(({row:G})=>[e(c,{type:"success"},{default:t(()=>[v(w(p(ot)(G.value)),1)]),_:2},1024)]),_:1}),e(r,{prop:"confidence",label:"Уверенность",width:"150"},{default:t(({row:G})=>[G.confidence!==null?(n(),M("span",{key:0,style:Ye({color:X(G.confidence)})},w((G.confidence*100).toFixed(0))+"% ",5)):(n(),M("span",Ca,"—"))]),_:1}),e(r,{prop:"updated_at",label:"Обновлено",width:"180"},{default:t(({row:G})=>[v(w(p(be)(G.updated_at)),1)]),_:1}),e(r,{prop:"last_source_report_id",label:"Источник"},{default:t(({row:G})=>[G.last_source_report_id?(n(),y(c,{key:0,size:"small"},{default:t(()=>[...A[1]||(A[1]=[v(" Из отчёта ",-1)])]),_:1})):(n(),M("span",$a,"—"))]),_:1})]),_:1},8,["data","empty-text"]),!U.value.length&&!x.value?(n(),y(m,{key:0,description:N.value},null,8,["description"])):P("",!0)])),[[q,x.value]])]),_:1},8,["model-value","title"])}}},xa=fe(Sa,[["__scopeId","data-v-ce564aa7"]]),Ea={class:"scoring-result"},Da={class:"score-value"},Ra={class:"score-number"},Ma={class:"score-details"},Ia={class:"score-section"},Va={key:0},Aa={class:"score-section"},Fa={key:0},Na={key:0,class:"final-report-actions"},Ta={__name:"ScoringResultCard",props:{result:{type:Object,required:!0}},emits:["download-pdf"],setup(a){const k=a,o=Z(()=>{const z=k.result.score_pct;return z>=70?"success":z>=40?"warning":"exception"}),h=(z,x=1)=>ot(z,x);return(z,x)=>{const U=d("el-progress"),S=d("el-empty"),N=d("el-icon"),J=d("el-button"),W=d("el-card");return n(),y(W,{class:"scoring-card"},{default:t(()=>[u("h4",null,w(a.result.prof_activity_name),1),u("div",Ea,[u("div",Da,[u("span",Ra,w(a.result.score_pct)+"%",1),e(U,{percentage:a.result.score_pct,status:o.value},null,8,["percentage","status"])]),u("div",Ma,[u("div",Ia,[x[1]||(x[1]=u("h5",null,"Сильные стороны:",-1)),a.result.strengths&&a.result.strengths.length?(n(),M("ul",Va,[(n(!0),M(te,null,se(a.result.strengths,(I,E)=>(n(),M("li",{key:E},[u("strong",null,w(I.metric_name),1),v(" — "+w(h(I.value))+" (вес "+w(h(I.weight,2))+") ",1)]))),128))])):(n(),y(S,{key:1,description:"Нет данных","image-size":60}))]),u("div",Aa,[x[2]||(x[2]=u("h5",null,"Зоны развития:",-1)),a.result.dev_areas&&a.result.dev_areas.length?(n(),M("ul",Fa,[(n(!0),M(te,null,se(a.result.dev_areas,(I,E)=>(n(),M("li",{key:E},[u("strong",null,w(I.metric_name),1),v(" — "+w(h(I.value))+" (вес "+w(h(I.weight,2))+") ",1)]))),128))])):(n(),y(S,{key:1,description:"Нет данных","image-size":60}))])]),a.result.prof_activity_code?(n(),M("div",Na,[e(J,{type:"primary",size:"small",onClick:x[0]||(x[0]=I=>z.$emit("download-pdf",a.result))},{default:t(()=>[e(N,null,{default:t(()=>[e(p(Pe))]),_:1}),x[3]||(x[3]=v(" Скачать PDF ",-1))]),_:1})])):P("",!0)])]),_:1})}}},za=fe(Ta,[["__scopeId","data-v-d4c54e9d"]]),La={class:"participant-detail"},Oa={class:"card-header"},Pa={class:"header-actions"},Ua={class:"section-header"},Ba={key:0,class:"batch-files-list"},Xa={class:"batch-files-header"},qa={class:"batch-file-info"},Ga={class:"batch-file-name"},ja={class:"batch-file-size"},Ja={key:0,class:"batch-file-error"},Ha={class:"activity-code-hint"},Ze=20*1024*1024,Te=10,Ka={__name:"ParticipantDetailView",setup(a){const k=at(),o=tt(),h=Vt(),z=nt(),x=_(!1),U=_(!1),{isMobile:S}=lt(),N=_(!1),J=_(!1),W=_(!1),I=Z(()=>h.currentParticipant),E=_([]),X=_([]),g=_([]),A=_(null);Z(()=>z.metricDefs);const V=_(null),D=Z(()=>E.value.some(l=>l.status==="PROCESSING")),r=Z(()=>A.value&&E.value.find(s=>s.id===A.value)?.status||null),c=_(!1),F=_(!1),m=_(!1),O=_(!1),q=_(null),G=_([]),j=_([]);let ae=0;const ee=Ct({activityCode:""}),me=async()=>{x.value=!0;try{await h.getParticipant(o.params.id)}catch{B.error("Участник не найден"),k.push("/participants")}finally{x.value=!1}},le=async({silent:l=!1}={})=>{l||(U.value=!0);try{const s=await st.getReports(o.params.id);E.value=s.items||[]}catch(s){console.error("Error loading reports:",s),B.error("Ошибка загрузки списка отчётов")}finally{l||(U.value=!1)}},ue=l=>{if(!l)return l;const s=Array.isArray(l.recommendations)?l.recommendations:[];let T=l.recommendations_status||l.recommendationsStatus||null;T||(T=s.length>0?"ready":"pending");const R=Number(l.score_pct),re=Number.isNaN(R)?l.score_pct:R;return{...l,score_pct:re,recommendations:s,recommendations_status:T,recommendations_error:l.recommendations_error||l.recommendationsError||null}},de=async()=>{try{const l=await Ne.getHistory(o.params.id),s=Array.isArray(l.items)?l.items:[];X.value=s.map(ue)}catch(l){console.error("Error loading scoring results:",l)}},f=async()=>{N.value=!0;try{const l=await It.list();g.value=l||[]}catch{B.error("Ошибка загрузки профессиональных областей")}finally{N.value=!1}},ne=async()=>{try{await z.fetchMetricDefs({activeOnly:!0})}catch(l){console.error("Error loading metric definitions:",l)}},ke=l=>l<1024?l+" B":l<1024*1024?(l/1024).toFixed(1)+" KB":(l/(1024*1024)).toFixed(1)+" MB",Se=l=>l.name.toLowerCase().endsWith(".docx")?l.size>Ze?`Размер файла превышает ${ke(Ze)}`:null:"Только файлы формата .docx",xe=(l,s)=>{const T=l.raw;if(j.value.length>=Te){B.warning(`Максимальное количество файлов: ${Te}`),q.value&&q.value.clearFiles();return}const R=Se(T);if(R){B.error(R),q.value&&q.value.clearFiles();return}j.value.push({id:++ae,file:T,name:T.name,size:T.size,status:"pending",progress:0,error:null,reportId:null}),q.value&&q.value.clearFiles()},Ee=l=>{j.value=j.value.filter(s=>s.id!==l)},De=async l=>{l.status="uploading",l.progress=0;try{const s=await ge.upload(o.params.id,l.file);l.status="success",l.reportId=s.id}catch(s){l.status="error",l.error=s.response?.data?.detail||"Ошибка загрузки"}},Re=async()=>{const l=j.value.filter(s=>s.status==="pending");if(l.length===0){B.warning("Нет файлов для загрузки");return}J.value=!0;try{await Promise.allSettled(l.map(R=>De(R)));const s=j.value.filter(R=>R.status==="success").length,T=j.value.filter(R=>R.status==="error").length;T===0?(B.success(`Загружено ${s} отчётов`),c.value=!1,_e()):B.warning(`Загружено: ${s}, ошибок: ${T}`),await le()}finally{J.value=!1}},_e=()=>{j.value=[],G.value=[],q.value&&q.value.clearFiles()},C=async l=>{try{const s=await ge.download(l),T=window.URL.createObjectURL(new Blob([s.data])),R=document.createElement("a");R.href=T,R.setAttribute("download",`report_${l}.docx`),document.body.appendChild(R),R.click(),R.remove(),window.URL.revokeObjectURL(T),B.success("Отчёт скачан")}catch{B.error("Ошибка скачивания отчёта")}},i=async l=>{try{await ge.extract(l),B.success("Извлечение метрик запущено"),await le()}catch{B.error("Ошибка запуска извлечения метрик")}},$=()=>{V.value||(V.value=setInterval(async()=>{try{await le({silent:!0})}catch(l){console.error("Auto-refresh error:",l)}},3e3))},H=()=>{V.value&&(clearInterval(V.value),V.value=null)};ie(D,l=>{l?$():H()});const K=async l=>{A.value=l,await xt(),m.value=!0},Q=async()=>{B.success("Метрики обновлены"),await le({silent:!0})},oe=async l=>{try{await ge.delete(l),B.success("Отчёт удалён"),await le()}catch{B.error("Ошибка удаления отчёта")}},ce=async()=>{if(!ee.activityCode){B.warning("Выберите профессиональную область");return}W.value=!0;try{const l=await Ne.calculate(o.params.id,ee.activityCode),s=ue({id:l.scoring_result_id,participant_id:o.params.id,prof_activity_code:l.prof_activity_code||ee.activityCode,prof_activity_name:l.prof_activity_name,score_pct:parseFloat(l.score_pct),strengths:l.strengths||[],dev_areas:l.dev_areas||[],recommendations:l.recommendations||[],recommendations_status:l.recommendations_status||((l.recommendations||[]).length>0?"ready":"pending"),recommendations_error:l.recommendations_error||null,created_at:new Date().toISOString()});X.value.unshift(s),B.success("Расчёт пригодности выполнен"),F.value=!1,ee.activityCode=""}catch(l){console.error("Scoring calculation error:",l);const s=l.response?.data?.detail||"Ошибка расчёта пригодности";B.error(s)}finally{W.value=!1}},ve=async l=>{if(!l.prof_activity_code){B.warning("Код профессиональной деятельности не найден");return}try{const s=await Ne.downloadFinalReportPdf(o.params.id,l.prof_activity_code,l.id),T=window.URL.createObjectURL(new Blob([s.data])),R=document.createElement("a");R.href=T,R.setAttribute("download",`final_report_${l.prof_activity_code}_${new Date().toISOString().split("T")[0]}.pdf`),document.body.appendChild(R),R.click(),R.remove(),window.URL.revokeObjectURL(T),B.success("Отчёт PDF скачан")}catch(s){const T=s.response?.data?.detail||"Ошибка загрузки PDF отчёта";B.error(T)}};return Xe(async()=>{await Promise.all([me(),le(),de(),f(),ne()])}),Qe(()=>{H()}),(l,s)=>{const T=d("el-button"),R=d("el-icon"),re=d("el-descriptions-item"),Me=d("el-descriptions"),ye=d("el-card"),Ie=d("el-timeline-item"),Ve=d("el-timeline"),Ae=d("el-upload"),L=d("el-dialog"),Fe=d("el-option"),rt=d("el-select"),it=d("el-form-item"),Ge=d("el-alert"),ut=d("el-form"),je=qe("loading");return n(),y(Et,null,{default:t(()=>[he((n(),M("div",La,[I.value?(n(),y(ye,{key:0,class:"detail-card"},{header:t(()=>[u("div",Oa,[u("h2",null,w(I.value.full_name),1),u("div",Pa,[e(T,{onClick:s[0]||(s[0]=b=>p(k).back())},{default:t(()=>[...s[12]||(s[12]=[v(" Назад ",-1)])]),_:1}),e(T,{type:"info",onClick:s[1]||(s[1]=b=>O.value=!0)},{default:t(()=>[e(R,null,{default:t(()=>[e(p($t))]),_:1}),s[13]||(s[13]=v(" Метрики ",-1))]),_:1}),e(T,{type:"primary",onClick:s[2]||(s[2]=b=>F.value=!0)},{default:t(()=>[e(R,null,{default:t(()=>[e(p(St))]),_:1}),s[14]||(s[14]=v(" Рассчитать пригодность ",-1))]),_:1})])])]),default:t(()=>[e(Me,{column:p(S)?1:2,border:""},{default:t(()=>[e(re,{label:"ФИО"},{default:t(()=>[v(w(I.value.full_name),1)]),_:1}),e(re,{label:"Дата рождения"},{default:t(()=>[v(w(I.value.birth_date||"Не указана"),1)]),_:1}),e(re,{label:"Внешний ID"},{default:t(()=>[v(w(I.value.external_id||"Не указан"),1)]),_:1}),e(re,{label:"Дата создания"},{default:t(()=>[v(w(p(be)(I.value.created_at)),1)]),_:1})]),_:1},8,["column"])]),_:1})):P("",!0),e(ye,{class:"section-card"},{header:t(()=>[u("div",Ua,[s[16]||(s[16]=u("h3",null,"Отчёты",-1)),e(T,{type:"primary",onClick:s[3]||(s[3]=b=>c.value=!0)},{default:t(()=>[e(R,null,{default:t(()=>[e(p(We))]),_:1}),s[15]||(s[15]=v(" Загрузить отчёт ",-1))]),_:1})])]),default:t(()=>[e(ha,{reports:E.value,loading:U.value,onView:K,onEdit:K,onExtract:i,onDownload:C,onDelete:oe,onUpload:s[4]||(s[4]=b=>c.value=!0)},null,8,["reports","loading"])]),_:1}),X.value.length>0?(n(),y(ye,{key:1,class:"section-card"},{header:t(()=>[...s[17]||(s[17]=[u("h3",null,"История оценок пригодности",-1)])]),default:t(()=>[e(Ve,null,{default:t(()=>[(n(!0),M(te,null,se(X.value,b=>(n(),y(Ie,{key:b.id,timestamp:p(be)(b.created_at),placement:"top"},{default:t(()=>[e(za,{result:b,onDownloadPdf:ve},null,8,["result"])]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):P("",!0),e(L,{modelValue:c.value,"onUpdate:modelValue":s[6]||(s[6]=b=>c.value=b),title:"Загрузить отчёты",width:p(S)?"95%":"600px","destroy-on-close":"",onClose:_e},{footer:t(()=>[e(T,{onClick:s[5]||(s[5]=b=>c.value=!1)},{default:t(()=>[...s[20]||(s[20]=[v(" Отмена ",-1)])]),_:1}),e(T,{type:"primary",loading:J.value,disabled:!j.value.some(b=>b.status==="pending"),onClick:Re},{default:t(()=>[v(" Загрузить все ("+w(j.value.filter(b=>b.status==="pending").length)+") ",1)]),_:1},8,["loading","disabled"])]),default:t(()=>[e(Ae,{ref_key:"uploadRef",ref:q,"auto-upload":!1,multiple:"",accept:".docx","on-change":xe,"show-file-list":!1,drag:""},{tip:t(()=>[...s[18]||(s[18]=[u("div",{class:"el-upload__tip"}," Только .docx файлы, макс. 20 МБ, до 10 файлов ",-1)])]),default:t(()=>[e(R,{class:"el-icon--upload"},{default:t(()=>[e(p(We))]),_:1}),s[19]||(s[19]=u("div",{class:"el-upload__text"},[v(" Перетащите файлы сюда или "),u("em",null,"нажмите для выбора")],-1))]),_:1},512),j.value.length?(n(),M("div",Ba,[u("div",Xa," Выбрано файлов: "+w(j.value.length)+"/"+w(Te),1),(n(!0),M(te,null,se(j.value,b=>(n(),M("div",{key:b.id,class:Be(["batch-file-item","batch-file-item--"+b.status])},[b.status==="pending"?(n(),y(R,{key:0,class:"batch-file-icon"},{default:t(()=>[e(p(Oe))]),_:1})):b.status==="uploading"?(n(),y(R,{key:1,class:"batch-file-icon is-loading"},{default:t(()=>[e(p(we))]),_:1})):b.status==="success"?(n(),y(R,{key:2,class:"batch-file-icon batch-file-icon--success"},{default:t(()=>[e(p(ze))]),_:1})):b.status==="error"?(n(),y(R,{key:3,class:"batch-file-icon batch-file-icon--error"},{default:t(()=>[e(p(Le))]),_:1})):P("",!0),u("div",qa,[u("span",Ga,w(b.name),1),u("span",ja,w(ke(b.size)),1),b.error?(n(),M("span",Ja,w(b.error),1)):P("",!0)]),b.status==="pending"||b.status==="error"?(n(),y(T,{key:4,type:"danger",icon:p(Ue),circle:"",size:"small",onClick:Wa=>Ee(b.id)},null,8,["icon","onClick"])):P("",!0)],2))),128))])):P("",!0)]),_:1},8,["modelValue","width"]),e(L,{modelValue:F.value,"onUpdate:modelValue":s[9]||(s[9]=b=>F.value=b),title:"Рассчитать профессиональную пригодность",width:p(S)?"95%":"500px","destroy-on-close":""},{footer:t(()=>[e(T,{onClick:s[8]||(s[8]=b=>F.value=!1)},{default:t(()=>[...s[21]||(s[21]=[v(" Отмена ",-1)])]),_:1}),e(T,{type:"primary",loading:W.value,disabled:!ee.activityCode||E.value.length===0,onClick:ce},{default:t(()=>[...s[22]||(s[22]=[v(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:t(()=>[e(ut,{model:ee,"label-position":"top"},{default:t(()=>[e(it,{label:"Профессиональная область",required:""},{default:t(()=>[he((n(),y(rt,{modelValue:ee.activityCode,"onUpdate:modelValue":s[7]||(s[7]=b=>ee.activityCode=b),placeholder:"Выберите область",style:{width:"100%"}},{default:t(()=>[(n(!0),M(te,null,se(g.value,b=>(n(),y(Fe,{key:b.code,label:b.name,value:b.code},{default:t(()=>[u("span",null,w(b.name),1),u("span",Ha,w(b.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[je,N.value]])]),_:1}),e(Ge,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),E.value.length===0?(n(),y(Ge,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):P("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),e(L,{modelValue:m.value,"onUpdate:modelValue":s[10]||(s[10]=b=>m.value=b),title:"Метрики отчёта",width:"90%",top:"5vh","destroy-on-close":""},{default:t(()=>[A.value?(n(),y(la,{key:0,"report-id":A.value,"report-status":r.value,onMetricsUpdated:Q},null,8,["report-id","report-status"])):P("",!0)]),_:1},8,["modelValue"]),e(xa,{modelValue:O.value,"onUpdate:modelValue":s[11]||(s[11]=b=>O.value=b),"participant-id":I.value?.id,"participant-name":I.value?.full_name},null,8,["modelValue","participant-id","participant-name"])])),[[je,x.value]])]),_:1})}}},ll=fe(Ka,[["__scopeId","data-v-0b627b1b"]]);export{ll as default};
