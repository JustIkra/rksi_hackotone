import{P as Q,m as v,Q as Y,p as re,r as p,c as R,o as l,d as t,x as V,R as Rt,w as e,u as g,S as Et,L as St,z as Ye,B as y,F as ae,H as et,I as tt,v as f,f as m,a as i,C as le,T as $e,U as xt,V as Dt,W as Mt,X as It,M as dt,Y as Vt,Z as at,E as T,q as ct,e as pt,J as st,K as Re,_ as At,k as We,$ as He,g as Ke,a0 as Ft,a1 as nt,a2 as ot,h as rt,a3 as Ze,a4 as Qe,O as Nt,n as Tt,a5 as zt,t as Lt,a6 as it,G as Pt}from"./index-D2vGccO4.js";import{A as Ut}from"./AppLayout-KmPa5HSF.js";import{_ as Ee}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{f as Ot,m as Ce,g as Bt,p as Xt}from"./metricNames-BLwYN0Fp.js";import{p as mt,u as Gt}from"./participants-Bzi4Yn4V.js";const be={async upload(u,$){const r=new FormData;return r.append("file",$),(await Q.post(`/participants/${u}/reports`,r,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(u){return await Q.get(`/reports/${u}/download`,{responseType:"blob"})},async getById(u){return(await Q.get(`/reports/${u}`)).data},async delete(u){return(await Q.delete(`/reports/${u}`)).data},async extract(u){return(await Q.post(`/reports/${u}/extract`)).data},async getMetrics(u){return(await Q.get(`/reports/${u}/metrics`)).data},async getList(u){return(await Q.get(`/participants/${u}/reports`)).data},async getReportImages(u){return(await Q.get(`/reports/${u}/images`)).data}},je={async calculate(u,$){return(await Q.post(`/scoring/participants/${u}/calculate`,null,{params:{activity_code:$}})).data},async getHistory(u,$=10){return(await Q.get(`/scoring/participants/${u}/scores`,{params:{limit:$}})).data},async getById(u){return(await Q.get(`/scoring-results/${u}`)).data},async generateRecommendations(u){return(await Q.post(`/reports/${u}/recommendations`)).data},async getFinalReport(u,$,r="json"){const E={params:{activity_code:$,format:r}};r==="html"&&(E.responseType="text");const P=await Q.get(`/participants/${u}/final-report`,E);return P.data},async downloadFinalReportPdf(u,$,r=null){const E={activity_code:$,format:"pdf"};return r&&(E.scoring_result_id=r),await Q.get(`/participants/${u}/final-report`,{params:E,responseType:"blob"})}};function Fe(u,$=1){if(u==null||u==="")return"";const r=typeof u=="string"?parseFloat(u):u;return isNaN(r)?"":r.toLocaleString("ru-RU",{minimumFractionDigits:$,maximumFractionDigits:$})}function ye(u){if(u==null||u==="")return null;const r=String(u).trim().replace(",","."),E=parseFloat(r);return isNaN(E)?null:E}function qt(u){return ye(u)}function ke(u,$=1){return Fe(u,$)}const jt={key:0,class:"error-message"},Jt={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(u,{emit:$}){const r=u,E=$,P=v(null),U=v(""),B=v(!1),A=v(!1),F=v(""),O=Y(()=>ye(U.value)),Z=Y(()=>{const d=O.value;return d===null||d<=r.min}),X=Y(()=>{const d=O.value;return d===null||d>=r.max}),M=d=>{if(d==null||d===""){U.value="";return}B.value?U.value=String(d).replace(".",","):U.value=Fe(d,r.precision)},z=d=>{if(d==null||d==="")return A.value=!1,F.value="",!0;const n=ye(d);return n===null?(A.value=!0,F.value="Некорректное число",!1):n<r.min?(A.value=!0,F.value=`Значение должно быть не меньше ${Fe(r.min,r.precision)}`,!1):n>r.max?(A.value=!0,F.value=`Значение должно быть не больше ${Fe(r.max,r.precision)}`,!1):(A.value=!1,F.value="",!0)},k=d=>{const n=d.replace(/[^\d,.-]/g,"");let C=!1;const L=n.split("").filter(D=>D===","||D==="."?C?!1:(C=!0,!0):!0).join("").replace(".",",");U.value=L;const b=ye(L);b!==null?E("update:modelValue",b):(L===""||L==="-")&&E("update:modelValue",null)},G=()=>{B.value=!1;const d=ye(U.value);if(z(U.value)){if(d!==null){const n=Math.round(d*Math.pow(10,r.precision))/Math.pow(10,r.precision),C=Math.max(r.min,Math.min(r.max,n));E("update:modelValue",C),M(C),E("change",C)}}else if(d!==null&&(d<r.min||d>r.max)){const n=Math.max(r.min,Math.min(r.max,d));E("update:modelValue",n),M(n),E("change",n),A.value=!1,F.value=""}E("blur")},W=()=>{B.value=!0,O.value!==null&&(U.value=String(O.value).replace(".",","))},H=()=>{const d=O.value||0,n=Math.min(r.max,d+r.step),C=Math.round(n*Math.pow(10,r.precision))/Math.pow(10,r.precision);E("update:modelValue",C),E("change",C),M(C)},x=()=>{const d=O.value||0,n=Math.max(r.min,d-r.step),C=Math.round(n*Math.pow(10,r.precision))/Math.pow(10,r.precision);E("update:modelValue",C),E("change",C),M(C)};return re(()=>r.modelValue,d=>{M(d)},{immediate:!0}),M(r.modelValue),(d,n)=>{const C=p("el-button"),L=p("el-button-group"),b=p("el-input");return l(),R(ae,null,[t(b,{ref_key:"inputRef",ref:P,modelValue:U.value,"onUpdate:modelValue":n[0]||(n[0]=D=>U.value=D),placeholder:u.placeholder,disabled:u.disabled,class:Ye({"is-invalid":A.value}),onInput:k,onBlur:G,onFocus:W},Rt({_:2},[u.showControls?{name:"append",fn:e(()=>[t(L,null,{default:e(()=>[t(C,{icon:g(Et),disabled:u.disabled||Z.value,onClick:x},null,8,["icon","disabled"]),t(C,{icon:g(St),disabled:u.disabled||X.value,onClick:H},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),A.value?(l(),R("div",jt,y(F.value),1)):V("",!0)],64)}}},Wt=Ee(Jt,[["__scopeId","data-v-74ef628d"]]),Ht={class:"card-header"},Kt={class:"card-header-left"},Zt={class:"card-header-actions"},Qt={class:"metrics-filter"},Yt={class:"metrics-stats"},ea={class:"metrics-count"},ta={key:0,class:"metric-description"},aa={key:0,class:"metrics-info"},sa={class:"info-row"},la={key:0,class:"info-row"},na={key:0,class:"loading-container"},oa={key:1,class:"no-images"},ra={key:2,class:"images-container"},ia={class:"image-controls"},ua={class:"image-slide"},da=["src","alt"],ca={class:"image-info"},pa={class:"image-filename"},ma={key:0,class:"image-page"},fa={__name:"MetricsEditor",props:{reportId:{type:String,required:!0},reportStatus:{type:String,default:null}},emits:["metrics-updated"],setup(u,{emit:$}){const r=u,E=$,P=v(!1),U=v(!1),B=v(!1),A=v(null),F=v(!1),O=v(0),Z=v(0),X=v([]),M=v([]),z=v({metrics:{}}),k=v({}),G=v("metrics"),W=v([]),H=v(!1),x=v(1),d=v(!1),n=v(null),C=v(500),L=v(null),b=Y(()=>{if(!X.value||X.value.length===0)return[];if(F.value)return X.value;const w=new Set(M.value.filter(c=>{const h=parseFloat(String(c.value).replace(",","."));return!isNaN(h)&&h>0}).map(c=>c.metric_def_id));return X.value.filter(c=>{const h=w.has(c.id),j=z.value.metrics[c.id],J=j!=null&&j!==""&&parseFloat(String(j).replace(",","."))>0;return h||J})}),D=Y(()=>!M.value||M.value.length===0?[]:[...new Set(M.value.map(w=>w.source))]),se=Y(()=>{if(!M.value||M.value.length===0)return null;const w=M.value.map(c=>c.updated_at||c.created_at).filter(Boolean).map(c=>new Date(c));return w.length===0?null:new Date(Math.max(...w))}),q=async()=>{P.value=!0,A.value=null;try{const w=await Ce.getMetricTemplate(r.reportId);O.value=w.filled_count||0,Z.value=w.missing_count||0;const c=w.items||[];M.value=c.filter(h=>h.value!==null).map(h=>({metric_def_id:h.metric_def.id,value:h.value,source:h.source,confidence:h.confidence,notes:h.notes,updated_at:h.updated_at})),X.value=c.map(h=>({id:h.metric_def.id,code:h.metric_def.code,name:h.metric_def.name,name_ru:h.metric_def.name_ru,unit:h.metric_def.unit,min_value:h.metric_def.min_value,max_value:h.metric_def.max_value,description:h.metric_def.description})),z.value.metrics={},c.forEach(h=>{const j=h.metric_def.id;h.value!==null?z.value.metrics[j]=ye(h.value):z.value.metrics[j]=null}),k.value=JSON.parse(JSON.stringify(z.value.metrics))}catch(w){console.error("Failed to load metrics:",w),A.value="Не удалось загрузить метрики"}finally{P.value=!1}},ne=async()=>{await q(),T.success("Метрики обновлены")},K=()=>{L.value||(L.value=setInterval(async()=>{await q()},5e3))},ce=()=>{L.value&&(clearInterval(L.value),L.value=null)},ee=()=>{B.value=!0,F.value=!0,k.value=JSON.parse(JSON.stringify(z.value.metrics))},pe=()=>{z.value.metrics=JSON.parse(JSON.stringify(k.value)),B.value=!1,A.value=null},me=async()=>{U.value=!0,A.value=null;try{const w=[],c=[];for(const[J,te]of Object.entries(z.value.metrics)){const de=k.value[J],we=de!=null&&de!=="";if(te!=null&&te!==""){const _e=qt(te);_e!==null&&w.push({metric_def_id:J,value:_e,source:"MANUAL",notes:null})}else we&&c.push(J)}let h=0;for(const J of c)try{await Ce.clearExtractedMetric(r.reportId,J),h++}catch(te){te.response?.status!==404&&console.error("Failed to delete metric:",J,te)}w.length>0&&await Ce.bulkCreateExtractedMetrics(r.reportId,w);const j=[];w.length>0&&j.push(`сохранено: ${w.length}`),h>0&&j.push(`сброшено: ${h}`),j.length===0?T.info("Нет изменений для сохранения"):T.success(`Метрики обновлены (${j.join(", ")})`),B.value=!1,await q(),E("metrics-updated")}catch(w){console.error("Failed to save metrics:",w);let c="Не удалось сохранить метрики";w.response?.data?.detail&&(typeof w.response.data.detail=="string"?c=w.response.data.detail:Array.isArray(w.response.data.detail)&&(c=w.response.data.detail.map(h=>h.msg||h.message).join(", "))),A.value=c,T.error(c)}finally{U.value=!1}},fe=w=>{switch(w){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},_=w=>{switch(w){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return w}},ie=w=>new Date(w).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),ue=async()=>{H.value=!0,A.value=null;try{W.value=await be.getReportImages(r.reportId)}catch(w){console.error("Failed to load report images:",w),A.value="Не удалось загрузить изображения отчёта",T.error("Не удалось загрузить изображения отчёта")}finally{H.value=!1}},Se=()=>{x.value<2&&(x.value=Math.min(2,x.value+.25))},xe=()=>{x.value>.5&&(x.value=Math.max(.5,x.value-.25))},Ne=()=>{x.value=1},De=()=>{d.value=!d.value,d.value?C.value=window.innerHeight-100:C.value=500};return et(async()=>{}),tt(()=>{ce()}),re(()=>r.reportId,async w=>{w&&(await q(),W.value=[])}),re(()=>r.reportStatus,async(w,c)=>{c||await q(),w==="PROCESSING"?(K(),c&&c!=="PROCESSING"&&await q()):(ce(),w==="EXTRACTED"&&c&&c!=="EXTRACTED"&&await q())},{immediate:!0}),re(G,async w=>{w==="images"&&W.value.length===0&&!H.value&&await ue()}),(w,c)=>{const h=p("el-icon"),j=p("el-tag"),J=p("el-button"),te=p("el-alert"),de=p("el-switch"),we=p("el-form-item"),_e=p("el-col"),Te=p("el-row"),Me=p("el-form"),ze=p("el-divider"),he=p("el-tab-pane"),Ie=p("el-empty"),Le=p("el-button-group"),Pe=p("el-carousel-item"),Ue=p("el-carousel"),Oe=p("el-tabs"),Ve=p("el-card");return l(),f(Ve,{class:"metrics-editor"},{header:e(()=>[i("div",Ht,[i("div",Kt,[c[5]||(c[5]=i("span",null,"Метрики отчёта",-1)),u.reportStatus==="PROCESSING"?(l(),f(j,{key:0,type:"warning",size:"small",class:"status-tag"},{default:e(()=>[t(h,{class:"is-loading"},{default:e(()=>[t(g($e))]),_:1}),c[3]||(c[3]=m(" Извлечение... ",-1))]),_:1})):u.reportStatus==="EXTRACTED"?(l(),f(j,{key:1,type:"success",size:"small",class:"status-tag"},{default:e(()=>[...c[4]||(c[4]=[m(" Извлечено ",-1)])]),_:1})):V("",!0)]),i("div",Zt,[B.value?V("",!0):(l(),f(J,{key:0,size:"small",loading:P.value,onClick:ne},{default:e(()=>[t(h,null,{default:e(()=>[t(g(at))]),_:1}),c[6]||(c[6]=m(" Обновить ",-1))]),_:1},8,["loading"])),B.value?(l(),R(ae,{key:2},[t(J,{size:"small",onClick:pe},{default:e(()=>[...c[8]||(c[8]=[m(" Отмена ",-1)])]),_:1}),t(J,{type:"primary",size:"small",loading:U.value,onClick:me},{default:e(()=>[...c[9]||(c[9]=[m(" Сохранить ",-1)])]),_:1},8,["loading"])],64)):(l(),f(J,{key:1,type:"primary",size:"small",onClick:ee},{default:e(()=>[...c[7]||(c[7]=[m(" Редактировать ",-1)])]),_:1}))])])]),default:e(()=>[A.value?(l(),f(te,{key:0,type:"error",title:A.value,closable:"",style:{"margin-bottom":"16px"},onClose:c[0]||(c[0]=N=>A.value=null)},null,8,["title"])):V("",!0),!M.value||M.value.length===0?(l(),f(te,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...c[10]||(c[10]=[m(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):V("",!0),t(Oe,{modelValue:G.value,"onUpdate:modelValue":c[2]||(c[2]=N=>G.value=N),type:"card"},{default:e(()=>[t(he,{label:"Метрики",name:"metrics"},{default:e(()=>[i("div",Qt,[t(de,{modelValue:F.value,"onUpdate:modelValue":c[1]||(c[1]=N=>F.value=N),"active-text":"Показать все метрики","inactive-text":"Только заполненные"},null,8,["modelValue"]),i("div",Yt,[t(j,{type:"success",size:"small"},{default:e(()=>[m("Заполнено: "+y(O.value),1)]),_:1}),t(j,{type:"info",size:"small"},{default:e(()=>[m("Не заполнено: "+y(Z.value),1)]),_:1}),i("span",ea," Показано: "+y(b.value.length)+" из "+y(X.value.length),1)])]),t(Me,{ref:"formRef",model:z.value,"label-position":"top",disabled:!B.value},{default:e(()=>[t(Te,{gutter:20},{default:e(()=>[(l(!0),R(ae,null,le(b.value,N=>(l(),f(_e,{key:N.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(we,{label:g(Ot)(N),prop:`metrics.${N.id}`},{default:e(()=>[t(Wt,{modelValue:z.value.metrics[N.id],"onUpdate:modelValue":Be=>z.value.metrics[N.id]=Be,min:N.min_value||1,max:N.max_value||10,precision:1,step:.1,disabled:!B.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),N.description?(l(),R("div",ta,y(N.description),1)):V("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),M.value&&M.value.length>0?(l(),R("div",aa,[t(ze),i("div",sa,[c[11]||(c[11]=i("span",{class:"info-label"},"Источник данных:",-1)),(l(!0),R(ae,null,le(D.value,N=>(l(),f(j,{key:N,type:fe(N),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[m(y(_(N)),1)]),_:2},1032,["type"]))),128))]),se.value?(l(),R("div",la,[c[12]||(c[12]=i("span",{class:"info-label"},"Последнее обновление:",-1)),i("span",null,y(ie(se.value)),1)])):V("",!0)])):V("",!0)]),_:1}),t(he,{label:"Изображения отчёта",name:"images"},{default:e(()=>[H.value?(l(),R("div",na,[t(h,{class:"is-loading"},{default:e(()=>[t(g($e))]),_:1}),c[13]||(c[13]=i("span",{style:{"margin-left":"8px"}},"Загрузка изображений...",-1))])):W.value.length===0?(l(),R("div",oa,[t(Ie,{description:"Изображения отсутствуют"},{image:e(()=>[t(h,{size:60,color:"var(--el-color-info)"},{default:e(()=>[t(g(xt))]),_:1})]),_:1})])):(l(),R("div",ra,[i("div",ia,[t(Le,null,{default:e(()=>[t(J,{disabled:x.value<=.5,onClick:xe},{default:e(()=>[t(h,null,{default:e(()=>[t(g(Dt))]),_:1})]),_:1},8,["disabled"]),t(J,{onClick:Ne},{default:e(()=>[m(y(Math.round(x.value*100))+"% ",1)]),_:1}),t(J,{disabled:x.value>=2,onClick:Se},{default:e(()=>[t(h,null,{default:e(()=>[t(g(Mt))]),_:1})]),_:1},8,["disabled"])]),_:1}),t(J,{style:{"margin-left":"12px"},onClick:De},{default:e(()=>[t(h,null,{default:e(()=>[t(g(It))]),_:1}),c[14]||(c[14]=m(" Полноэкранный режим ",-1))]),_:1})]),i("div",{ref_key:"carouselContainer",ref:n,class:Ye(["carousel-wrapper",{fullscreen:d.value}])},[t(Ue,{height:C.value+"px",arrow:"always","indicator-position":"outside"},{default:e(()=>[(l(!0),R(ae,null,le(W.value,N=>(l(),f(Pe,{key:N.id},{default:e(()=>[i("div",ua,[i("div",{class:"image-wrapper",style:dt({transform:`scale(${x.value})`})},[i("img",{src:N.data_url,alt:N.filename,class:"report-image"},null,8,da)],4),i("div",ca,[i("span",pa,y(N.filename),1),N.page_number?(l(),R("span",ma," Страница "+y(N.page_number),1)):V("",!0)])])]),_:2},1024))),128))]),_:1},8,["height"]),d.value?(l(),f(J,{key:0,class:"exit-fullscreen",circle:"",onClick:De},{default:e(()=>[t(h,null,{default:e(()=>[t(g(Vt))]),_:1})]),_:1})):V("",!0)],2)]))]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},_a=Ee(fa,[["__scopeId","data-v-a79fdd18"]]),va={class:"report-list"},ga={class:"report-list__controls"},ya={class:"controls-left"},wa={class:"controls-right"},ha={class:"filename"},ba={class:"status-cell"},ka={key:1,class:"report-list__cards"},Ca={class:"report-card__header"},$a={class:"report-card__status"},Ra={class:"report-card__body"},Ea={class:"report-card__field"},Sa={class:"field-value field-value--filename"},xa={class:"report-card__field"},Da={class:"field-value"},Ma={class:"report-card__actions"},Ia={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(u,{emit:$}){const r=u,E=$,P=ct(),U=pt(),B=v(window.innerWidth<=768),A=()=>{B.value=window.innerWidth<=768};et(()=>{window.addEventListener("resize",A),P.query.status&&(F.value=P.query.status),P.query.sort&&(O.value=P.query.sort)}),tt(()=>{window.removeEventListener("resize",A)});const F=v(""),O=v("desc"),Z=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];re([F,O],([d,n])=>{const C={...P.query};d?C.status=d:delete C.status,n?C.sort=n:delete C.sort,U.replace({query:C})});const X=()=>{},M=()=>{O.value=O.value==="desc"?"asc":"desc"},z=Y(()=>{let d=[...r.reports];return F.value&&(d=d.filter(n=>n.status===F.value)),d.sort((n,C)=>{const L=new Date(n.uploaded_at),b=new Date(C.uploaded_at);return O.value==="desc"?b-L:L-b}),d}),k=Y(()=>F.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),G=d=>{if(!d)return"—";const n=new Date(d);return Number.isNaN(n.getTime())?"—":n.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},W=d=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[d]||d,H=d=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[d]||"info",x=async({action:d,report:n})=>{switch(d){case"view":E("view",n.id);break;case"edit":E("edit",n.id);break;case"extract":E("extract",n.id);break;case"download":E("download",n.id);break;case"delete":try{await Nt.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),E("delete",n.id)}catch{}break}};return(d,n)=>{const C=p("el-option"),L=p("el-select"),b=p("el-icon"),D=p("el-button"),se=p("el-table-column"),q=p("el-tag"),ne=p("el-dropdown-item"),K=p("el-dropdown-menu"),ce=p("el-dropdown"),ee=p("el-table"),pe=p("el-card"),me=p("el-empty"),fe=st("loading");return l(),R("div",va,[i("div",ga,[i("div",ya,[t(L,{modelValue:F.value,"onUpdate:modelValue":n[0]||(n[0]=_=>F.value=_),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:X},{default:e(()=>[t(C,{label:"Все статусы",value:""}),(l(),R(ae,null,le(Z,_=>t(C,{key:_.value,label:_.label,value:_.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),i("div",wa,[t(D,{type:O.value==="desc"?"primary":"default",size:"small",onClick:M},{default:e(()=>[t(b,null,{default:e(()=>[t(g(At))]),_:1}),m(" "+y(O.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),B.value?Re((l(),R("div",ka,[(l(!0),R(ae,null,le(z.value,_=>(l(),f(pe,{key:_.id,class:"report-card",shadow:"hover"},{header:e(()=>[i("div",Ca,[i("div",$a,[_.status==="PROCESSING"?(l(),f(b,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(g($e))]),_:1})):_.status==="EXTRACTED"?(l(),f(b,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(g(We))]),_:1})):_.status==="FAILED"?(l(),f(b,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(g(He))]),_:1})):(l(),f(b,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(g(Ke))]),_:1})),t(q,{type:H(_.status),size:"small"},{default:e(()=>[m(y(W(_.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[i("div",Ma,[_.status==="EXTRACTED"?(l(),f(D,{key:0,type:"success",size:"small",onClick:ie=>x({action:"edit",report:_})},{default:e(()=>[t(b,null,{default:e(()=>[t(g(nt))]),_:1}),n[10]||(n[10]=m(" Редактировать ",-1))]),_:1},8,["onClick"])):V("",!0),_.status==="PROCESSING"||_.status==="EXTRACTED"?(l(),f(D,{key:1,type:"info",size:"small",onClick:ie=>x({action:"view",report:_})},{default:e(()=>[t(b,null,{default:e(()=>[t(g(ot))]),_:1}),n[11]||(n[11]=m(" Просмотр ",-1))]),_:1},8,["onClick"])):V("",!0),t(D,{type:"primary",size:"small",onClick:ie=>x({action:"extract",report:_})},{default:e(()=>[t(b,null,{default:e(()=>[t(g(rt))]),_:1}),m(" "+y(_.status==="FAILED"?"Повторить":_.status==="PROCESSING"?"Перезапустить":_.status==="EXTRACTED"?"Переизвлечь":"Извлечь"),1)]),_:2},1032,["onClick"]),t(D,{size:"small",onClick:ie=>x({action:"download",report:_})},{default:e(()=>[t(b,null,{default:e(()=>[t(g(Ze))]),_:1}),n[12]||(n[12]=m(" Скачать ",-1))]),_:1},8,["onClick"]),t(D,{type:"danger",size:"small",onClick:ie=>x({action:"delete",report:_})},{default:e(()=>[t(b,null,{default:e(()=>[t(g(Qe))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[i("div",Ra,[i("div",Ea,[n[8]||(n[8]=i("span",{class:"field-label"},"Файл:",-1)),i("span",Sa,y(_.file_ref?.filename||"Без названия"),1)]),i("div",xa,[n[9]||(n[9]=i("span",{class:"field-label"},"Дата загрузки:",-1)),i("span",Da,y(G(_.uploaded_at)),1)])])]),_:2},1024))),128)),!z.value.length&&!u.loading?(l(),f(me,{key:0,description:k.value,"image-size":120},{default:e(()=>[F.value?V("",!0):(l(),f(D,{key:0,type:"primary",onClick:n[1]||(n[1]=_=>d.$emit("upload"))},{default:e(()=>[...n[13]||(n[13]=[m(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):V("",!0)])),[[fe,u.loading]]):Re((l(),f(ee,{key:0,data:z.value,class:"report-list__table",stripe:"","empty-text":k.value},{default:e(()=>[t(se,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:_})=>[i("span",ha,y(_.file_ref?.filename||"Без названия"),1)]),_:1}),t(se,{prop:"status",label:"Статус",width:"200"},{default:e(({row:_})=>[i("div",ba,[_.status==="PROCESSING"?(l(),f(b,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(g($e))]),_:1})):_.status==="EXTRACTED"?(l(),f(b,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(g(We))]),_:1})):_.status==="FAILED"?(l(),f(b,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(g(He))]),_:1})):(l(),f(b,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(g(Ke))]),_:1})),t(q,{type:H(_.status),size:"default"},{default:e(()=>[m(y(W(_.status)),1)]),_:2},1032,["type"])])]),_:1}),t(se,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:_})=>[m(y(G(_.uploaded_at)),1)]),_:1}),t(se,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:_})=>[t(ce,{trigger:"click",onCommand:x},{dropdown:e(()=>[t(K,null,{default:e(()=>[_.status==="EXTRACTED"?(l(),f(ne,{key:0,command:{action:"edit",report:_}},{default:e(()=>[t(b,null,{default:e(()=>[t(g(nt))]),_:1}),n[4]||(n[4]=m(" Редактировать метрики ",-1))]),_:1},8,["command"])):V("",!0),_.status==="PROCESSING"||_.status==="EXTRACTED"?(l(),f(ne,{key:1,command:{action:"view",report:_}},{default:e(()=>[t(b,null,{default:e(()=>[t(g(ot))]),_:1}),n[5]||(n[5]=m(" Просмотр метрик ",-1))]),_:1},8,["command"])):V("",!0),t(ne,{command:{action:"extract",report:_}},{default:e(()=>[t(b,null,{default:e(()=>[t(g(rt))]),_:1}),m(" "+y(_.status==="FAILED"?"Повторить извлечение":_.status==="PROCESSING"?"Перезапустить извлечение":_.status==="EXTRACTED"?"Переизвлечь метрики":"Извлечь метрики"),1)]),_:2},1032,["command"]),t(ne,{divided:"",command:{action:"download",report:_}},{default:e(()=>[t(b,null,{default:e(()=>[t(g(Ze))]),_:1}),n[6]||(n[6]=m(" Скачать ",-1))]),_:1},8,["command"]),t(ne,{command:{action:"delete",report:_},class:"dropdown-item--danger"},{default:e(()=>[t(b,null,{default:e(()=>[t(g(Qe))]),_:1}),n[7]||(n[7]=m(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(D,{type:"primary",size:"small"},{default:e(()=>[n[3]||(n[3]=m(" Действия ",-1)),t(b,{class:"el-icon--right"},{default:e(()=>[t(g(Ft))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[fe,u.loading]]),!z.value.length&&!u.loading&&!B.value?(l(),f(me,{key:2,description:k.value,"image-size":120},{default:e(()=>[F.value?V("",!0):(l(),f(D,{key:0,type:"primary",onClick:n[2]||(n[2]=_=>d.$emit("upload"))},{default:e(()=>[...n[14]||(n[14]=[m(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):V("",!0)])}}},Va=Ee(Ia,[["__scopeId","data-v-0ed222e2"]]),Aa={class:"metrics-drawer"},Fa={class:"drawer-actions"},Na={key:1},Ta={key:1},za={__name:"ParticipantMetricsDrawer",props:{modelValue:{type:Boolean,required:!0},participantId:{type:String,required:!0},participantName:{type:String,required:!0}},emits:["update:modelValue"],setup(u,{emit:$}){const r=u,E=$,P=v(!1),U=v([]),B=v([]),A=Y(()=>"Метрики ещё не извлечены. Загрузите и обработайте отчёты."),F=k=>{E("update:modelValue",k)},O=async()=>{try{const k=await Ce.listMetricDefs(!0);B.value=k.items||[]}catch(k){console.error("Error loading metric definitions:",k)}},Z=async()=>{P.value=!0;try{const k=await mt.getMetrics(r.participantId);U.value=k.metrics||[]}catch(k){console.error("Error loading participant metrics:",k),T.error("Ошибка загрузки метрик участника")}finally{P.value=!1}},X=k=>{if(!k)return"—";const G=B.value.find(H=>H.code===k);return Bt(G,k,{warn:()=>{}})},M=k=>k>=.8?"var(--el-color-success)":k>=.6?"var(--el-color-warning)":"var(--el-color-danger)",z=k=>{if(!k)return"—";const G=new Date(k);return Number.isNaN(G.getTime())?"—":G.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})};return re(()=>r.participantId,async k=>{k&&r.modelValue&&(await O(),await Z())}),re(()=>r.modelValue,async k=>{k&&r.participantId&&(await O(),await Z())}),(k,G)=>{const W=p("el-icon"),H=p("el-button"),x=p("el-table-column"),d=p("el-tag"),n=p("el-table"),C=p("el-empty"),L=p("el-drawer"),b=st("loading");return l(),f(L,{"model-value":u.modelValue,title:`Метрики участника: ${u.participantName}`,size:"70%",direction:"rtl","onUpdate:modelValue":F},{default:e(()=>[Re((l(),R("div",Aa,[i("div",Fa,[t(H,{type:"primary",size:"small",onClick:Z},{default:e(()=>[t(W,null,{default:e(()=>[t(g(at))]),_:1}),G[0]||(G[0]=m(" Обновить ",-1))]),_:1})]),t(n,{data:U.value,stripe:"","empty-text":A.value},{default:e(()=>[t(x,{prop:"metric_code",label:"Код метрики",width:"200"}),t(x,{label:"Название метрики","min-width":"250"},{default:e(({row:D})=>[m(y(X(D.metric_code)),1)]),_:1}),t(x,{prop:"value",label:"Значение",width:"120"},{default:e(({row:D})=>[t(d,{type:"success"},{default:e(()=>[m(y(g(ke)(D.value)),1)]),_:2},1024)]),_:1}),t(x,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:D})=>[D.confidence!==null?(l(),R("span",{key:0,style:dt({color:M(D.confidence)})},y((D.confidence*100).toFixed(0))+"% ",5)):(l(),R("span",Na,"—"))]),_:1}),t(x,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:D})=>[m(y(z(D.updated_at)),1)]),_:1}),t(x,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:D})=>[D.last_source_report_id?(l(),f(d,{key:0,size:"small"},{default:e(()=>[...G[1]||(G[1]=[m(" Из отчёта ",-1)])]),_:1})):(l(),R("span",Ta,"—"))]),_:1})]),_:1},8,["data","empty-text"]),!U.value.length&&!P.value?(l(),f(C,{key:0,description:A.value},null,8,["description"])):V("",!0)])),[[b,P.value]])]),_:1},8,["model-value","title"])}}},La=Ee(za,[["__scopeId","data-v-93720633"]]),Pa={class:"participant-detail"},Ua={class:"card-header"},Oa={class:"header-actions"},Ba={class:"section-header"},Xa={class:"scoring-result"},Ga={class:"score-value"},qa={class:"score-number"},ja={class:"score-details"},Ja={class:"score-section"},Wa={key:0},Ha={class:"score-section"},Ka={key:0},Za={class:"score-section recommendations-status-section"},Qa={class:"recommendations-pending-alert"},Ya={key:0,class:"final-report-actions"},es={key:0,class:"batch-files-list"},ts={class:"batch-files-header"},as={class:"batch-file-info"},ss={class:"batch-file-name"},ls={class:"batch-file-size"},ns={key:0,class:"batch-file-error"},os={class:"activity-code-hint"},ut=20*1024*1024,Je=10,rs={__name:"ParticipantDetailView",setup(u){const $=pt(),r=ct(),E=Gt(),P=v(!1),U=v(!1),B=v(window.innerWidth<=768),A=()=>{B.value=window.innerWidth<=768},F=v(!1),O=v(!1),Z=v(!1),X=Y(()=>E.currentParticipant),M=v([]),z=v([]),k=v([]),G=v([]),W=v(null),H=v(null),x=v(null),d=Y(()=>M.value.some(a=>a.status==="PROCESSING")),n=Y(()=>W.value&&M.value.find(s=>s.id===W.value)?.status||null),C=Y(()=>z.value.some(a=>a.recommendations_status==="pending")),L=v(!1),b=v(!1),D=v(!1),se=v(!1),q=v(null),ne=v([]),K=v([]);let ce=0;const ee=Tt({activityCode:""}),pe=a=>{if(!a)return"—";const s=new Date(a);return Number.isNaN(s.getTime())?"—":s.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},me=a=>a>=80?"success":a>=60?"":"warning",fe=a=>({pending:"Формируются",ready:"Готовы",error:"Ошибка",disabled:"Отключены"})[a]||a,_=a=>({pending:"info",ready:"success",error:"danger",disabled:"warning"})[a]||"info",ie=async()=>{P.value=!0;try{await E.getParticipant(r.params.id)}catch{T.error("Участник не найден"),$.push("/participants")}finally{P.value=!1}},ue=async({silent:a=!1}={})=>{a||(U.value=!0);try{const s=await mt.getReports(r.params.id);M.value=s.items||[]}catch(s){console.error("Error loading reports:",s),T.error("Ошибка загрузки списка отчётов")}finally{a||(U.value=!1)}},Se=a=>{if(!a)return a;const s=Array.isArray(a.recommendations)?a.recommendations:[];let I=a.recommendations_status||a.recommendationsStatus||null;I||(I=s.length>0?"ready":"pending");const S=Number(a.score_pct),ve=Number.isNaN(S)?a.score_pct:S;return{...a,score_pct:ve,recommendations:s,recommendations_status:I,recommendations_error:a.recommendations_error||a.recommendationsError||null}},xe=async()=>{try{const a=await je.getHistory(r.params.id),s=Array.isArray(a.items)?a.items:[];z.value=s.map(Se)}catch(a){console.error("Error loading scoring results:",a)}},Ne=async()=>{F.value=!0;try{const a=await Xt.list();k.value=a||[]}catch{T.error("Ошибка загрузки профессиональных областей")}finally{F.value=!1}},De=async()=>{try{const a=await Ce.listMetricDefs(!0);G.value=a.items||[]}catch(a){console.error("Error loading metric definitions:",a)}},w=a=>a<1024?a+" B":a<1024*1024?(a/1024).toFixed(1)+" KB":(a/(1024*1024)).toFixed(1)+" MB",c=a=>a.name.toLowerCase().endsWith(".docx")?a.size>ut?`Размер файла превышает ${w(ut)}`:null:"Только файлы формата .docx",h=(a,s)=>{const I=a.raw;if(K.value.length>=Je){T.warning(`Максимальное количество файлов: ${Je}`),q.value&&q.value.clearFiles();return}const S=c(I);if(S){T.error(S),q.value&&q.value.clearFiles();return}K.value.push({id:++ce,file:I,name:I.name,size:I.size,status:"pending",progress:0,error:null,reportId:null}),q.value&&q.value.clearFiles()},j=a=>{K.value=K.value.filter(s=>s.id!==a)},J=async a=>{a.status="uploading",a.progress=0;try{const s=await be.upload(r.params.id,a.file);a.status="success",a.reportId=s.id}catch(s){a.status="error",a.error=s.response?.data?.detail||"Ошибка загрузки"}},te=async()=>{const a=K.value.filter(s=>s.status==="pending");if(a.length===0){T.warning("Нет файлов для загрузки");return}O.value=!0;try{await Promise.allSettled(a.map(S=>J(S)));const s=K.value.filter(S=>S.status==="success").length,I=K.value.filter(S=>S.status==="error").length;I===0?(T.success(`Загружено ${s} отчётов`),L.value=!1,de()):T.warning(`Загружено: ${s}, ошибок: ${I}`),await ue()}finally{O.value=!1}},de=()=>{K.value=[],ne.value=[],q.value&&q.value.clearFiles()},we=async a=>{try{const s=await be.download(a),I=window.URL.createObjectURL(new Blob([s.data])),S=document.createElement("a");S.href=I,S.setAttribute("download",`report_${a}.docx`),document.body.appendChild(S),S.click(),S.remove(),window.URL.revokeObjectURL(I),T.success("Отчёт скачан")}catch{T.error("Ошибка скачивания отчёта")}},_e=async a=>{try{await be.extract(a),T.success("Извлечение метрик запущено"),await ue()}catch{T.error("Ошибка запуска извлечения метрик")}},Te=()=>{H.value||(H.value=setInterval(async()=>{try{await ue({silent:!0})}catch(a){console.error("Auto-refresh error:",a)}},3e3))},Me=()=>{H.value&&(clearInterval(H.value),H.value=null)},ze=()=>{x.value||(x.value=setInterval(async()=>{try{await xe()}catch(a){console.error("Recommendations auto-refresh error:",a)}},15e3))},he=()=>{x.value&&(clearInterval(x.value),x.value=null)};re(d,a=>{a?Te():Me()}),re(C,a=>{a?ze():he()});const Ie=async a=>{W.value=a,await Pt(),D.value=!0},Le=async()=>{T.success("Метрики обновлены"),await ue({silent:!0})},Pe=async a=>{try{await be.delete(a),T.success("Отчёт удалён"),await ue()}catch{T.error("Ошибка удаления отчёта")}},Ue=async()=>{if(!ee.activityCode){T.warning("Выберите профессиональную область");return}Z.value=!0;try{const a=await je.calculate(r.params.id,ee.activityCode),s=Se({id:a.scoring_result_id,participant_id:r.params.id,prof_activity_code:a.prof_activity_code||ee.activityCode,prof_activity_name:a.prof_activity_name,score_pct:parseFloat(a.score_pct),strengths:a.strengths||[],dev_areas:a.dev_areas||[],recommendations:a.recommendations||[],recommendations_status:a.recommendations_status||((a.recommendations||[]).length>0?"ready":"pending"),recommendations_error:a.recommendations_error||null,created_at:new Date().toISOString()});z.value.unshift(s),T.success("Расчёт пригодности выполнен"),b.value=!1,ee.activityCode=""}catch(a){console.error("Scoring calculation error:",a);const s=a.response?.data?.detail||"Ошибка расчёта пригодности";T.error(s)}finally{Z.value=!1}},Oe=async a=>{if(!a.prof_activity_code){T.warning("Код профессиональной деятельности не найден");return}try{const s=await je.downloadFinalReportPdf(r.params.id,a.prof_activity_code,a.id),I=window.URL.createObjectURL(new Blob([s.data])),S=document.createElement("a");S.href=I,S.setAttribute("download",`final_report_${a.prof_activity_code}_${new Date().toISOString().split("T")[0]}.pdf`),document.body.appendChild(S),S.click(),S.remove(),window.URL.revokeObjectURL(I),T.success("Отчёт PDF скачан")}catch(s){const I=s.response?.data?.detail||"Ошибка загрузки PDF отчёта";T.error(I)}},Ve=a=>a?.recommendations_status==="ready"||a?.recommendations_status==="disabled",N=a=>a?.recommendations_status==="pending"?"Дождитесь завершения генерации рекомендаций":a?.recommendations_status==="error"?"Ошибка генерации рекомендаций. Попробуйте пересчитать пригодность":"",Be=a=>a?.recommendations_error?`Ошибка генерации: ${a.recommendations_error}`:"Не удалось получить рекомендации";return et(async()=>{window.addEventListener("resize",A),await ie(),await ue(),await xe(),await Ne(),await De()}),tt(()=>{window.removeEventListener("resize",A),Me(),he()}),(a,s)=>{const I=p("el-button"),S=p("el-icon"),ve=p("el-descriptions-item"),ft=p("el-descriptions"),Ae=p("el-card"),_t=p("el-progress"),Xe=p("el-empty"),vt=p("el-tag"),ge=p("el-alert"),gt=p("el-tooltip"),yt=p("el-timeline-item"),wt=p("el-timeline"),ht=p("el-upload"),Ge=p("el-dialog"),bt=p("el-option"),kt=p("el-select"),Ct=p("el-form-item"),$t=p("el-form"),lt=st("loading");return l(),f(Ut,null,{default:e(()=>[Re((l(),R("div",Pa,[X.value?(l(),f(Ae,{key:0,class:"detail-card"},{header:e(()=>[i("div",Ua,[i("h2",null,y(X.value.full_name),1),i("div",Oa,[t(I,{onClick:s[0]||(s[0]=o=>g($).back())},{default:e(()=>[...s[12]||(s[12]=[m(" Назад ",-1)])]),_:1}),t(I,{type:"info",onClick:s[1]||(s[1]=o=>se.value=!0)},{default:e(()=>[t(S,null,{default:e(()=>[t(g(zt))]),_:1}),s[13]||(s[13]=m(" Метрики ",-1))]),_:1}),t(I,{type:"primary",onClick:s[2]||(s[2]=o=>b.value=!0)},{default:e(()=>[t(S,null,{default:e(()=>[t(g(Lt))]),_:1}),s[14]||(s[14]=m(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(ft,{column:B.value?1:2,border:""},{default:e(()=>[t(ve,{label:"ФИО"},{default:e(()=>[m(y(X.value.full_name),1)]),_:1}),t(ve,{label:"Дата рождения"},{default:e(()=>[m(y(X.value.birth_date||"Не указана"),1)]),_:1}),t(ve,{label:"Внешний ID"},{default:e(()=>[m(y(X.value.external_id||"Не указан"),1)]),_:1}),t(ve,{label:"Дата создания"},{default:e(()=>[m(y(pe(X.value.created_at)),1)]),_:1})]),_:1},8,["column"])]),_:1})):V("",!0),t(Ae,{class:"section-card"},{header:e(()=>[i("div",Ba,[s[16]||(s[16]=i("h3",null,"Отчёты",-1)),t(I,{type:"primary",onClick:s[3]||(s[3]=o=>L.value=!0)},{default:e(()=>[t(S,null,{default:e(()=>[t(g(it))]),_:1}),s[15]||(s[15]=m(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(Va,{reports:M.value,loading:U.value,onView:Ie,onEdit:Ie,onExtract:_e,onDownload:we,onDelete:Pe,onUpload:s[4]||(s[4]=o=>L.value=!0)},null,8,["reports","loading"])]),_:1}),z.value.length>0?(l(),f(Ae,{key:1,class:"section-card"},{header:e(()=>[...s[17]||(s[17]=[i("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(wt,null,{default:e(()=>[(l(!0),R(ae,null,le(z.value,o=>(l(),f(yt,{key:o.id,timestamp:pe(o.created_at),placement:"top"},{default:e(()=>[t(Ae,null,{default:e(()=>[i("h4",null,y(o.prof_activity_name),1),i("div",Xa,[i("div",Ga,[i("span",qa,y(o.score_pct)+"%",1),t(_t,{percentage:o.score_pct,status:me(o.score_pct)},null,8,["percentage","status"])]),i("div",ja,[i("div",Ja,[s[18]||(s[18]=i("h5",null,"Сильные стороны:",-1)),o.strengths&&o.strengths.length?(l(),R("ul",Wa,[(l(!0),R(ae,null,le(o.strengths,(oe,qe)=>(l(),R("li",{key:qe},[i("strong",null,y(oe.metric_name),1),m(" — "+y(g(ke)(oe.value))+" (вес "+y(g(ke)(oe.weight,2))+") ",1)]))),128))])):(l(),f(Xe,{key:1,description:"Нет данных","image-size":60}))]),i("div",Ha,[s[19]||(s[19]=i("h5",null,"Зоны развития:",-1)),o.dev_areas&&o.dev_areas.length?(l(),R("ul",Ka,[(l(!0),R(ae,null,le(o.dev_areas,(oe,qe)=>(l(),R("li",{key:qe},[i("strong",null,y(oe.metric_name),1),m(" — "+y(g(ke)(oe.value))+" (вес "+y(g(ke)(oe.weight,2))+") ",1)]))),128))])):(l(),f(Xe,{key:1,description:"Нет данных","image-size":60}))]),i("div",Za,[i("h5",null,[s[20]||(s[20]=m(" Рекомендации: ",-1)),o.recommendations_status?(l(),f(vt,{key:0,type:_(o.recommendations_status),size:"small",class:"recommendation-status-tag"},{default:e(()=>[m(y(fe(o.recommendations_status)),1)]),_:2},1032,["type"])):V("",!0)]),o.recommendations_status==="pending"?(l(),f(ge,{key:0,type:"info",closable:!1,"show-icon":""},{title:e(()=>[i("div",Qa,[t(S,{class:"is-loading"},{default:e(()=>[t(g(at))]),_:1}),s[21]||(s[21]=i("span",null,"Рекомендации формируются...",-1))])]),default:e(()=>[...s[22]||(s[22]=[m(" Кнопка «Скачать PDF» станет доступна после завершения генерации. ",-1)])]),_:1})):o.recommendations_status==="ready"?(l(),f(ge,{key:1,title:"Рекомендации готовы",type:"success",closable:!1,"show-icon":""},{default:e(()=>[...s[23]||(s[23]=[m(" Персональные рекомендации доступны в итоговом PDF-отчёте. ",-1)])]),_:1})):o.recommendations_status==="error"?(l(),f(ge,{key:2,title:Be(o),type:"error",closable:!1,"show-icon":""},{default:e(()=>[...s[24]||(s[24]=[m(" Не удалось сформировать рекомендации. Попробуйте пересчитать пригодность. ",-1)])]),_:1},8,["title"])):o.recommendations_status==="disabled"?(l(),f(ge,{key:3,title:"Генерация рекомендаций отключена",type:"warning",closable:!1,"show-icon":""},{default:e(()=>[...s[25]||(s[25]=[m(" Генерация рекомендаций отключена для данного окружения. ",-1)])]),_:1})):(l(),f(Xe,{key:4,description:"Статус рекомендаций неизвестен","image-size":60}))])]),o.prof_activity_code?(l(),R("div",Ya,[t(gt,{disabled:Ve(o),content:N(o),placement:"top"},{default:e(()=>[i("span",null,[t(I,{type:"primary",size:"small",disabled:!Ve(o),loading:o.recommendations_status==="pending",onClick:oe=>Oe(o)},{default:e(()=>[o.recommendations_status!=="pending"?(l(),f(S,{key:0},{default:e(()=>[t(g(Ze))]),_:1})):V("",!0),m(" "+y(o.recommendations_status==="pending"?"Формируется...":"Скачать PDF"),1)]),_:2},1032,["disabled","loading","onClick"])])]),_:2},1032,["disabled","content"])])):V("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):V("",!0),t(Ge,{modelValue:L.value,"onUpdate:modelValue":s[6]||(s[6]=o=>L.value=o),title:"Загрузить отчёты",width:B.value?"95%":"600px",onClose:de},{footer:e(()=>[t(I,{onClick:s[5]||(s[5]=o=>L.value=!1)},{default:e(()=>[...s[28]||(s[28]=[m(" Отмена ",-1)])]),_:1}),t(I,{type:"primary",loading:O.value,disabled:!K.value.some(o=>o.status==="pending"),onClick:te},{default:e(()=>[m(" Загрузить все ("+y(K.value.filter(o=>o.status==="pending").length)+") ",1)]),_:1},8,["loading","disabled"])]),default:e(()=>[t(ht,{ref_key:"uploadRef",ref:q,"auto-upload":!1,multiple:"",accept:".docx","on-change":h,"show-file-list":!1,drag:""},{tip:e(()=>[...s[26]||(s[26]=[i("div",{class:"el-upload__tip"}," Только .docx файлы, макс. 20 МБ, до 10 файлов ",-1)])]),default:e(()=>[t(S,{class:"el-icon--upload"},{default:e(()=>[t(g(it))]),_:1}),s[27]||(s[27]=i("div",{class:"el-upload__text"},[m(" Перетащите файлы сюда или "),i("em",null,"нажмите для выбора")],-1))]),_:1},512),K.value.length?(l(),R("div",es,[i("div",ts," Выбрано файлов: "+y(K.value.length)+"/"+y(Je),1),(l(!0),R(ae,null,le(K.value,o=>(l(),R("div",{key:o.id,class:Ye(["batch-file-item","batch-file-item--"+o.status])},[o.status==="pending"?(l(),f(S,{key:0,class:"batch-file-icon"},{default:e(()=>[t(g(Ke))]),_:1})):o.status==="uploading"?(l(),f(S,{key:1,class:"batch-file-icon is-loading"},{default:e(()=>[t(g($e))]),_:1})):o.status==="success"?(l(),f(S,{key:2,class:"batch-file-icon batch-file-icon--success"},{default:e(()=>[t(g(We))]),_:1})):o.status==="error"?(l(),f(S,{key:3,class:"batch-file-icon batch-file-icon--error"},{default:e(()=>[t(g(He))]),_:1})):V("",!0),i("div",as,[i("span",ss,y(o.name),1),i("span",ls,y(w(o.size)),1),o.error?(l(),R("span",ns,y(o.error),1)):V("",!0)]),o.status==="pending"||o.status==="error"?(l(),f(I,{key:4,type:"danger",icon:g(Qe),circle:"",size:"small",onClick:oe=>j(o.id)},null,8,["icon","onClick"])):V("",!0)],2))),128))])):V("",!0)]),_:1},8,["modelValue","width"]),t(Ge,{modelValue:b.value,"onUpdate:modelValue":s[9]||(s[9]=o=>b.value=o),title:"Рассчитать профессиональную пригодность",width:B.value?"95%":"500px"},{footer:e(()=>[t(I,{onClick:s[8]||(s[8]=o=>b.value=!1)},{default:e(()=>[...s[29]||(s[29]=[m(" Отмена ",-1)])]),_:1}),t(I,{type:"primary",loading:Z.value,disabled:!ee.activityCode||M.value.length===0,onClick:Ue},{default:e(()=>[...s[30]||(s[30]=[m(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t($t,{model:ee,"label-position":"top"},{default:e(()=>[t(Ct,{label:"Профессиональная область",required:""},{default:e(()=>[Re((l(),f(kt,{modelValue:ee.activityCode,"onUpdate:modelValue":s[7]||(s[7]=o=>ee.activityCode=o),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(l(!0),R(ae,null,le(k.value,o=>(l(),f(bt,{key:o.code,label:o.name,value:o.code},{default:e(()=>[i("span",null,y(o.name),1),i("span",os,y(o.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[lt,F.value]])]),_:1}),t(ge,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),M.value.length===0?(l(),f(ge,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):V("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),t(Ge,{modelValue:D.value,"onUpdate:modelValue":s[10]||(s[10]=o=>D.value=o),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[W.value?(l(),f(_a,{key:0,"report-id":W.value,"report-status":n.value,onMetricsUpdated:Le},null,8,["report-id","report-status"])):V("",!0)]),_:1},8,["modelValue"]),t(La,{modelValue:se.value,"onUpdate:modelValue":s[11]||(s[11]=o=>se.value=o),"participant-id":X.value?.id,"participant-name":X.value?.full_name},null,8,["modelValue","participant-id","participant-name"])])),[[lt,P.value]])]),_:1})}}},ms=Ee(rs,[["__scopeId","data-v-55553c13"]]);export{ms as default};
