import{N as j,m as h,O as W,p as Y,r as _,c as E,o as n,d as t,x as A,P as ht,w as e,u as y,Q as kt,K as Ct,z as Oe,B as w,F as H,H as Se,v as f,f as v,C as Z,a as p,E as I,q as Be,e as qe,R as Xe,I as Ee,J as ce,S as $t,T as he,k as ke,U as Ce,g as $e,V as Rt,W as Te,X as Le,h as ze,Y as Re,Z as De,M as Dt,_ as Ge,$ as St,n as Et,a0 as xt,t as Mt,a1 as Ue,G as At}from"./index-Do8p25N1.js";import{A as Vt}from"./AppLayout-BTAh3kjC.js";import{_ as pe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{f as It,m as de,g as Nt,p as Ft}from"./metricNames-CpPhPvKr.js";import{p as je,u as Tt}from"./participants-CBoQEOOv.js";const fe={async upload(d,$){const u=new FormData;return u.append("file",$),(await j.post(`/participants/${d}/reports`,u,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(d){return await j.get(`/reports/${d}/download`,{responseType:"blob"})},async getById(d){return(await j.get(`/reports/${d}`)).data},async delete(d){return(await j.delete(`/reports/${d}`)).data},async extract(d){return(await j.post(`/reports/${d}/extract`)).data},async getMetrics(d){return(await j.get(`/reports/${d}/metrics`)).data},async getList(d){return(await j.get(`/participants/${d}/reports`)).data}},we={async calculate(d,$){return(await j.post(`/scoring/participants/${d}/calculate`,null,{params:{activity_code:$}})).data},async getHistory(d,$=10){return(await j.get(`/scoring/participants/${d}/scores`,{params:{limit:$}})).data},async getById(d){return(await j.get(`/scoring-results/${d}`)).data},async generateRecommendations(d){return(await j.post(`/reports/${d}/recommendations`)).data},async getFinalReport(d,$,u="json"){const D={params:{activity_code:$,format:u}};u==="html"&&(D.responseType="text");const z=await j.get(`/participants/${d}/final-report`,D);return z.data},async downloadFinalReportPdf(d,$){return await j.get(`/participants/${d}/final-report`,{params:{activity_code:$,format:"pdf"},responseType:"blob"})}};function _e(d,$=1){if(d==null||d==="")return"";const u=typeof d=="string"?parseFloat(d):d;return isNaN(u)?"":u.toLocaleString("ru-RU",{minimumFractionDigits:$,maximumFractionDigits:$})}function le(d){if(d==null||d==="")return null;const u=String(d).trim().replace(",","."),D=parseFloat(u);return isNaN(D)?null:D}function Lt(d){return le(d)}function ue(d,$=1){return _e(d,$)}const zt={key:0,class:"error-message"},Ut={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(d,{emit:$}){const u=d,D=$,z=h(null),V=h(""),U=h(!1),x=h(!1),M=h(""),b=W(()=>le(V.value)),T=W(()=>{const i=b.value;return i===null||i<=u.min}),B=W(()=>{const i=b.value;return i===null||i>=u.max}),q=i=>{if(i==null||i===""){V.value="";return}U.value?V.value=String(i).replace(".",","):V.value=_e(i,u.precision)},G=i=>{if(i==null||i==="")return x.value=!1,M.value="",!0;const l=le(i);return l===null?(x.value=!0,M.value="Некорректное число",!1):l<u.min?(x.value=!0,M.value=`Значение должно быть не меньше ${_e(u.min,u.precision)}`,!1):l>u.max?(x.value=!0,M.value=`Значение должно быть не больше ${_e(u.max,u.precision)}`,!1):(x.value=!1,M.value="",!0)},k=i=>{const l=i.replace(/[^\d,.-]/g,"");let C=!1;const m=l.split("").filter(g=>g===","||g==="."?C?!1:(C=!0,!0):!0).join("").replace(".",",");V.value=m;const r=le(m);r!==null?D("update:modelValue",r):(m===""||m==="-")&&D("update:modelValue",null)},N=()=>{U.value=!1;const i=le(V.value);if(G(V.value)){if(i!==null){const l=Math.round(i*Math.pow(10,u.precision))/Math.pow(10,u.precision),C=Math.max(u.min,Math.min(u.max,l));D("update:modelValue",C),q(C),D("change",C)}}else if(i!==null&&(i<u.min||i>u.max)){const l=Math.max(u.min,Math.min(u.max,i));D("update:modelValue",l),q(l),D("change",l),x.value=!1,M.value=""}D("blur")},X=()=>{U.value=!0,b.value!==null&&(V.value=String(b.value).replace(".",","))},J=()=>{const i=b.value||0,l=Math.min(u.max,i+u.step),C=Math.round(l*Math.pow(10,u.precision))/Math.pow(10,u.precision);D("update:modelValue",C),D("change",C),q(C)},P=()=>{const i=b.value||0,l=Math.max(u.min,i-u.step),C=Math.round(l*Math.pow(10,u.precision))/Math.pow(10,u.precision);D("update:modelValue",C),D("change",C),q(C)};return Y(()=>u.modelValue,i=>{q(i)},{immediate:!0}),q(u.modelValue),(i,l)=>{const C=_("el-button"),m=_("el-button-group"),r=_("el-input");return n(),E(H,null,[t(r,{ref_key:"inputRef",ref:z,modelValue:V.value,"onUpdate:modelValue":l[0]||(l[0]=g=>V.value=g),placeholder:d.placeholder,disabled:d.disabled,class:Oe({"is-invalid":x.value}),onInput:k,onBlur:N,onFocus:X},ht({_:2},[d.showControls?{name:"append",fn:e(()=>[t(m,null,{default:e(()=>[t(C,{icon:y(kt),disabled:d.disabled||T.value,onClick:P},null,8,["icon","disabled"]),t(C,{icon:y(Ct),disabled:d.disabled||B.value,onClick:J},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),x.value?(n(),E("div",zt,w(M.value),1)):A("",!0)],64)}}},Pt=pe(Ut,[["__scopeId","data-v-74ef628d"]]),Ot={class:"card-header"},Bt={key:1},qt={key:0,class:"metric-description"},Xt={key:2,class:"metrics-info"},Gt={class:"info-row"},jt={key:0,class:"info-row"},Jt={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(d,{emit:$}){const u=d,D=$,z=h(!1),V=h(!1),U=h(!1),x=h(null),M=h([]),b=h([]),T=h({metrics:{}}),B=h({}),q=W(()=>!b.value||b.value.length===0?[]:[...new Set(b.value.map(m=>m.source))]),G=W(()=>!b.value||b.value.length===0?null:new Date),k=async()=>{try{const m=await de.listMetricDefs(!0);M.value=m.items||[]}catch(m){console.error("Failed to load metric definitions:",m),x.value="Не удалось загрузить определения метрик"}},N=async()=>{z.value=!0,x.value=null;try{const m=await de.listExtractedMetrics(u.reportId);b.value=m.items||[],T.value.metrics={},b.value.forEach(r=>{T.value.metrics[r.metric_def_id]=le(r.value)}),B.value=JSON.parse(JSON.stringify(T.value.metrics))}catch(m){console.error("Failed to load metrics:",m),x.value="Не удалось загрузить метрики"}finally{z.value=!1}},X=()=>{U.value=!0,B.value=JSON.parse(JSON.stringify(T.value.metrics))},J=()=>{T.value.metrics=JSON.parse(JSON.stringify(B.value)),U.value=!1,x.value=null},P=async()=>{V.value=!0,x.value=null;try{const m=[];for(const[r,g]of Object.entries(T.value.metrics))if(g!=null&&g!==""){const F=Lt(g);F!==null&&m.push({metric_def_id:r,value:F,source:"MANUAL",notes:null})}if(m.length===0){I.warning("Не введено ни одного значения метрики"),V.value=!1;return}await de.bulkCreateExtractedMetrics(u.reportId,m),I.success(`Успешно сохранено ${m.length} метрик`),U.value=!1,await N(),D("metrics-updated")}catch(m){console.error("Failed to save metrics:",m);let r="Не удалось сохранить метрики";m.response?.data?.detail&&(typeof m.response.data.detail=="string"?r=m.response.data.detail:Array.isArray(m.response.data.detail)&&(r=m.response.data.detail.map(g=>g.msg||g.message).join(", "))),x.value=r,I.error(r)}finally{V.value=!1}},i=m=>{switch(m){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},l=m=>{switch(m){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return m}},C=m=>new Date(m).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return Se(async()=>{await k(),await N()}),Y(()=>u.reportId,async m=>{m&&await N()}),(m,r)=>{const g=_("el-button"),F=_("el-alert"),ee=_("el-form-item"),O=_("el-col"),te=_("el-row"),oe=_("el-form"),re=_("el-divider"),ie=_("el-tag"),ae=_("el-card");return n(),f(ae,{class:"metrics-editor"},{header:e(()=>[p("div",Ot,[r[4]||(r[4]=p("span",null,"Ручной ввод метрик",-1)),U.value?(n(),E("div",Bt,[t(g,{size:"small",onClick:J},{default:e(()=>[...r[2]||(r[2]=[v(" Отмена ",-1)])]),_:1}),t(g,{type:"primary",size:"small",loading:V.value,onClick:P},{default:e(()=>[...r[3]||(r[3]=[v(" Сохранить ",-1)])]),_:1},8,["loading"])])):(n(),f(g,{key:0,type:"primary",size:"small",onClick:X},{default:e(()=>[...r[1]||(r[1]=[v(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[x.value?(n(),f(F,{key:0,type:"error",title:x.value,closable:"",style:{"margin-bottom":"16px"},onClose:r[0]||(r[0]=L=>x.value=null)},null,8,["title"])):A("",!0),!b.value||b.value.length===0?(n(),f(F,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...r[5]||(r[5]=[v(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):A("",!0),t(oe,{ref:"formRef",model:T.value,"label-position":"top",disabled:!U.value},{default:e(()=>[t(te,{gutter:20},{default:e(()=>[(n(!0),E(H,null,Z(M.value,L=>(n(),f(O,{key:L.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(ee,{label:y(It)(L),prop:`metrics.${L.id}`},{default:e(()=>[t(Pt,{modelValue:T.value.metrics[L.id],"onUpdate:modelValue":c=>T.value.metrics[L.id]=c,min:L.min_value||1,max:L.max_value||10,precision:1,step:.1,disabled:!U.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),L.description?(n(),E("div",qt,w(L.description),1)):A("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),b.value&&b.value.length>0?(n(),E("div",Xt,[t(re),p("div",Gt,[r[6]||(r[6]=p("span",{class:"info-label"},"Источник данных:",-1)),(n(!0),E(H,null,Z(q.value,L=>(n(),f(ie,{key:L,type:i(L),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[v(w(l(L)),1)]),_:2},1032,["type"]))),128))]),G.value?(n(),E("div",jt,[r[7]||(r[7]=p("span",{class:"info-label"},"Последнее обновление:",-1)),p("span",null,w(C(G.value)),1)])):A("",!0)])):A("",!0)]),_:1})}}},Wt=pe(Jt,[["__scopeId","data-v-1e3d866a"]]),Ht={class:"report-list"},Kt={class:"report-list__controls"},Zt={class:"controls-left"},Qt={class:"controls-right"},Yt={class:"filename"},ea={class:"status-cell"},ta={key:1,class:"report-list__cards"},aa={class:"report-card__header"},sa={class:"report-card__status"},na={class:"report-card__body"},la={class:"report-card__field"},oa={class:"field-value"},ra={class:"report-card__field"},ia={class:"field-value"},ua={class:"report-card__actions"},da={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(d,{emit:$}){const u=d,D=$,z=Be(),V=qe(),U=h(window.innerWidth<=768),x=()=>{U.value=window.innerWidth<=768};Se(()=>{window.addEventListener("resize",x),z.query.status&&(M.value=z.query.status),z.query.sort&&(b.value=z.query.sort)}),Xe(()=>{window.removeEventListener("resize",x)});const M=h(""),b=h("desc"),T=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];Y([M,b],([i,l])=>{const C={...z.query};i?C.status=i:delete C.status,l?C.sort=l:delete C.sort,V.replace({query:C})});const B=()=>{},q=()=>{b.value=b.value==="desc"?"asc":"desc"},G=W(()=>{let i=[...u.reports];return M.value&&(i=i.filter(l=>l.status===M.value)),i.sort((l,C)=>{const m=new Date(l.uploaded_at),r=new Date(C.uploaded_at);return b.value==="desc"?r-m:m-r}),i}),k=W(()=>M.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),N=i=>{if(!i)return"—";const l=new Date(i);return Number.isNaN(l.getTime())?"—":l.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},X=i=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[i]||i,J=i=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[i]||"info",P=async({action:i,report:l})=>{switch(i){case"view":D("view",l.id);break;case"edit":D("edit",l.id);break;case"extract":D("extract",l.id);break;case"download":D("download",l.id);break;case"delete":try{await Dt.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),D("delete",l.id)}catch{}break}};return(i,l)=>{const C=_("el-option"),m=_("el-select"),r=_("el-icon"),g=_("el-button"),F=_("el-table-column"),ee=_("el-tag"),O=_("el-dropdown-item"),te=_("el-dropdown-menu"),oe=_("el-dropdown"),re=_("el-table"),ie=_("el-card"),ae=_("el-empty"),L=Ee("loading");return n(),E("div",Ht,[p("div",Kt,[p("div",Zt,[t(m,{modelValue:M.value,"onUpdate:modelValue":l[0]||(l[0]=c=>M.value=c),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:B},{default:e(()=>[t(C,{label:"Все статусы",value:""}),(n(),E(H,null,Z(T,c=>t(C,{key:c.value,label:c.label,value:c.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),p("div",Qt,[t(g,{type:b.value==="desc"?"primary":"default",size:"small",onClick:q},{default:e(()=>[t(r,null,{default:e(()=>[t(y($t))]),_:1}),v(" "+w(b.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),U.value?ce((n(),E("div",ta,[(n(!0),E(H,null,Z(G.value,c=>(n(),f(ie,{key:c.id,class:"report-card",shadow:"hover"},{header:e(()=>[p("div",aa,[p("div",sa,[c.status==="PROCESSING"?(n(),f(r,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(y(he))]),_:1})):c.status==="EXTRACTED"?(n(),f(r,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(y(ke))]),_:1})):c.status==="FAILED"?(n(),f(r,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(y(Ce))]),_:1})):(n(),f(r,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(y($e))]),_:1})),t(ee,{type:J(c.status),size:"small"},{default:e(()=>[v(w(X(c.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[p("div",ua,[c.status==="EXTRACTED"?(n(),f(g,{key:0,type:"success",size:"small",onClick:Q=>P({action:"edit",report:c})},{default:e(()=>[t(r,null,{default:e(()=>[t(y(Te))]),_:1}),l[10]||(l[10]=v(" Редактировать ",-1))]),_:1},8,["onClick"])):A("",!0),c.status==="PROCESSING"||c.status==="EXTRACTED"?(n(),f(g,{key:1,type:"info",size:"small",onClick:Q=>P({action:"view",report:c})},{default:e(()=>[t(r,null,{default:e(()=>[t(y(Le))]),_:1}),l[11]||(l[11]=v(" Просмотр ",-1))]),_:1},8,["onClick"])):A("",!0),t(g,{type:"primary",size:"small",onClick:Q=>P({action:"extract",report:c})},{default:e(()=>[t(r,null,{default:e(()=>[t(y(ze))]),_:1}),v(" "+w(c.status==="FAILED"?"Повторить":c.status==="PROCESSING"?"Перезапустить":c.status==="EXTRACTED"?"Переизвлечь":"Извлечь"),1)]),_:2},1032,["onClick"]),t(g,{size:"small",onClick:Q=>P({action:"download",report:c})},{default:e(()=>[t(r,null,{default:e(()=>[t(y(Re))]),_:1}),l[12]||(l[12]=v(" Скачать ",-1))]),_:1},8,["onClick"]),t(g,{type:"danger",size:"small",onClick:Q=>P({action:"delete",report:c})},{default:e(()=>[t(r,null,{default:e(()=>[t(y(De))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[p("div",na,[p("div",la,[l[8]||(l[8]=p("span",{class:"field-label"},"Файл:",-1)),p("span",oa,w(c.file_ref?.filename||"Без названия"),1)]),p("div",ra,[l[9]||(l[9]=p("span",{class:"field-label"},"Дата загрузки:",-1)),p("span",ia,w(N(c.uploaded_at)),1)])])]),_:2},1024))),128)),!G.value.length&&!d.loading?(n(),f(ae,{key:0,description:k.value,"image-size":120},{default:e(()=>[M.value?A("",!0):(n(),f(g,{key:0,type:"primary",onClick:l[1]||(l[1]=c=>i.$emit("upload"))},{default:e(()=>[...l[13]||(l[13]=[v(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):A("",!0)])),[[L,d.loading]]):ce((n(),f(re,{key:0,data:G.value,class:"report-list__table",stripe:"","empty-text":k.value},{default:e(()=>[t(F,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:c})=>[p("span",Yt,w(c.file_ref?.filename||"Без названия"),1)]),_:1}),t(F,{prop:"status",label:"Статус",width:"200"},{default:e(({row:c})=>[p("div",ea,[c.status==="PROCESSING"?(n(),f(r,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(y(he))]),_:1})):c.status==="EXTRACTED"?(n(),f(r,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(y(ke))]),_:1})):c.status==="FAILED"?(n(),f(r,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(y(Ce))]),_:1})):(n(),f(r,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(y($e))]),_:1})),t(ee,{type:J(c.status),size:"default"},{default:e(()=>[v(w(X(c.status)),1)]),_:2},1032,["type"])])]),_:1}),t(F,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:c})=>[v(w(N(c.uploaded_at)),1)]),_:1}),t(F,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:c})=>[t(oe,{trigger:"click",onCommand:P},{dropdown:e(()=>[t(te,null,{default:e(()=>[c.status==="EXTRACTED"?(n(),f(O,{key:0,command:{action:"edit",report:c}},{default:e(()=>[t(r,null,{default:e(()=>[t(y(Te))]),_:1}),l[4]||(l[4]=v(" Редактировать метрики ",-1))]),_:1},8,["command"])):A("",!0),c.status==="PROCESSING"||c.status==="EXTRACTED"?(n(),f(O,{key:1,command:{action:"view",report:c}},{default:e(()=>[t(r,null,{default:e(()=>[t(y(Le))]),_:1}),l[5]||(l[5]=v(" Просмотр метрик ",-1))]),_:1},8,["command"])):A("",!0),t(O,{command:{action:"extract",report:c}},{default:e(()=>[t(r,null,{default:e(()=>[t(y(ze))]),_:1}),v(" "+w(c.status==="FAILED"?"Повторить извлечение":c.status==="PROCESSING"?"Перезапустить извлечение":c.status==="EXTRACTED"?"Переизвлечь метрики":"Извлечь метрики"),1)]),_:2},1032,["command"]),t(O,{divided:"",command:{action:"download",report:c}},{default:e(()=>[t(r,null,{default:e(()=>[t(y(Re))]),_:1}),l[6]||(l[6]=v(" Скачать ",-1))]),_:1},8,["command"]),t(O,{command:{action:"delete",report:c},class:"dropdown-item--danger"},{default:e(()=>[t(r,null,{default:e(()=>[t(y(De))]),_:1}),l[7]||(l[7]=v(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(g,{type:"primary",size:"small"},{default:e(()=>[l[3]||(l[3]=v(" Действия ",-1)),t(r,{class:"el-icon--right"},{default:e(()=>[t(y(Rt))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[L,d.loading]]),!G.value.length&&!d.loading&&!U.value?(n(),f(ae,{key:2,description:k.value,"image-size":120},{default:e(()=>[M.value?A("",!0):(n(),f(g,{key:0,type:"primary",onClick:l[2]||(l[2]=c=>i.$emit("upload"))},{default:e(()=>[...l[14]||(l[14]=[v(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):A("",!0)])}}},ca=pe(da,[["__scopeId","data-v-c9651b50"]]),pa={class:"metrics-drawer"},ma={class:"drawer-actions"},fa={key:1},_a={key:1},va={__name:"ParticipantMetricsDrawer",props:{modelValue:{type:Boolean,required:!0},participantId:{type:String,required:!0},participantName:{type:String,required:!0}},emits:["update:modelValue"],setup(d,{emit:$}){const u=d,D=$,z=h(!1),V=h([]),U=h([]),x=W(()=>"Метрики ещё не извлечены. Загрузите и обработайте отчёты."),M=k=>{D("update:modelValue",k)},b=async()=>{try{const k=await de.listMetricDefs(!0);U.value=k.items||[]}catch(k){console.error("Error loading metric definitions:",k)}},T=async()=>{z.value=!0;try{const k=await je.getMetrics(u.participantId);V.value=k.metrics||[]}catch(k){console.error("Error loading participant metrics:",k),I.error("Ошибка загрузки метрик участника")}finally{z.value=!1}},B=k=>{if(!k)return"—";const N=U.value.find(J=>J.code===k);return Nt(N,k,{warn:()=>{}})},q=k=>k>=.8?"var(--el-color-success)":k>=.6?"var(--el-color-warning)":"var(--el-color-danger)",G=k=>{if(!k)return"—";const N=new Date(k);return Number.isNaN(N.getTime())?"—":N.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})};return Y(()=>u.participantId,async k=>{k&&u.modelValue&&(await b(),await T())}),Y(()=>u.modelValue,async k=>{k&&u.participantId&&(await b(),await T())}),(k,N)=>{const X=_("el-icon"),J=_("el-button"),P=_("el-table-column"),i=_("el-tag"),l=_("el-table"),C=_("el-empty"),m=_("el-drawer"),r=Ee("loading");return n(),f(m,{"model-value":d.modelValue,title:`Метрики участника: ${d.participantName}`,size:"70%",direction:"rtl","onUpdate:modelValue":M},{default:e(()=>[ce((n(),E("div",pa,[p("div",ma,[t(J,{type:"primary",size:"small",onClick:T},{default:e(()=>[t(X,null,{default:e(()=>[t(y(Ge))]),_:1}),N[0]||(N[0]=v(" Обновить ",-1))]),_:1})]),t(l,{data:V.value,stripe:"","empty-text":x.value},{default:e(()=>[t(P,{prop:"metric_code",label:"Код метрики",width:"200"}),t(P,{label:"Название метрики","min-width":"250"},{default:e(({row:g})=>[v(w(B(g.metric_code)),1)]),_:1}),t(P,{prop:"value",label:"Значение",width:"120"},{default:e(({row:g})=>[t(i,{type:"success"},{default:e(()=>[v(w(y(ue)(g.value)),1)]),_:2},1024)]),_:1}),t(P,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:g})=>[g.confidence!==null?(n(),E("span",{key:0,style:St({color:q(g.confidence)})},w((g.confidence*100).toFixed(0))+"% ",5)):(n(),E("span",fa,"—"))]),_:1}),t(P,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:g})=>[v(w(G(g.updated_at)),1)]),_:1}),t(P,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:g})=>[g.last_source_report_id?(n(),f(i,{key:0,size:"small"},{default:e(()=>[...N[1]||(N[1]=[v(" Из отчёта ",-1)])]),_:1})):(n(),E("span",_a,"—"))]),_:1})]),_:1},8,["data","empty-text"]),!V.value.length&&!z.value?(n(),f(C,{key:0,description:x.value},null,8,["description"])):A("",!0)])),[[r,z.value]])]),_:1},8,["model-value","title"])}}},ya=pe(va,[["__scopeId","data-v-93720633"]]),ga={class:"participant-detail"},wa={class:"card-header"},ba={class:"header-actions"},ha={class:"section-header"},ka={class:"scoring-result"},Ca={class:"score-value"},$a={class:"score-number"},Ra={class:"score-details"},Da={class:"score-section"},Sa={key:0},Ea={class:"score-section"},xa={key:0},Ma={class:"score-section recommendations-status-section"},Aa={class:"recommendations-pending-alert"},Va={key:0,class:"final-report-actions"},Ia={key:0,class:"batch-files-list"},Na={class:"batch-files-header"},Fa={class:"batch-file-info"},Ta={class:"batch-file-name"},La={class:"batch-file-size"},za={key:0,class:"batch-file-error"},Ua={class:"activity-code-hint"},Pe=20*1024*1024,be=10,Pa={__name:"ParticipantDetailView",setup(d){const $=qe(),u=Be(),D=Tt(),z=h(!1),V=h(!1),U=h(!1),x=h(!1),M=h(!1),b=W(()=>D.currentParticipant),T=h([]),B=h([]),q=h([]),G=h([]),k=h(null),N=h(null),X=h(null),J=W(()=>T.value.some(a=>a.status==="PROCESSING")),P=W(()=>B.value.some(a=>a.recommendations_status==="pending")),i=h(!1),l=h(!1),C=h(!1),m=h(!1),r=h(null),g=h([]),F=h([]);let ee=0;const O=Et({activityCode:""}),te=a=>{if(!a)return"—";const s=new Date(a);return Number.isNaN(s.getTime())?"—":s.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},oe=a=>a>=80?"success":a>=60?"":"warning",re=a=>({pending:"Формируются",ready:"Готовы",error:"Ошибка",disabled:"Отключены"})[a]||a,ie=a=>({pending:"info",ready:"success",error:"danger",disabled:"warning"})[a]||"info",ae=async()=>{z.value=!0;try{await D.getParticipant(u.params.id)}catch{I.error("Участник не найден"),$.push("/participants")}finally{z.value=!1}},L=async({silent:a=!1}={})=>{a||(V.value=!0);try{const s=await je.getReports(u.params.id);T.value=s.items||[]}catch(s){console.error("Error loading reports:",s),I.error("Ошибка загрузки списка отчётов")}finally{a||(V.value=!1)}},c=a=>{if(!a)return a;const s=Array.isArray(a.recommendations)?a.recommendations:[];let S=a.recommendations_status||a.recommendationsStatus||null;S||(S=s.length>0?"ready":"pending");const R=Number(a.score_pct),se=Number.isNaN(R)?a.score_pct:R;return{...a,score_pct:se,recommendations:s,recommendations_status:S,recommendations_error:a.recommendations_error||a.recommendationsError||null}},Q=async()=>{try{const a=await we.getHistory(u.params.id),s=Array.isArray(a.items)?a.items:[];B.value=s.map(c)}catch(a){console.error("Error loading scoring results:",a)}},Je=async()=>{U.value=!0;try{const a=await Ft.list();q.value=a||[]}catch{I.error("Ошибка загрузки профессиональных областей")}finally{U.value=!1}},We=async()=>{try{const a=await de.listMetricDefs(!0);G.value=a.items||[]}catch(a){console.error("Error loading metric definitions:",a)}},xe=a=>a<1024?a+" B":a<1024*1024?(a/1024).toFixed(1)+" KB":(a/(1024*1024)).toFixed(1)+" MB",He=a=>a.name.toLowerCase().endsWith(".docx")?a.size>Pe?`Размер файла превышает ${xe(Pe)}`:null:"Только файлы формата .docx",Ke=(a,s)=>{const S=a.raw;if(F.value.length>=be){I.warning(`Максимальное количество файлов: ${be}`),r.value&&r.value.clearFiles();return}const R=He(S);if(R){I.error(R),r.value&&r.value.clearFiles();return}F.value.push({id:++ee,file:S,name:S.name,size:S.size,status:"pending",progress:0,error:null,reportId:null}),r.value&&r.value.clearFiles()},Ze=a=>{F.value=F.value.filter(s=>s.id!==a)},Qe=async a=>{a.status="uploading",a.progress=0;try{const s=await fe.upload(u.params.id,a.file);a.status="success",a.reportId=s.id}catch(s){a.status="error",a.error=s.response?.data?.detail||"Ошибка загрузки"}},Ye=async()=>{const a=F.value.filter(s=>s.status==="pending");if(a.length===0){I.warning("Нет файлов для загрузки");return}x.value=!0;try{await Promise.allSettled(a.map(R=>Qe(R)));const s=F.value.filter(R=>R.status==="success").length,S=F.value.filter(R=>R.status==="error").length;S===0?(I.success(`Загружено ${s} отчётов`),i.value=!1,Me()):I.warning(`Загружено: ${s}, ошибок: ${S}`),await L()}finally{x.value=!1}},Me=()=>{F.value=[],g.value=[],r.value&&r.value.clearFiles()},et=async a=>{try{const s=await fe.download(a),S=window.URL.createObjectURL(new Blob([s.data])),R=document.createElement("a");R.href=S,R.setAttribute("download",`report_${a}.docx`),document.body.appendChild(R),R.click(),R.remove(),window.URL.revokeObjectURL(S),I.success("Отчёт скачан")}catch{I.error("Ошибка скачивания отчёта")}},tt=async a=>{try{await fe.extract(a),I.success("Извлечение метрик запущено"),await L()}catch{I.error("Ошибка запуска извлечения метрик")}},at=()=>{N.value||(N.value=setInterval(async()=>{try{await L({silent:!0})}catch(a){console.error("Auto-refresh error:",a)}},3e3))},Ae=()=>{N.value&&(clearInterval(N.value),N.value=null)},st=()=>{X.value||(X.value=setInterval(async()=>{try{await Q()}catch(a){console.error("Recommendations auto-refresh error:",a)}},15e3))},Ve=()=>{X.value&&(clearInterval(X.value),X.value=null)};Y(J,a=>{a?at():Ae()}),Y(P,a=>{a?st():Ve()});const Ie=async a=>{k.value=a,await At(),C.value=!0},nt=async()=>{I.success("Метрики обновлены")},lt=async a=>{try{await fe.delete(a),I.success("Отчёт удалён"),await L()}catch{I.error("Ошибка удаления отчёта")}},ot=async()=>{if(!O.activityCode){I.warning("Выберите профессиональную область");return}M.value=!0;try{const a=await we.calculate(u.params.id,O.activityCode),s=c({id:a.scoring_result_id,participant_id:u.params.id,prof_activity_code:a.prof_activity_code||O.activityCode,prof_activity_name:a.prof_activity_name,score_pct:parseFloat(a.score_pct),strengths:a.strengths||[],dev_areas:a.dev_areas||[],recommendations:a.recommendations||[],recommendations_status:a.recommendations_status||((a.recommendations||[]).length>0?"ready":"pending"),recommendations_error:a.recommendations_error||null,created_at:new Date().toISOString()});B.value.unshift(s),I.success("Расчёт пригодности выполнен"),l.value=!1,O.activityCode=""}catch(a){console.error("Scoring calculation error:",a);const s=a.response?.data?.detail||"Ошибка расчёта пригодности";I.error(s)}finally{M.value=!1}},rt=async a=>{if(!a.prof_activity_code){I.warning("Код профессиональной деятельности не найден");return}try{const s=await we.downloadFinalReportPdf(u.params.id,a.prof_activity_code),S=window.URL.createObjectURL(new Blob([s.data])),R=document.createElement("a");R.href=S,R.setAttribute("download",`final_report_${a.prof_activity_code}_${new Date().toISOString().split("T")[0]}.pdf`),document.body.appendChild(R),R.click(),R.remove(),window.URL.revokeObjectURL(S),I.success("Отчёт PDF скачан")}catch(s){const S=s.response?.data?.detail||"Ошибка загрузки PDF отчёта";I.error(S)}},Ne=a=>a?.recommendations_status==="ready"||a?.recommendations_status==="disabled",it=a=>a?.recommendations_status==="pending"?"Дождитесь завершения генерации рекомендаций":a?.recommendations_status==="error"?"Ошибка генерации рекомендаций. Попробуйте пересчитать пригодность":"",ut=a=>a?.recommendations_error?`Ошибка генерации: ${a.recommendations_error}`:"Не удалось получить рекомендации";return Se(async()=>{await ae(),await L(),await Q(),await Je(),await We()}),Xe(()=>{Ae(),Ve()}),(a,s)=>{const S=_("el-button"),R=_("el-icon"),se=_("el-descriptions-item"),dt=_("el-descriptions"),me=_("el-card"),ct=_("el-progress"),ve=_("el-empty"),pt=_("el-tag"),ne=_("el-alert"),mt=_("el-tooltip"),ft=_("el-timeline-item"),_t=_("el-timeline"),vt=_("el-upload"),ye=_("el-dialog"),yt=_("el-option"),gt=_("el-select"),wt=_("el-form-item"),bt=_("el-form"),Fe=Ee("loading");return n(),f(Vt,null,{default:e(()=>[ce((n(),E("div",ga,[b.value?(n(),f(me,{key:0,class:"detail-card"},{header:e(()=>[p("div",wa,[p("h2",null,w(b.value.full_name),1),p("div",ba,[t(S,{onClick:s[0]||(s[0]=o=>y($).back())},{default:e(()=>[...s[12]||(s[12]=[v(" Назад ",-1)])]),_:1}),t(S,{type:"info",onClick:s[1]||(s[1]=o=>m.value=!0)},{default:e(()=>[t(R,null,{default:e(()=>[t(y(xt))]),_:1}),s[13]||(s[13]=v(" Метрики ",-1))]),_:1}),t(S,{type:"primary",onClick:s[2]||(s[2]=o=>l.value=!0)},{default:e(()=>[t(R,null,{default:e(()=>[t(y(Mt))]),_:1}),s[14]||(s[14]=v(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(dt,{column:2,border:""},{default:e(()=>[t(se,{label:"ФИО"},{default:e(()=>[v(w(b.value.full_name),1)]),_:1}),t(se,{label:"Дата рождения"},{default:e(()=>[v(w(b.value.birth_date||"Не указана"),1)]),_:1}),t(se,{label:"Внешний ID"},{default:e(()=>[v(w(b.value.external_id||"Не указан"),1)]),_:1}),t(se,{label:"Дата создания"},{default:e(()=>[v(w(te(b.value.created_at)),1)]),_:1})]),_:1})]),_:1})):A("",!0),t(me,{class:"section-card"},{header:e(()=>[p("div",ha,[s[16]||(s[16]=p("h3",null,"Отчёты",-1)),t(S,{type:"primary",onClick:s[3]||(s[3]=o=>i.value=!0)},{default:e(()=>[t(R,null,{default:e(()=>[t(y(Ue))]),_:1}),s[15]||(s[15]=v(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(ca,{reports:T.value,loading:V.value,onView:Ie,onEdit:Ie,onExtract:tt,onDownload:et,onDelete:lt,onUpload:s[4]||(s[4]=o=>i.value=!0)},null,8,["reports","loading"])]),_:1}),B.value.length>0?(n(),f(me,{key:1,class:"section-card"},{header:e(()=>[...s[17]||(s[17]=[p("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(_t,null,{default:e(()=>[(n(!0),E(H,null,Z(B.value,o=>(n(),f(ft,{key:o.id,timestamp:te(o.created_at),placement:"top"},{default:e(()=>[t(me,null,{default:e(()=>[p("h4",null,w(o.prof_activity_name),1),p("div",ka,[p("div",Ca,[p("span",$a,w(o.score_pct)+"%",1),t(ct,{percentage:o.score_pct,status:oe(o.score_pct)},null,8,["percentage","status"])]),p("div",Ra,[p("div",Da,[s[18]||(s[18]=p("h5",null,"Сильные стороны:",-1)),o.strengths&&o.strengths.length?(n(),E("ul",Sa,[(n(!0),E(H,null,Z(o.strengths,(K,ge)=>(n(),E("li",{key:ge},[p("strong",null,w(K.metric_name),1),v(" — "+w(y(ue)(K.value))+" (вес "+w(y(ue)(K.weight,2))+") ",1)]))),128))])):(n(),f(ve,{key:1,description:"Нет данных","image-size":60}))]),p("div",Ea,[s[19]||(s[19]=p("h5",null,"Зоны развития:",-1)),o.dev_areas&&o.dev_areas.length?(n(),E("ul",xa,[(n(!0),E(H,null,Z(o.dev_areas,(K,ge)=>(n(),E("li",{key:ge},[p("strong",null,w(K.metric_name),1),v(" — "+w(y(ue)(K.value))+" (вес "+w(y(ue)(K.weight,2))+") ",1)]))),128))])):(n(),f(ve,{key:1,description:"Нет данных","image-size":60}))]),p("div",Ma,[p("h5",null,[s[20]||(s[20]=v(" Рекомендации: ",-1)),o.recommendations_status?(n(),f(pt,{key:0,type:ie(o.recommendations_status),size:"small",class:"recommendation-status-tag"},{default:e(()=>[v(w(re(o.recommendations_status)),1)]),_:2},1032,["type"])):A("",!0)]),o.recommendations_status==="pending"?(n(),f(ne,{key:0,type:"info",closable:!1,"show-icon":""},{title:e(()=>[p("div",Aa,[t(R,{class:"is-loading"},{default:e(()=>[t(y(Ge))]),_:1}),s[21]||(s[21]=p("span",null,"Рекомендации формируются...",-1))])]),default:e(()=>[...s[22]||(s[22]=[v(" Кнопка «Скачать PDF» станет доступна после завершения генерации. ",-1)])]),_:1})):o.recommendations_status==="ready"?(n(),f(ne,{key:1,title:"Рекомендации готовы",type:"success",closable:!1,"show-icon":""},{default:e(()=>[...s[23]||(s[23]=[v(" Персональные рекомендации доступны в итоговом PDF-отчёте. ",-1)])]),_:1})):o.recommendations_status==="error"?(n(),f(ne,{key:2,title:ut(o),type:"error",closable:!1,"show-icon":""},{default:e(()=>[...s[24]||(s[24]=[v(" Не удалось сформировать рекомендации. Попробуйте пересчитать пригодность. ",-1)])]),_:1},8,["title"])):o.recommendations_status==="disabled"?(n(),f(ne,{key:3,title:"Генерация рекомендаций отключена",type:"warning",closable:!1,"show-icon":""},{default:e(()=>[...s[25]||(s[25]=[v(" Генерация рекомендаций отключена для данного окружения. ",-1)])]),_:1})):(n(),f(ve,{key:4,description:"Статус рекомендаций неизвестен","image-size":60}))])]),o.prof_activity_code?(n(),E("div",Va,[t(mt,{disabled:Ne(o),content:it(o),placement:"top"},{default:e(()=>[p("span",null,[t(S,{type:"primary",size:"small",disabled:!Ne(o),loading:o.recommendations_status==="pending",onClick:K=>rt(o)},{default:e(()=>[o.recommendations_status!=="pending"?(n(),f(R,{key:0},{default:e(()=>[t(y(Re))]),_:1})):A("",!0),v(" "+w(o.recommendations_status==="pending"?"Формируется...":"Скачать PDF"),1)]),_:2},1032,["disabled","loading","onClick"])])]),_:2},1032,["disabled","content"])])):A("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):A("",!0),t(ye,{modelValue:i.value,"onUpdate:modelValue":s[6]||(s[6]=o=>i.value=o),title:"Загрузить отчёты",width:"600px",onClose:Me},{footer:e(()=>[t(S,{onClick:s[5]||(s[5]=o=>i.value=!1)},{default:e(()=>[...s[28]||(s[28]=[v(" Отмена ",-1)])]),_:1}),t(S,{type:"primary",loading:x.value,disabled:!F.value.some(o=>o.status==="pending"),onClick:Ye},{default:e(()=>[v(" Загрузить все ("+w(F.value.filter(o=>o.status==="pending").length)+") ",1)]),_:1},8,["loading","disabled"])]),default:e(()=>[t(vt,{ref_key:"uploadRef",ref:r,"auto-upload":!1,multiple:"",accept:".docx","on-change":Ke,"show-file-list":!1,drag:""},{tip:e(()=>[...s[26]||(s[26]=[p("div",{class:"el-upload__tip"}," Только .docx файлы, макс. 20 МБ, до 10 файлов ",-1)])]),default:e(()=>[t(R,{class:"el-icon--upload"},{default:e(()=>[t(y(Ue))]),_:1}),s[27]||(s[27]=p("div",{class:"el-upload__text"},[v(" Перетащите файлы сюда или "),p("em",null,"нажмите для выбора")],-1))]),_:1},512),F.value.length?(n(),E("div",Ia,[p("div",Na," Выбрано файлов: "+w(F.value.length)+"/"+w(be),1),(n(!0),E(H,null,Z(F.value,o=>(n(),E("div",{key:o.id,class:Oe(["batch-file-item","batch-file-item--"+o.status])},[o.status==="pending"?(n(),f(R,{key:0,class:"batch-file-icon"},{default:e(()=>[t(y($e))]),_:1})):o.status==="uploading"?(n(),f(R,{key:1,class:"batch-file-icon is-loading"},{default:e(()=>[t(y(he))]),_:1})):o.status==="success"?(n(),f(R,{key:2,class:"batch-file-icon batch-file-icon--success"},{default:e(()=>[t(y(ke))]),_:1})):o.status==="error"?(n(),f(R,{key:3,class:"batch-file-icon batch-file-icon--error"},{default:e(()=>[t(y(Ce))]),_:1})):A("",!0),p("div",Fa,[p("span",Ta,w(o.name),1),p("span",La,w(xe(o.size)),1),o.error?(n(),E("span",za,w(o.error),1)):A("",!0)]),o.status==="pending"||o.status==="error"?(n(),f(S,{key:4,type:"danger",icon:y(De),circle:"",size:"small",onClick:K=>Ze(o.id)},null,8,["icon","onClick"])):A("",!0)],2))),128))])):A("",!0)]),_:1},8,["modelValue"]),t(ye,{modelValue:l.value,"onUpdate:modelValue":s[9]||(s[9]=o=>l.value=o),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:e(()=>[t(S,{onClick:s[8]||(s[8]=o=>l.value=!1)},{default:e(()=>[...s[29]||(s[29]=[v(" Отмена ",-1)])]),_:1}),t(S,{type:"primary",loading:M.value,disabled:!O.activityCode||T.value.length===0,onClick:ot},{default:e(()=>[...s[30]||(s[30]=[v(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t(bt,{model:O,"label-position":"top"},{default:e(()=>[t(wt,{label:"Профессиональная область",required:""},{default:e(()=>[ce((n(),f(gt,{modelValue:O.activityCode,"onUpdate:modelValue":s[7]||(s[7]=o=>O.activityCode=o),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(n(!0),E(H,null,Z(q.value,o=>(n(),f(yt,{key:o.code,label:o.name,value:o.code},{default:e(()=>[p("span",null,w(o.name),1),p("span",Ua,w(o.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[Fe,U.value]])]),_:1}),t(ne,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),T.value.length===0?(n(),f(ne,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):A("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(ye,{modelValue:C.value,"onUpdate:modelValue":s[10]||(s[10]=o=>C.value=o),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[k.value?(n(),f(Wt,{key:0,"report-id":k.value,onMetricsUpdated:nt},null,8,["report-id"])):A("",!0)]),_:1},8,["modelValue"]),t(ya,{modelValue:m.value,"onUpdate:modelValue":s[11]||(s[11]=o=>m.value=o),"participant-id":b.value?.id,"participant-name":b.value?.full_name},null,8,["modelValue","participant-id","participant-name"])])),[[Fe,z.value]])]),_:1})}}},ja=pe(Pa,[["__scopeId","data-v-4dcfc3e5"]]);export{ja as default};
